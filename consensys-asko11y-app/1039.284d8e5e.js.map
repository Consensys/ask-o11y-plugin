{"version":3,"file":"1039.284d8e5e.js","mappings":"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","sources":["webpack://consensys-asko11y-app/./components/LoadingOverlay.tsx","webpack://consensys-asko11y-app/./core/models/ChatSession.ts","webpack://consensys-asko11y-app/./services/sessionShare.ts","webpack://consensys-asko11y-app/./services/backendMCPClient.ts","webpack://consensys-asko11y-app/./services/queue.ts","webpack://consensys-asko11y-app/./services/tokenizer.ts","webpack://consensys-asko11y-app/./components/Chat/utils/grafanaLinkParser.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useStreamManager.ts","webpack://consensys-asko11y-app/./constants.ts","webpack://consensys-asko11y-app/./services/memory.ts","webpack://consensys-asko11y-app/./services/reliability.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useChat.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useMCPManager.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useSessionManager.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useEmbeddingAllowed.ts","webpack://consensys-asko11y-app/./components/Chat/components/ChatHeader/ChatHeader.tsx","webpack://consensys-asko11y-app/./components/Chat/components/ToolCallsSection/ToolCallDisplay.tsx","webpack://consensys-asko11y-app/./components/Chat/components/ToolCallsSection/ToolCallsSection.tsx","webpack://consensys-asko11y-app/./components/Chat/components/GraphRenderer/GraphRenderer.tsx","webpack://consensys-asko11y-app/./components/Chat/components/LogsRenderer/LogsRenderer.tsx","webpack://consensys-asko11y-app/./components/Chat/components/TracesRenderer/TracesRenderer.tsx","webpack://consensys-asko11y-app/./components/Chat/utils/promqlParser.ts","webpack://consensys-asko11y-app/./components/Chat/components/ChatMessage/ChatMessage.tsx","webpack://consensys-asko11y-app/./components/Chat/components/ChatHistory/ChatHistory.tsx","webpack://consensys-asko11y-app/./components/Chat/components/ChatInput/ChatInput.tsx","webpack://consensys-asko11y-app/./components/Chat/components/WelcomeMessage/WelcomeMessage.tsx","webpack://consensys-asko11y-app/./components/Chat/components/QuickSuggestions/QuickSuggestions.tsx","webpack://consensys-asko11y-app/./components/Chat/components/ShareDialog/ShareDialog.tsx","webpack://consensys-asko11y-app/./components/Chat/components/SessionSidebar/SessionSidebar.tsx","webpack://consensys-asko11y-app/./components/Chat/components/SummarizationIndicator/SummarizationIndicator.tsx","webpack://consensys-asko11y-app/./components/Chat/components/SidePanel/TabCloseButton.tsx","webpack://consensys-asko11y-app/./components/Chat/components/SidePanel/SidePanel.tsx","webpack://consensys-asko11y-app/./components/Chat/Chat.tsx","webpack://consensys-asko11y-app/./components/Chat/hooks/useGrafanaTheme.ts","webpack://consensys-asko11y-app/./components/Chat/hooks/useKeyboardNavigation.ts","webpack://consensys-asko11y-app/./core/errors/StorageError.ts","webpack://consensys-asko11y-app/./core/services/SessionService.ts","webpack://consensys-asko11y-app/./core/repositories/GrafanaUserStorageRepository.ts","webpack://consensys-asko11y-app/./core/services/ServiceFactory.ts"],"sourcesContent":["/**\n * Loading Overlay Component\n * Provides visual feedback during async operations with customizable messages and styles\n */\n\nimport React from 'react';\nimport { Spinner, Portal } from '@grafana/ui';\n\ninterface LoadingOverlayProps {\n  isLoading: boolean;\n  message?: string;\n  variant?: 'overlay' | 'inline' | 'fullscreen';\n  size?: 'sm' | 'md' | 'lg' | 'xl';\n  showSpinner?: boolean;\n  showProgress?: boolean;\n  progress?: number;\n  transparent?: boolean;\n  children?: React.ReactNode;\n  className?: string;\n}\n\n/**\n * Loading overlay component for async operations\n */\nexport const LoadingOverlay: React.FC<LoadingOverlayProps> = ({\n  isLoading,\n  message = 'Loading...',\n  variant = 'overlay',\n  size = 'md',\n  showSpinner = true,\n  showProgress = false,\n  progress = 0,\n  transparent = false,\n  children,\n  className = '',\n}) => {\n  if (!isLoading) {\n    return <>{children}</>;\n  }\n\n  const getSizeClass = () => {\n    switch (size) {\n      case 'sm':\n        return 'text-xs';\n      case 'md':\n        return 'text-sm';\n      case 'lg':\n        return 'text-base';\n      case 'xl':\n        return 'text-lg';\n      default:\n        return 'text-sm';\n    }\n  };\n\n  const getSpinnerSize = () => {\n    switch (size) {\n      case 'sm':\n        return 14;\n      case 'md':\n        return 20;\n      case 'lg':\n        return 28;\n      case 'xl':\n        return 36;\n      default:\n        return 20;\n    }\n  };\n\n  const content = (\n    <div className={`flex flex-col items-center justify-center ${getSizeClass()}`}>\n      {showSpinner && <Spinner size={getSpinnerSize()} className=\"mb-3\" aria-label=\"Loading spinner\" />}\n      {message && (\n        <div className=\"text-secondary font-medium\" role=\"status\" aria-live=\"polite\">\n          {message}\n        </div>\n      )}\n      {showProgress && progress > 0 && (\n        <div className=\"mt-3 w-48\">\n          <div className=\"bg-weak rounded-full h-2 overflow-hidden\">\n            <div\n              className=\"bg-primary h-full transition-all duration-300 ease-out\"\n              style={{ width: `${Math.min(100, Math.max(0, progress))}%` }}\n              role=\"progressbar\"\n              aria-valuenow={progress}\n              aria-valuemin={0}\n              aria-valuemax={100}\n              aria-label={`Loading progress: ${Math.round(progress)}%`}\n            />\n          </div>\n          <div className=\"text-center mt-1 text-xs text-secondary\">{Math.round(progress)}%</div>\n        </div>\n      )}\n    </div>\n  );\n\n  if (variant === 'inline') {\n    return (\n      <div className={`relative ${className}`}>\n        {children && <div className=\"opacity-50 pointer-events-none\">{children}</div>}\n        <div className=\"flex items-center justify-center py-4\">{content}</div>\n      </div>\n    );\n  }\n\n  if (variant === 'fullscreen') {\n    return (\n      <Portal>\n        <div\n          className={`fixed inset-0 z-50 flex items-center justify-center ${\n            transparent ? 'bg-black/30' : 'bg-background'\n          } ${className}`}\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-label={message}\n        >\n          <div className=\"bg-background rounded-lg shadow-lg p-8 max-w-sm w-full mx-4\">{content}</div>\n        </div>\n      </Portal>\n    );\n  }\n\n  // Default overlay variant\n  return (\n    <div className={`relative ${className}`}>\n      {children}\n      <div\n        className={`absolute inset-0 z-10 flex items-center justify-center rounded-lg ${\n          transparent ? 'bg-black/20' : 'bg-background/90'\n        }`}\n        role=\"status\"\n        aria-live=\"polite\"\n        aria-label={message}\n      >\n        {content}\n      </div>\n    </div>\n  );\n};\n\n/**\n * Inline loading indicator for smaller components\n */\nexport const InlineLoading: React.FC<{\n  message?: string;\n  size?: 'sm' | 'md' | 'lg';\n  className?: string;\n}> = ({ message = 'Loading...', size = 'sm', className = '' }) => {\n  const spinnerSize = size === 'sm' ? 12 : size === 'md' ? 16 : 20;\n\n  return (\n    <div className={`flex items-center gap-2 text-secondary ${className}`} role=\"status\" aria-live=\"polite\">\n      <Spinner size={spinnerSize} />\n      {message && <span className={size === 'sm' ? 'text-xs' : 'text-sm'}>{message}</span>}\n    </div>\n  );\n};\n\n/**\n * Skeleton loader for content placeholders\n */\nexport const SkeletonLoader: React.FC<{\n  width?: string;\n  height?: string;\n  className?: string;\n  variant?: 'text' | 'rect' | 'circle';\n  animate?: boolean;\n}> = ({ width = '100%', height = '20px', className = '', variant = 'rect', animate = true }) => {\n  const getVariantClass = () => {\n    switch (variant) {\n      case 'text':\n        return 'rounded';\n      case 'circle':\n        return 'rounded-full';\n      default:\n        return 'rounded-md';\n    }\n  };\n\n  return (\n    <div\n      className={`bg-weak ${getVariantClass()} ${animate ? 'animate-pulse' : ''} ${className}`}\n      style={{ width, height }}\n      role=\"presentation\"\n      aria-hidden=\"true\"\n    />\n  );\n};\n\n/**\n * Loading dots animation\n */\nexport const LoadingDots: React.FC<{\n  size?: 'sm' | 'md' | 'lg';\n  className?: string;\n}> = ({ size = 'md', className = '' }) => {\n  const dotSize = size === 'sm' ? 'w-1 h-1' : size === 'md' ? 'w-1.5 h-1.5' : 'w-2 h-2';\n\n  return (\n    <div className={`flex items-center gap-1 ${className}`} role=\"status\" aria-live=\"polite\" aria-label=\"Loading\">\n      {[0, 1, 2].map((i) => (\n        <div\n          key={i}\n          className={`${dotSize} bg-current rounded-full animate-pulse`}\n          style={{ animationDelay: `${i * 150}ms` }}\n        />\n      ))}\n    </div>\n  );\n};\n\n/**\n * Button with loading state\n */\nexport const LoadingButton: React.FC<{\n  isLoading?: boolean;\n  loadingText?: string;\n  onClick?: () => void;\n  disabled?: boolean;\n  variant?: 'primary' | 'secondary' | 'destructive';\n  size?: 'sm' | 'md' | 'lg';\n  icon?: React.ReactNode;\n  children: React.ReactNode;\n  className?: string;\n  type?: 'button' | 'submit' | 'reset';\n}> = ({\n  isLoading = false,\n  loadingText = 'Processing...',\n  onClick,\n  disabled = false,\n  variant = 'primary',\n  size = 'md',\n  icon,\n  children,\n  className = '',\n  type = 'button',\n}) => {\n  const getVariantClass = () => {\n    if (isLoading || disabled) {\n      return 'bg-weak text-disabled cursor-not-allowed';\n    }\n\n    switch (variant) {\n      case 'primary':\n        return 'bg-primary hover:bg-primary-shade text-primary-text';\n      case 'secondary':\n        return 'bg-secondary hover:bg-secondary-shade text-secondary-text border border-medium';\n      case 'destructive':\n        return 'bg-error hover:bg-error-shade text-error-text';\n      default:\n        return 'bg-primary hover:bg-primary-shade text-primary-text';\n    }\n  };\n\n  const getSizeClass = () => {\n    switch (size) {\n      case 'sm':\n        return 'px-3 py-1.5 text-xs';\n      case 'md':\n        return 'px-4 py-2 text-sm';\n      case 'lg':\n        return 'px-6 py-3 text-base';\n      default:\n        return 'px-4 py-2 text-sm';\n    }\n  };\n\n  return (\n    <button\n      type={type}\n      onClick={onClick}\n      disabled={isLoading || disabled}\n      className={`\n        inline-flex items-center justify-center gap-2\n        rounded-md font-medium transition-colors\n        focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2\n        ${getVariantClass()}\n        ${getSizeClass()}\n        ${className}\n      `}\n      aria-busy={isLoading}\n      aria-disabled={isLoading || disabled}\n    >\n      {isLoading ? (\n        <>\n          <Spinner size={size === 'sm' ? 12 : size === 'md' ? 14 : 16} />\n          <span>{loadingText}</span>\n        </>\n      ) : (\n        <>\n          {icon}\n          {children}\n        </>\n      )}\n    </button>\n  );\n};\n","import { ChatMessage } from '../../components/Chat/types';\n\n/**\n * Chat session domain model with validation and factory methods\n */\nexport class ChatSession {\n  constructor(\n    public readonly id: string,\n    public title: string,\n    public messages: ChatMessage[],\n    public readonly createdAt: Date,\n    public updatedAt: Date,\n    public messageCount: number,\n    public summary?: string\n  ) {}\n\n  /**\n   * Factory method to create a new session\n   */\n  static create(messages: ChatMessage[], title?: string): ChatSession {\n    const now = new Date();\n    const sessionId = ChatSession.generateId();\n    const sessionTitle = title || ChatSession.generateTitle(messages);\n\n    return new ChatSession(sessionId, sessionTitle, messages, now, now, messages.length);\n  }\n\n  /**\n   * Create from storage data (with date parsing)\n   */\n  static fromStorage(data: any): ChatSession {\n    return new ChatSession(\n      data.id,\n      data.title,\n      data.messages.map((msg: any) => ({\n        ...msg,\n        timestamp: new Date(msg.timestamp),\n      })),\n      new Date(data.createdAt),\n      new Date(data.updatedAt),\n      data.messageCount,\n      data.summary\n    );\n  }\n\n  /**\n   * Convert to storage format\n   */\n  toStorage(): any {\n    return {\n      id: this.id,\n      title: this.title,\n      messages: this.messages,\n      createdAt: this.createdAt,\n      updatedAt: this.updatedAt,\n      messageCount: this.messageCount,\n      summary: this.summary,\n    };\n  }\n\n  /**\n   * Update messages and refresh metadata\n   */\n  updateMessages(messages: ChatMessage[], summary?: string): void {\n    this.messages = messages;\n    this.messageCount = messages.length;\n    this.updatedAt = new Date();\n\n    if (summary) {\n      this.summary = summary;\n    }\n\n    // Update title if it's still default\n    if (this.title === 'New Conversation' && messages.length > 0) {\n      this.title = ChatSession.generateTitle(messages);\n    }\n  }\n\n  /**\n   * Get session metadata (without messages)\n   */\n  getMetadata(): SessionMetadata {\n    return {\n      id: this.id,\n      title: this.title,\n      createdAt: this.createdAt,\n      updatedAt: this.updatedAt,\n      messageCount: this.messageCount,\n    };\n  }\n\n  /**\n   * Generate unique session ID\n   */\n  private static generateId(): string {\n    return `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\n  }\n\n  /**\n   * Generate title from first user message\n   */\n  private static generateTitle(messages: ChatMessage[]): string {\n    const firstUserMessage = messages.find((msg) => msg.role === 'user');\n    if (!firstUserMessage) {\n      return 'New Conversation';\n    }\n\n    const content = firstUserMessage.content.trim();\n    const maxLength = 60;\n    return content.length > maxLength ? `${content.substring(0, maxLength)}...` : content;\n  }\n}\n\nexport interface SessionMetadata {\n  id: string;\n  title: string;\n  createdAt: Date;\n  updatedAt: Date;\n  messageCount: number;\n}\n","import { getBackendSrv } from '@grafana/runtime';\nimport { firstValueFrom } from 'rxjs';\nimport { ChatSession } from '../core/models/ChatSession';\nimport { ChatMessage } from '../components/Chat/types';\n\nexport interface CreateShareRequest {\n  sessionId: string;\n  sessionData: ChatSession;\n  expiresInDays?: number;\n}\n\nexport interface CreateShareResponse {\n  shareId: string;\n  shareUrl: string;\n  expiresAt: string | null;\n}\n\nexport interface SharedSession {\n  id: string;\n  title: string;\n  messages: ChatMessage[];\n  createdAt: string;\n  updatedAt: string;\n  isShared: true;\n  sharedBy?: string;\n}\n\nexport class SessionShareService {\n  private baseUrl = '/api/plugins/consensys-asko11y-app/resources';\n\n  /**\n   * Create a shareable link for a session\n   */\n  async createShare(sessionId: string, sessionData: ChatSession, expiresInDays?: number): Promise<CreateShareResponse> {\n    try {\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<CreateShareResponse>({\n          url: `${this.baseUrl}/api/sessions/share`,\n          method: 'POST',\n          data: {\n            sessionId,\n            sessionData: sessionData.toStorage(),\n            expiresInDays,\n          },\n          showErrorAlert: false,\n        })\n      );\n\n      if (!response || !response.data) {\n        throw new Error('No response from backend');\n      }\n\n      return response.data;\n    } catch (error) {\n      console.error('[SessionShareService] Failed to create share:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get a shared session by share ID\n   */\n  async getSharedSession(shareId: string): Promise<SharedSession> {\n    try {\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<SharedSession>({\n          url: `${this.baseUrl}/api/sessions/shared/${shareId}`,\n          method: 'GET',\n          showErrorAlert: false,\n        })\n      );\n\n      if (!response || !response.data) {\n        throw new Error('No response from backend');\n      }\n\n      return response.data;\n    } catch (error) {\n      console.error('[SessionShareService] Failed to get shared session:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Revoke a share link\n   */\n  async revokeShare(shareId: string): Promise<void> {\n    try {\n      await firstValueFrom(\n        getBackendSrv().fetch({\n          url: `${this.baseUrl}/api/sessions/share/${shareId}`,\n          method: 'DELETE',\n          showErrorAlert: false,\n        })\n      );\n    } catch (error) {\n      console.error('[SessionShareService] Failed to revoke share:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get all shares for a session\n   */\n  async getSessionShares(sessionId: string): Promise<CreateShareResponse[]> {\n    try {\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<CreateShareResponse[]>({\n          url: `${this.baseUrl}/api/sessions/${sessionId}/shares`,\n          method: 'GET',\n          showErrorAlert: false,\n        })\n      );\n\n      if (!response || !response.data) {\n        return [];\n      }\n\n      return response.data;\n    } catch (error) {\n      console.error('[SessionShareService] Failed to get session shares:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Build a full share URL from a share ID\n   */\n  buildShareUrl(shareId: string): string {\n    // Get current origin\n    const origin = window.location.origin;\n    return `${origin}/a/consensys-asko11y-app/shared/${shareId}`;\n  }\n}\n\n// Export singleton instance\nexport const sessionShareService = new SessionShareService();\n","/**\n * Backend MCP Client\n * Communicates with the backend MCP proxy instead of directly connecting to external servers\n */\n\nimport { firstValueFrom } from 'rxjs';\nimport { getBackendSrv, config } from '@grafana/runtime';\nimport type { Tool, CallToolResult } from '@modelcontextprotocol/sdk/types';\n\n// Define CallToolParams locally since it's not exported from SDK\ninterface CallToolParams {\n  name: string;\n  arguments?: Record<string, unknown>;\n  scopeOrgId?: string; // Optional: Direct X-Scope-OrgId value (takes priority over orgName for mcp-alertmanager)\n}\n\nexport class BackendMCPClient {\n  private baseUrl: string;\n  private cachedTools: Tool[] | null = null;\n\n  constructor() {\n    // Use Grafana's plugin resource endpoint\n    this.baseUrl = '/api/plugins/consensys-asko11y-app/resources';\n  }\n\n  /**\n   * List all tools from the backend MCP proxy\n   */\n  async listTools(): Promise<Tool[]> {\n    if (this.cachedTools) {\n      return this.cachedTools;\n    }\n\n    try {\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<{ tools: Tool[] }>({\n          url: `${this.baseUrl}/api/mcp/tools`,\n          method: 'GET',\n        })\n      );\n\n      this.cachedTools = response?.data.tools || [];\n      console.log('[BackendMCPClient] Listed tools from backend:', this.cachedTools.length);\n\n      return this.cachedTools;\n    } catch (error) {\n      console.error('[BackendMCPClient] Failed to list tools:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Call a tool via the backend MCP proxy\n   * Note: Grafana's getBackendSrv() automatically includes X-Grafana-Org-Id header\n   * We pass orgName and scopeOrgId in the request body (not headers) because Grafana's proxy\n   * does not forward custom headers to backend plugins.\n   *\n   * For mcp-alertmanager:\n   * - If scopeOrgId is provided, it's used directly as X-Scope-OrgId\n   * - Otherwise, orgName is used as the X-Scope-OrgId value\n   */\n  async callTool(params: CallToolParams): Promise<CallToolResult> {\n    try {\n      console.log('[BackendMCPClient] Calling tool via backend:', params.name);\n\n      // Get org name from Grafana config for services that need tenant name (e.g., Alertmanager)\n      // This must be passed in the body, not headers, as Grafana's proxy doesn't forward custom headers\n      const orgName = config.bootData?.user?.orgName || '';\n\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<CallToolResult>({\n          url: `${this.baseUrl}/api/mcp/call-tool`,\n          method: 'POST',\n          data: {\n            name: params.name,\n            arguments: params.arguments || {},\n            orgName: orgName,\n            scopeOrgId: params.scopeOrgId || '', // Direct X-Scope-OrgId (priority over orgName for mcp-alertmanager)\n          },\n          showErrorAlert: false,\n        })\n      );\n\n      if (!response) {\n        throw new Error('No response from backend');\n      }\n\n      return response.data;\n    } catch (error) {\n      console.error('[BackendMCPClient] Failed to call tool:', error);\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: `Error calling tool via backend: ${error instanceof Error ? error.message : 'Unknown error'}`,\n          },\n        ],\n        isError: true,\n      };\n    }\n  }\n\n  /**\n   * Check if a tool is handled by the backend\n   */\n  isTool(toolName: string): boolean {\n    if (!this.cachedTools) {\n      return false;\n    }\n\n    return this.cachedTools.some((tool) => tool.name === toolName);\n  }\n\n  /**\n   * Clear the cached tools\n   */\n  clearCache(): void {\n    this.cachedTools = null;\n  }\n\n  /**\n   * Get health status from backend\n   */\n  async getHealth(): Promise<{ status: string; mcpServers: number; message: string }> {\n    try {\n      const response = await firstValueFrom(\n        getBackendSrv().fetch<{\n          status: string;\n          mcpServers: number;\n          message: string;\n        }>({\n          url: `${this.baseUrl}/health`,\n          method: 'GET',\n        })\n      );\n\n      if (!response) {\n        throw new Error('No response from backend');\n      }\n\n      return response.data;\n    } catch (error) {\n      console.error('[BackendMCPClient] Failed to get health:', error);\n      return {\n        status: 'error',\n        mcpServers: 0,\n        message: 'Failed to connect to backend',\n      };\n    }\n  }\n}\n\n// Export singleton instance\nexport const backendMCPClient = new BackendMCPClient();\n","/**\n * Request Queue Service\n * Manages concurrent requests with rate limiting and queuing\n * Prevents overwhelming backend services and ensures stable performance\n */\n\ninterface QueueItem<T = any> {\n  id: string;\n  execute: () => Promise<T>;\n  resolve: (value: T) => void;\n  reject: (error: any) => void;\n  priority: number;\n  timestamp: number;\n  retryCount: number;\n  maxRetries: number;\n}\n\ninterface QueueConfig {\n  maxConcurrent: number;\n  maxQueueSize: number;\n  requestsPerSecond: number;\n  retryDelays: number[];\n  defaultPriority: number;\n  timeout: number;\n}\n\nexport class RequestQueueService {\n  private queue: QueueItem[] = [];\n  private activeRequests = new Map<string, Promise<any>>();\n  private requestCount = 0;\n  private requestCountResetTime = 0;\n\n  private config: QueueConfig = {\n    maxConcurrent: 3,\n    maxQueueSize: 100,\n    requestsPerSecond: 10,\n    retryDelays: [1000, 2000, 5000], // Exponential backoff\n    defaultPriority: 5,\n    timeout: 30000, // 30 seconds\n  };\n\n  // Metrics for monitoring\n  private metrics = {\n    totalRequests: 0,\n    successfulRequests: 0,\n    failedRequests: 0,\n    retriedRequests: 0,\n    queuedTime: [] as number[],\n    executionTime: [] as number[],\n  };\n\n  constructor(config?: Partial<QueueConfig>) {\n    if (config) {\n      this.config = { ...this.config, ...config };\n    }\n  }\n\n  /**\n   * Add a request to the queue\n   * @param execute Function that returns a promise\n   * @param options Queue options\n   * @returns Promise that resolves when the request completes\n   */\n  async add<T>(\n    execute: () => Promise<T>,\n    options: {\n      priority?: number;\n      maxRetries?: number;\n      id?: string;\n    } = {}\n  ): Promise<T> {\n    const {\n      priority = this.config.defaultPriority,\n      maxRetries = this.config.retryDelays.length,\n      id = this.generateId(),\n    } = options;\n\n    // Check queue size limit\n    if (this.queue.length >= this.config.maxQueueSize) {\n      throw new Error(`Queue is full (max size: ${this.config.maxQueueSize})`);\n    }\n\n    return new Promise<T>((resolve, reject) => {\n      const queueItem: QueueItem<T> = {\n        id,\n        execute,\n        resolve,\n        reject,\n        priority,\n        timestamp: Date.now(),\n        retryCount: 0,\n        maxRetries,\n      };\n\n      // Add to queue sorted by priority (higher priority first)\n      const insertIndex = this.queue.findIndex((item) => item.priority < priority);\n      if (insertIndex === -1) {\n        this.queue.push(queueItem);\n      } else {\n        this.queue.splice(insertIndex, 0, queueItem);\n      }\n\n      console.log(`[RequestQueue] Added request ${id} to queue. Queue size: ${this.queue.length}`);\n\n      // Start processing\n      this.processQueue();\n    });\n  }\n\n  /**\n   * Process items in the queue\n   */\n  private async processQueue() {\n    // Check if we can process more requests\n    if (this.activeRequests.size >= this.config.maxConcurrent || this.queue.length === 0) {\n      return;\n    }\n\n    // Check rate limiting\n    if (!this.checkRateLimit()) {\n      // Schedule retry after rate limit window\n      const delay = this.getRateLimitDelay();\n      console.log(`[RequestQueue] Rate limit reached, waiting ${delay}ms`);\n      setTimeout(() => this.processQueue(), delay);\n      return;\n    }\n\n    // Get next item from queue\n    const item = this.queue.shift();\n    if (!item) {\n      return;\n    }\n\n    // Record metrics\n    const queueTime = Date.now() - item.timestamp;\n    this.metrics.queuedTime.push(queueTime);\n    this.metrics.totalRequests++;\n\n    console.log(`[RequestQueue] Processing request ${item.id} after ${queueTime}ms in queue`);\n\n    // Execute the request\n    this.executeRequest(item);\n\n    // Continue processing queue\n    if (this.queue.length > 0) {\n      setImmediate(() => this.processQueue());\n    }\n  }\n\n  /**\n   * Execute a queued request with retries and timeout\n   */\n  private async executeRequest<T>(item: QueueItem<T>) {\n    const startTime = Date.now();\n    const timeoutId = setTimeout(() => {\n      if (this.activeRequests.has(item.id)) {\n        item.reject(new Error(`Request ${item.id} timed out after ${this.config.timeout}ms`));\n        this.activeRequests.delete(item.id);\n        this.metrics.failedRequests++;\n      }\n    }, this.config.timeout);\n\n    try {\n      // Track active request\n      const requestPromise = item.execute();\n      this.activeRequests.set(item.id, requestPromise);\n\n      // Update rate limiting counters\n      this.recordRequest();\n\n      // Wait for completion\n      const result = await requestPromise;\n\n      clearTimeout(timeoutId);\n      this.activeRequests.delete(item.id);\n\n      // Record success metrics\n      const executionTime = Date.now() - startTime;\n      this.metrics.executionTime.push(executionTime);\n      this.metrics.successfulRequests++;\n\n      console.log(`[RequestQueue] Request ${item.id} completed in ${executionTime}ms`);\n\n      item.resolve(result);\n\n      // Process next item in queue\n      this.processQueue();\n    } catch (error) {\n      clearTimeout(timeoutId);\n      this.activeRequests.delete(item.id);\n\n      // Check if we should retry\n      if (item.retryCount < item.maxRetries) {\n        const retryDelay = this.config.retryDelays[item.retryCount] || 5000;\n        item.retryCount++;\n\n        console.log(\n          `[RequestQueue] Request ${item.id} failed, retrying (${item.retryCount}/${item.maxRetries}) after ${retryDelay}ms`,\n          error\n        );\n\n        this.metrics.retriedRequests++;\n\n        // Re-add to queue with delay\n        setTimeout(() => {\n          // Re-add with same priority but at the front of that priority group\n          const insertIndex = this.queue.findIndex((i) => i.priority < item.priority);\n          if (insertIndex === -1) {\n            this.queue.push(item);\n          } else {\n            this.queue.splice(insertIndex, 0, item);\n          }\n          this.processQueue();\n        }, retryDelay);\n      } else {\n        // Max retries reached, reject the promise\n        console.error(`[RequestQueue] Request ${item.id} failed after ${item.retryCount} retries`, error);\n        this.metrics.failedRequests++;\n        item.reject(error);\n\n        // Process next item\n        this.processQueue();\n      }\n    }\n  }\n\n  /**\n   * Check if we're within rate limits\n   */\n  private checkRateLimit(): boolean {\n    const now = Date.now();\n\n    // Reset counter every second\n    if (now - this.requestCountResetTime > 1000) {\n      this.requestCount = 0;\n      this.requestCountResetTime = now;\n    }\n\n    return this.requestCount < this.config.requestsPerSecond;\n  }\n\n  /**\n   * Get delay until rate limit resets\n   */\n  private getRateLimitDelay(): number {\n    const now = Date.now();\n    const timeSinceReset = now - this.requestCountResetTime;\n    return Math.max(0, 1000 - timeSinceReset);\n  }\n\n  /**\n   * Record a request for rate limiting\n   */\n  private recordRequest() {\n    this.requestCount++;\n  }\n\n  /**\n   * Generate unique ID for request\n   */\n  private generateId(): string {\n    return `req-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\n  }\n\n  /**\n   * Clear the queue\n   */\n  clear() {\n    // Reject all pending items\n    for (const item of this.queue) {\n      item.reject(new Error('Queue cleared'));\n    }\n    this.queue = [];\n\n    console.log('[RequestQueue] Queue cleared');\n  }\n\n  /**\n   * Get queue status\n   */\n  getStatus() {\n    return {\n      queueLength: this.queue.length,\n      activeRequests: this.activeRequests.size,\n      maxConcurrent: this.config.maxConcurrent,\n      maxQueueSize: this.config.maxQueueSize,\n      requestsPerSecond: this.config.requestsPerSecond,\n    };\n  }\n\n  /**\n   * Get queue metrics\n   */\n  getMetrics() {\n    const avgQueueTime =\n      this.metrics.queuedTime.length > 0\n        ? this.metrics.queuedTime.reduce((a, b) => a + b, 0) / this.metrics.queuedTime.length\n        : 0;\n\n    const avgExecutionTime =\n      this.metrics.executionTime.length > 0\n        ? this.metrics.executionTime.reduce((a, b) => a + b, 0) / this.metrics.executionTime.length\n        : 0;\n\n    return {\n      totalRequests: this.metrics.totalRequests,\n      successfulRequests: this.metrics.successfulRequests,\n      failedRequests: this.metrics.failedRequests,\n      retriedRequests: this.metrics.retriedRequests,\n      successRate:\n        this.metrics.totalRequests > 0 ? (this.metrics.successfulRequests / this.metrics.totalRequests) * 100 : 0,\n      avgQueueTime: Math.round(avgQueueTime),\n      avgExecutionTime: Math.round(avgExecutionTime),\n      activeRequests: this.activeRequests.size,\n      pendingRequests: this.queue.length,\n      completedRequests: this.metrics.successfulRequests,\n    };\n  }\n\n  /**\n   * Update configuration\n   */\n  updateConfig(config: Partial<QueueConfig>) {\n    this.config = { ...this.config, ...config };\n    console.log('[RequestQueue] Configuration updated:', this.config);\n  }\n\n  /**\n   * Wait for all active requests to complete\n   */\n  async waitForAll(): Promise<void> {\n    const promises = Array.from(this.activeRequests.values());\n    await Promise.allSettled(promises);\n  }\n}\n\n// Create singleton instances for different request types\nexport const llmRequestQueue = new RequestQueueService({\n  maxConcurrent: 1, // LLM requests are expensive, limit to 1 at a time\n  requestsPerSecond: 5,\n  timeout: 60000, // 60 seconds for LLM\n});\n\nexport const toolRequestQueue = new RequestQueueService({\n  maxConcurrent: 3, // Tools can run in parallel\n  requestsPerSecond: 20,\n  timeout: 30000, // 30 seconds for tools\n});\n\nexport const storageRequestQueue = new RequestQueueService({\n  maxConcurrent: 5, // Storage operations can be more parallel\n  requestsPerSecond: 50,\n  timeout: 10000, // 10 seconds for storage\n});\n\n// Export default instance for general use\nexport default new RequestQueueService();\n","/**\n * Token counting service using tiktoken for accurate OpenAI model token estimation\n * Provides precise token counting for context window management and cost estimation\n */\n\nimport { Tiktoken, encodingForModel, TiktokenModel } from 'js-tiktoken';\nimport { llm } from '@grafana/llm';\n\n// Type definition for chat messages\ninterface ChatMessage {\n  role: 'system' | 'user' | 'assistant' | 'function';\n  content: string;\n  name?: string;\n}\n\n// Cache for tokenizer instances to avoid re-creating them\nconst tokenizerCache = new Map<string, Tiktoken>();\n\n/**\n * Get or create a tokenizer for the specified model\n * Caches tokenizers to improve performance\n */\nfunction getTokenizer(model = 'gpt-4'): Tiktoken {\n  if (tokenizerCache.has(model)) {\n    return tokenizerCache.get(model)!;\n  }\n\n  try {\n    // Try to get the encoding for the specific model\n    const tokenizer = encodingForModel(model as TiktokenModel);\n    tokenizerCache.set(model, tokenizer);\n    return tokenizer;\n  } catch (error) {\n    console.warn(`[Tokenizer] Model ${model} not recognized, falling back to gpt-4 encoding`);\n    // Fallback to GPT-4 encoding if model is not recognized\n    const tokenizer = encodingForModel('gpt-4');\n    tokenizerCache.set(model, tokenizer);\n    return tokenizer;\n  }\n}\n\nexport class TokenizerService {\n  private static tokenizer: Tiktoken | null = null;\n\n  /**\n   * Initialize the tokenizer with a specific model\n   * @param model The model name (e.g., 'gpt-4', 'gpt-3.5-turbo')\n   */\n  static initialize(model = 'gpt-4') {\n    console.log(`[TokenizerService] Initializing with model: ${model}`);\n    this.tokenizer = getTokenizer(model);\n  }\n\n  /**\n   * Count tokens in a text string\n   * @param text The text to count tokens for\n   * @returns The number of tokens\n   */\n  static countTokens(text: string): number {\n    if (!this.tokenizer) {\n      this.initialize();\n    }\n\n    if (!text) {\n      return 0;\n    }\n\n    try {\n      const tokens = this.tokenizer!.encode(text);\n      return tokens.length;\n    } catch (error) {\n      console.error('[TokenizerService] Error counting tokens:', error);\n      // Fallback to character-based estimation if tokenization fails\n      return Math.ceil(text.length / 4);\n    }\n  }\n\n  /**\n   * Count tokens in a message object\n   * Accounts for role, content, and tool calls\n   * @param message The message object\n   * @returns The number of tokens\n   */\n  static countMessageTokens(message: llm.Message): number {\n    if (!this.tokenizer) {\n      this.initialize();\n    }\n\n    let tokens = 0;\n\n    // Every message follows <|start|>{role}\\n{content}<|end|>\\n\n    // This adds approximately 4 tokens per message\n    tokens += 4;\n\n    // Count role tokens\n    if (message.role) {\n      tokens += this.countTokens(message.role);\n    }\n\n    // Count content tokens\n    if (typeof message.content === 'string') {\n      tokens += this.countTokens(message.content);\n    } else if (message.content && Array.isArray(message.content)) {\n      // Handle array content (multimodal messages)\n      for (const part of message.content as any[]) {\n        if (typeof part === 'string') {\n          tokens += this.countTokens(part);\n        } else if (part && typeof part === 'object') {\n          if ('text' in part && part.text) {\n            tokens += this.countTokens(part.text as string);\n          }\n          // Images and other non-text content have fixed token costs\n          if ('image' in part) {\n            // Base64 images typically use ~85 tokens per 512x512 tile\n            tokens += 85; // Conservative estimate\n          }\n        }\n      }\n    }\n\n    // Count tool call tokens\n    if (message.tool_calls) {\n      for (const toolCall of message.tool_calls) {\n        // Tool call structure adds overhead\n        tokens += 3; // For the tool call wrapper\n\n        if ('function' in toolCall && toolCall.function) {\n          tokens += this.countTokens(toolCall.function.name || '');\n          tokens += this.countTokens(toolCall.function.arguments || '');\n        } else {\n          // Stringify the tool call for counting\n          tokens += this.countTokens(JSON.stringify(toolCall));\n        }\n      }\n    }\n\n    // Count tool response tokens\n    if (message.role === 'tool' && message.tool_call_id) {\n      tokens += this.countTokens(message.tool_call_id);\n    }\n\n    return tokens;\n  }\n\n  /**\n   * Count tokens for an array of messages\n   * @param messages Array of messages\n   * @returns Total number of tokens\n   */\n  static countMessagesTokens(messages: llm.Message[]): number {\n    if (!messages || messages.length === 0) {\n      return 0;\n    }\n\n    let totalTokens = 0;\n    for (const message of messages) {\n      totalTokens += this.countMessageTokens(message);\n    }\n\n    // Add tokens for message array wrapper\n    totalTokens += 3;\n\n    return totalTokens;\n  }\n\n  /**\n   * Count tokens for tool definitions\n   * @param tools Array of tool definitions\n   * @returns Total number of tokens\n   */\n  static countToolTokens(tools: any[]): number {\n    if (!tools || tools.length === 0) {\n      return 0;\n    }\n\n    // Tools are typically sent as JSON, so we stringify them\n    const toolsJson = JSON.stringify(tools);\n    return this.countTokens(toolsJson);\n  }\n\n  /**\n   * Calculate total context tokens including messages and tools\n   * @param messages Array of messages\n   * @param tools Array of tool definitions\n   * @returns Object with detailed token counts\n   */\n  static calculateContextTokens(\n    messages: llm.Message[],\n    tools: any[] = []\n  ): {\n    messageTokens: number;\n    toolTokens: number;\n    totalTokens: number;\n    breakdown: {\n      system: number;\n      user: number;\n      assistant: number;\n      tool: number;\n    };\n  } {\n    const messageTokens = this.countMessagesTokens(messages);\n    const toolTokens = this.countToolTokens(tools);\n\n    // Calculate breakdown by role\n    const breakdown = {\n      system: 0,\n      user: 0,\n      assistant: 0,\n      tool: 0,\n    };\n\n    for (const message of messages) {\n      const tokens = this.countMessageTokens(message);\n      switch (message.role) {\n        case 'system':\n          breakdown.system += tokens;\n          break;\n        case 'user':\n          breakdown.user += tokens;\n          break;\n        case 'assistant':\n          breakdown.assistant += tokens;\n          break;\n        case 'tool':\n          breakdown.tool += tokens;\n          break;\n      }\n    }\n\n    return {\n      messageTokens,\n      toolTokens,\n      totalTokens: messageTokens + toolTokens,\n      breakdown,\n    };\n  }\n\n  /**\n   * Truncate text to fit within a token limit\n   * @param text The text to truncate\n   * @param maxTokens Maximum number of tokens\n   * @param addEllipsis Whether to add ellipsis at the end\n   * @returns Truncated text\n   */\n  static truncateToTokenLimit(text: string, maxTokens: number, addEllipsis = true): string {\n    if (!this.tokenizer) {\n      this.initialize();\n    }\n\n    if (!text) {\n      return '';\n    }\n\n    try {\n      const tokens = this.tokenizer!.encode(text);\n\n      if (tokens.length <= maxTokens) {\n        return text;\n      }\n\n      // Reserve tokens for ellipsis if needed\n      const targetTokens = addEllipsis ? maxTokens - 5 : maxTokens;\n\n      // Truncate tokens\n      const truncatedTokens = tokens.slice(0, targetTokens);\n\n      // Decode back to text\n      let truncatedText = this.tokenizer!.decode(truncatedTokens);\n\n      // Add ellipsis if requested\n      if (addEllipsis) {\n        truncatedText += '\\n\\n[... content truncated ...]';\n      }\n\n      return truncatedText;\n    } catch (error) {\n      console.error('[TokenizerService] Error truncating text:', error);\n      // Fallback to character-based truncation\n      const estimatedChars = maxTokens * 4;\n      if (text.length <= estimatedChars) {\n        return text;\n      }\n\n      const truncated = text.slice(0, estimatedChars - (addEllipsis ? 30 : 0));\n      return addEllipsis ? truncated + '\\n\\n[... content truncated ...]' : truncated;\n    }\n  }\n\n  /**\n   * Estimate the cost of tokens based on model pricing\n   * @param tokens Number of tokens\n   * @param model Model name\n   * @param isOutput Whether these are output tokens (more expensive)\n   * @returns Estimated cost in USD\n   */\n  static estimateCost(tokens: number, model = 'gpt-4', isOutput = false): number {\n    // Pricing as of 2024 (per 1K tokens)\n    const pricing: Record<string, { input: number; output: number }> = {\n      'gpt-4': { input: 0.03, output: 0.06 },\n      'gpt-4-turbo': { input: 0.01, output: 0.03 },\n      'gpt-3.5-turbo': { input: 0.0005, output: 0.0015 },\n      'claude-3-opus': { input: 0.015, output: 0.075 },\n      'claude-3-sonnet': { input: 0.003, output: 0.015 },\n      'claude-3-haiku': { input: 0.00025, output: 0.00125 },\n    };\n\n    const modelPricing = pricing[model] || pricing['gpt-4'];\n    const rate = isOutput ? modelPricing.output : modelPricing.input;\n\n    return (tokens / 1000) * rate;\n  }\n\n  /**\n   * Get token limit for a specific model\n   * @param model Model name\n   * @returns Maximum context window size in tokens\n   */\n  static getModelTokenLimit(model = 'gpt-4'): number {\n    const limits: Record<string, number> = {\n      'gpt-4': 8192,\n      'gpt-4-32k': 32768,\n      'gpt-4-turbo': 128000,\n      'gpt-3.5-turbo': 16385,\n      'gpt-3.5-turbo-16k': 16385,\n      'claude-3-opus': 200000,\n      'claude-3-sonnet': 200000,\n      'claude-3-haiku': 200000,\n    };\n\n    return limits[model] || 8192;\n  }\n\n  /**\n   * Validate if text is within token limit\n   */\n  static validateTokenLimit(text: string, limit: number): void {\n    const tokens = this.countTokens(text);\n    if (tokens > limit) {\n      throw new Error(`Text exceeds token limit: ${tokens} tokens (limit: ${limit})`);\n    }\n  }\n\n  /**\n   * Estimate tokens (fallback method)\n   */\n  static estimateTokens(text: string): number {\n    // Simple estimation: ~4 characters per token on average\n    return Math.ceil(text.length / 4);\n  }\n\n  /**\n   * Get token budget for messages\n   */\n  static getTokenBudget(\n    messages: ChatMessage[],\n    model = 'gpt-3.5-turbo'\n  ): {\n    used: number;\n    remaining: number;\n    limit: number;\n    percentage: number;\n  } {\n    const limit = this.getModelTokenLimit(model);\n    const used = this.countMessagesTokens(messages);\n    const remaining = Math.max(0, limit - used);\n    const percentage = (used / limit) * 100;\n\n    return { used, remaining, limit, percentage };\n  }\n\n  /**\n   * Split text into chunks with overlap\n   */\n  static splitTextIntoChunks(\n    text: string,\n    maxTokensPerChunk: number,\n    overlapTokens = 0\n  ): Array<{ text: string; startIndex: number; endIndex: number }> {\n    if (!text) {\n      return [];\n    }\n\n    const chunks: Array<{ text: string; startIndex: number; endIndex: number }> = [];\n    const words = text.split(/\\s+/);\n    let currentChunk = '';\n    let startIndex = 0;\n\n    for (let i = 0; i < words.length; i++) {\n      const testChunk = currentChunk ? `${currentChunk} ${words[i]}` : words[i];\n      const tokenCount = this.countTokens(testChunk);\n\n      if (tokenCount > maxTokensPerChunk) {\n        if (currentChunk) {\n          chunks.push({\n            text: currentChunk,\n            startIndex,\n            endIndex: text.indexOf(currentChunk, startIndex) + currentChunk.length,\n          });\n\n          // Calculate overlap\n          if (overlapTokens > 0 && chunks.length > 0) {\n            const overlapWords = Math.ceil(overlapTokens * 0.75);\n            i = Math.max(0, i - overlapWords);\n          }\n\n          startIndex = text.indexOf(words[i], startIndex + currentChunk.length);\n          currentChunk = words[i];\n        }\n      } else {\n        currentChunk = testChunk;\n      }\n    }\n\n    if (currentChunk) {\n      chunks.push({\n        text: currentChunk,\n        startIndex,\n        endIndex: text.length,\n      });\n    }\n\n    return chunks;\n  }\n\n  /**\n   * Calculate cost for token usage\n   */\n  static getCost(\n    inputTokens: number,\n    outputTokens: number,\n    model = 'gpt-3.5-turbo'\n  ): {\n    inputCost: number;\n    outputCost: number;\n    totalCost: number;\n  } {\n    // Use existing pricing\n    const inputCost = this.estimateCost(inputTokens, model, false);\n    const outputCost = this.estimateCost(outputTokens, model, true);\n\n    return {\n      inputCost,\n      outputCost,\n      totalCost: inputCost + outputCost,\n    };\n  }\n\n  /**\n   * Optimize prompt to fit within token limit\n   */\n  static optimizePrompt(\n    parts: { context?: string; instruction: string; userInput: string },\n    maxTokens: number\n  ): string {\n    // Prioritize: userInput > instruction > context\n    const userTokens = this.countTokens(parts.userInput);\n    const instructionTokens = this.countTokens(parts.instruction);\n\n    let remainingTokens = maxTokens;\n    let result = '';\n\n    // Always include user input\n    result = parts.userInput;\n    remainingTokens -= userTokens;\n\n    // Include instruction if space allows\n    if (remainingTokens >= instructionTokens) {\n      result = `${parts.instruction}\\n\\n${result}`;\n      remainingTokens -= instructionTokens;\n    }\n\n    // Include as much context as possible\n    if (parts.context && remainingTokens > 0) {\n      const truncatedContext = this.truncateToTokenLimit(parts.context, remainingTokens - 10);\n      result = `${truncatedContext}\\n\\n${result}`;\n    }\n\n    return result;\n  }\n\n  /**\n   * Clean up resources\n   */\n  static cleanup() {\n    if (this.tokenizer) {\n      // Tiktoken doesn't have a free method, but we can clear our reference\n      this.tokenizer = null;\n    }\n    tokenizerCache.clear();\n  }\n}\n\n// Auto-initialize with default model\nTokenizerService.initialize();\n\n// Export convenience functions\nexport const countTokens = TokenizerService.countTokens.bind(TokenizerService);\nexport const countMessageTokens = TokenizerService.countMessageTokens.bind(TokenizerService);\nexport const countMessagesTokens = TokenizerService.countMessagesTokens.bind(TokenizerService);\nexport const countToolTokens = TokenizerService.countToolTokens.bind(TokenizerService);\nexport const calculateContextTokens = TokenizerService.calculateContextTokens.bind(TokenizerService);\nexport const truncateToTokenLimit = TokenizerService.truncateToTokenLimit.bind(TokenizerService);\nexport const estimateCost = TokenizerService.estimateCost.bind(TokenizerService);\nexport const getModelTokenLimit = TokenizerService.getModelTokenLimit.bind(TokenizerService);\n","import { GrafanaPageRef } from '../types';\n\n/**\n * Regex pattern to match dashboard URLs: /d/{uid} with optional slug and query params\n * Supports both relative paths and full URLs (http/https)\n *\n * Examples:\n * - /d/abc123\n * - /d/abc123/my-dashboard\n * - /d/abc123?orgId=1&from=now-1h\n * - http://localhost:3000/d/abc123\n * - https://grafana.example.com/d/abc123/slug?from=now-6h\n */\nconst DASHBOARD_PATTERN = /(?:https?:\\/\\/[^\\s/]+)?\\/d\\/([a-zA-Z0-9_-]+)(?:\\/[^\\s?#)\"\\]`]*)?(?:\\?[^\\s)\"\\]`]*)?/g;\n\n/**\n * Regex pattern to match explore URLs: /explore with optional query params\n * Supports both relative paths and full URLs (http/https)\n * Uses lookahead to ensure /explore is a complete path segment (not /explorer, /explore-beta, etc.)\n *\n * Examples:\n * - /explore\n * - /explore?orgId=1\n * - /explore?orgId=1&left=[\"now-1h\",\"now\"]\n * - /explore?panes={\"abc\":{\"datasource\":\"...\"}}\n * - https://grafana.example.com/explore?orgId=1\n */\nconst EXPLORE_PATTERN = /(?:https?:\\/\\/[^\\s/]+)?\\/explore(?=\\?|[)\\]`\"\\s.,;:!?]|$)(?:\\?[^\\s)\"\\]`]*)?/g;\n\n/**\n * Regex pattern to match markdown links with Grafana dashboard or explore URLs\n * Captures: [link text](url)\n * For explore links, requires /explore to be a complete path segment (not /explorer, etc.)\n *\n * Examples:\n * - [My Dashboard](/d/abc123)\n * - [Explore Metrics](/explore?orgId=1)\n * - [Dashboard](https://grafana.com/d/abc123)\n */\nconst MARKDOWN_LINK_PATTERN = /\\[([^\\]]+)\\]\\(((?:https?:\\/\\/[^\\s/]+)?\\/(?:d\\/[^)]+|explore(?:\\?[^)]*)?))\\)/g;\n\n/**\n * Extract the dashboard UID from a dashboard URL\n */\nfunction extractDashboardUid(url: string): string | undefined {\n  const match = url.match(/\\/d\\/([a-zA-Z0-9_-]+)/);\n  return match ? match[1] : undefined;\n}\n\n/**\n * Pattern to check if URL contains /explore as a complete path segment\n * Matches /explore followed by end-of-string, query params (?), or path separator (/)\n */\nconst EXPLORE_PATH_CHECK = /\\/explore(?:\\?|\\/|$)/;\n\n/**\n * Determine if a URL is a dashboard or explore link\n */\nfunction getPageType(url: string): 'dashboard' | 'explore' | null {\n  if (url.includes('/d/')) {\n    return 'dashboard';\n  }\n  if (EXPLORE_PATH_CHECK.test(url)) {\n    return 'explore';\n  }\n  return null;\n}\n\n/**\n * Normalize a URL by trimming trailing punctuation that might have been captured\n */\nfunction normalizeUrl(url: string): string {\n  return url.replace(/[.,;:!?`]+$/, '').trim();\n}\n\n/**\n * Extract a deduplication key from a URL (path portion starting from /d/ or /explore)\n * This ensures relative and absolute URLs pointing to the same resource are treated as duplicates\n * For /explore, ensures it's a complete path segment (not /explorer, /explore-beta, etc.)\n */\nfunction getDedupeKey(url: string): string {\n  const dashboardMatch = url.match(/\\/d\\/[^\\s]*/);\n  if (dashboardMatch) {\n    return dashboardMatch[0];\n  }\n  // Match /explore only when followed by ?, /, or end of string (complete path segment)\n  const exploreMatch = url.match(/\\/explore(?:\\?[^\\s]*|\\/[^\\s]*)?$/);\n  if (exploreMatch) {\n    return exploreMatch[0];\n  }\n  return url;\n}\n\ninterface ParsedLink {\n  url: string;\n  title?: string;\n  type: 'dashboard' | 'explore';\n  uid?: string;\n}\n\n/**\n * Parse content for Grafana page references (dashboards and explore pages)\n *\n * This function extracts:\n * 1. Markdown links: [Link Text](/d/abc123)\n * 2. Raw dashboard URLs: /d/abc123 or https://grafana.com/d/abc123\n * 3. Raw explore URLs: /explore or https://grafana.com/explore?orgId=1\n *\n * Returns an array of deduplicated GrafanaPageRef objects with metadata.\n */\nexport function parseGrafanaLinks(content: string): GrafanaPageRef[] {\n  if (!content) {\n    return [];\n  }\n\n  const links: ParsedLink[] = [];\n  const seenUrls = new Set<string>();\n\n  // First, extract markdown links (these include titles)\n  const markdownMatches = Array.from(content.matchAll(MARKDOWN_LINK_PATTERN));\n  for (const match of markdownMatches) {\n    const title = match[1];\n    const rawUrl = normalizeUrl(match[2]);\n    const type = getPageType(rawUrl);\n    const dedupeKey = getDedupeKey(rawUrl);\n\n    if (type && !seenUrls.has(dedupeKey)) {\n      seenUrls.add(dedupeKey);\n      links.push({\n        url: rawUrl,\n        title,\n        type,\n        uid: type === 'dashboard' ? extractDashboardUid(rawUrl) : undefined,\n      });\n    }\n  }\n\n  // Then extract raw dashboard URLs\n  const dashboardMatches = Array.from(content.matchAll(DASHBOARD_PATTERN));\n  for (const match of dashboardMatches) {\n    const rawUrl = normalizeUrl(match[0]);\n    const dedupeKey = getDedupeKey(rawUrl);\n    if (!seenUrls.has(dedupeKey)) {\n      seenUrls.add(dedupeKey);\n      links.push({\n        url: rawUrl,\n        type: 'dashboard',\n        uid: extractDashboardUid(rawUrl),\n      });\n    }\n  }\n\n  // Finally extract raw explore URLs\n  const exploreMatches = Array.from(content.matchAll(EXPLORE_PATTERN));\n  for (const match of exploreMatches) {\n    const rawUrl = normalizeUrl(match[0]);\n    const dedupeKey = getDedupeKey(rawUrl);\n    if (!seenUrls.has(dedupeKey)) {\n      seenUrls.add(dedupeKey);\n      links.push({\n        url: rawUrl,\n        type: 'explore',\n      });\n    }\n  }\n\n  return links;\n}\n\n/**\n * Quick check if content contains any Grafana links (dashboard or explore)\n */\nexport function hasGrafanaLinks(content: string): boolean {\n  if (!content) {\n    return false;\n  }\n\n  // Reset lastIndex since these are global regexes\n  DASHBOARD_PATTERN.lastIndex = 0;\n  EXPLORE_PATTERN.lastIndex = 0;\n\n  return DASHBOARD_PATTERN.test(content) || EXPLORE_PATTERN.test(content);\n}\n","import { useRef, useEffect, useCallback } from 'react';\nimport { llm } from '@grafana/llm';\nimport { ChatMessage } from '../types';\nimport {\n  MAX_TOTAL_TOKENS,\n  SYSTEM_MESSAGE_BUFFER,\n  MAX_TOOL_RESPONSE_TOKENS,\n  AGGRESSIVE_TOOL_RESPONSE_TOKENS,\n  LLM_API_TIMEOUT_MS,\n} from '../../../constants';\nimport { TokenizerService, truncateToTokenLimit } from '../../../services/tokenizer';\nimport { llmRequestQueue } from '../../../services/queue';\nimport { parseGrafanaLinks } from '../utils/grafanaLinkParser';\nimport type { AppPluginSettings } from '../../../types/plugin';\n\n// Simulate streaming by updating content incrementally\nconst SIMULATE_STREAMING = true;\nconst CHARS_PER_UPDATE = 50;\nconst UPDATE_INTERVAL_MS = 30;\n\n// Trim tool response content if it's too large\nconst trimToolResponseContent = (\n  content: string,\n  maxTokens: number = MAX_TOOL_RESPONSE_TOKENS\n): { content: string; wasTrimmed: boolean } => {\n  const actualTokens = TokenizerService.countTokens(content);\n  if (actualTokens <= maxTokens) {\n    return { content, wasTrimmed: false };\n  }\n\n  // Use the tokenizer to truncate precisely to the token limit\n  const trimmedContent = truncateToTokenLimit(content, maxTokens, true);\n  return { content: trimmedContent, wasTrimmed: true };\n};\n\n// Create a trimmed version of a message, handling tool responses specially\nconst trimMessageContent = (\n  message: llm.Message,\n  aggressive = false\n): { message: llm.Message; wasTrimmed: boolean } => {\n  if (message.role === 'tool' && typeof message.content === 'string') {\n    const maxTokens = aggressive ? AGGRESSIVE_TOOL_RESPONSE_TOKENS : MAX_TOOL_RESPONSE_TOKENS;\n    const { content, wasTrimmed } = trimToolResponseContent(message.content, maxTokens);\n    return {\n      message: { ...message, content },\n      wasTrimmed,\n    };\n  }\n\n  return { message, wasTrimmed: false };\n};\n\n// Trim messages to stay within token limit while preserving system message and recent context\nconst trimMessagesToTokenLimit = (messages: llm.Message[], tools: any[], maxTokens: number): llm.Message[] => {\n  const formattedTools = tools;\n  let contextInfo = TokenizerService.calculateContextTokens(messages, formattedTools);\n\n  // If we're already under the limit, return as-is\n  if (contextInfo.totalTokens <= maxTokens) {\n    return messages;\n  }\n\n  console.warn(` Token limit exceeded: ${contextInfo.totalTokens} > ${maxTokens}. Trimming messages...`);\n  console.log(` Token breakdown:`, contextInfo.breakdown);\n\n  // First pass: Trim large tool responses in place\n  let messagesWithTrimmedTools = messages.map((msg) => {\n    const { message, wasTrimmed } = trimMessageContent(msg);\n    if (wasTrimmed) {\n      console.log(` Trimmed large tool response in message`);\n    }\n    return message;\n  });\n\n  // Recalculate tokens after tool response trimming\n  contextInfo = TokenizerService.calculateContextTokens(messagesWithTrimmedTools, formattedTools);\n\n  // If still over limit after tool trimming, try aggressive trimming\n  if (contextInfo.totalTokens > maxTokens) {\n    console.log(\n      ` Still over limit after normal trimming (${contextInfo.totalTokens}). Applying aggressive tool response trimming...`\n    );\n\n    messagesWithTrimmedTools = messages.map((msg) => {\n      const { message, wasTrimmed } = trimMessageContent(msg, true); // aggressive = true\n      if (wasTrimmed) {\n        console.log(` Aggressively trimmed tool response in message`);\n      }\n      return message;\n    });\n\n    contextInfo = TokenizerService.calculateContextTokens(messagesWithTrimmedTools, formattedTools);\n  }\n\n  // If resolved after tool trimming, return early\n  if (contextInfo.totalTokens <= maxTokens) {\n    console.log(` Token limit resolved by trimming tool responses. Final tokens: ${contextInfo.totalTokens}`);\n    return messagesWithTrimmedTools;\n  }\n\n  // Always preserve the system message (first message) if it exists\n  const systemMessage =\n    messagesWithTrimmedTools.length > 0 && messagesWithTrimmedTools[0].role === 'system'\n      ? messagesWithTrimmedTools[0]\n      : null;\n  const nonSystemMessages = systemMessage ? messagesWithTrimmedTools.slice(1) : messagesWithTrimmedTools;\n\n  // Start with system message and work backwards from the most recent messages\n  let trimmedMessages: llm.Message[] = systemMessage ? [systemMessage] : [];\n  let targetTokens = maxTokens - SYSTEM_MESSAGE_BUFFER;\n\n  // Add messages from newest to oldest until we hit the token limit\n  for (let i = nonSystemMessages.length - 1; i >= 0; i--) {\n    const testMessages = [systemMessage, ...nonSystemMessages.slice(i)].filter(Boolean) as llm.Message[];\n    const testContextInfo = TokenizerService.calculateContextTokens(testMessages, formattedTools);\n\n    if (testContextInfo.totalTokens <= targetTokens) {\n      trimmedMessages = testMessages;\n      break;\n    }\n  }\n\n  // If we still can't fit anything, keep only system message and the most recent message\n  if (trimmedMessages.length <= (systemMessage ? 1 : 0) && nonSystemMessages.length > 0) {\n    trimmedMessages = systemMessage\n      ? [systemMessage, nonSystemMessages[nonSystemMessages.length - 1]]\n      : [nonSystemMessages[nonSystemMessages.length - 1]];\n  }\n\n  const finalContextInfo = TokenizerService.calculateContextTokens(trimmedMessages, formattedTools);\n\n  // Log detailed trimming summary with accurate token counts\n  const removedMessages = messages.length - trimmedMessages.length;\n  const toolMessagesRemoved =\n    messages.filter((m) => m.role === 'tool').length - trimmedMessages.filter((m) => m.role === 'tool').length;\n  const userMessagesRemoved =\n    messages.filter((m) => m.role === 'user').length - trimmedMessages.filter((m) => m.role === 'user').length;\n  const assistantMessagesRemoved =\n    messages.filter((m) => m.role === 'assistant').length -\n    trimmedMessages.filter((m) => m.role === 'assistant').length;\n\n  console.log(` Message trimming summary:`, {\n    totalMessages: `${messages.length}  ${trimmedMessages.length} (removed ${removedMessages})`,\n    tokens: `${contextInfo.totalTokens}  ${finalContextInfo.totalTokens}`,\n    accurateBreakdown: finalContextInfo.breakdown,\n    removedByType: {\n      tool: toolMessagesRemoved,\n      user: userMessagesRemoved,\n      assistant: assistantMessagesRemoved,\n    },\n  });\n\n  return trimmedMessages;\n};\n\n// Simulate streaming by gradually revealing content with cancellation support\nconst simulateStreaming = async (\n  content: string,\n  updateCallback: (partialContent: string) => void,\n  abortSignal?: AbortSignal\n): Promise<void> => {\n  if (!SIMULATE_STREAMING || !content) {\n    updateCallback(content);\n    return;\n  }\n\n  let currentIndex = 0;\n  while (currentIndex < content.length) {\n    // Check if we should abort\n    if (abortSignal?.aborted) {\n      console.log('[simulateStreaming] Aborted');\n      throw new DOMException('Streaming aborted', 'AbortError');\n    }\n\n    const nextIndex = Math.min(currentIndex + CHARS_PER_UPDATE, content.length);\n    const partialContent = content.slice(0, nextIndex);\n    updateCallback(partialContent);\n    currentIndex = nextIndex;\n\n    if (currentIndex < content.length) {\n      await new Promise((resolve, reject) => {\n        const timeoutId = setTimeout(resolve, UPDATE_INTERVAL_MS);\n\n        // Clean up timeout if aborted\n        if (abortSignal) {\n          const abortHandler = () => {\n            clearTimeout(timeoutId);\n            reject(new DOMException('Streaming aborted', 'AbortError'));\n          };\n\n          if (abortSignal.aborted) {\n            abortHandler();\n          } else {\n            abortSignal.addEventListener('abort', abortHandler, { once: true });\n          }\n        }\n      });\n    }\n  }\n};\n\n// Wrapper to add timeout to API calls\nconst withTimeout = <T>(promise: Promise<T>, timeoutMs: number, operationName: string): Promise<T> => {\n  return Promise.race([\n    promise,\n    new Promise<T>((_, reject) =>\n      setTimeout(\n        () =>\n          reject(\n            new Error(`${operationName} timed out after ${timeoutMs}ms. The LLM API may be slow or unresponsive.`)\n          ),\n        timeoutMs\n      )\n    ),\n  ]);\n};\n\nexport const useStreamManager = (\n  setChatHistory: React.Dispatch<React.SetStateAction<ChatMessage[]>>,\n  handleToolCalls: (\n    toolCalls: Array<{ function: { name: string; arguments: string }; id: string }>,\n    messages: llm.Message[]\n  ) => Promise<void>,\n  formatToolsForOpenAI: (tools: any[]) => any[],\n  pluginSettings: AppPluginSettings\n) => {\n  // Use refs to store abort controller and cleanup flags\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const isStreamingRef = useRef(false);\n\n  // Clean up on unmount\n  useEffect(() => {\n    return () => {\n      // Abort any ongoing streaming when component unmounts\n      if (abortControllerRef.current) {\n        console.log('[useStreamManager] Cleaning up: aborting streaming');\n        abortControllerRef.current.abort();\n        abortControllerRef.current = null;\n      }\n      isStreamingRef.current = false;\n    };\n  }, []);\n\n  // Get the effective max tokens from plugin settings or use fallback\n  const getEffectiveMaxTokens = useCallback(() => {\n    return pluginSettings.maxTotalTokens || MAX_TOTAL_TOKENS;\n  }, [pluginSettings.maxTotalTokens]);\n\n  const handleStreamingChatWithHistory = useCallback(\n    async (messages: llm.Message[], tools: any[]) => {\n      // Create new abort controller for this streaming session\n      const abortController = new AbortController();\n      abortControllerRef.current = abortController;\n      const formattedTools = formatToolsForOpenAI(tools);\n      const effectiveMaxTokens = getEffectiveMaxTokens();\n\n      // Trim messages to stay within token limit\n      const trimmedMessages = trimMessagesToTokenLimit(messages, formattedTools, effectiveMaxTokens);\n      const contextInfo = TokenizerService.calculateContextTokens(trimmedMessages, formattedTools);\n\n      console.log(' Starting LLM request with context:', {\n        originalMessageCount: messages.length,\n        trimmedMessageCount: trimmedMessages.length,\n        toolCount: formattedTools.length,\n        accurateTokens: {\n          messages: contextInfo.messageTokens,\n          tools: contextInfo.toolTokens,\n          total: contextInfo.totalTokens,\n          breakdown: contextInfo.breakdown,\n        },\n      });\n\n      const requestStartTime = Date.now();\n      console.log('[API] Sending request at', new Date().toISOString());\n\n      try {\n        // Queue the LLM request to prevent overwhelming the API\n        const response = await llmRequestQueue.add(\n          () =>\n            withTimeout(\n              llm.chatCompletions({\n                model: llm.Model.LARGE,\n                messages: trimmedMessages,\n                tools: formattedTools,\n              }),\n              LLM_API_TIMEOUT_MS,\n              'LLM API request'\n            ),\n          {\n            priority: 10, // High priority for user-initiated requests\n            maxRetries: 2,\n          }\n        );\n\n        const elapsed = Date.now() - requestStartTime;\n        console.log(`[API]  Response received after ${elapsed}ms`);\n        console.log('[API] Response structure:', {\n          hasChoices: !!response.choices,\n          choicesLength: response.choices?.length,\n          firstChoice: response.choices?.[0],\n        });\n\n        const firstChoice = response.choices?.[0];\n        if (!firstChoice) {\n          throw new Error('No response from LLM');\n        }\n\n        const message = firstChoice.message;\n        console.log('[API] Message:', {\n          role: message.role,\n          hasContent: !!message.content,\n          contentLength: message.content?.length,\n          hasToolCalls: !!message.tool_calls,\n          toolCallsCount: message.tool_calls?.length || 0,\n        });\n\n        // Handle content response with simulated streaming\n        if (message.content) {\n          console.log('[Content] Simulating streaming for content');\n\n          // Check if we should abort before streaming\n          if (abortController.signal.aborted) {\n            throw new DOMException('Request aborted', 'AbortError');\n          }\n\n          await simulateStreaming(\n            message.content,\n            (partialContent) => {\n              // Only update if not aborted\n              if (!abortController.signal.aborted) {\n                setChatHistory((prev) =>\n                  prev.map((msg, idx) =>\n                    idx === prev.length - 1 && msg.role === 'assistant' ? { ...msg, content: partialContent } : msg\n                  )\n                );\n              }\n            },\n            abortController.signal\n          );\n          console.log('[Content] Finished displaying content');\n\n          const pageRefs = parseGrafanaLinks(message.content);\n          setChatHistory((prev) =>\n            prev.map((msg, idx) => (idx === prev.length - 1 && msg.role === 'assistant' ? { ...msg, pageRefs } : msg))\n          );\n        }\n\n        // Handle tool calls\n        if (message.tool_calls && message.tool_calls.length > 0) {\n          console.log(`[Tool Calls] Processing ${message.tool_calls.length} tool calls`);\n\n          // Check if aborted before processing tool calls\n          if (abortController.signal.aborted) {\n            throw new DOMException('Request aborted', 'AbortError');\n          }\n\n          // Add the assistant message with tool calls to history\n          messages.push(message as any);\n\n          // Filter for function tool calls\n          const functionToolCalls = message.tool_calls.filter((tc: any) => tc.type === 'function');\n          console.log(`[Tool Calls] Filtered to ${functionToolCalls.length} function calls`);\n\n          // Execute tool calls\n          await handleToolCalls(functionToolCalls as any, messages);\n\n          // Make another request with tool results\n          console.log('[Tool Calls] Making follow-up request with tool results');\n          const newTrimmedMessages = trimMessagesToTokenLimit(messages, formattedTools, effectiveMaxTokens);\n          const updatedContextInfo = TokenizerService.calculateContextTokens(newTrimmedMessages, formattedTools);\n\n          console.log(' Continuing after tool calls:', {\n            originalMessageCount: messages.length,\n            trimmedMessageCount: newTrimmedMessages.length,\n            toolCount: formattedTools.length,\n            accurateTokens: {\n              messages: updatedContextInfo.messageTokens,\n              tools: updatedContextInfo.toolTokens,\n              total: updatedContextInfo.totalTokens,\n              breakdown: updatedContextInfo.breakdown,\n            },\n            toolCallsProcessed: functionToolCalls.length,\n          });\n\n          // Recursive call to handle the response after tool execution\n          // Note: This maintains the same abort controller through the recursion\n          await handleStreamingChatWithHistory(messages, tools);\n        }\n\n        console.log('[API] Request completed successfully');\n      } catch (error) {\n        const elapsed = Date.now() - requestStartTime;\n\n        // Handle abort errors gracefully\n        if (error instanceof DOMException && error.name === 'AbortError') {\n          console.log(`[API] Request aborted after ${elapsed}ms`);\n          // Don't rethrow abort errors - they're expected during cleanup\n          return;\n        }\n\n        console.error(`[API] Error after ${elapsed}ms:`, error);\n        throw error;\n      } finally {\n        // Clean up abort controller reference if this is the current one\n        if (abortControllerRef.current === abortController) {\n          abortControllerRef.current = null;\n        }\n        isStreamingRef.current = false;\n      }\n    },\n    [formatToolsForOpenAI, getEffectiveMaxTokens, setChatHistory, handleToolCalls]\n  );\n\n  return { handleStreamingChatWithHistory };\n};\n","import pluginJson from './plugin.json';\n\nexport const PLUGIN_BASE_URL = `/a/${pluginJson.id}`;\n\nexport enum ROUTES {\n  Home = '',\n}\n\n// Token limit configuration for LLM requests\nexport const MAX_TOTAL_TOKENS = 100000;\nexport const SYSTEM_MESSAGE_BUFFER = 1000; // Reserve tokens for system message\nexport const MAX_TOOL_RESPONSE_TOKENS = 8000; // Max tokens per tool response\nexport const AGGRESSIVE_TOOL_RESPONSE_TOKENS = 500; // Aggressive trimming when needed\n\n// API timeout configuration\nexport const LLM_API_TIMEOUT_MS = 120000; // 60 seconds timeout for LLM API calls\n","import { llm } from '@grafana/llm';\nimport { lastValueFrom } from 'rxjs';\nimport { ChatMessage } from '../components/Chat/types';\n\n/**\n * Memory service for conversation summarization and context management\n */\nexport class ConversationMemoryService {\n  /**\n   * Summarize a set of messages to preserve context while reducing tokens\n   */\n  static async summarizeMessages(messages: ChatMessage[]): Promise<string> {\n    if (messages.length === 0) {\n      return '';\n    }\n\n    // Create a summary prompt\n    const conversationText = messages\n      .map((msg) => `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.content}`)\n      .join('\\n\\n');\n\n    const summaryPrompt = `Please provide a concise summary of the following conversation between a user and an AI assistant. Focus on:\n1. Key questions asked by the user\n2. Important information discovered or tools used\n3. Main conclusions or action items\n4. Any ongoing context that should be remembered\n\nConversation:\n${conversationText}\n\nSummary:`;\n\n    try {\n      // Use streaming API and accumulate the result\n      const stream = llm.streamChatCompletions({\n        model: llm.Model.LARGE, // Use available model\n        messages: [{ role: 'user', content: summaryPrompt }],\n      });\n\n      // Accumulate the full response\n      const result = await lastValueFrom(stream.pipe(llm.accumulateContent()));\n\n      return typeof result === 'string' ? result : '';\n    } catch (error) {\n      console.error('Failed to generate summary:', error);\n      return this.fallbackSummarize(messages);\n    }\n  }\n\n  /**\n   * Fallback summarization without LLM (simple extraction)\n   */\n  private static fallbackSummarize(messages: ChatMessage[]): string {\n    const userMessages = messages.filter((msg) => msg.role === 'user');\n    const topics = userMessages.map((msg, idx) => `${idx + 1}. ${msg.content.slice(0, 100)}...`);\n\n    return `Conversation covered ${messages.length} messages about:\\n${topics.join('\\n')}`;\n  }\n\n  /**\n   * Create a memory-aware message history for context\n   * Combines recent messages with older summaries\n   */\n  static createMemoryAwareHistory(\n    allMessages: ChatMessage[],\n    summary?: string,\n    recentMessageCount = 10\n  ): { summary: string | null; recentMessages: ChatMessage[] } {\n    // If we have fewer messages than the threshold, return all\n    if (allMessages.length <= recentMessageCount) {\n      return { summary: null, recentMessages: allMessages };\n    }\n\n    // Split into old (to be summarized) and recent (keep full)\n    const recentMessages = allMessages.slice(-recentMessageCount);\n\n    return {\n      summary: summary || null,\n      recentMessages,\n    };\n  }\n\n  /**\n   * Generate a context summary message to inject into conversation\n   */\n  static createContextSummaryMessage(summary: string): llm.Message {\n    return {\n      role: 'system',\n      content: `[Previous conversation summary: ${summary}]`,\n    };\n  }\n\n  /**\n   * Determine if a conversation should be summarized\n   */\n  static shouldSummarize(messageCount: number, threshold = 20): boolean {\n    return messageCount >= threshold && messageCount % 10 === 0; // Summarize every 10 messages after threshold\n  }\n\n  /**\n   * Extract key information from tool calls for memory\n   */\n  static extractToolCallContext(messages: ChatMessage[]): string[] {\n    const toolContext: string[] = [];\n\n    messages.forEach((msg) => {\n      if (msg.role === 'assistant' && msg.toolCalls && msg.toolCalls.length > 0) {\n        msg.toolCalls.forEach((tc) => {\n          if (!tc.error) {\n            toolContext.push(`Used tool: ${tc.name}`);\n          }\n        });\n      }\n    });\n\n    return toolContext;\n  }\n\n  /**\n   * Create a smart context window that includes:\n   * - System prompt\n   * - Conversation summary (if available)\n   * - Recent messages\n   * - Current user message\n   */\n  static buildContextWindow(\n    systemPrompt: string,\n    allMessages: ChatMessage[],\n    summary?: string,\n    recentMessageCount = 10\n  ): llm.Message[] {\n    const context: llm.Message[] = [];\n\n    // 1. System prompt\n    context.push({ role: 'system', content: systemPrompt });\n\n    // 2. Add summary if available and conversation is long\n    if (summary && allMessages.length > recentMessageCount) {\n      context.push(this.createContextSummaryMessage(summary));\n    }\n\n    // 3. Add recent messages\n    const recentMessages = allMessages.slice(-recentMessageCount);\n    recentMessages.forEach((msg) => {\n      context.push({ role: msg.role, content: msg.content });\n    });\n\n    return context;\n  }\n\n  /**\n   * Estimate if current context will fit in token limit\n   */\n  static estimateContextSize(messages: llm.Message[], tools: any[]): number {\n    let totalTokens = 0;\n\n    messages.forEach((msg) => {\n      const content = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);\n      totalTokens += Math.ceil(content.length / 4); // ~4 chars per token\n    });\n\n    tools.forEach((tool) => {\n      totalTokens += Math.ceil(JSON.stringify(tool).length / 4);\n    });\n\n    return totalTokens;\n  }\n\n  /**\n   * Optimize message history for token efficiency\n   */\n  static optimizeMessageHistory(\n    messages: ChatMessage[],\n    maxTokens = 50000,\n    summary?: string\n  ): { messages: ChatMessage[]; needsSummary: boolean } {\n    const estimatedTokens = messages.reduce((total, msg) => {\n      return total + Math.ceil(msg.content.length / 4);\n    }, 0);\n\n    // If within limit, no optimization needed\n    if (estimatedTokens < maxTokens * 0.7) {\n      // 70% threshold\n      return { messages, needsSummary: false };\n    }\n\n    // If we have a summary, keep fewer old messages\n    const recentCount = summary ? 15 : 25;\n\n    // Check if we need to generate a new summary\n    const needsSummary = !summary && messages.length > 30;\n\n    return {\n      messages: messages.slice(-recentCount),\n      needsSummary,\n    };\n  }\n}\n","/**\n * Reliability service for error handling, retry logic, and state recovery\n */\nexport class ReliabilityService {\n  private static readonly MAX_RETRIES = 3;\n  private static readonly RETRY_DELAYS = [1000, 2000, 4000]; // Exponential backoff in ms\n\n  /**\n   * Retry a promise-based operation with exponential backoff\n   */\n  static async retryWithBackoff<T>(\n    operation: () => Promise<T>,\n    operationName: string,\n    maxRetries: number = this.MAX_RETRIES\n  ): Promise<T> {\n    let lastError: Error | unknown;\n\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\n      try {\n        console.log(`[Reliability] Attempting ${operationName} (attempt ${attempt + 1}/${maxRetries})`);\n        return await operation();\n      } catch (error) {\n        lastError = error;\n        console.error(`[Reliability] ${operationName} failed (attempt ${attempt + 1}/${maxRetries}):`, error);\n\n        // Check if error is retryable\n        if (!this.isRetryableError(error)) {\n          console.log(`[Reliability] Error is not retryable, aborting`);\n          throw error;\n        }\n\n        // If not the last attempt, wait before retrying\n        if (attempt < maxRetries - 1) {\n          const delay = this.RETRY_DELAYS[attempt] || this.RETRY_DELAYS[this.RETRY_DELAYS.length - 1];\n          console.log(`[Reliability] Waiting ${delay}ms before retry...`);\n          await this.sleep(delay);\n        }\n      }\n    }\n\n    console.error(`[Reliability] ${operationName} failed after ${maxRetries} attempts`);\n    throw lastError;\n  }\n\n  /**\n   * Determine if an error should trigger a retry\n   */\n  private static isRetryableError(error: unknown): boolean {\n    if (!error) {\n      return false;\n    }\n\n    // Network errors\n    if (error instanceof TypeError && error.message.includes('fetch')) {\n      return true;\n    }\n\n    // Check error message for common retryable patterns\n    const errorMessage = String(error).toLowerCase();\n\n    const retryablePatterns = [\n      'network',\n      'timeout',\n      'econnrefused',\n      'enotfound',\n      'rate limit',\n      '429',\n      '500',\n      '502',\n      '503',\n      '504',\n      'temporarily unavailable',\n      'too many requests',\n    ];\n\n    return retryablePatterns.some((pattern) => errorMessage.includes(pattern));\n  }\n\n  /**\n   * Sleep utility for retry delays\n   */\n  private static sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Categorize error types for better handling\n   */\n  static categorizeError(error: unknown): {\n    type: 'network' | 'api' | 'tool' | 'validation' | 'storage' | 'unknown';\n    message: string;\n    retryable: boolean;\n  } {\n    const errorStr = String(error).toLowerCase();\n    const errorMessage = error instanceof Error ? error.message : String(error);\n\n    // Network errors\n    if (\n      errorStr.includes('network') ||\n      errorStr.includes('fetch') ||\n      errorStr.includes('econnrefused') ||\n      errorStr.includes('timeout')\n    ) {\n      return {\n        type: 'network',\n        message: 'Network connection error. Please check your connection and try again.',\n        retryable: true,\n      };\n    }\n\n    // API errors (rate limits, server errors)\n    if (\n      errorStr.includes('rate limit') ||\n      errorStr.includes('429') ||\n      errorStr.includes('500') ||\n      errorStr.includes('502') ||\n      errorStr.includes('503')\n    ) {\n      return {\n        type: 'api',\n        message: 'API request failed. The service may be temporarily unavailable.',\n        retryable: true,\n      };\n    }\n\n    // Tool execution errors\n    if (errorStr.includes('tool') || errorStr.includes('function')) {\n      return {\n        type: 'tool',\n        message: `Tool execution failed: ${errorMessage}`,\n        retryable: false,\n      };\n    }\n\n    // Validation errors\n    if (errorStr.includes('validation') || errorStr.includes('invalid')) {\n      return {\n        type: 'validation',\n        message: `Validation error: ${errorMessage}`,\n        retryable: false,\n      };\n    }\n\n    // Storage errors\n    if (errorStr.includes('storage') || errorStr.includes('quota')) {\n      return {\n        type: 'storage',\n        message: 'Storage error. Your browser storage may be full.',\n        retryable: false,\n      };\n    }\n\n    return {\n      type: 'unknown',\n      message: errorMessage,\n      retryable: false,\n    };\n  }\n\n  /**\n   * Create a user-friendly error message\n   */\n  static getUserFriendlyErrorMessage(error: unknown): string {\n    const categorized = this.categorizeError(error);\n\n    switch (categorized.type) {\n      case 'network':\n        return ' Network error: Unable to connect. Please check your internet connection and try again.';\n      case 'api':\n        return ' Service temporarily unavailable: The API is currently experiencing issues. Please try again in a moment.';\n      case 'tool':\n        return ` Tool error: ${categorized.message}`;\n      case 'validation':\n        return ` Validation error: ${categorized.message}`;\n      case 'storage':\n        return ' Storage error: Unable to save data. Your browser storage may be full. Consider clearing old conversations.';\n      default:\n        return ` An error occurred: ${categorized.message}`;\n    }\n  }\n\n  /**\n   * State recovery: Save and restore conversation state\n   */\n  private static readonly RECOVERY_KEY = 'grafana-o11y-chat-recovery';\n\n  static saveRecoveryState(data: { sessionId: string | null; lastMessageIndex: number; wasGenerating: boolean }): void {\n    try {\n      sessionStorage.setItem(this.RECOVERY_KEY, JSON.stringify(data));\n    } catch (error) {\n      console.error('Failed to save recovery state:', error);\n    }\n  }\n\n  static loadRecoveryState(): {\n    sessionId: string | null;\n    lastMessageIndex: number;\n    wasGenerating: boolean;\n  } | null {\n    try {\n      const data = sessionStorage.getItem(this.RECOVERY_KEY);\n      return data ? JSON.parse(data) : null;\n    } catch (error) {\n      console.error('Failed to load recovery state:', error);\n      return null;\n    }\n  }\n\n  static clearRecoveryState(): void {\n    try {\n      sessionStorage.removeItem(this.RECOVERY_KEY);\n    } catch (error) {\n      console.error('Failed to clear recovery state:', error);\n    }\n  }\n\n  /**\n   * Check if a recovery is available\n   */\n  static hasRecoveryState(): boolean {\n    return sessionStorage.getItem(this.RECOVERY_KEY) !== null;\n  }\n\n  /**\n   * Safe operation wrapper that catches and logs errors\n   */\n  static async safeOperation<T>(operation: () => Promise<T>, fallback: T, operationName: string): Promise<T> {\n    try {\n      return await operation();\n    } catch (error) {\n      console.error(`[Reliability] Safe operation \"${operationName}\" failed:`, error);\n      return fallback;\n    }\n  }\n\n  /**\n   * Validate tool call before execution\n   */\n  static validateToolCall(toolCall: { function: { name: string; arguments: string }; id: string }): {\n    valid: boolean;\n    error?: string;\n  } {\n    if (!toolCall.function?.name) {\n      return { valid: false, error: 'Tool name is missing' };\n    }\n\n    try {\n      // Try to parse arguments\n      JSON.parse(toolCall.function.arguments);\n      return { valid: true };\n    } catch (error) {\n      return { valid: false, error: 'Invalid tool arguments JSON' };\n    }\n  }\n\n  /**\n   * Rate limiter for API calls\n   */\n  private static rateLimitMap = new Map<string, { count: number; resetTime: number }>();\n\n  static checkRateLimit(key: string, maxCalls: number, windowMs: number): boolean {\n    const now = Date.now();\n    const record = this.rateLimitMap.get(key);\n\n    if (!record || now > record.resetTime) {\n      // Reset or initialize\n      this.rateLimitMap.set(key, { count: 1, resetTime: now + windowMs });\n      return true;\n    }\n\n    if (record.count >= maxCalls) {\n      return false; // Rate limit exceeded\n    }\n\n    record.count++;\n    return true;\n  }\n\n  /**\n   * Circuit breaker pattern for failing operations\n   */\n  private static circuitBreakers = new Map<\n    string,\n    { failures: number; lastFailure: number; state: 'closed' | 'open' | 'half-open' }\n  >();\n\n  private static readonly CIRCUIT_BREAKER_THRESHOLD = 5;\n  private static readonly CIRCUIT_BREAKER_TIMEOUT = 60000; // 1 minute\n\n  static checkCircuitBreaker(key: string): boolean {\n    const breaker = this.circuitBreakers.get(key);\n    const now = Date.now();\n\n    if (!breaker) {\n      this.circuitBreakers.set(key, { failures: 0, lastFailure: 0, state: 'closed' });\n      return true;\n    }\n\n    // If open, check if timeout has passed\n    if (breaker.state === 'open') {\n      if (now - breaker.lastFailure > this.CIRCUIT_BREAKER_TIMEOUT) {\n        breaker.state = 'half-open';\n        return true;\n      }\n      return false; // Circuit is still open\n    }\n\n    return true; // Closed or half-open\n  }\n\n  static recordCircuitBreakerFailure(key: string): void {\n    const breaker = this.circuitBreakers.get(key);\n    const now = Date.now();\n\n    if (!breaker) {\n      this.circuitBreakers.set(key, { failures: 1, lastFailure: now, state: 'closed' });\n      return;\n    }\n\n    breaker.failures++;\n    breaker.lastFailure = now;\n\n    if (breaker.failures >= this.CIRCUIT_BREAKER_THRESHOLD) {\n      breaker.state = 'open';\n      console.warn(`[Reliability] Circuit breaker opened for ${key} due to repeated failures`);\n    }\n  }\n\n  static recordCircuitBreakerSuccess(key: string): void {\n    const breaker = this.circuitBreakers.get(key);\n    if (breaker) {\n      breaker.failures = 0;\n      breaker.state = 'closed';\n    }\n  }\n}\n","import { useState, useRef, useEffect, useMemo } from 'react';\nimport { llm } from '@grafana/llm';\nimport { config } from '@grafana/runtime';\nimport { ChatMessage, GrafanaPageRef } from '../types';\nimport { useMCPManager } from './useMCPManager';\nimport { useStreamManager } from './useStreamManager';\nimport { useSessionManager } from './useSessionManager';\nimport { SYSTEM_PROMPT } from '../constants';\nimport { ConversationMemoryService } from '../../../services/memory';\nimport { ReliabilityService } from '../../../services/reliability';\nimport { ValidationService } from '../../../services/validation';\nimport { ChatSession } from '../../../core/models/ChatSession';\nimport type { AppPluginSettings } from '../../../types/plugin';\n\n/**\n * Builds the effective system prompt based on the configured mode and custom prompt.\n * - 'default': Uses the built-in SYSTEM_PROMPT\n * - 'replace': Uses only the custom prompt\n * - 'append': Concatenates SYSTEM_PROMPT with the custom prompt\n */\nconst buildEffectiveSystemPrompt = (\n  mode: AppPluginSettings['systemPromptMode'] = 'default',\n  customPrompt = ''\n): string => {\n  switch (mode) {\n    case 'replace':\n      return customPrompt || SYSTEM_PROMPT; // Fallback to default if custom is empty\n    case 'append':\n      if (customPrompt.trim()) {\n        return `${SYSTEM_PROMPT}\\n\\n## Additional Instructions\\n\\n${customPrompt}`;\n      }\n      return SYSTEM_PROMPT;\n    case 'default':\n    default:\n      return SYSTEM_PROMPT;\n  }\n};\n\nexport const useChat = (pluginSettings: AppPluginSettings, initialSession?: ChatSession) => {\n  console.log('[useChat] Hook initialized');\n\n  // Get organization ID from Grafana config\n  const orgId = String(config.bootData.user.orgId || '1');\n\n  // Destructure specific settings to avoid unnecessary re-computations\n  const { systemPromptMode, customSystemPrompt } = pluginSettings;\n\n  // Compute effective system prompt based on plugin settings\n  const effectiveSystemPrompt = useMemo(\n    () => buildEffectiveSystemPrompt(systemPromptMode, customSystemPrompt),\n    [systemPromptMode, customSystemPrompt]\n  );\n\n  const [chatHistory, setChatHistory] = useState<ChatMessage[]>(\n    initialSession ? initialSession.messages : []\n  );\n  const [currentInput, setCurrentInput] = useState('');\n  const [isGenerating, setIsGenerating] = useState(false);\n  const chatContainerRef = useRef<HTMLDivElement>(null);\n  const bottomSpacerRef = useRef<HTMLDivElement>(null);\n  const [isAutoScroll, setIsAutoScroll] = useState(true);\n  const [retryCount, setRetryCount] = useState(0);\n\n  const {\n    toolCalls,\n    toolsLoading,\n    toolsError,\n    toolsData,\n    clearToolCalls,\n    handleToolCalls,\n    getRunningToolCallsCount,\n    formatToolsForOpenAI,\n  } = useMCPManager();\n\n  console.log('[useChat] MCP Manager state:', {\n    toolsLoading,\n    toolsError: !!toolsError,\n    toolCount: toolsData?.tools?.length,\n  });\n\n  const { handleStreamingChatWithHistory } = useStreamManager(\n    setChatHistory,\n    handleToolCalls,\n    formatToolsForOpenAI,\n    pluginSettings\n  );\n\n  // Session management with persistence\n  const sessionManager = useSessionManager(orgId, chatHistory, setChatHistory);\n\n  // Auto-scroll when chat history changes (only if auto-scroll is enabled)\n  useEffect(() => {\n    if (isAutoScroll && bottomSpacerRef.current) {\n      bottomSpacerRef.current.scrollIntoView({ block: 'end', behavior: 'auto' });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [chatHistory]);\n\n  // Handle scroll: pause auto-scroll when user scrolls up; resume when at bottom\n  useEffect(() => {\n    const handleScroll = () => {\n      const threshold = 50; // px tolerance from the bottom\n      const atBottom = window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - threshold;\n      setIsAutoScroll(atBottom);\n    };\n\n    window.addEventListener('scroll', handleScroll, { passive: true });\n    return () => window.removeEventListener('scroll', handleScroll);\n  }, []);\n\n  // Legacy handleScroll kept for compatibility but not used\n  const handleScroll = () => {};\n\n  const sendMessage = async () => {\n    console.log('[useChat] sendMessage called', {\n      hasInput: !!currentInput.trim(),\n      isGenerating,\n    });\n\n    if (!currentInput.trim() || isGenerating) {\n      console.log('[useChat] sendMessage aborted - conditions not met');\n      return;\n    }\n\n    // Force auto-scroll to bottom when sending a message\n    setIsAutoScroll(true);\n\n    // Validate input before processing\n    let validatedInput: string;\n    try {\n      validatedInput = ValidationService.validateChatInput(currentInput);\n      console.log('[useChat] Input validation passed');\n    } catch (error) {\n      console.error('[useChat] Input validation failed:', error);\n      setChatHistory((prev) => [\n        ...prev,\n        {\n          role: 'assistant',\n          content: ` Input validation error: ${error instanceof Error ? error.message : 'Invalid input'}`,\n        },\n      ]);\n      return;\n    }\n\n    // Check circuit breaker before attempting\n    if (!ReliabilityService.checkCircuitBreaker('llm-stream')) {\n      console.log('[useChat] Circuit breaker is open, showing error message');\n      setChatHistory((prev) => [\n        ...prev,\n        {\n          role: 'assistant',\n          content: ' The service is temporarily unavailable due to repeated errors. Please try again in a moment.',\n        },\n      ]);\n      return;\n    }\n\n    const userMessage: ChatMessage = {\n      role: 'user',\n      content: validatedInput,\n    };\n\n    const newChatHistory = [...chatHistory, userMessage];\n    console.log('[useChat] Adding user message to history');\n    setChatHistory(newChatHistory);\n    setCurrentInput('');\n    setIsGenerating(true);\n    clearToolCalls();\n\n    const assistantMessage: ChatMessage = {\n      role: 'assistant',\n      content: '',\n      toolCalls: [],\n    };\n\n    console.log('[useChat] Adding empty assistant message to history');\n    setChatHistory((prev) => [...prev, assistantMessage]);\n\n    // Build context with memory and summarization\n    console.log('[useChat] Building context window');\n    const messages: llm.Message[] = ConversationMemoryService.buildContextWindow(\n      effectiveSystemPrompt,\n      newChatHistory,\n      sessionManager.currentSummary,\n      15 // Keep last 15 messages in full\n    );\n    console.log('[useChat] Context window built, message count:', messages.length);\n\n    // Save recovery state\n    console.log('[useChat] Saving recovery state');\n    ReliabilityService.saveRecoveryState({\n      sessionId: sessionManager.currentSessionId,\n      lastMessageIndex: newChatHistory.length,\n      wasGenerating: true,\n    });\n\n    try {\n      // Call streaming directly - retry logic is complex with RxJS streams\n      // The stream manager handles its own error recovery\n      const tools = toolsData?.tools || [];\n      console.log('[useChat] Calling handleStreamingChatWithHistory with', tools.length, 'tools');\n      await handleStreamingChatWithHistory(messages, tools);\n\n      // Success - record for circuit breaker\n      console.log('[useChat] Streaming completed successfully');\n      ReliabilityService.recordCircuitBreakerSuccess('llm-stream');\n      setRetryCount(0);\n\n      // Clear recovery state on success\n      ReliabilityService.clearRecoveryState();\n    } catch (error) {\n      console.error('[useChat] Error in chat completion:', error);\n\n      // Record failure for circuit breaker\n      ReliabilityService.recordCircuitBreakerFailure('llm-stream');\n\n      // Get user-friendly error message\n      const errorMessage = ReliabilityService.getUserFriendlyErrorMessage(error);\n\n      setChatHistory((prev) =>\n        prev.map((msg, idx) =>\n          idx === prev.length - 1 && msg.role === 'assistant' ? { ...msg, content: errorMessage } : msg\n        )\n      );\n\n      // Track retry count\n      setRetryCount((prev) => prev + 1);\n    } finally {\n      console.log('[useChat] Resetting isGenerating to false');\n      setIsGenerating(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  const clearChat = () => {\n    setChatHistory([]);\n    clearToolCalls();\n    sessionManager.createNewSession();\n  };\n\n  // Update chat history with tool calls\n  const updateToolCallsInChatHistory = (toolCallsMap: Map<string, any>) => {\n    const toolCallsArray = Array.from(toolCallsMap.values());\n    setChatHistory((prev) =>\n      prev.map((msg, idx) =>\n        idx === prev.length - 1 && msg.role === 'assistant' ? { ...msg, toolCalls: toolCallsArray } : msg\n      )\n    );\n  };\n\n  // Watch for tool calls changes and update chat history\n  useEffect(() => {\n    if (toolCalls.size > 0) {\n      updateToolCallsInChatHistory(toolCalls);\n    }\n  }, [toolCalls]);\n\n  // Recovery on mount\n  useEffect(() => {\n    const recovery = ReliabilityService.loadRecoveryState();\n    if (recovery && recovery.wasGenerating) {\n      console.log('[Chat] Recovery state detected, but streaming cannot be resumed. State cleared.');\n      ReliabilityService.clearRecoveryState();\n    }\n  }, []);\n\n  const detectedPageRefs = useMemo((): Array<GrafanaPageRef & { messageIndex: number }> => {\n    for (let i = chatHistory.length - 1; i >= 0; i--) {\n      const msg = chatHistory[i];\n      if (msg.role === 'assistant') {\n        if (msg.pageRefs && msg.pageRefs.length > 0) {\n          return msg.pageRefs.map((ref) => ({ ...ref, messageIndex: i }));\n        }\n        return [];\n      }\n    }\n    return [];\n  }, [chatHistory]);\n\n  return {\n    chatHistory,\n    currentInput,\n    isGenerating,\n    chatContainerRef,\n    toolCalls,\n    toolsLoading,\n    toolsError,\n    toolsData,\n    setCurrentInput,\n    sendMessage,\n    handleKeyPress,\n    clearChat,\n    getRunningToolCallsCount,\n    isAutoScroll,\n    setIsAutoScroll,\n    handleScroll,\n    // Session management\n    sessionManager,\n    retryCount,\n    bottomSpacerRef: bottomSpacerRef as React.RefObject<HTMLDivElement>,\n    detectedPageRefs,\n  };\n};\n","import { useState, useCallback, useEffect, useRef } from 'react';\nimport { useAsync } from 'react-use';\nimport { llm, mcp } from '@grafana/llm';\nimport { CallToolResultSchema } from '@modelcontextprotocol/sdk/types';\nimport { backendMCPClient } from '../../../services/backendMCPClient';\nimport { toolRequestQueue } from '../../../services/queue';\nimport { RenderedToolCall } from '../types';\n\nexport const useMCPManager = () => {\n  const [toolCalls, setToolCalls] = useState<Map<string, RenderedToolCall>>(new Map());\n\n  // Track active tool call promises for cleanup\n  const activeToolCallsRef = useRef<Set<Promise<any>>>(new Set());\n  const isMountedRef = useRef(true);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    const activeToolCalls = activeToolCallsRef.current;\n    return () => {\n      isMountedRef.current = false;\n      // Clear any pending tool calls\n      if (activeToolCalls.size > 0) {\n        console.log('[useMCPManager] Cleaning up:', activeToolCalls.size, 'active tool calls');\n        activeToolCalls.clear();\n      }\n    };\n  }, []);\n\n  const clearToolCalls = useCallback(() => {\n    setToolCalls(new Map());\n  }, []);\n\n  const getAvailableTools = useCallback(async () => {\n    try {\n      // Get all tools from backend MCP proxy\n      const tools = await backendMCPClient.listTools();\n\n      console.log('[useMCPManager] Available tools from backend:', tools.length);\n\n      return { tools };\n    } catch (error) {\n      console.error('Error fetching tools:', error);\n      return { tools: [] };\n    }\n  }, []);\n\n  const handleToolCall = useCallback(\n    async (toolCall: { function: { name: string; arguments: string }; id: string }, messages: llm.Message[]) => {\n      const { function: f, id } = toolCall;\n\n      // Only update state if still mounted\n      if (isMountedRef.current) {\n        setToolCalls((prev) => new Map(prev).set(id, { name: f.name, arguments: f.arguments, running: true }));\n      }\n\n      const args = JSON.parse(f.arguments);\n\n      // Create and track the tool call promise with queuing\n      const toolCallPromise = toolRequestQueue\n        .add(\n          async () => {\n            console.log('[useMCPManager] Calling backend MCP tool:', f.name);\n\n            const response = await backendMCPClient.callTool({ name: f.name, arguments: args });\n            if (!response) {\n              throw new Error('Backend MCP tool call returned null');\n            }\n\n            const toolResult = CallToolResultSchema.parse(response);\n            const textContent = toolResult.content\n              .filter((c: any) => c.type === 'text')\n              .map((c: any) => c.text)\n              .join('');\n\n            // Ensure we always have content - Anthropic API rejects empty tool results\n            const finalContent = textContent.trim() || 'No results returned (empty response)';\n\n            messages.push({ role: 'tool', tool_call_id: id, content: finalContent });\n\n            // Only update state if still mounted\n            if (isMountedRef.current) {\n              setToolCalls((prev) => new Map(prev).set(id, { ...prev.get(id)!, running: false, response }));\n            }\n\n            return response;\n          },\n          {\n            priority: 8, // Tool calls are important but lower priority than main LLM requests\n            maxRetries: 1,\n            id: `tool-${id}`,\n          }\n        )\n        .catch((error: any) => {\n          const errorMessage = error.message ?? error.toString();\n          console.error('Tool call error:', errorMessage);\n\n          messages.push({ role: 'tool', tool_call_id: id, content: errorMessage });\n\n          // Only update state if still mounted\n          if (isMountedRef.current) {\n            setToolCalls((prev) => new Map(prev).set(id, { ...prev.get(id)!, running: false, error: errorMessage }));\n          }\n\n          throw error; // Re-throw for tracking\n        });\n\n      // Track the promise\n      activeToolCallsRef.current.add(toolCallPromise);\n\n      // Remove from tracking when complete\n      toolCallPromise.finally(() => {\n        activeToolCallsRef.current.delete(toolCallPromise);\n      });\n\n      // Wait for the tool call to complete\n      await toolCallPromise;\n    },\n    []\n  );\n\n  const handleToolCalls = useCallback(\n    async (\n      toolCalls: Array<{ function: { name: string; arguments: string }; id: string }>,\n      messages: llm.Message[]\n    ) => {\n      const functionCalls = toolCalls.filter((tc) => tc.function);\n      await Promise.all(functionCalls.map((fc) => handleToolCall(fc, messages)));\n    },\n    [handleToolCall]\n  );\n\n  const getRunningToolCallsCount = useCallback(() => {\n    return Array.from(toolCalls.values()).filter((tc) => tc.running).length;\n  }, [toolCalls]);\n\n  const hasRunningToolCalls = useCallback(() => {\n    return getRunningToolCallsCount() > 0;\n  }, [getRunningToolCallsCount]);\n\n  const formatToolsForOpenAI = (tools: any[]) => {\n    return mcp.convertToolsToOpenAI(tools);\n  };\n\n  const {\n    loading: toolsLoading,\n    error: toolsError,\n    value: toolsData,\n  } = useAsync(getAvailableTools, [getAvailableTools]);\n\n  return {\n    toolCalls,\n    toolsLoading,\n    toolsError,\n    toolsData,\n    clearToolCalls,\n    handleToolCall,\n    handleToolCalls,\n    getRunningToolCallsCount,\n    hasRunningToolCalls,\n    formatToolsForOpenAI,\n    getAvailableTools,\n  };\n};\n","import { useState, useEffect, useCallback, useRef, useMemo } from 'react';\nimport { usePluginUserStorage } from '@grafana/runtime';\nimport { ChatMessage } from '../types';\nimport { SessionMetadata } from '../../../core';\nimport { ServiceFactory } from '../../../core/services/ServiceFactory';\nimport { ConversationMemoryService } from '../../../services/memory';\n\nexport interface UseSessionManagerReturn {\n  // Current session state\n  currentSessionId: string | null;\n  sessions: SessionMetadata[];\n  currentSummary: string | undefined;\n\n  // Session operations\n  createNewSession: () => Promise<void>;\n  loadSession: (sessionId: string) => Promise<void>;\n  deleteSession: (sessionId: string) => Promise<void>;\n  deleteAllSessions: () => Promise<void>;\n  exportSession: (sessionId: string) => Promise<void>;\n  importSession: (jsonData: string) => Promise<boolean>;\n\n  // Auto-save\n  autoSaveMessages: (messages: ChatMessage[]) => void;\n\n  // Summarization\n  triggerSummarization: (messages: ChatMessage[]) => Promise<void>;\n  isSummarizing: boolean;\n\n  // Storage stats\n  storageStats: { used: number; total: number; sessionCount: number };\n}\n\n/**\n * Refactored hook using clean architecture with Service layer\n * Performance optimized with memoization and proper dependency management\n */\nexport const useSessionManager = (\n  orgId: string,\n  chatHistory: ChatMessage[],\n  setChatHistory: React.Dispatch<React.SetStateAction<ChatMessage[]>>\n): UseSessionManagerReturn => {\n  // Get Grafana user storage (automatically falls back to localStorage when user is not signed in)\n  const storage = usePluginUserStorage();\n\n  // Get session service instance (memoized with storage dependency)\n  const sessionService = useMemo(() => ServiceFactory.getSessionService(storage), [storage]);\n\n  // State\n  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);\n  const [sessions, setSessions] = useState<SessionMetadata[]>([]);\n  const [currentSummary, setCurrentSummary] = useState<string | undefined>(undefined);\n  const [isSummarizing, setIsSummarizing] = useState(false);\n  const [storageStats, setStorageStats] = useState({ used: 0, total: 0, sessionCount: 0 });\n\n  // Auto-save debounce timer\n  const autoSaveTimerRef = useRef<NodeJS.Timeout | null>(null);\n\n  /**\n   * Refresh the sessions list\n   */\n  const refreshSessions = useCallback(async () => {\n    try {\n      const loadedSessions = await sessionService.getAllSessions(orgId);\n      setSessions(loadedSessions);\n      const stats = await sessionService.getStorageStats(orgId);\n      setStorageStats(stats);\n    } catch (error) {\n      console.error('[SessionManager] Failed to refresh sessions:', error);\n    }\n  }, [sessionService, orgId]);\n\n  /**\n   * Load sessions index on mount\n   * Skip loading current session if chatHistory already has messages (read-only mode with initialSession)\n   */\n  useEffect(() => {\n    console.log('[SessionManager] Initializing with orgId:', orgId);\n    console.log('[SessionManager] Using Grafana user storage (falls back to localStorage if not signed in)');\n    \n    let cancelled = false;\n    \n    const initialize = async () => {\n      try {\n        const loadedSessions = await sessionService.getAllSessions(orgId);\n        if (!cancelled) {\n          setSessions(loadedSessions);\n        }\n        \n        const stats = await sessionService.getStorageStats(orgId);\n        if (!cancelled) {\n          setStorageStats(stats);\n        }\n        \n        // Only load current session from storage if chatHistory is empty\n        // If chatHistory has messages, we're in read-only mode with an initialSession\n        if (chatHistory.length === 0) {\n          const session = await sessionService.getCurrentSession(orgId);\n          if (!cancelled && session) {\n            setCurrentSessionId(session.id);\n            setChatHistory(session.messages);\n            setCurrentSummary(session.summary);\n            console.log(`[SessionManager] Loaded session: ${session.title} (${session.messages.length} messages)`);\n          }\n        } else {\n          console.log('[SessionManager] Skipping session load - chatHistory already has messages (read-only mode)');\n        }\n      } catch (error) {\n        if (!cancelled) {\n          console.error('[SessionManager] Failed to initialize:', error);\n        }\n      }\n    };\n    \n    initialize();\n    \n    return () => {\n      cancelled = true;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [orgId]); // Only depend on orgId to avoid infinite loops\n\n\n  /**\n   * Create a new session\n   */\n  const createNewSession = useCallback(async () => {\n    setChatHistory([]);\n    setCurrentSessionId(null);\n    setCurrentSummary(undefined);\n    try {\n      await sessionService.clearActiveSession(orgId);\n      console.log('[SessionManager] Created new session');\n    } catch (error) {\n      console.error('[SessionManager] Failed to clear active session:', error);\n    }\n  }, [sessionService, orgId, setChatHistory]);\n\n  /**\n   * Load an existing session\n   */\n  const loadSession = useCallback(\n    async (sessionId: string) => {\n      try {\n        const session = await sessionService.getSession(orgId, sessionId);\n        if (session) {\n          setCurrentSessionId(session.id);\n          setChatHistory(session.messages);\n          setCurrentSummary(session.summary);\n          await sessionService.setActiveSession(orgId, session.id);\n          console.log(`[SessionManager] Loaded session: ${session.title} (${session.messages.length} messages)`);\n        } else {\n          console.error(`[SessionManager] Session ${sessionId} not found`);\n        }\n      } catch (error) {\n        console.error(`[SessionManager] Error loading session:`, error);\n      }\n    },\n    [sessionService, orgId, setChatHistory]\n  );\n\n  /**\n   * Delete a session\n   */\n  const deleteSession = useCallback(\n    async (sessionId: string) => {\n      try {\n        await sessionService.deleteSession(orgId, sessionId);\n        await refreshSessions();\n\n        // If deleting current session, clear it\n        if (sessionId === currentSessionId) {\n          await createNewSession();\n        }\n\n        console.log(`[SessionManager] Deleted session: ${sessionId}`);\n      } catch (error) {\n        console.error('[SessionManager] Error deleting session:', error);\n      }\n    },\n    [sessionService, orgId, currentSessionId, createNewSession, refreshSessions]\n  );\n\n  /**\n   * Delete all sessions\n   */\n  const deleteAllSessions = useCallback(async () => {\n    try {\n      await sessionService.deleteAllSessions(orgId);\n      await refreshSessions();\n      await createNewSession();\n      console.log('[SessionManager] Deleted all sessions');\n    } catch (error) {\n      console.error('[SessionManager] Error deleting all sessions:', error);\n    }\n  }, [sessionService, orgId, createNewSession, refreshSessions]);\n\n  /**\n   * Export a session as JSON\n   */\n  const exportSession = useCallback(\n    async (sessionId: string) => {\n      try {\n        const jsonData = await sessionService.exportSession(orgId, sessionId);\n        if (jsonData) {\n          // Download as file\n          const blob = new Blob([jsonData], { type: 'application/json' });\n          const url = URL.createObjectURL(blob);\n          const a = document.createElement('a');\n          a.href = url;\n          a.download = `chat-session-${sessionId}-${Date.now()}.json`;\n          document.body.appendChild(a);\n          a.click();\n          document.body.removeChild(a);\n          URL.revokeObjectURL(url);\n          console.log(`[SessionManager] Exported session: ${sessionId}`);\n        }\n      } catch (error) {\n        console.error('[SessionManager] Error exporting session:', error);\n      }\n    },\n    [sessionService, orgId]\n  );\n\n  /**\n   * Import a session from JSON\n   */\n  const importSession = useCallback(\n    async (jsonData: string): Promise<boolean> => {\n      try {\n        const session = await sessionService.importSession(orgId, jsonData);\n        await refreshSessions();\n        await loadSession(session.id);\n        console.log(`[SessionManager] Imported session: ${session.title}`);\n        return true;\n      } catch (error) {\n        console.error('[SessionManager] Error importing session:', error);\n        return false;\n      }\n    },\n    [sessionService, orgId, loadSession, refreshSessions]\n  );\n\n  /**\n   * Auto-save messages with debouncing\n   */\n  const autoSaveMessages = useCallback(\n    (messages: ChatMessage[]) => {\n      if (messages.length === 0) {\n        return;\n      }\n\n      // Clear existing timer\n      if (autoSaveTimerRef.current) {\n        clearTimeout(autoSaveTimerRef.current);\n      }\n\n      // Set new timer for debounced save\n      autoSaveTimerRef.current = setTimeout(async () => {\n        try {\n          // Capture currentSessionId at the time the callback executes\n          const sessionIdAtStart = currentSessionId;\n          \n          if (sessionIdAtStart) {\n            await sessionService.updateSession(orgId, sessionIdAtStart, messages, currentSummary);\n            console.log(`[SessionManager] Auto-saved session: ${sessionIdAtStart}`);\n          } else if (messages.length > 0) {\n            const newSession = await sessionService.createSession(orgId, messages);\n            // Only update if currentSessionId is still null (no session was loaded in the meantime)\n            setCurrentSessionId((prevId) => {\n              if (prevId === null) {\n                return newSession.id;\n              }\n              // Session was loaded while creating, don't overwrite it\n              console.log(`[SessionManager] Session ${prevId} was loaded during creation, keeping it instead of ${newSession.id}`);\n              return prevId;\n            });\n            console.log(`[SessionManager] Created and saved new session: ${newSession.id}`);\n          }\n          await refreshSessions();\n        } catch (error) {\n          console.error('[SessionManager] Auto-save failed:', error);\n        }\n      }, 10000);\n    },\n    [sessionService, orgId, currentSessionId, currentSummary, refreshSessions]\n  );\n\n  /**\n   * Trigger summarization for long conversations\n   */\n  const triggerSummarization = useCallback(\n    async (messages: ChatMessage[]) => {\n      if (isSummarizing || messages.length < 20) {\n        return;\n      }\n\n      setIsSummarizing(true);\n      console.log('[SessionManager] Starting conversation summarization...');\n\n      try {\n        const messagesToSummarize = currentSummary ? messages.slice(0, -10) : messages.slice(0, -5);\n\n        if (messagesToSummarize.length > 0) {\n          const summary = await ConversationMemoryService.summarizeMessages(messagesToSummarize);\n          setCurrentSummary(summary);\n\n          // Update session with summary\n          if (currentSessionId) {\n            await sessionService.updateSession(orgId, currentSessionId, messages, summary);\n            console.log('[SessionManager] Summarization complete and saved');\n          }\n        }\n      } catch (error) {\n        console.error('[SessionManager] Summarization failed:', error);\n      } finally {\n        setIsSummarizing(false);\n      }\n    },\n    [sessionService, orgId, currentSessionId, currentSummary, isSummarizing]\n  );\n\n  /**\n   * Auto-save whenever chat history changes\n   */\n  useEffect(() => {\n    if (chatHistory.length > 0) {\n      autoSaveMessages(chatHistory);\n\n      // Check if we should summarize\n      if (ConversationMemoryService.shouldSummarize(chatHistory.length)) {\n        triggerSummarization(chatHistory);\n      }\n    }\n  }, [chatHistory, autoSaveMessages, triggerSummarization]);\n\n  /**\n   * Cleanup on unmount\n   */\n  useEffect(() => {\n    return () => {\n      if (autoSaveTimerRef.current) {\n        clearTimeout(autoSaveTimerRef.current);\n      }\n    };\n  }, []);\n\n  return {\n    currentSessionId,\n    sessions,\n    currentSummary,\n    createNewSession,\n    loadSession,\n    deleteSession,\n    deleteAllSessions,\n    exportSession,\n    importSession,\n    autoSaveMessages,\n    triggerSummarization,\n    isSummarizing,\n    storageStats,\n  };\n};\n","import { useState, useEffect } from 'react';\n\nlet cachedResult: boolean | null = null;\nlet fetchPromise: Promise<boolean> | null = null;\n\n/**\n * Detects if Grafana allows embedding by checking the X-Frame-Options header.\n * Returns null while loading, true if allowed, false if denied.\n */\nexport function useEmbeddingAllowed(): boolean | null {\n  const [allowed, setAllowed] = useState<boolean | null>(cachedResult);\n\n  useEffect(() => {\n    if (cachedResult !== null) {\n      return;\n    }\n\n    let mounted = true;\n\n    if (!fetchPromise) {\n      fetchPromise = fetch(window.location.origin + '/api/health', { method: 'HEAD' })\n        .then((response) => {\n          const xFrameOptions = response.headers.get('X-Frame-Options');\n          cachedResult = !xFrameOptions || xFrameOptions.toLowerCase() !== 'deny';\n          return cachedResult;\n        })\n        .catch(() => {\n          cachedResult = false;\n          return false;\n        });\n    }\n\n    fetchPromise.then((result) => {\n      if (mounted) {\n        setAllowed(result);\n      }\n    });\n\n    return () => {\n      mounted = false;\n    };\n  }, []);\n\n  return allowed;\n}\n","import React from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\ninterface ChatHeaderProps {\n  isGenerating: boolean;\n  currentSessionTitle?: string;\n}\n\nexport const ChatHeader: React.FC<ChatHeaderProps> = ({ isGenerating, currentSessionTitle }) => {\n  const theme = useTheme2();\n\n  return (\n    <div className=\"flex justify-between items-center py-3 mb-2\">\n      <div className=\"flex items-center gap-3\">\n        {/* Session title */}\n        {currentSessionTitle && (\n          <span\n            className=\"text-sm truncate max-w-md font-medium\"\n            style={{ color: theme.colors.text.secondary }}\n            title={currentSessionTitle}\n          >\n            {currentSessionTitle}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n};\n","import React, { useState } from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\ninterface ToolCallDisplayProps {\n  toolCall: {\n    name: string;\n    arguments: string;\n    running: boolean;\n    error?: string;\n    response?: any;\n  };\n}\n\n// Checkmark icon\nconst CheckIcon: React.FC<{ size?: number }> = ({ size = 14 }) => (\n  <svg\n    width={size}\n    height={size}\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    strokeWidth=\"2.5\"\n    strokeLinecap=\"round\"\n    strokeLinejoin=\"round\"\n  >\n    <polyline points=\"20 6 9 17 4 12\" />\n  </svg>\n);\n\n// X icon for errors\nconst XIcon: React.FC<{ size?: number }> = ({ size = 14 }) => (\n  <svg\n    width={size}\n    height={size}\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    strokeWidth=\"2.5\"\n    strokeLinecap=\"round\"\n    strokeLinejoin=\"round\"\n  >\n    <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n  </svg>\n);\n\n// Spinner for running\nconst SpinnerIcon: React.FC<{ size?: number }> = ({ size = 14 }) => (\n  <svg\n    width={size}\n    height={size}\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    strokeWidth=\"2\"\n    strokeLinecap=\"round\"\n    strokeLinejoin=\"round\"\n    className=\"animate-spin\"\n  >\n    <path d=\"M21 12a9 9 0 1 1-6.219-8.56\" />\n  </svg>\n);\n\nexport const ToolCallDisplay: React.FC<ToolCallDisplayProps> = ({ toolCall }) => {\n  const theme = useTheme2();\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const formatInlineArguments = (args: string) => {\n    try {\n      const parsed = JSON.parse(args);\n      const keys = Object.keys(parsed);\n      if (keys.length === 0) {\n        return '';\n      }\n      if (keys.length === 1) {\n        const value = JSON.stringify(parsed[keys[0]]);\n        return value.length > 40 ? `${keys[0]}: ${value.substring(0, 40)}...` : `${keys[0]}: ${value}`;\n      }\n      return `${keys.length} params`;\n    } catch {\n      return args.length > 40 ? args.substring(0, 40) + '...' : args;\n    }\n  };\n\n  const formatFullArguments = (args: string) => {\n    try {\n      const parsed = JSON.parse(args);\n      return JSON.stringify(parsed, null, 2);\n    } catch {\n      return args;\n    }\n  };\n\n  const getStatusConfig = (running: boolean, error?: string) => {\n    if (error) {\n      return {\n        icon: <XIcon size={12} />,\n        color: '#ef4444',\n      };\n    }\n    if (running) {\n      return {\n        icon: <SpinnerIcon size={12} />,\n        color: '#fbbf24',\n      };\n    }\n    return {\n      icon: <CheckIcon size={12} />,\n      color: '#22c55e',\n    };\n  };\n\n  const status = getStatusConfig(toolCall.running, toolCall.error);\n  const inlineArgs = formatInlineArguments(toolCall.arguments);\n  const hasArgs = toolCall.arguments && toolCall.arguments !== '{}';\n  const canExpand = hasArgs && toolCall.arguments.length > 50;\n\n  return (\n    <div\n      className=\"group rounded-lg transition-all duration-200\"\n      style={{\n        backgroundColor: theme.isDark ? 'rgba(255, 255, 255, 0.02)' : 'rgba(0, 0, 0, 0.01)',\n        border: `1px solid ${theme.isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)'}`,\n      }}\n    >\n      {/* Main row */}\n      <div\n        className={`flex items-center gap-3 px-3 py-2.5 ${canExpand ? 'cursor-pointer' : ''}`}\n        onClick={canExpand ? () => setIsExpanded(!isExpanded) : undefined}\n      >\n        {/* Status icon */}\n        <div className=\"flex-shrink-0 w-5 h-5 rounded flex items-center justify-center\" style={{ color: status.color }}>\n          {status.icon}\n        </div>\n\n        {/* Tool name and args */}\n        <div className=\"flex-1 min-w-0 flex items-center gap-2\">\n          <span\n            className=\"font-mono text-xs font-medium truncate\"\n            style={{ color: theme.colors.text.primary }}\n            title={toolCall.name}\n          >\n            {toolCall.name}\n          </span>\n          {hasArgs && (\n            <span className=\"font-mono text-xs truncate\" style={{ color: theme.colors.text.secondary }}>\n              {inlineArgs}\n            </span>\n          )}\n        </div>\n\n        {/* Expand indicator */}\n        {canExpand && (\n          <div\n            className=\"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n            style={{ color: theme.colors.text.secondary }}\n          >\n            <svg\n              width=\"14\"\n              height=\"14\"\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              strokeWidth=\"2\"\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}\n            >\n              <polyline points=\"6 9 12 15 18 9\" />\n            </svg>\n          </div>\n        )}\n      </div>\n\n      {/* Expanded arguments */}\n      {isExpanded && hasArgs && (\n        <div\n          className=\"mx-3 mb-3 p-2.5 rounded-md font-mono text-xs overflow-x-auto\"\n          style={{\n            backgroundColor: theme.isDark ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.03)',\n            color: theme.colors.text.secondary,\n          }}\n        >\n          <pre className=\"whitespace-pre-wrap break-words m-0 leading-relaxed\">\n            {formatFullArguments(toolCall.arguments)}\n          </pre>\n        </div>\n      )}\n\n      {/* Error display */}\n      {toolCall.error && (\n        <div\n          className=\"mx-3 mb-3 p-2.5 rounded-md\"\n          style={{\n            backgroundColor: theme.isDark ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)',\n            border: `1px solid ${theme.isDark ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.15)'}`,\n          }}\n        >\n          <div className=\"flex items-start gap-2\">\n            <span style={{ color: '#ef4444' }}>\n              <XIcon size={12} />\n            </span>\n            <pre\n              className=\"text-xs font-mono whitespace-pre-wrap break-words m-0 flex-1\"\n              style={{ color: theme.colors.text.secondary }}\n            >\n              {toolCall.error}\n            </pre>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","import React, { useState } from 'react';\nimport { useTheme2 } from '@grafana/ui';\nimport { ToolCallDisplay } from './ToolCallDisplay';\n\ninterface ToolCallsSectionProps {\n  toolCalls: Array<{\n    name: string;\n    arguments: string;\n    running: boolean;\n    error?: string;\n    response?: any;\n  }>;\n}\n\n// Tool/Wrench SVG icon\nconst ToolIcon: React.FC<{ size?: number }> = ({ size = 18 }) => (\n  <svg\n    width={size}\n    height={size}\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    strokeWidth=\"2\"\n    strokeLinecap=\"round\"\n    strokeLinejoin=\"round\"\n  >\n    <path d=\"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z\" />\n  </svg>\n);\n\n// Chevron icon\nconst ChevronIcon: React.FC<{ size?: number; isExpanded: boolean }> = ({ size = 16, isExpanded }) => (\n  <svg\n    width={size}\n    height={size}\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    strokeWidth=\"2\"\n    strokeLinecap=\"round\"\n    strokeLinejoin=\"round\"\n    className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}\n  >\n    <polyline points=\"6 9 12 15 18 9\" />\n  </svg>\n);\n\nexport const ToolCallsSection: React.FC<ToolCallsSectionProps> = ({ toolCalls }) => {\n  const theme = useTheme2();\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const runningCount = toolCalls.filter((tc) => tc.running).length;\n  const completedCount = toolCalls.filter((tc) => !tc.running && !tc.error).length;\n  const errorCount = toolCalls.filter((tc) => tc.error).length;\n\n  if (!toolCalls || toolCalls.length === 0) {\n    return null;\n  }\n\n  return (\n    <div\n      className=\"rounded-xl overflow-hidden mb-4 transition-all duration-200\"\n      style={{\n        backgroundColor: theme.isDark ? 'rgba(255, 255, 255, 0.02)' : 'rgba(0, 0, 0, 0.02)',\n        border: `1px solid ${theme.isDark ? 'rgba(255, 255, 255, 0.06)' : theme.colors.border.weak}`,\n      }}\n    >\n      {/* Compact Header */}\n      <button\n        className=\"w-full flex justify-between items-center px-4 py-3 transition-colors duration-200\"\n        style={{\n          backgroundColor: 'transparent',\n        }}\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-3\">\n          {/* Icon */}\n          <div\n            className=\"w-7 h-7 rounded-lg flex items-center justify-center\"\n            style={{\n              backgroundColor: theme.isDark ? 'rgba(139, 92, 246, 0.15)' : 'rgba(139, 92, 246, 0.1)',\n              color: '#a78bfa',\n            }}\n          >\n            <ToolIcon size={14} />\n          </div>\n\n          {/* Title and count */}\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm font-medium\" style={{ color: theme.colors.text.primary }}>\n              Tool Execution\n            </span>\n            <span\n              className=\"px-1.5 py-0.5 rounded text-xs font-medium\"\n              style={{\n                backgroundColor: theme.isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)',\n                color: theme.colors.text.secondary,\n              }}\n            >\n              {toolCalls.length}\n            </span>\n          </div>\n\n          {/* Status pills */}\n          <div className=\"flex items-center gap-1.5\">\n            {runningCount > 0 && (\n              <span\n                className=\"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium\"\n                style={{\n                  backgroundColor: theme.isDark ? 'rgba(251, 191, 36, 0.15)' : 'rgba(251, 191, 36, 0.1)',\n                  color: '#fbbf24',\n                }}\n              >\n                <span className=\"w-1.5 h-1.5 rounded-full bg-current animate-pulse\" />\n                {runningCount}\n              </span>\n            )}\n            {completedCount > 0 && (\n              <span\n                className=\"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium\"\n                style={{\n                  backgroundColor: theme.isDark ? 'rgba(34, 197, 94, 0.15)' : 'rgba(34, 197, 94, 0.1)',\n                  color: '#22c55e',\n                }}\n              >\n                <span></span>\n                {completedCount}\n              </span>\n            )}\n            {errorCount > 0 && (\n              <span\n                className=\"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium\"\n                style={{\n                  backgroundColor: theme.isDark ? 'rgba(239, 68, 68, 0.15)' : 'rgba(239, 68, 68, 0.1)',\n                  color: '#ef4444',\n                }}\n              >\n                <span></span>\n                {errorCount}\n              </span>\n            )}\n          </div>\n        </div>\n\n        {/* Expand/Collapse */}\n        <div style={{ color: theme.colors.text.secondary }}>\n          <ChevronIcon isExpanded={isExpanded} />\n        </div>\n      </button>\n\n      {/* Tool Calls List */}\n      {isExpanded && (\n        <div className=\"px-4 pb-3 pt-1 space-y-2\">\n          {toolCalls.map((toolCall, index) => (\n            <ToolCallDisplay key={index} toolCall={toolCall} />\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n","import React, { useState, useEffect, useCallback } from 'react';\nimport {\n  SceneFlexLayout,\n  SceneFlexItem,\n  PanelBuilders,\n  SceneQueryRunner,\n  SceneTimeRange,\n  EmbeddedScene,\n  SceneRefreshPicker,\n  SceneTimePicker,\n} from '@grafana/scenes';\nimport { useTheme2, IconButton, Tooltip, RadioButtonGroup } from '@grafana/ui';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { VizOrientation, VisibilityMode, AxisPlacement } from '@grafana/schema';\nimport {\n  PieChartType,\n  PieChartLabels,\n} from '@grafana/schema/dist/esm/raw/composable/piechart/panelcfg/x/PieChartPanelCfg_types.gen';\nimport { HeatmapColorMode } from '@grafana/schema/dist/esm/raw/composable/heatmap/panelcfg/x/HeatmapPanelCfg_types.gen';\nimport { PromQLQuery } from '../../utils/promqlParser';\nimport { ErrorBoundary } from '../../../ErrorBoundary';\nimport { LoadingOverlay } from '../../../LoadingOverlay';\n\ninterface GraphRendererProps {\n  query: PromQLQuery;\n  height?: number;\n  showControls?: boolean;\n  defaultTimeRange?: { from: string; to: string };\n  refreshInterval?: string;\n  visualizationType?: 'timeseries' | 'stat' | 'gauge' | 'table' | 'piechart' | 'barchart' | 'heatmap' | 'histogram';\n}\n\nconst GraphRendererComponent: React.FC<GraphRendererProps> = ({\n  query,\n  height = 300,\n  showControls = true,\n  defaultTimeRange = { from: 'now-1h', to: 'now' },\n  refreshInterval = '',\n  visualizationType = 'timeseries',\n}) => {\n  // Get Grafana theme for styling\n  const theme = useTheme2();\n  const [scene, setScene] = useState<EmbeddedScene | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [currentVizType, setCurrentVizType] = useState(visualizationType);\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const vizTypeOptions = [\n    { label: 'Time Series', value: 'timeseries' },\n    { label: 'Stats', value: 'stat' },\n    { label: 'Gauge', value: 'gauge' },\n    { label: 'Table', value: 'table' },\n    { label: 'Pie Chart', value: 'piechart' },\n    { label: 'Bar Chart', value: 'barchart' },\n    { label: 'Heatmap', value: 'heatmap' },\n    { label: 'Histogram', value: 'histogram' },\n  ];\n\n  const handleVizTypeChange = useCallback((value: string) => {\n    setCurrentVizType(value as typeof visualizationType);\n  }, []);\n\n  useEffect(() => {\n    console.log('[GraphRenderer] Creating scene for query:', query.query, 'viz type:', currentVizType);\n    setIsLoading(true);\n\n    // Create a time range\n    const timeRange = new SceneTimeRange({\n      from: defaultTimeRange.from,\n      to: defaultTimeRange.to,\n    });\n\n    // Get Prometheus data source\n    let dataSource: any;\n    try {\n      // Try to get the default Prometheus data source\n      const dsService = getDataSourceSrv();\n      dataSource = dsService.getInstanceSettings('Prometheus');\n\n      if (!dataSource) {\n        console.warn('[GraphRenderer] No Prometheus data source found, using default');\n        dataSource = { uid: 'prometheus', type: 'prometheus' };\n      }\n    } catch (error) {\n      console.warn('[GraphRenderer] Error getting data source:', error);\n      dataSource = { uid: 'prometheus', type: 'prometheus' };\n    }\n\n    // Create query runner with the PromQL query\n    // Note: Don't pass $timeRange here - it will inherit from the EmbeddedScene\n    const queryRunner = new SceneQueryRunner({\n      datasource: dataSource,\n      queries: [\n        {\n          refId: 'A',\n          expr: query.query,\n          format: 'time_series',\n          instant: false,\n        },\n      ],\n    });\n\n    // Create the panel based on visualization type\n    let panel;\n    switch (currentVizType) {\n      case 'stat':\n        panel = PanelBuilders.stat()\n          .setTitle(query.title || 'Stats')\n          .setData(queryRunner)\n          .setOption('reduceOptions', {\n            values: false,\n            fields: '',\n            calcs: ['lastNotNull'],\n          })\n          .build();\n        break;\n      case 'gauge':\n        panel = PanelBuilders.gauge()\n          .setTitle(query.title || 'Gauge')\n          .setData(queryRunner)\n          .setOption('showThresholdLabels', true)\n          .setOption('showThresholdMarkers', true)\n          .build();\n        break;\n      case 'table':\n        panel = PanelBuilders.table()\n          .setTitle(query.title || 'Table')\n          .setData(queryRunner)\n          .setOption('showHeader', true)\n          .build();\n        break;\n      case 'piechart':\n        panel = PanelBuilders.piechart()\n          .setTitle(query.title || 'Pie Chart')\n          .setData(queryRunner)\n          .setOption('legend', { showLegend: true, placement: 'right' })\n          .setOption('pieType', PieChartType.Pie)\n          .setOption('displayLabels', [PieChartLabels.Name, PieChartLabels.Percent])\n          .build();\n        break;\n      case 'barchart':\n        panel = PanelBuilders.barchart()\n          .setTitle(query.title || 'Bar Chart')\n          .setData(queryRunner)\n          .setOption('legend', { showLegend: true, placement: 'bottom' })\n          .setOption('orientation', VizOrientation.Auto)\n          .setOption('showValue', VisibilityMode.Auto)\n          .build();\n        break;\n      case 'heatmap':\n        panel = PanelBuilders.heatmap()\n          .setTitle(query.title || 'Heatmap')\n          .setData(queryRunner)\n          .setOption('calculate', false)\n          .setOption('cellGap', 1)\n          .setOption('color', {\n            mode: HeatmapColorMode.Scheme,\n            scheme: 'Spectral',\n            steps: 64,\n          })\n          .setOption('yAxis', { axisPlacement: AxisPlacement.Left })\n          .build();\n        break;\n      case 'histogram':\n        panel = PanelBuilders.histogram()\n          .setTitle(query.title || 'Histogram')\n          .setData(queryRunner)\n          .setOption('legend', { showLegend: true, placement: 'bottom' })\n          .setOption('bucketCount', 30)\n          .build();\n        break;\n      default:\n        panel = PanelBuilders.timeseries()\n          .setTitle(query.title || 'Time Series')\n          .setData(queryRunner)\n          .setOption('legend', { showLegend: true, placement: 'bottom' })\n          .build();\n    }\n\n    // Create the scene layout\n    const layout = new SceneFlexLayout({\n      direction: 'column',\n      children: [\n        new SceneFlexItem({\n          body: panel,\n          minHeight: isExpanded ? height * 2 : height,\n        }),\n      ],\n    });\n\n    // Create scene controls if enabled\n    const controls = showControls\n      ? [\n          new SceneTimePicker({}),\n          new SceneRefreshPicker({\n            intervals: ['5s', '10s', '30s', '1m', '5m', '15m', '30m', '1h'],\n            refresh: refreshInterval,\n          }),\n        ]\n      : [];\n\n    // Create the embedded scene\n    const embeddedScene = new EmbeddedScene({\n      $timeRange: timeRange,\n      body: layout,\n      controls,\n    });\n\n    console.log('[GraphRenderer] Scene created successfully');\n\n    // Track if this effect instance is still valid (survives React Strict Mode)\n    let isCancelled = false;\n\n    // Delay activation to survive React Strict Mode's unmount/remount cycle\n    const activationTimeout = setTimeout(() => {\n      if (!isCancelled) {\n        console.log('[GraphRenderer] Activating scene...');\n        embeddedScene.activate();\n        setScene(embeddedScene);\n        setIsLoading(false);\n      }\n    }, 0);\n\n    // Cleanup function\n    return () => {\n      console.log('[GraphRenderer] Cleanup running');\n      isCancelled = true;\n      clearTimeout(activationTimeout);\n    };\n  }, [\n    query.query,\n    query.title,\n    height,\n    currentVizType,\n    showControls,\n    refreshInterval,\n    isExpanded,\n    defaultTimeRange.from,\n    defaultTimeRange.to,\n  ]);\n\n  // Show loading state while scene is being created\n  if (!scene) {\n    return (\n      <div\n        className=\"my-4 rounded-lg overflow-hidden p-4\"\n        style={{\n          border: `1px solid ${theme.colors.border.weak}`,\n          backgroundColor: theme.colors.background.primary,\n        }}\n      >\n        <LoadingOverlay isLoading={true} message=\"Loading graph...\" />\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"my-4 rounded-lg overflow-hidden\"\n      style={{\n        border: `1px solid ${theme.colors.border.weak}`,\n      }}\n    >\n      {/* Header with title and controls */}\n      <div\n        className=\"px-4 py-2 flex items-center justify-between\"\n        style={{\n          backgroundColor: theme.colors.background.secondary,\n          borderBottom: `1px solid ${theme.colors.border.weak}`,\n        }}\n      >\n        <h4 className=\"text-sm font-medium\" style={{ color: theme.colors.text.primary }}>\n          {query.title || 'Query Result'}\n        </h4>\n        <div className=\"flex items-center gap-2\">\n          {/* Visualization type selector */}\n          <RadioButtonGroup size=\"sm\" value={currentVizType} options={vizTypeOptions} onChange={handleVizTypeChange} />\n\n          {/* Expand/Collapse button */}\n          <Tooltip content={isExpanded ? 'Collapse' : 'Expand'}>\n            <IconButton\n              name={isExpanded ? 'angle-up' : 'angle-down'}\n              size=\"sm\"\n              onClick={() => setIsExpanded(!isExpanded)}\n              aria-label={isExpanded ? 'Collapse graph' : 'Expand graph'}\n            />\n          </Tooltip>\n        </div>\n      </div>\n\n      {/* Graph area with loading overlay */}\n      <div\n        className=\"p-4 relative\"\n        style={{\n          backgroundColor: theme.colors.background.primary,\n          minHeight: isExpanded ? height * 2 : height,\n        }}\n      >\n        <LoadingOverlay isLoading={isLoading} message=\"Rendering visualization...\" variant=\"overlay\">\n          <scene.Component model={scene} />\n        </LoadingOverlay>\n      </div>\n\n      {/* Footer with query */}\n      <div\n        className=\"px-4 py-2 flex items-center justify-between\"\n        style={{\n          backgroundColor: theme.colors.background.secondary,\n          borderTop: `1px solid ${theme.colors.border.weak}`,\n        }}\n      >\n        <code className=\"text-xs flex-1\" style={{ color: theme.colors.text.secondary }}>\n          {query.query}\n        </code>\n        <Tooltip content=\"Copy query\">\n          <IconButton\n            name=\"copy\"\n            size=\"sm\"\n            onClick={() => {\n              navigator.clipboard.writeText(query.query);\n            }}\n            aria-label=\"Copy query to clipboard\"\n          />\n        </Tooltip>\n      </div>\n    </div>\n  );\n};\n\n// Export the GraphRenderer wrapped with error boundary\nexport const GraphRenderer: React.FC<GraphRendererProps> = (props) => {\n  return (\n    <ErrorBoundary fallbackTitle=\"Graph Rendering Error\">\n      <GraphRendererComponent {...props} />\n    </ErrorBoundary>\n  );\n};\n","import React, { useState, useEffect } from 'react';\nimport {\n  SceneFlexLayout,\n  SceneFlexItem,\n  PanelBuilders,\n  SceneQueryRunner,\n  SceneTimeRange,\n  EmbeddedScene,\n} from '@grafana/scenes';\nimport { useTheme2 } from '@grafana/ui';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { LogsDedupStrategy, LogsSortOrder } from '@grafana/data';\nimport { Query } from '../../utils/promqlParser';\n\ninterface LogsRendererProps {\n  query: Query;\n  height?: number;\n  defaultTimeRange?: { from: string; to: string };\n}\n\nexport const LogsRenderer: React.FC<LogsRendererProps> = ({\n  query,\n  height = 400,\n  defaultTimeRange = { from: 'now-1h', to: 'now' },\n}) => {\n  // Get Grafana theme for styling\n  const theme = useTheme2();\n  const [scene, setScene] = useState<EmbeddedScene | null>(null);\n\n  useEffect(() => {\n    console.log('[LogsRenderer] Creating scene for query:', query.query);\n\n    // Create a time range\n    const timeRange = new SceneTimeRange({\n      from: defaultTimeRange.from,\n      to: defaultTimeRange.to,\n    });\n\n    // Try to get the default Loki data source\n    let dataSource: { uid?: string; type: string } = { type: 'loki' };\n    try {\n      const ds = getDataSourceSrv().getInstanceSettings('loki');\n      if (ds) {\n        dataSource = { uid: ds.uid, type: 'loki' };\n        console.log('[LogsRenderer] Using Loki data source:', ds.uid);\n      }\n    } catch (error) {\n      console.warn('[LogsRenderer] Could not get default Loki data source, using fallback');\n    }\n\n    // Create a query runner with Loki data source\n    // Note: Don't pass $timeRange here - it will inherit from the EmbeddedScene\n    const queryRunner = new SceneQueryRunner({\n      datasource: dataSource,\n      queries: [\n        {\n          refId: 'A',\n          expr: query.query,\n          queryType: 'range',\n        },\n      ],\n    });\n\n    // Create a logs panel\n    const panel = PanelBuilders.logs()\n      .setTitle(query.title || 'Logs')\n      .setData(queryRunner)\n      .setOption('showTime', true)\n      .setOption('showLabels', true)\n      .setOption('showCommonLabels', false)\n      .setOption('wrapLogMessage', true)\n      .setOption('prettifyLogMessage', false)\n      .setOption('enableLogDetails', true)\n      .setOption('dedupStrategy', LogsDedupStrategy.none)\n      .setOption('sortOrder', LogsSortOrder.Descending)\n      .build();\n\n    // Create a layout with the panel\n    const layout = new SceneFlexLayout({\n      direction: 'column',\n      children: [\n        new SceneFlexItem({\n          minHeight: height,\n          body: panel,\n        }),\n      ],\n    });\n\n    // Create the embedded scene\n    const embeddedScene = new EmbeddedScene({\n      $timeRange: timeRange,\n      body: layout,\n      controls: [],\n    });\n\n    console.log('[LogsRenderer] Scene created successfully');\n\n    // Track if this effect instance is still valid (survives React Strict Mode)\n    let isCancelled = false;\n\n    // Delay activation to survive React Strict Mode's unmount/remount cycle\n    const activationTimeout = setTimeout(() => {\n      if (!isCancelled) {\n        console.log('[LogsRenderer] Activating scene...');\n        embeddedScene.activate();\n        setScene(embeddedScene);\n      }\n    }, 0);\n\n    // Cleanup function\n    return () => {\n      console.log('[LogsRenderer] Cleanup running');\n      isCancelled = true;\n      clearTimeout(activationTimeout);\n    };\n  }, [query.query, query.title, height, defaultTimeRange.from, defaultTimeRange.to]);\n\n  // Show loading state while scene is being created\n  if (!scene) {\n    return (\n      <div\n        className=\"my-4 rounded-lg overflow-hidden p-4\"\n        style={{\n          border: `1px solid ${theme.colors.border.weak}`,\n          backgroundColor: theme.colors.background.primary,\n        }}\n      >\n        <div style={{ color: theme.colors.text.secondary }}>Loading logs...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"my-4 rounded-lg overflow-hidden\"\n      style={{\n        border: `1px solid ${theme.colors.border.weak}`,\n      }}\n    >\n      {query.title && (\n        <div\n          className=\"px-4 py-2\"\n          style={{\n            backgroundColor: theme.colors.background.secondary,\n            borderBottom: `1px solid ${theme.colors.border.weak}`,\n          }}\n        >\n          <h4 className=\"text-sm font-medium\" style={{ color: theme.colors.text.primary }}>\n            {query.title}\n          </h4>\n        </div>\n      )}\n      <div\n        className=\"p-4\"\n        style={{\n          backgroundColor: theme.colors.background.primary,\n        }}\n      >\n        <scene.Component model={scene} />\n      </div>\n      <div\n        className=\"px-4 py-2\"\n        style={{\n          backgroundColor: theme.colors.background.secondary,\n          borderTop: `1px solid ${theme.colors.border.weak}`,\n        }}\n      >\n        <code className=\"text-xs\" style={{ color: theme.colors.text.secondary }}>\n          {query.query}\n        </code>\n      </div>\n    </div>\n  );\n};\n","import React, { useState, useEffect } from 'react';\nimport {\n  SceneFlexLayout,\n  SceneFlexItem,\n  PanelBuilders,\n  SceneQueryRunner,\n  SceneTimeRange,\n  EmbeddedScene,\n} from '@grafana/scenes';\nimport { useTheme2 } from '@grafana/ui';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Query } from '../../utils/promqlParser';\n\ninterface TracesRendererProps {\n  query: Query;\n  height?: number;\n  defaultTimeRange?: { from: string; to: string };\n}\n\nexport const TracesRenderer: React.FC<TracesRendererProps> = ({\n  query,\n  height = 400,\n  defaultTimeRange = { from: 'now-1h', to: 'now' },\n}) => {\n  // Get Grafana theme for styling\n  const theme = useTheme2();\n  const [scene, setScene] = useState<EmbeddedScene | null>(null);\n\n  useEffect(() => {\n    console.log('[TracesRenderer] Creating scene for query:', query.query);\n\n    // Create a time range\n    const timeRange = new SceneTimeRange({\n      from: defaultTimeRange.from,\n      to: defaultTimeRange.to,\n    });\n\n    // Try to get the default Tempo data source\n    let dataSource: { uid?: string; type: string } = { type: 'tempo' };\n    try {\n      const ds = getDataSourceSrv().getInstanceSettings('tempo');\n      if (ds) {\n        dataSource = { uid: ds.uid, type: 'tempo' };\n        console.log('[TracesRenderer] Using Tempo data source:', ds.uid);\n      }\n    } catch (error) {\n      console.warn('[TracesRenderer] Could not get default Tempo data source, using fallback');\n    }\n\n    // Create a query runner with Tempo data source\n    // Note: Don't pass $timeRange here - it will inherit from the EmbeddedScene\n    const queryRunner = new SceneQueryRunner({\n      datasource: dataSource,\n      queries: [\n        {\n          refId: 'A',\n          query: query.query,\n          queryType: 'traceql',\n        },\n      ],\n    });\n\n    // Create a traces panel\n    const panel = PanelBuilders.traces()\n      .setTitle(query.title || 'Traces')\n      .setData(queryRunner)\n      .build();\n\n    // Create a layout with the panel\n    const layout = new SceneFlexLayout({\n      direction: 'column',\n      children: [\n        new SceneFlexItem({\n          minHeight: height,\n          body: panel,\n        }),\n      ],\n    });\n\n    // Create the embedded scene\n    const embeddedScene = new EmbeddedScene({\n      $timeRange: timeRange,\n      body: layout,\n      controls: [],\n    });\n\n    console.log('[TracesRenderer] Scene created successfully');\n\n    // Track if this effect instance is still valid (survives React Strict Mode)\n    let isCancelled = false;\n\n    // Delay activation to survive React Strict Mode's unmount/remount cycle\n    const activationTimeout = setTimeout(() => {\n      if (!isCancelled) {\n        console.log('[TracesRenderer] Activating scene...');\n        embeddedScene.activate();\n        setScene(embeddedScene);\n      }\n    }, 0);\n\n    // Cleanup function\n    return () => {\n      console.log('[TracesRenderer] Cleanup running');\n      isCancelled = true;\n      clearTimeout(activationTimeout);\n    };\n  }, [query.query, query.title, height, defaultTimeRange.from, defaultTimeRange.to]);\n\n  // Show loading state while scene is being created\n  if (!scene) {\n    return (\n      <div\n        className=\"my-4 rounded-lg overflow-hidden p-4\"\n        style={{\n          border: `1px solid ${theme.colors.border.weak}`,\n          backgroundColor: theme.colors.background.primary,\n        }}\n      >\n        <div style={{ color: theme.colors.text.secondary }}>Loading traces...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"my-4 rounded-lg overflow-hidden\"\n      style={{\n        border: `1px solid ${theme.colors.border.weak}`,\n      }}\n    >\n      {query.title && (\n        <div\n          className=\"px-4 py-2\"\n          style={{\n            backgroundColor: theme.colors.background.secondary,\n            borderBottom: `1px solid ${theme.colors.border.weak}`,\n          }}\n        >\n          <h4 className=\"text-sm font-medium\" style={{ color: theme.colors.text.primary }}>\n            {query.title}\n          </h4>\n        </div>\n      )}\n      <div\n        className=\"p-4\"\n        style={{\n          backgroundColor: theme.colors.background.primary,\n        }}\n      >\n        <scene.Component model={scene} />\n      </div>\n      <div\n        className=\"px-4 py-2\"\n        style={{\n          backgroundColor: theme.colors.background.secondary,\n          borderTop: `1px solid ${theme.colors.border.weak}`,\n        }}\n      >\n        <code className=\"text-xs\" style={{ color: theme.colors.text.secondary }}>\n          {query.query}\n        </code>\n      </div>\n    </div>\n  );\n};\n","/**\n * Utility functions for detecting and parsing PromQL, LogQL, and TraceQL queries from text\n */\n\nexport type QueryLanguage = 'promql' | 'prometheus' | 'logql' | 'loki' | 'traceql' | 'tempo';\nexport type QueryType = 'metrics' | 'logs' | 'traces';\n\nexport type VisualizationType =\n  | 'timeseries'\n  | 'stat'\n  | 'gauge'\n  | 'table'\n  | 'piechart'\n  | 'barchart'\n  | 'heatmap'\n  | 'histogram';\n\nexport interface Query {\n  query: string;\n  title?: string;\n  language: QueryLanguage;\n  type: QueryType;\n  from?: string;\n  to?: string;\n  visualization?: VisualizationType;\n}\n\n// For backward compatibility\nexport type PromQLQuery = Query;\n\n/**\n * Determines the query type from language\n */\nfunction getQueryType(language: QueryLanguage): QueryType {\n  if (language === 'logql' || language === 'loki') {\n    return 'logs';\n  } else if (language === 'traceql' || language === 'tempo') {\n    return 'traces';\n  }\n  return 'metrics';\n}\n\n/**\n * Parses attributes (title, from, to, viz) from a string like: title=\"My Title\" from=\"now-7d\" to=\"now\" viz=\"gauge\"\n */\nfunction parseAttributes(attrString: string): { title?: string; from?: string; to?: string; viz?: VisualizationType } {\n  const attrs: { title?: string; from?: string; to?: string; viz?: VisualizationType } = {};\n\n  const titleMatch = attrString.match(/title=\"([^\"]*)\"/);\n  if (titleMatch) {\n    attrs.title = titleMatch[1];\n  }\n\n  const fromMatch = attrString.match(/from=\"([^\"]*)\"/);\n  if (fromMatch) {\n    attrs.from = fromMatch[1];\n  }\n\n  const toMatch = attrString.match(/to=\"([^\"]*)\"/);\n  if (toMatch) {\n    attrs.to = toMatch[1];\n  }\n\n  const vizMatch = attrString.match(/viz=\"([^\"]*)\"/);\n  if (vizMatch) {\n    const vizValue = vizMatch[1] as VisualizationType;\n    // Only accept valid visualization types\n    if (['timeseries', 'stat', 'gauge', 'table', 'piechart', 'barchart', 'heatmap', 'histogram'].includes(vizValue)) {\n      attrs.viz = vizValue;\n    }\n  }\n\n  return attrs;\n}\n\n/**\n * Detects PromQL, LogQL, and TraceQL queries in markdown code blocks\n * Supports ```promql, ```prometheus, ```logql, ```loki, ```traceql, and ```tempo formats\n */\nexport function extractPromQLQueries(content: string): Query[] {\n  const queries: Query[] = [];\n\n  // Match code blocks with promql, prometheus, logql, loki, traceql, or tempo language tag\n  // Captures all attributes as a single group to support title, from, to in any order\n  const codeBlockRegex = /```(promql|prometheus|logql|loki|traceql|tempo)([^\\n]*)\\n([\\s\\S]*?)```/gi;\n\n  let match;\n  while ((match = codeBlockRegex.exec(content)) !== null) {\n    const [, language, attrString, query] = match;\n    const lang = language.toLowerCase() as QueryLanguage;\n    const attrs = parseAttributes(attrString);\n    queries.push({\n      query: query.trim(),\n      title: attrs.title,\n      language: lang,\n      type: getQueryType(lang),\n      from: attrs.from,\n      to: attrs.to,\n      visualization: attrs.viz,\n    });\n  }\n\n  return queries;\n}\n\n/**\n * Check if content contains PromQL, LogQL, or TraceQL queries\n */\nexport function hasPromQLQueries(content: string): boolean {\n  return extractPromQLQueries(content).length > 0;\n}\n\n/**\n * Remove PromQL, LogQL, and TraceQL code blocks from content for text rendering\n */\nexport function removePromQLCodeBlocks(content: string): string {\n  return content.replace(/```(promql|prometheus|logql|loki|traceql|tempo)[^\\n]*\\n[\\s\\S]*?```/gi, '');\n}\n\n/**\n * Split content into text, PromQL, LogQL, and TraceQL sections\n */\nexport function splitContentByPromQL(\n  content: string\n): Array<{ type: 'text' | 'promql' | 'logql' | 'traceql'; content: string; query?: Query }> {\n  const sections: Array<{ type: 'text' | 'promql' | 'logql' | 'traceql'; content: string; query?: Query }> = [];\n\n  // Captures all attributes as a single group to support title, from, to in any order\n  const codeBlockRegex = /```(promql|prometheus|logql|loki|traceql|tempo)([^\\n]*)\\n([\\s\\S]*?)```/gi;\n\n  let lastIndex = 0;\n  let match;\n\n  while ((match = codeBlockRegex.exec(content)) !== null) {\n    // Add text before this code block\n    if (match.index > lastIndex) {\n      const textContent = content.substring(lastIndex, match.index).trim();\n      if (textContent) {\n        sections.push({ type: 'text', content: textContent });\n      }\n    }\n\n    // Add the query\n    const [, language, attrString, query] = match;\n    const lang = language.toLowerCase() as QueryLanguage;\n    const queryType = getQueryType(lang);\n    const attrs = parseAttributes(attrString);\n\n    let sectionType: 'promql' | 'logql' | 'traceql';\n    if (queryType === 'logs') {\n      sectionType = 'logql';\n    } else if (queryType === 'traces') {\n      sectionType = 'traceql';\n    } else {\n      sectionType = 'promql';\n    }\n\n    sections.push({\n      type: sectionType,\n      content: match[0],\n      query: {\n        query: query.trim(),\n        title: attrs.title,\n        language: lang,\n        type: queryType,\n        from: attrs.from,\n        to: attrs.to,\n        visualization: attrs.viz,\n      },\n    });\n\n    lastIndex = match.index + match[0].length;\n  }\n\n  // Add remaining text\n  if (lastIndex < content.length) {\n    const textContent = content.substring(lastIndex).trim();\n    if (textContent) {\n      sections.push({ type: 'text', content: textContent });\n    }\n  }\n\n  // If no sections were added, return the whole content as text\n  if (sections.length === 0 && content.trim()) {\n    sections.push({ type: 'text', content: content });\n  }\n\n  return sections;\n}\n","import React from 'react';\nimport { Streamdown } from 'streamdown';\nimport { useTheme2 } from '@grafana/ui';\nimport { ToolCallsSection } from '../ToolCallsSection/ToolCallsSection';\nimport { GraphRenderer } from '../GraphRenderer/GraphRenderer';\nimport { LogsRenderer } from '../LogsRenderer/LogsRenderer';\nimport { TracesRenderer } from '../TracesRenderer/TracesRenderer';\nimport { ChatMessage as ChatMessageType } from '../../types';\nimport { splitContentByPromQL } from '../../utils/promqlParser';\n\ninterface ChatMessageProps {\n  message: ChatMessageType;\n  isGenerating?: boolean;\n  isLastMessage?: boolean;\n}\n\nexport const ChatMessage: React.FC<ChatMessageProps> = ({ message, isGenerating = false, isLastMessage = false }) => {\n  const theme = useTheme2();\n  const showThinking = message.role === 'assistant' && isGenerating && isLastMessage && !message.content;\n  const isUser = message.role === 'user';\n\n  if (isUser) {\n    // User messages: Sober colored bubble\n    return (\n      <div className=\"flex w-full justify-end mb-5 animate-slideIn\" role=\"article\" aria-label=\"User message\">\n        <div className=\"max-w-[75%]\">\n          <div\n            className=\"px-4 py-3 rounded-xl rounded-br-sm\"\n            style={{\n              backgroundColor: theme.isDark ? '#3730a3' : '#4f46e5',\n              color: '#ffffff',\n            }}\n            tabIndex={0}\n            aria-live=\"polite\"\n          >\n            <span className=\"sr-only\">User message</span>\n            <div className=\"text-sm leading-relaxed whitespace-normal break-words\">{message.content}</div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Split content by PromQL queries for assistant messages\n  const contentSections = message.content ? splitContentByPromQL(message.content) : [];\n\n  // Assistant messages: Plain text with modern styling and embedded graphs\n  return (\n    <div className=\"flex w-full mb-6 animate-fadeIn\" role=\"article\" aria-label=\"Assistant message\">\n      <div className=\"w-full max-w-none\" tabIndex={0}>\n        <span className=\"sr-only\">Assistant message</span>\n        {/* Tool Calls Section */}\n        {message.toolCalls && message.toolCalls.length > 0 && (\n          <div className=\"mb-4\">\n            <ToolCallsSection toolCalls={message.toolCalls} />\n          </div>\n        )}\n\n        {/* Message Content */}\n        {showThinking ? (\n          <div\n            className=\"flex items-center gap-3 px-4 py-3 rounded-lg animate-pulse\"\n            style={{\n              backgroundColor: theme.isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.02)',\n              color: theme.colors.text.secondary,\n            }}\n          >\n            <div className=\"flex gap-1.5\">\n              <div\n                className=\"w-2 h-2 rounded-full animate-pulse\"\n                style={{\n                  backgroundColor: theme.colors.primary.main,\n                  animationDelay: '0ms',\n                }}\n              ></div>\n              <div\n                className=\"w-2 h-2 rounded-full animate-pulse\"\n                style={{\n                  backgroundColor: theme.colors.primary.main,\n                  animationDelay: '150ms',\n                }}\n              ></div>\n              <div\n                className=\"w-2 h-2 rounded-full animate-pulse\"\n                style={{\n                  backgroundColor: theme.colors.primary.main,\n                  animationDelay: '300ms',\n                }}\n              ></div>\n            </div>\n            <span className=\"text-sm font-medium\">Thinking...</span>\n          </div>\n        ) : contentSections.length > 0 ? (\n          <div\n            className=\"text-sm leading-relaxed whitespace-normal break-words\"\n            style={{ color: theme.colors.text.primary }}\n          >\n            {contentSections.map((section, index) => {\n              if (section.type === 'text') {\n                return (\n                  <div key={index} className=\"prose prose-sm max-w-none\">\n                    <Streamdown>{section.content}</Streamdown>\n                  </div>\n                );\n              } else if (section.type === 'promql' && section.query) {\n                return (\n                  <div key={index} className=\"my-3\">\n                    <GraphRenderer\n                      query={section.query}\n                      defaultTimeRange={\n                        section.query.from\n                          ? {\n                              from: section.query.from,\n                              to: section.query.to || 'now',\n                            }\n                          : undefined\n                      }\n                      visualizationType={section.query.visualization}\n                    />\n                  </div>\n                );\n              } else if (section.type === 'logql' && section.query) {\n                return (\n                  <div key={index} className=\"my-3\">\n                    <LogsRenderer\n                      query={section.query}\n                      defaultTimeRange={\n                        section.query.from\n                          ? {\n                              from: section.query.from,\n                              to: section.query.to || 'now',\n                            }\n                          : undefined\n                      }\n                    />\n                  </div>\n                );\n              } else if (section.type === 'traceql' && section.query) {\n                return (\n                  <div key={index} className=\"my-3\">\n                    <TracesRenderer\n                      query={section.query}\n                      defaultTimeRange={\n                        section.query.from\n                          ? {\n                              from: section.query.from,\n                              to: section.query.to || 'now',\n                            }\n                          : undefined\n                      }\n                    />\n                  </div>\n                );\n              }\n              return null;\n            })}\n          </div>\n        ) : (\n          <div\n            className=\"text-sm leading-relaxed whitespace-normal break-words prose prose-sm max-w-none\"\n            style={{ color: theme.colors.text.primary }}\n          >\n            <Streamdown>{message.content}</Streamdown>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n","import React from 'react';\n\nimport { ChatMessage } from '../ChatMessage/ChatMessage';\nimport { ChatMessage as ChatMessageType } from '../../types';\n\ninterface ChatHistoryProps {\n  chatHistory: ChatMessageType[];\n  isGenerating: boolean;\n}\n\nexport const ChatHistory: React.FC<ChatHistoryProps> = ({ chatHistory, isGenerating }) => (\n  <div>\n    {chatHistory.map((message, index) => (\n      <ChatMessage\n        key={index}\n        message={message}\n        isGenerating={isGenerating}\n        isLastMessage={index === chatHistory.length - 1}\n      />\n    ))}\n  </div>\n);\n","import React, { forwardRef, useImperativeHandle, useRef, useEffect, useState } from 'react';\nimport { Icon, Alert, useTheme2 } from '@grafana/ui';\nimport { ValidationService } from '../../../../services/validation';\n\ninterface ChatInputProps {\n  currentInput: string;\n  isGenerating: boolean;\n  toolsLoading: boolean;\n  setCurrentInput: (value: string) => void;\n  sendMessage: () => void;\n  handleKeyPress: (e: React.KeyboardEvent) => void;\n  rightSlot?: React.ReactNode;\n  leftSlot?: React.ReactNode;\n}\n\nexport interface ChatInputRef {\n  focus: () => void;\n}\n\nexport const ChatInput = forwardRef<ChatInputRef, ChatInputProps>(\n  (\n    { currentInput, isGenerating, toolsLoading, setCurrentInput, sendMessage, handleKeyPress, rightSlot, leftSlot },\n    ref\n  ) => {\n    const textareaRef = useRef<HTMLTextAreaElement>(null);\n    const [validationError, setValidationError] = useState<string | null>(null);\n    const theme = useTheme2();\n\n    useImperativeHandle(ref, () => ({\n      focus: () => {\n        if (textareaRef.current) {\n          textareaRef.current.focus();\n          textareaRef.current.setSelectionRange(textareaRef.current.value.length, textareaRef.current.value.length);\n        }\n      },\n    }));\n\n    // Auto-resize textarea\n    const autoResize = () => {\n      if (textareaRef.current) {\n        textareaRef.current.style.height = 'auto';\n        textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`;\n      }\n    };\n\n    useEffect(() => {\n      autoResize();\n    }, [currentInput]);\n\n    const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n      const rawValue = e.target.value;\n\n      // Allow setting the value even if it's invalid (for better UX)\n      setCurrentInput(rawValue);\n\n      // Validate the input\n      if (rawValue.trim()) {\n        try {\n          ValidationService.validateChatInput(rawValue);\n          setValidationError(null);\n        } catch (error) {\n          setValidationError(error instanceof Error ? error.message : 'Invalid input');\n        }\n      } else {\n        setValidationError(null);\n      }\n\n      autoResize();\n    };\n\n    // Enhanced send handler with validation\n    const handleSendClick = () => {\n      if (validationError) {\n        return; // Don't send if there's a validation error\n      }\n      sendMessage();\n    };\n\n    // Enhanced key press handler\n    const handleKeyDown = (e: React.KeyboardEvent) => {\n      if (e.key === 'Enter' && !e.shiftKey && !validationError) {\n        handleKeyPress(e);\n      } else if (e.key === 'Enter' && !e.shiftKey && validationError) {\n        e.preventDefault(); // Prevent sending invalid input\n      } else {\n        handleKeyPress(e);\n      }\n    };\n\n    return (\n      <div className=\"relative\">\n        {validationError && (\n          <div className=\"mb-2\">\n            <Alert severity=\"error\" title=\"Input validation error\">\n              {validationError}\n            </Alert>\n          </div>\n        )}\n\n        {/* Gradient border wrapper */}\n        <div className={`gradient-border-wrapper ${validationError ? 'opacity-50' : ''}`}>\n          <div\n            className=\"gradient-border-inner px-5 py-4\"\n            style={{\n              backgroundColor: theme.isDark ? '#1a1a1a' : theme.colors.background.primary,\n            }}\n          >\n            {/* Top row: @ symbol and settings icon */}\n            {/* <div className=\"flex items-center justify-between mb-3\">\n              <span className=\"text-base font-medium\" style={{ color: theme.colors.text.secondary }}>\n                @\n              </span>\n              <button\n                type=\"button\"\n                className=\"p-1.5 rounded hover:bg-white/5 transition-colors\"\n                aria-label=\"Settings\"\n                style={{ color: theme.colors.text.secondary }}\n              >\n                <Icon name=\"cog\" size=\"md\" />\n              </button>\n            </div> */}\n\n            {/* Text input area */}\n            <textarea\n              ref={textareaRef}\n              value={currentInput}\n              onChange={handleInputChange}\n              onKeyDown={handleKeyDown}\n              placeholder=\"Ask me anything about your metrics, logs, or observability...\"\n              disabled={isGenerating || toolsLoading}\n              rows={1}\n              className=\"w-full resize-none bg-transparent border-0 text-base placeholder-secondary focus:outline-none focus:ring-0 min-h-[28px] max-h-[200px]\"\n              style={{\n                lineHeight: '1.6',\n                height: 'auto',\n                color: theme.colors.text.primary,\n              }}\n              aria-label=\"Chat input\"\n              aria-invalid={!!validationError}\n              aria-describedby={validationError ? 'input-error' : undefined}\n            />\n\n            {/* Bottom row: Loading indicator and send/enter icon */}\n            <div className=\"flex items-center justify-between mt-4 pt-3\">\n              <div className=\"flex items-center gap-3\">\n                {/* Left slot for optional actions */}\n                {leftSlot}\n\n                {/* Loading indicator */}\n                {(isGenerating || toolsLoading) && (\n                  <div className=\"flex items-center text-sm\" style={{ color: theme.colors.text.secondary }}>\n                    {isGenerating ? (\n                      <>\n                        <div className=\"flex gap-1 mr-2\">\n                          <div\n                            className=\"w-1.5 h-1.5 bg-current rounded-full animate-pulse\"\n                            style={{ animationDelay: '0ms' }}\n                          />\n                          <div\n                            className=\"w-1.5 h-1.5 bg-current rounded-full animate-pulse\"\n                            style={{ animationDelay: '150ms' }}\n                          />\n                          <div\n                            className=\"w-1.5 h-1.5 bg-current rounded-full animate-pulse\"\n                            style={{ animationDelay: '300ms' }}\n                          />\n                        </div>\n                        <span>Generating...</span>\n                      </>\n                    ) : (\n                      <span>Loading tools...</span>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                {/* Right slot for optional actions */}\n                {rightSlot}\n\n                {/* Enter/Send button */}\n                <button\n                  onClick={handleSendClick}\n                  disabled={!currentInput.trim() || isGenerating || toolsLoading || !!validationError}\n                  className=\"p-2 rounded-md hover:bg-white/10 transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                  aria-label=\"Send message (Enter)\"\n                  style={{ color: theme.colors.text.secondary }}\n                >\n                  <Icon name=\"enter\" size=\"xl\" />\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n);\n\nChatInput.displayName = 'ChatInput';\n","import React from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\n// Sparkle SVG icon component matching Grafana's style\nconst SparkleIcon: React.FC<{ className?: string; style?: React.CSSProperties }> = ({ className, style }) => (\n  <svg\n    className={className}\n    style={style}\n    width=\"44\"\n    height=\"44\"\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <path\n      d=\"M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z\"\n      fill=\"currentColor\"\n    />\n  </svg>\n);\n\nexport const WelcomeMessage: React.FC = () => {\n  const theme = useTheme2();\n\n  return (\n    <div className=\"text-center animate-fadeIn flex flex-col items-center justify-center py-8\">\n      {/* \"Hi, I'm\" text */}\n      <p className=\"text-base mb-2\" style={{ color: theme.colors.text.secondary }}>\n        Hi, I&apos;m\n      </p>\n\n      {/* Title with sparkle icon */}\n      <div className=\"flex items-center justify-center gap-3 mb-5\">\n        <SparkleIcon className=\"animate-sparkle\" style={{ color: theme.colors.text.primary }} />\n        <h1 className=\"text-5xl font-bold tracking-tight\" style={{ color: theme.colors.text.primary }}>\n          Ask O11y Assistant\n        </h1>\n      </div>\n\n      {/* Status badge and version */}\n      <div className=\"flex items-center gap-3 mb-8\">\n        <span className=\"status-badge\">BETA</span>\n        <span className=\"text-base\" style={{ color: theme.colors.text.secondary }}>\n          v0.2.0\n        </span>\n      </div>\n\n      {/* Description with highlighted text */}\n      <p className=\"text-lg max-w-2xl mx-auto leading-relaxed\" style={{ color: theme.colors.text.secondary }}>\n        An{' '}\n        <span className=\"font-medium\" style={{ color: '#f97316' }}>\n          agentic LLM assistant\n        </span>{' '}\n        for Grafana that helps you query data, investigate issues, manage dashboards, and more through natural language.\n      </p>\n    </div>\n  );\n};\n","import React from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\ninterface QuickSuggestionsProps {\n  onSuggestionClick?: (message: string) => void;\n}\n\nconst suggestions = [\n  {\n    label: 'Show me a graph of CPU usage',\n    message: 'Show me a graph of CPU usage over time',\n    icon: '',\n  },\n  {\n    label: 'Graph memory by pod',\n    message: 'Graph memory usage by pod in my default namespace',\n    icon: '',\n  },\n  {\n    label: 'Monitor user activity',\n    message: 'Create a query to monitor user activity over the last 24 hours',\n    icon: '',\n  },\n  {\n    label: 'Build a dashboard',\n    message: 'Help me build a dashboard for system performance metrics',\n    icon: '',\n  },\n];\n\nexport const QuickSuggestions: React.FC<QuickSuggestionsProps> = ({ onSuggestionClick }) => {\n  const theme = useTheme2();\n\n  return (\n    <div className=\"mt-8 animate-fadeIn\" style={{ animationDelay: '200ms' }}>\n      {/* Section label */}\n      <p className=\"text-center text-sm mb-4\" style={{ color: theme.colors.text.secondary }}>\n        Quick start suggestions\n      </p>\n\n      {/* Suggestion pills */}\n      <div className=\"flex flex-wrap justify-center gap-3\">\n        {suggestions.map((suggestion, index) => (\n          <button\n            key={index}\n            onClick={() => onSuggestionClick?.(suggestion.message)}\n            className=\"group inline-flex items-center gap-2.5 px-5 py-3 rounded-xl text-base cursor-pointer transition-all duration-300 hover:-translate-y-1 hover:shadow-lg\"\n            style={{\n              backgroundColor: theme.isDark ? 'rgba(255, 255, 255, 0.03)' : theme.colors.background.secondary,\n              border: `1px solid ${theme.isDark ? 'rgba(255, 255, 255, 0.1)' : theme.colors.border.weak}`,\n              color: theme.colors.text.primary,\n              animationDelay: `${(index + 1) * 50}ms`,\n            }}\n            onMouseEnter={(e) => {\n              e.currentTarget.style.borderColor = theme.isDark ? 'rgba(139, 92, 246, 0.5)' : theme.colors.primary.main;\n              e.currentTarget.style.backgroundColor = theme.isDark\n                ? 'rgba(139, 92, 246, 0.1)'\n                : 'rgba(139, 92, 246, 0.05)';\n            }}\n            onMouseLeave={(e) => {\n              e.currentTarget.style.borderColor = theme.isDark ? 'rgba(255, 255, 255, 0.1)' : theme.colors.border.weak;\n              e.currentTarget.style.backgroundColor = theme.isDark\n                ? 'rgba(255, 255, 255, 0.03)'\n                : theme.colors.background.secondary;\n            }}\n          >\n            <span className=\"text-lg transition-transform duration-300 group-hover:scale-110\">{suggestion.icon}</span>\n            <span className=\"font-medium\">{suggestion.label}</span>\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n};\n","import React, { useState, useEffect } from 'react';\n// Note: Select is deprecated but used for compatibility. Consider migrating to Combobox in future.\n \nimport { Modal, Button, Select, Input, ClipboardButton } from '@grafana/ui';\nimport { sessionShareService, CreateShareResponse } from '../../../../services/sessionShare';\nimport { ChatSession } from '../../../../core/models/ChatSession';\n\ninterface ShareDialogProps {\n  sessionId: string;\n  session: ChatSession;\n  onClose: () => void;\n  existingShares?: CreateShareResponse[];\n}\n\nexport function ShareDialog({ sessionId, session, onClose, existingShares = [] }: ShareDialogProps) {\n  const [expiresInDays, setExpiresInDays] = useState<number | undefined>(undefined);\n  const [customDays, setCustomDays] = useState<string>('');\n  const [isCreating, setIsCreating] = useState(false);\n  const [createdShare, setCreatedShare] = useState<CreateShareResponse | null>(null);\n  const [shares, setShares] = useState<CreateShareResponse[]>(existingShares);\n  const [revokingShareId, setRevokingShareId] = useState<string | null>(null);\n\n  useEffect(() => {\n    // Load existing shares if not provided\n    if (existingShares.length === 0) {\n      loadShares();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [sessionId, existingShares.length]);\n\n  const loadShares = async () => {\n    try {\n      const loadedShares = await sessionShareService.getSessionShares(sessionId);\n      setShares(loadedShares);\n    } catch (error) {\n      console.error('[ShareDialog] Failed to load shares:', error);\n    }\n  };\n\n  const handleCreateShare = async () => {\n    setIsCreating(true);\n    try {\n      let expiresDays: number | undefined = expiresInDays;\n      \n      // Handle custom days\n      if (expiresInDays === -1 && customDays) {\n        const days = parseInt(customDays, 10);\n        if (isNaN(days) || days <= 0) {\n          alert('Please enter a valid number of days');\n          setIsCreating(false);\n          return;\n        }\n        expiresDays = days;\n      }\n\n      const share = await sessionShareService.createShare(sessionId, session, expiresDays);\n      setCreatedShare(share);\n      await loadShares(); // Refresh shares list\n    } catch (error) {\n      console.error('[ShareDialog] Failed to create share:', error);\n      alert('Failed to create share. Please try again.');\n    } finally {\n      setIsCreating(false);\n    }\n  };\n\n  const handleRevokeShare = async (shareId: string) => {\n    setRevokingShareId(shareId);\n    try {\n      await sessionShareService.revokeShare(shareId);\n      setShares(shares.filter((s) => s.shareId !== shareId));\n      if (createdShare?.shareId === shareId) {\n        setCreatedShare(null);\n      }\n    } catch (error) {\n      console.error('[ShareDialog] Failed to revoke share:', error);\n      alert('Failed to revoke share. Please try again.');\n    } finally {\n      setRevokingShareId(null);\n    }\n  };\n\n  const formatExpiryDate = (expiresAt: string | null): string => {\n    if (!expiresAt) {\n      return 'Never';\n    }\n    try {\n      const date = new Date(expiresAt);\n      return date.toLocaleDateString();\n    } catch {\n      return 'Invalid date';\n    }\n  };\n\n  const expiryOptions = [\n    { label: 'Never', value: undefined },\n    { label: '7 days', value: 7 },\n    { label: '30 days', value: 30 },\n    { label: '90 days', value: 90 },\n    { label: 'Custom', value: -1 },\n  ];\n\n\n  return (\n    <Modal title=\"Share Session\" isOpen={true} onDismiss={onClose}>\n      <div className=\"min-w-[400px]\">\n        {createdShare ? (\n          <div className=\"space-y-3\">\n            <p className=\"text-sm text-primary\">Share link created successfully!</p>\n            <div>\n              <label className=\"block text-xs font-medium mb-1 text-primary\">Share URL:</label>\n              <div className=\"flex gap-1.5\">\n                <Input\n                  value={sessionShareService.buildShareUrl(createdShare.shareId)}\n                  readOnly\n                  className=\"flex-1\"\n                />\n                <ClipboardButton\n                  icon=\"copy\"\n                  getText={() => sessionShareService.buildShareUrl(createdShare.shareId)}\n                >\n                  Copy\n                </ClipboardButton>\n              </div>\n            </div>\n            <div className=\"text-xs text-secondary\">\n              <strong>Expires:</strong> {formatExpiryDate(createdShare.expiresAt)}\n            </div>\n            <div className=\"flex gap-1.5 justify-end pt-2\">\n              <Button variant=\"secondary\" size=\"sm\" onClick={() => setCreatedShare(null)}>\n                Create Another Share\n              </Button>\n              <Button variant=\"primary\" size=\"sm\" onClick={onClose}>\n                Close\n              </Button>\n            </div>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            <div>\n              <label className=\"block text-xs font-medium mb-1 text-primary\">\n                Expiration:\n              </label>\n              <Select\n                options={expiryOptions.map((opt) => ({ label: opt.label, value: opt.value ?? null }))}\n                value={expiresInDays ?? null}\n                onChange={(option) => {\n                  if (option) {\n                    setExpiresInDays(option.value === null ? undefined : (option.value as number));\n                    if (option.value !== -1) {\n                      setCustomDays('');\n                    }\n                  }\n                }}\n                placeholder=\"Select expiration\"\n              />\n              {expiresInDays === -1 && (\n                <div className=\"mt-1.5\">\n                  <Input\n                    type=\"number\"\n                    placeholder=\"Enter number of days\"\n                    value={customDays}\n                    onChange={(e) => setCustomDays(e.currentTarget.value)}\n                    min={1}\n                  />\n                </div>\n              )}\n            </div>\n\n            <div className=\"p-2 bg-secondary rounded text-xs text-secondary\">\n              <p className=\"m-0\">\n                Shared sessions can be viewed in read-only mode. Recipients can import the session to their account.\n              </p>\n            </div>\n\n            {shares.length > 0 && (\n              <div>\n                <label className=\"block text-xs font-medium mb-1 text-primary\">\n                  Existing Shares:\n                </label>\n                <div className=\"flex flex-col gap-1.5\">\n                  {shares.map((share) => (\n                    <div\n                      key={share.shareId}\n                      className=\"flex justify-between items-center p-1.5 bg-secondary rounded border border-weak\"\n                    >\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"text-xs text-secondary overflow-hidden text-ellipsis\">\n                          {share.shareUrl}\n                        </div>\n                        <div className=\"text-xs text-disabled mt-0.5\">\n                          Expires: {formatExpiryDate(share.expiresAt)}\n                        </div>\n                      </div>\n                      <Button\n                        variant=\"destructive\"\n                        size=\"sm\"\n                        onClick={() => handleRevokeShare(share.shareId)}\n                        disabled={revokingShareId === share.shareId}\n                      >\n                        {revokingShareId === share.shareId ? 'Revoking...' : 'Revoke'}\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex gap-1.5 justify-end pt-2\">\n              <Button variant=\"secondary\" size=\"sm\" onClick={onClose}>\n                Cancel\n              </Button>\n              <Button variant=\"primary\" size=\"sm\" onClick={handleCreateShare} disabled={isCreating}>\n                {isCreating ? 'Creating...' : 'Create Share'}\n              </Button>\n            </div>\n          </div>\n        )}\n      </div>\n    </Modal>\n  );\n}\n","import React, { useState, useEffect, useRef } from 'react';\nimport { UseSessionManagerReturn } from '../../hooks/useSessionManager';\nimport { SessionMetadata } from '../../../../core';\nimport { LoadingOverlay, LoadingButton, InlineLoading } from '../../../LoadingOverlay';\nimport { ShareDialog } from '../ShareDialog/ShareDialog';\nimport { sessionShareService, CreateShareResponse } from '../../../../services/sessionShare';\nimport { ServiceFactory } from '../../../../core/services/ServiceFactory';\nimport { usePluginUserStorage, config } from '@grafana/runtime';\nimport { Icon, useTheme2 } from '@grafana/ui';\n\ninterface SessionSidebarProps {\n  sessionManager: UseSessionManagerReturn;\n  currentSessionId: string | null;\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport function SessionSidebar({ sessionManager, currentSessionId, isOpen, onClose }: SessionSidebarProps) {\n  const theme = useTheme2();\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState<string | null>(null);\n  const [showImport, setShowImport] = useState(false);\n  const [loadingAction, setLoadingAction] = useState<string | null>(null);\n  const [importLoading, setImportLoading] = useState(false);\n  const [creatingSession, setCreatingSession] = useState(false);\n  const [shareDialogSessionId, setShareDialogSessionId] = useState<string | null>(null);\n  const [sessionShares, setSessionShares] = useState<Map<string, CreateShareResponse[]>>(new Map());\n  const previousSessionIdsRef = useRef<string>('');\n  const isLoadingRef = useRef<boolean>(false);\n\n  // Create a stable string representation of session IDs for comparison\n  const sessionIdsString = sessionManager.sessions.map((s) => s.id).sort().join(',');\n\n  // Load shares when sidebar opens or when session IDs change\n  useEffect(() => {\n    if (!isOpen) {\n      return;\n    }\n\n    // Only reload if session IDs actually changed and we're not already loading\n    if (sessionIdsString === previousSessionIdsRef.current || isLoadingRef.current) {\n      return;\n    }\n\n    previousSessionIdsRef.current = sessionIdsString;\n    isLoadingRef.current = true;\n\n    const loadAllShares = async () => {\n      try {\n        const sharesMap = new Map<string, CreateShareResponse[]>();\n        for (const session of sessionManager.sessions) {\n          try {\n            const shares = await sessionShareService.getSessionShares(session.id);\n            sharesMap.set(session.id, shares);\n          } catch (error) {\n            console.error(`[SessionSidebar] Failed to load shares for session ${session.id}:`, error);\n          }\n        }\n        setSessionShares(sharesMap);\n      } finally {\n        isLoadingRef.current = false;\n      }\n    };\n    loadAllShares();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isOpen, sessionIdsString]); // sessionIdsString is a stable string value, won't cause infinite loops\n\n  const formatDate = (date: Date) => {\n    const now = new Date();\n    const diff = now.getTime() - date.getTime();\n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n\n    if (days === 0) {\n      return 'Today';\n    } else if (days === 1) {\n      return 'Yesterday';\n    } else if (days < 7) {\n      return `${days} days ago`;\n    } else {\n      return date.toLocaleDateString();\n    }\n  };\n\n  const handleLoadSession = async (sessionId: string) => {\n    setLoadingAction(`loading-${sessionId}`);\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 300)); // Small delay for UX\n      await sessionManager.loadSession(sessionId);\n      onClose();\n    } finally {\n      setLoadingAction(null);\n    }\n  };\n\n  const handleDeleteClick = (sessionId: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setShowDeleteConfirm(sessionId);\n  };\n\n  const confirmDelete = async (sessionId: string) => {\n    setLoadingAction(`deleting-${sessionId}`);\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 300)); // Small delay for UX\n      await sessionManager.deleteSession(sessionId);\n      setShowDeleteConfirm(null);\n    } finally {\n      setLoadingAction(null);\n    }\n  };\n\n  const handleExport = async (sessionId: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setLoadingAction(`exporting-${sessionId}`);\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 300)); // Small delay for UX\n      await sessionManager.exportSession(sessionId);\n    } finally {\n      setLoadingAction(null);\n    }\n  };\n\n  const handleImport = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setImportLoading(true);\n      const reader = new FileReader();\n      reader.onload = async (event) => {\n        const jsonData = event.target?.result as string;\n        await new Promise((resolve) => setTimeout(resolve, 500)); // Simulate processing\n        const success = await sessionManager.importSession(jsonData);\n        if (success) {\n          setShowImport(false);\n        } else {\n          alert('Failed to import session. Please check the file format.');\n        }\n        setImportLoading(false);\n      };\n      reader.onerror = () => {\n        setImportLoading(false);\n        alert('Failed to read file');\n      };\n      reader.readAsText(file);\n    }\n  };\n\n  const storagePercent = Math.round((sessionManager.storageStats.used / sessionManager.storageStats.total) * 100);\n\n  if (!isOpen) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex\">\n      {/* Backdrop - theme-aware overlay */}\n      <div \n        className=\"absolute inset-0\" \n        onClick={onClose}\n        style={{ \n          backgroundColor: theme.colors.background.canvas,\n          opacity: theme.isDark ? 0.9 : 0.8\n        }}\n      />\n\n      {/* Sidebar */}\n      <div \n        className=\"relative w-80 shadow-xl flex flex-col border-r border-weak\"\n        style={{ \n          backgroundColor: theme.colors.background.primary\n        }}\n      >\n        {/* Header */}\n        <div className=\"p-2 border-b border-weak\">\n          <div className=\"flex items-center justify-between mb-1\">\n            <h2 className=\"text-base font-semibold text-primary\">Chat History</h2>\n            <button \n              onClick={onClose} \n              className=\"p-0.5 hover:bg-secondary rounded text-secondary hover:text-primary transition-colors\" \n              title=\"Close\"\n            >\n              <Icon name=\"times\" size=\"sm\" />\n            </button>\n          </div>\n\n          {/* Actions */}\n          <div className=\"flex gap-1.5 mt-2\">\n            <LoadingButton\n              onClick={async () => {\n                setCreatingSession(true);\n                try {\n                  await sessionManager.createNewSession();\n                  onClose();\n                } catch (error) {\n                  console.error('[SessionSidebar] Failed to create new session:', error);\n                } finally {\n                  setCreatingSession(false);\n                }\n              }}\n              isLoading={creatingSession}\n              loadingText=\"Creating...\"\n              variant=\"primary\"\n              size=\"sm\"\n              className=\"flex-1\"\n            >\n              + New Chat\n            </LoadingButton>\n            <button\n              onClick={() => setShowImport(true)}\n              className=\"px-2 py-1 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary transition-colors\"\n              title=\"Import session\"\n              disabled={importLoading}\n            >\n              <Icon name=\"upload\" size=\"sm\" />\n            </button>\n          </div>\n\n          {/* Storage indicator */}\n          <div className=\"mt-2 text-xs text-secondary\">\n            <div className=\"flex justify-between mb-1\">\n              <span>{sessionManager.sessions.length} sessions</span>\n              <span>{storagePercent}% storage used</span>\n            </div>\n            <div className=\"w-full bg-surface rounded-full h-1\">\n              <div\n                className={`h-1 rounded-full ${storagePercent > 80 ? 'bg-error' : 'bg-primary'}`}\n                style={{ width: `${storagePercent}%` }}\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* Session list */}\n        <div className=\"flex-1 overflow-y-auto p-1.5\">\n          {sessionManager.sessions.length === 0 ? (\n            <div className=\"text-center text-secondary mt-8\">\n              <p className=\"text-sm\">No saved conversations yet</p>\n              <p className=\"text-xs mt-1\">Start a new chat to begin</p>\n            </div>\n          ) : (\n            <div className=\"space-y-0.5\">\n              {sessionManager.sessions.map((session: SessionMetadata) => (\n                <SessionItem\n                  key={session.id}\n                  session={session}\n                  isActive={session.id === currentSessionId}\n                  showDeleteConfirm={showDeleteConfirm === session.id}\n                  isLoading={loadingAction === `loading-${session.id}`}\n                  isDeleting={loadingAction === `deleting-${session.id}`}\n                  isExporting={loadingAction === `exporting-${session.id}`}\n                  hasShares={(sessionShares.get(session.id)?.length ?? 0) > 0}\n                  onLoad={() => handleLoadSession(session.id)}\n                  onDelete={(e) => handleDeleteClick(session.id, e)}\n                  onConfirmDelete={() => confirmDelete(session.id)}\n                  onCancelDelete={() => setShowDeleteConfirm(null)}\n                  onExport={(e) => handleExport(session.id, e)}\n                  onShare={() => setShareDialogSessionId(session.id)}\n                  formatDate={formatDate}\n                />\n              ))}\n            </div>\n          )}\n        </div>\n\n        {/* Footer actions */}\n        <div className=\"p-2 border-t border-weak\">\n          {sessionManager.sessions.length > 0 && (\n            <button\n              onClick={async () => {\n                if (confirm('Are you sure you want to delete all conversations? This cannot be undone.')) {\n                  try {\n                    await sessionManager.deleteAllSessions();\n                  } catch (error) {\n                    console.error('[SessionSidebar] Failed to delete all sessions:', error);\n                  }\n                }\n              }}\n              className=\"w-full px-2 py-1 text-xs text-error hover:bg-error/10 rounded transition-colors\"\n            >\n              Clear All History\n            </button>\n          )}\n        </div>\n\n        {/* Import modal */}\n        {showImport && (\n          <div className=\"absolute inset-0 bg-background flex items-center justify-center p-3 border border-weak\">\n            <LoadingOverlay isLoading={importLoading} message=\"Importing session...\">\n              <div className=\"w-full max-w-sm\">\n                <h3 className=\"text-sm font-semibold mb-2 text-primary\">Import Session</h3>\n                <input\n                  type=\"file\"\n                  accept=\".json\"\n                  onChange={handleImport}\n                  disabled={importLoading}\n                  className=\"w-full px-2 py-1 text-xs border border-weak rounded bg-background text-primary disabled:opacity-50\"\n                />\n                <button\n                  onClick={() => setShowImport(false)}\n                  disabled={importLoading}\n                  className=\"mt-2 w-full px-2 py-1 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </LoadingOverlay>\n          </div>\n        )}\n\n        {/* Share dialog */}\n        {shareDialogSessionId && (\n          <ShareDialogWrapper\n            sessionId={shareDialogSessionId}\n            onClose={async () => {\n              setShareDialogSessionId(null);\n              // Refresh shares for the session that was shared\n              try {\n                const shares = await sessionShareService.getSessionShares(shareDialogSessionId);\n                setSessionShares((prev) => {\n                  const next = new Map(prev);\n                  next.set(shareDialogSessionId, shares);\n                  return next;\n                });\n              } catch (error) {\n                console.error('[SessionSidebar] Failed to refresh shares:', error);\n              }\n            }}\n            existingShares={sessionShares.get(shareDialogSessionId) || []}\n          />\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Wrapper component to load session data for ShareDialog\nfunction ShareDialogWrapper({\n  sessionId,\n  onClose,\n  existingShares,\n}: {\n  sessionId: string;\n  onClose: () => void;\n  existingShares: CreateShareResponse[];\n}) {\n  const storage = usePluginUserStorage();\n  const orgId = String(config.bootData.user.orgId || '1');\n  const [session, setSession] = React.useState<any>(null);\n  const [loading, setLoading] = React.useState(true);\n\n  useEffect(() => {\n    const loadSession = async () => {\n      try {\n        const sessionService = ServiceFactory.getSessionService(storage);\n        const loadedSession = await sessionService.getSession(orgId, sessionId);\n        if (loadedSession) {\n          setSession(loadedSession);\n        }\n      } catch (error) {\n        console.error('[ShareDialogWrapper] Failed to load session:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n    loadSession();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [sessionId, orgId]); // storage is stable, don't include it to avoid unnecessary re-runs\n\n  if (loading || !session) {\n    return null;\n  }\n\n  return <ShareDialog sessionId={sessionId} session={session} onClose={onClose} existingShares={existingShares} />;\n}\n\ninterface SessionItemProps {\n  session: SessionMetadata;\n  isActive: boolean;\n  showDeleteConfirm: boolean;\n  isLoading?: boolean;\n  isDeleting?: boolean;\n  isExporting?: boolean;\n  hasShares?: boolean;\n  onLoad: () => void;\n  onDelete: (e: React.MouseEvent) => void;\n  onConfirmDelete: () => void;\n  onCancelDelete: () => void;\n  onExport: (e: React.MouseEvent) => void;\n  onShare: () => void;\n  formatDate: (date: Date) => string;\n}\n\nfunction SessionItem({\n  session,\n  isActive,\n  showDeleteConfirm,\n  isLoading = false,\n  isDeleting = false,\n  isExporting = false,\n  hasShares = false,\n  onLoad,\n  onDelete,\n  onConfirmDelete,\n  onCancelDelete,\n  onExport,\n  onShare,\n  formatDate,\n}: SessionItemProps) {\n  if (showDeleteConfirm) {\n    return (\n      <div className=\"p-2 bg-surface rounded border border-error\">\n        <p className=\"text-xs text-error mb-1.5\">Delete this conversation?</p>\n        <div className=\"flex gap-1.5\">\n          <LoadingButton\n            onClick={onConfirmDelete}\n            isLoading={isDeleting}\n            loadingText=\"Deleting...\"\n            variant=\"destructive\"\n            size=\"sm\"\n            className=\"flex-1\"\n          >\n            Delete\n          </LoadingButton>\n          <button\n            onClick={onCancelDelete}\n            disabled={isDeleting}\n            className=\"flex-1 px-1.5 py-0.5 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors\"\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      onClick={isLoading ? undefined : onLoad}\n      className={`p-1.5 rounded group transition-colors relative ${\n        isActive\n          ? 'bg-surface border border-primary'\n          : 'hover:bg-secondary border border-weak'\n      } ${isLoading ? 'cursor-wait' : 'cursor-pointer'}`}\n    >\n      {isLoading && (\n        <div className=\"absolute inset-0 flex items-center justify-center bg-background rounded border border-weak\">\n          <InlineLoading message=\"Loading...\" size=\"sm\" />\n        </div>\n      )}\n\n      <div className=\"flex items-start justify-between gap-1.5\">\n        <div className=\"flex-1 min-w-0\">\n          <h3 className=\"font-medium text-xs truncate text-primary\">{session.title}</h3>\n          <div className=\"flex items-center gap-1.5 mt-0.5 text-xs text-secondary\">\n            <span>{formatDate(session.updatedAt)}</span>\n            <span></span>\n            <span>{session.messageCount} messages</span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onShare();\n            }}\n            disabled={isLoading || isExporting}\n            className=\"p-0.5 hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors\"\n            title={hasShares ? 'View shares' : 'Share'}\n          >\n            <Icon name=\"share-alt\" size=\"sm\" />\n          </button>\n          <button\n            onClick={onExport}\n            disabled={isExporting}\n            className=\"p-0.5 hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors\"\n            title=\"Export\"\n          >\n            {isExporting ? <InlineLoading size=\"sm\" /> : <Icon name=\"arrow-down\" size=\"sm\" />}\n          </button>\n          <button\n            onClick={onDelete}\n            disabled={isLoading || isExporting}\n            className=\"p-0.5 hover:bg-surface rounded text-error hover:text-error disabled:opacity-50 transition-colors\"\n            title=\"Delete\"\n          >\n            <Icon name=\"trash-alt\" size=\"sm\" />\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","/**\n * Summarization Indicator Component\n * Shows visual feedback when the system is summarizing old messages to save context tokens\n */\n\nimport React from 'react';\nimport { InlineLoading, LoadingDots } from '../../../LoadingOverlay';\nimport { Icon } from '@grafana/ui';\n\ninterface SummarizationIndicatorProps {\n  isSummarizing: boolean;\n  hasSummary: boolean;\n  messageCount?: number;\n  className?: string;\n}\n\nexport function SummarizationIndicator({\n  isSummarizing,\n  hasSummary,\n  messageCount,\n  className = '',\n}: SummarizationIndicatorProps) {\n  if (!isSummarizing && !hasSummary) {\n    return null;\n  }\n\n  return (\n    <div\n      className={`px-4 py-3 bg-info-background border-l-4 border-info text-sm ${className}`}\n      role=\"status\"\n      aria-live=\"polite\"\n      aria-label={isSummarizing ? 'Summarizing conversation' : 'Conversation has been summarized'}\n    >\n      {isSummarizing ? (\n        <div className=\"flex items-center gap-3\">\n          <InlineLoading size=\"sm\" />\n          <div className=\"flex-1\">\n            <div className=\"font-medium text-info-text mb-1\">Optimizing conversation memory...</div>\n            <div className=\"text-xs text-secondary\">\n              Summarizing {messageCount ? `${messageCount} older messages` : 'older messages'} to preserve context while\n              reducing token usage\n            </div>\n          </div>\n        </div>\n      ) : (\n        <div className=\"flex items-center gap-3\">\n          <Icon name=\"check-circle\" className=\"text-info\" />\n          <div className=\"flex-1\">\n            <div className=\"font-medium text-info-text mb-1\">Conversation optimized</div>\n            <div className=\"text-xs text-secondary\">\n              Older messages have been summarized to maintain efficient context\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n/**\n * Minimal summarization badge for inline display\n */\nexport const SummarizationBadge: React.FC<{\n  isActive: boolean;\n  className?: string;\n}> = ({ isActive, className = '' }) => {\n  if (!isActive) {\n    return null;\n  }\n\n  return (\n    <div\n      className={`inline-flex items-center gap-1.5 px-2 py-1 bg-info-background rounded-full text-xs ${className}`}\n      role=\"status\"\n      aria-label=\"Summarizing conversation\"\n    >\n      <LoadingDots size=\"sm\" />\n      <span className=\"font-medium text-info-text\">Summarizing</span>\n    </div>\n  );\n};\n","import React from 'react';\n\nexport interface TabCloseButtonProps {\n  onClick: () => void;\n  color: string;\n}\n\nexport const TabCloseButton: React.FC<TabCloseButtonProps> = ({ onClick, color }) => {\n  return (\n    <button\n      onClick={(e) => {\n        e.stopPropagation();\n        onClick();\n      }}\n      className=\"p-1 mr-1 rounded hover:bg-black/20 transition-colors flex-shrink-0\"\n      style={{ color }}\n      aria-label=\"Close tab\"\n      title=\"Close tab\"\n    >\n      <svg\n        width=\"10\"\n        height=\"10\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      >\n        <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n        <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n};\n\n","import React, { useState, useEffect } from 'react';\nimport { useTheme2 } from '@grafana/ui';\nimport { GrafanaPageRef } from '../../types';\nimport { TabCloseButton } from './TabCloseButton';\nimport { useEmbeddingAllowed } from '../../hooks/useEmbeddingAllowed';\n\nexport interface SidePanelProps {\n  isOpen: boolean;\n  onClose: () => void;\n  pageRefs: Array<GrafanaPageRef & { messageIndex: number }>;\n  onRemoveTab?: (index: number) => void;\n}\n\nfunction getTabLabel(ref: GrafanaPageRef, index: number): string {\n  if (ref.title) {\n    return ref.title.length > 20 ? ref.title.substring(0, 20) + '...' : ref.title;\n  }\n  if (ref.type === 'dashboard' && ref.uid) {\n    return `Dashboard ${ref.uid.substring(0, 8)}`;\n  }\n  return ref.type === 'explore' ? 'Explore' : `Page ${index + 1}`;\n}\n\nfunction toRelativeUrl(url: string): string {\n  if (url.startsWith('http://') || url.startsWith('https://')) {\n    const match = url.match(/https?:\\/\\/[^/]+(\\/.*)/);\n    return match ? match[1] : url;\n  }\n  return url;\n}\n\nexport const SidePanel: React.FC<SidePanelProps> = ({ isOpen, onClose, pageRefs, onRemoveTab }) => {\n  const theme = useTheme2();\n  const [activeIndex, setActiveIndex] = useState(0);\n  const allowEmbedding = useEmbeddingAllowed();\n\n  const safeActiveIndex = Math.min(activeIndex, Math.max(0, pageRefs.length - 1));\n\n  useEffect(() => {\n    if (activeIndex !== safeActiveIndex) {\n      setActiveIndex(safeActiveIndex);\n    }\n  }, [activeIndex, safeActiveIndex]);\n\n  if (!isOpen || pageRefs.length === 0 || allowEmbedding === null || !allowEmbedding) {\n    return null;\n  }\n\n  const activeRef = pageRefs[safeActiveIndex];\n  const showTabs = pageRefs.length > 1;\n  const iframeSrc = toRelativeUrl(activeRef.url);\n\n  return (\n    <div\n      className=\"flex flex-col h-screen sticky top-0 border-r transition-all duration-300 ease-in-out\"\n      style={{\n        width: '800px',\n        minWidth: '400px',\n        maxWidth: '65%',\n        backgroundColor: theme.isDark ? '#1a1b1f' : theme.colors.background.primary,\n        borderColor: theme.colors.border.weak,\n      }}\n      role=\"complementary\"\n      aria-label=\"Grafana page preview\"\n    >\n      {/* Header */}\n      <div\n        className=\"flex items-center justify-between px-4 py-3 border-b flex-shrink-0\"\n        style={{\n          borderColor: theme.colors.border.weak,\n          backgroundColor: theme.isDark ? '#111217' : theme.colors.background.secondary,\n        }}\n      >\n        <div className=\"flex items-center gap-2\">\n          <svg\n            width=\"16\"\n            height=\"16\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            style={{ color: theme.colors.text.secondary }}\n          >\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\" />\n            <line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\" />\n          </svg>\n          <span className=\"text-sm font-medium\" style={{ color: theme.colors.text.primary }}>\n            {activeRef.title || (activeRef.type === 'explore' ? 'Explore' : 'Dashboard')}\n          </span>\n        </div>\n        <button\n          onClick={onClose}\n          className=\"p-1.5 rounded-md hover:bg-white/10 transition-colors\"\n          aria-label=\"Close panel\"\n          title=\"Close panel\"\n          style={{ color: theme.colors.text.secondary }}\n        >\n          <svg\n            width=\"16\"\n            height=\"16\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n          >\n            <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n            <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n          </svg>\n        </button>\n      </div>\n\n      {/* Tab bar */}\n      {showTabs && (\n        <div\n          className=\"flex gap-1 px-2 py-2 border-b flex-shrink-0\"\n          style={{\n            borderColor: theme.colors.border.weak,\n            backgroundColor: theme.isDark ? '#111217' : theme.colors.background.secondary,\n          }}\n          role=\"tablist\"\n        >\n          {pageRefs.map((ref, idx) => (\n            <div\n              key={`${ref.url}-${idx}`}\n              className=\"flex items-center gap-1 flex-1 min-w-0 rounded-md transition-colors\"\n              style={{\n                backgroundColor:\n                  idx === safeActiveIndex\n                    ? theme.colors.primary.main\n                    : theme.isDark\n                    ? 'rgba(255,255,255,0.05)'\n                    : 'rgba(0,0,0,0.05)',\n              }}\n              role=\"tab\"\n              aria-selected={idx === safeActiveIndex}\n            >\n              <button\n                onClick={() => setActiveIndex(idx)}\n                className=\"flex-1 min-w-0 px-3 py-1.5 text-xs truncate text-left\"\n                style={{\n                  color: idx === safeActiveIndex ? theme.colors.primary.contrastText : theme.colors.text.secondary,\n                }}\n                title={ref.url}\n              >\n                {getTabLabel(ref, idx)}\n              </button>\n              {onRemoveTab && (\n                <TabCloseButton\n                  onClick={() => onRemoveTab(idx)}\n                  color={idx === safeActiveIndex ? theme.colors.primary.contrastText : theme.colors.text.secondary}\n                />\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* Iframe content */}\n      <div className=\"flex-1 min-h-0\">\n        <iframe\n          src={iframeSrc}\n          title={activeRef.title || `Grafana ${activeRef.type}`}\n          className=\"w-full h-full border-0\"\n          style={{ backgroundColor: theme.colors.background.canvas }}\n        />\n      </div>\n    </div>\n  );\n};\n","import React, { useRef, useState, useCallback, useEffect } from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\nimport { useChat } from './hooks/useChat';\nimport { useGrafanaTheme } from './hooks/useGrafanaTheme';\nimport { useKeyboardNavigation, useAnnounce } from './hooks/useKeyboardNavigation';\nimport { useEmbeddingAllowed } from './hooks/useEmbeddingAllowed';\nimport {\n  ChatHeader,\n  ChatHistory,\n  ChatInput,\n  WelcomeMessage,\n  QuickSuggestions,\n  SessionSidebar,\n  SummarizationIndicator,\n  SidePanel,\n} from './components';\nimport { ChatInputRef } from './components/ChatInput/ChatInput';\nimport { ChatErrorBoundary } from '../ErrorBoundary';\nimport { SessionMetadata, ChatSession } from '../../core';\nimport type { AppPluginSettings } from '../../types/plugin';\n\ninterface ChatProps {\n  pluginSettings: AppPluginSettings;\n  readOnly?: boolean;\n  initialSession?: ChatSession;\n}\n\ninterface NewChatButtonProps {\n  onConfirm: () => void;\n  disabled: boolean;\n  theme: any;\n}\n\nconst NewChatButton: React.FC<NewChatButtonProps> = ({ onConfirm, disabled, theme }) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const popupRef = useRef<HTMLDivElement>(null);\n\n  // Close popup when clicking outside\n  React.useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (popupRef.current && !popupRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    if (isOpen) {\n      document.addEventListener('mousedown', handleClickOutside);\n    }\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [isOpen]);\n\n  return (\n    <div className=\"relative\">\n      <button\n        onClick={() => setIsOpen(!isOpen)}\n        disabled={disabled}\n        className=\"p-2 rounded-md hover:bg-white/10 transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n        aria-label=\"New chat\"\n        title=\"New chat\"\n        style={{ color: theme.colors.text.secondary }}\n      >\n        <svg\n          width=\"18\"\n          height=\"18\"\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth=\"2\"\n          strokeLinecap=\"round\"\n          strokeLinejoin=\"round\"\n        >\n          <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"></line>\n          <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"></line>\n        </svg>\n      </button>\n\n      {isOpen && (\n        <div\n          ref={popupRef}\n          className=\"absolute bottom-full left-0 mb-2 w-48 p-3 rounded-lg shadow-xl border z-50 flex flex-col gap-2\"\n          style={{\n            backgroundColor: theme.colors.background.primary,\n            borderColor: theme.colors.border.weak,\n          }}\n        >\n          <p className=\"text-xs font-medium mb-1\" style={{ color: theme.colors.text.primary }}>\n            Start a new chat?\n          </p>\n          <div className=\"flex gap-2\">\n            <button\n              onClick={() => {\n                onConfirm();\n                setIsOpen(false);\n              }}\n              className=\"flex-1 px-2 py-1 text-xs rounded font-medium transition-colors\"\n              style={{\n                backgroundColor: theme.colors.primary.main,\n                color: theme.colors.text.primary,\n              }}\n            >\n              Yes\n            </button>\n            <button\n              onClick={() => setIsOpen(false)}\n              className=\"flex-1 px-2 py-1 text-xs rounded font-medium transition-colors hover:bg-white/10\"\n              style={{\n                color: theme.colors.text.secondary,\n                border: `1px solid ${theme.colors.border.weak}`,\n              }}\n            >\n              No\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nfunction ChatComponent({ pluginSettings, readOnly = false, initialSession }: ChatProps) {\n  // Sync Grafana theme to CSS custom properties\n  useGrafanaTheme();\n  const theme = useTheme2();\n  const allowEmbedding = useEmbeddingAllowed();\n\n  const {\n    chatHistory,\n    currentInput,\n    isGenerating,\n    chatContainerRef,\n    toolsLoading,\n    toolsError,\n    setCurrentInput,\n    sendMessage,\n    handleKeyPress,\n    clearChat,\n\n    sessionManager,\n    bottomSpacerRef,\n    detectedPageRefs,\n  } = useChat(pluginSettings, readOnly ? initialSession : undefined);\n\n  const chatInputRef = useRef<ChatInputRef>(null);\n  const [isHistoryOpen, setIsHistoryOpen] = useState(false);\n  const [isSidePanelOpen, setIsSidePanelOpen] = useState(false);\n  const [removedTabUrls, setRemovedTabUrls] = useState<Set<string>>(new Set());\n  const prevSourceMessageIndexRef = useRef<number | null>(null);\n  const prevSessionIdRef = useRef<string | null>(null);\n  const announce = useAnnounce();\n\n  const visiblePageRefs = detectedPageRefs.filter((ref) => !removedTabUrls.has(ref.url));\n\n  const handleRemoveTab = useCallback(\n    (index: number) => {\n      const tabToRemove = visiblePageRefs[index];\n      if (tabToRemove) {\n        setRemovedTabUrls((prev) => new Set(prev).add(tabToRemove.url));\n      }\n    },\n    [visiblePageRefs]\n  );\n\n  useEffect(() => {\n    // Get the message index that the current page refs come from\n    const currentSourceIndex = detectedPageRefs.length > 0 ? detectedPageRefs[0].messageIndex : null;\n    const prevSourceIndex = prevSourceMessageIndexRef.current;\n    const currentSessionId = sessionManager.currentSessionId;\n    const prevSessionId = prevSessionIdRef.current;\n\n    // Reset state when session changes OR when page refs come from a different message\n    const sessionChanged = currentSessionId !== prevSessionId;\n    const messageIndexChanged = currentSourceIndex !== null && currentSourceIndex !== prevSourceIndex;\n\n    if (sessionChanged) {\n      // Always reset removed tabs when switching sessions to prevent cross-session state bleed\n      setRemovedTabUrls(new Set());\n      if (currentSourceIndex !== null) {\n        setIsSidePanelOpen(true);\n      }\n    } else if (messageIndexChanged) {\n      // New page refs from a different message in the same session\n      setIsSidePanelOpen(true);\n      setRemovedTabUrls(new Set());\n    }\n\n    prevSourceMessageIndexRef.current = currentSourceIndex;\n    prevSessionIdRef.current = currentSessionId;\n  }, [detectedPageRefs, sessionManager.currentSessionId]);\n\n  // Keyboard navigation callbacks\n  const focusChatInput = useCallback(() => {\n    chatInputRef.current?.focus();\n    announce('Chat input focused');\n  }, [announce]);\n\n  const openHistory = useCallback(() => {\n    setIsHistoryOpen(true);\n    announce('Chat history opened');\n  }, [announce]);\n\n  const exportCurrentChat = useCallback(() => {\n    if (sessionManager.currentSessionId) {\n      sessionManager.exportSession(sessionManager.currentSessionId);\n      announce('Chat exported');\n    }\n  }, [sessionManager, announce]);\n\n  // Set up keyboard shortcuts\n  useKeyboardNavigation({\n    onNewChat: () => {\n      sessionManager.createNewSession();\n      announce('New chat created');\n    },\n    onClearChat: () => {\n      if (window.confirm('Are you sure you want to clear the current chat?')) {\n        clearChat();\n        announce('Chat cleared');\n      }\n    },\n    onOpenHistory: openHistory,\n    onFocusInput: focusChatInput,\n    onExportChat: exportCurrentChat,\n  });\n\n  const handleSuggestionClick = (message: string) => {\n    setCurrentInput(message);\n    // Focus the input after setting the message\n    setTimeout(() => {\n      chatInputRef.current?.focus();\n    }, 100);\n    announce(`Suggestion selected: ${message.substring(0, 50)}...`);\n  };\n\n  if (toolsError) {\n    return <div>Error: {toolsError.message}</div>;\n  }\n\n  // Get current session title\n  const currentSession = sessionManager.sessions.find((s: SessionMetadata) => s.id === sessionManager.currentSessionId);\n  const currentSessionTitle = currentSession?.title;\n\n  const hasMessages = chatHistory.length > 0;\n  const showSidePanel = isSidePanelOpen && visiblePageRefs.length > 0 && allowEmbedding === true;\n\n  return (\n    <div\n      className=\"w-full min-h-full flex\"\n      role=\"main\"\n      aria-label=\"Chat interface\"\n      style={{\n        backgroundColor: theme.isDark ? '#111217' : theme.colors.background.canvas,\n      }}\n    >\n      {/* Side panel for Grafana page preview */}\n      <SidePanel\n        isOpen={showSidePanel}\n        onClose={() => setIsSidePanelOpen(false)}\n        pageRefs={visiblePageRefs}\n        onRemoveTab={handleRemoveTab}\n      />\n\n      {/* Main chat area */}\n      <div className=\"flex-1 flex flex-col min-h-0 min-w-0\">\n        {hasMessages ? (\n          <div\n            className={`flex-1 flex flex-col min-h-0 w-full px-4 ${showSidePanel ? 'max-w-none' : 'max-w-4xl mx-auto'}`}\n          >\n            {/* Header - only show when there are messages */}\n            <ChatHeader isGenerating={isGenerating} currentSessionTitle={currentSessionTitle} />\n\n            {/* Summarization indicator */}\n            <SummarizationIndicator\n              isSummarizing={sessionManager.isSummarizing}\n              hasSummary={!!sessionManager.currentSummary}\n            />\n\n            {/* Chat messages */}\n            <div\n              ref={chatContainerRef}\n              className=\"flex-1 py-6 rounded-lg\"\n              role=\"log\"\n              aria-label=\"Chat messages\"\n              aria-live=\"polite\"\n              aria-relevant=\"additions\"\n              tabIndex={0}\n              style={{\n                backgroundColor: theme.isDark ? '#1a1b1f' : theme.colors.background.primary,\n              }}\n            >\n              <div className=\"px-4\">\n                <ChatHistory chatHistory={chatHistory} isGenerating={isGenerating} />\n                <div ref={bottomSpacerRef} className=\"h-16\" style={{ scrollMarginBottom: '100px' }} />\n              </div>\n            </div>\n\n            {/* Chat input at bottom */}\n            {!readOnly && (\n              <div\n                className=\"flex-shrink-0 py-4 sticky bottom-0 z-10\"\n                role=\"region\"\n                aria-label=\"Message input\"\n                style={{\n                  backgroundColor: theme.isDark ? '#111217' : theme.colors.background.canvas,\n                }}\n              >\n                <ChatInput\n                  ref={chatInputRef}\n                  currentInput={currentInput}\n                  isGenerating={isGenerating}\n                  toolsLoading={toolsLoading}\n                  setCurrentInput={setCurrentInput}\n                  sendMessage={sendMessage}\n                  handleKeyPress={handleKeyPress}\n                  leftSlot={<NewChatButton onConfirm={clearChat} disabled={isGenerating} theme={theme} />}\n                  rightSlot={\n                    <button\n                      onClick={openHistory}\n                      className=\"flex items-center gap-2 px-2 py-1 text-xs font-medium rounded-md hover:bg-white/10 transition-colors\"\n                      aria-label=\"Chat history\"\n                      title=\"View chat history\"\n                      style={{ color: theme.colors.text.secondary }}\n                    >\n                      <svg\n                        width=\"14\"\n                        height=\"14\"\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"10\" />\n                        <polyline points=\"12 6 12 12 16 14\" />\n                      </svg>\n                      <span>View chat history ({sessionManager.sessions.length})</span>\n                    </button>\n                  }\n                />\n              </div>\n            )}\n          </div>\n        ) : (\n          /* Welcome state - centered layout, full width background */\n          /* Welcome state - centered layout with sticky input */\n          <div className=\"flex-1 flex flex-col min-h-0 w-full max-w-3xl mx-auto px-4\">\n            <div className=\"flex-1 flex flex-col items-center justify-center py-8\">\n              {/* Welcome header */}\n              <WelcomeMessage />\n\n              {/* Chat Input */}\n              <div className=\"w-full mt-10 mb-4\" role=\"region\" aria-label=\"Message input\">\n                <ChatInput\n                  ref={chatInputRef}\n                  currentInput={currentInput}\n                  isGenerating={isGenerating}\n                  toolsLoading={toolsLoading}\n                  setCurrentInput={setCurrentInput}\n                  sendMessage={sendMessage}\n                  handleKeyPress={handleKeyPress}\n                  leftSlot={undefined}\n                  rightSlot={\n                    <button\n                      onClick={openHistory}\n                      className=\"flex items-center gap-2 px-2 py-1 text-xs font-medium rounded-md hover:bg-white/10 transition-colors\"\n                      aria-label=\"Chat history\"\n                      title=\"View chat history\"\n                      style={{ color: theme.colors.text.secondary }}\n                    >\n                      <svg\n                        width=\"14\"\n                        height=\"14\"\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        strokeWidth=\"2\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"10\" />\n                        <polyline points=\"12 6 12 12 16 14\" />\n                      </svg>\n                      <span>View chat history ({sessionManager.sessions.length})</span>\n                    </button>\n                  }\n                />\n              </div>\n\n              {/* Quick suggestions */}\n              <div className=\"w-full\">\n                <QuickSuggestions onSuggestionClick={handleSuggestionClick} />\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Session sidebar */}\n      <SessionSidebar\n        sessionManager={sessionManager}\n        currentSessionId={sessionManager.currentSessionId}\n        isOpen={isHistoryOpen}\n        onClose={() => setIsHistoryOpen(false)}\n      />\n    </div>\n  );\n}\n\n// Export the Chat component wrapped with error boundary\nexport function Chat(props: ChatProps) {\n  return (\n    <ChatErrorBoundary>\n      <ChatComponent {...props} />\n    </ChatErrorBoundary>\n  );\n}\n","import { useEffect } from 'react';\nimport { useTheme2 } from '@grafana/ui';\n\n/**\n * Hook to sync Grafana theme to CSS custom properties\n * This ensures that the chat interface and embedded Scenes use the correct theme\n */\nexport const useGrafanaTheme = () => {\n  const theme = useTheme2();\n\n  useEffect(() => {\n    if (!theme) {\n      return;\n    }\n\n    // Get the root element\n    const root = document.documentElement;\n\n    // Sync Grafana theme colors to CSS custom properties\n    root.style.setProperty('--grafana-color-primary', theme.colors.primary.main);\n    root.style.setProperty('--grafana-color-primary-light', theme.colors.primary.shade);\n    root.style.setProperty('--grafana-color-primary-dark', theme.colors.primary.shade);\n    root.style.setProperty('--grafana-color-primary-transparent', theme.colors.primary.transparent);\n\n    root.style.setProperty('--grafana-color-secondary', theme.colors.secondary.main);\n    root.style.setProperty('--grafana-color-secondary-light', theme.colors.secondary.shade);\n    root.style.setProperty('--grafana-color-secondary-dark', theme.colors.secondary.shade);\n\n    root.style.setProperty('--grafana-color-background-primary', theme.colors.background.primary);\n    root.style.setProperty('--grafana-color-background-secondary', theme.colors.background.secondary);\n    root.style.setProperty('--grafana-color-background-canvas', theme.colors.background.canvas);\n    root.style.setProperty('--grafana-color-background-elevated', theme.colors.background.primary);\n\n    root.style.setProperty('--grafana-color-text-primary', theme.colors.text.primary);\n    root.style.setProperty('--grafana-color-text-secondary', theme.colors.text.secondary);\n    root.style.setProperty('--grafana-color-text-disabled', theme.colors.text.disabled);\n    root.style.setProperty('--grafana-color-text-link', theme.colors.text.link);\n    root.style.setProperty('--grafana-color-text-link-hover', theme.colors.text.link);\n    root.style.setProperty('--grafana-color-text-primary-inverse', theme.colors.text.primary);\n\n    root.style.setProperty('--grafana-color-border-weak', theme.colors.border.weak);\n    root.style.setProperty('--grafana-color-border-medium', theme.colors.border.medium);\n    root.style.setProperty('--grafana-color-border-strong', theme.colors.border.strong);\n\n    root.style.setProperty('--grafana-color-success', theme.colors.success.main);\n    root.style.setProperty('--grafana-color-success-light', theme.colors.success.shade);\n    root.style.setProperty('--grafana-color-success-dark', theme.colors.success.shade);\n\n    root.style.setProperty('--grafana-color-warning', theme.colors.warning.main);\n    root.style.setProperty('--grafana-color-warning-light', theme.colors.warning.shade);\n    root.style.setProperty('--grafana-color-warning-dark', theme.colors.warning.shade);\n\n    root.style.setProperty('--grafana-color-error', theme.colors.error.main);\n    root.style.setProperty('--grafana-color-error-light', theme.colors.error.shade);\n    root.style.setProperty('--grafana-color-error-dark', theme.colors.error.shade);\n\n    root.style.setProperty('--grafana-color-info', theme.colors.info.main);\n    root.style.setProperty('--grafana-color-info-light', theme.colors.info.shade);\n    root.style.setProperty('--grafana-color-info-dark', theme.colors.info.shade);\n\n    // Set spacing\n    root.style.setProperty('--grafana-spacing-xs', `${theme.spacing(0.5)}px`);\n    root.style.setProperty('--grafana-spacing-sm', `${theme.spacing(1)}px`);\n    root.style.setProperty('--grafana-spacing-md', `${theme.spacing(2)}px`);\n    root.style.setProperty('--grafana-spacing-lg', `${theme.spacing(3)}px`);\n    root.style.setProperty('--grafana-spacing-xl', `${theme.spacing(4)}px`);\n    root.style.setProperty('--grafana-spacing-xxl', `${theme.spacing(6)}px`);\n\n    // Set border radius\n    root.style.setProperty('--grafana-border-radius-sm', theme.shape.radius.default);\n    root.style.setProperty('--grafana-border-radius', theme.shape.radius.default);\n    root.style.setProperty('--grafana-border-radius-lg', theme.shape.radius.default);\n    root.style.setProperty('--grafana-border-radius-xl', theme.shape.radius.default);\n\n    // Set typography\n    root.style.setProperty('--grafana-font-family', theme.typography.fontFamily);\n    root.style.setProperty('--grafana-font-family-mono', theme.typography.fontFamilyMonospace);\n\n    console.log('[Theme] Grafana theme synced to CSS custom properties', {\n      isDark: theme.isDark,\n      name: theme.name,\n    });\n  }, [theme]);\n\n  return theme;\n};\n","/**\n * Keyboard Navigation Hook\n * Provides keyboard shortcuts and navigation support for the chat interface\n */\n\nimport { useEffect, useCallback } from 'react';\n\ninterface KeyboardShortcuts {\n  onNewChat?: () => void;\n  onClearChat?: () => void;\n  onOpenHistory?: () => void;\n  onFocusInput?: () => void;\n  onToggleTheme?: () => void;\n  onExportChat?: () => void;\n  onSearch?: () => void;\n}\n\nexport function useKeyboardNavigation({\n  onNewChat,\n  onClearChat,\n  onOpenHistory,\n  onFocusInput,\n  onToggleTheme,\n  onExportChat,\n  onSearch,\n}: KeyboardShortcuts) {\n  const handleKeyDown = useCallback(\n    (event: KeyboardEvent) => {\n      // Check if user is typing in an input/textarea\n      const isInputActive =\n        document.activeElement?.tagName === 'INPUT' ||\n        document.activeElement?.tagName === 'TEXTAREA' ||\n        document.activeElement?.getAttribute('contenteditable') === 'true';\n\n      // Global shortcuts (work even in inputs)\n      if (event.key === 'Escape') {\n        // Close any open modals or dialogs\n        const modal = document.querySelector('[role=\"dialog\"]');\n        if (modal) {\n          const closeButton = modal.querySelector('[aria-label*=\"Close\"]') as HTMLElement;\n          closeButton?.click();\n        }\n        return;\n      }\n\n      // Don't trigger shortcuts when typing\n      if (isInputActive && !event.metaKey && !event.ctrlKey) {\n        return;\n      }\n\n      // Cmd/Ctrl + K: Focus chat input\n      if ((event.metaKey || event.ctrlKey) && event.key === 'k') {\n        event.preventDefault();\n        onFocusInput?.();\n        return;\n      }\n\n      // Cmd/Ctrl + N: New chat\n      if ((event.metaKey || event.ctrlKey) && event.key === 'n') {\n        event.preventDefault();\n        onNewChat?.();\n        return;\n      }\n\n      // Cmd/Ctrl + Shift + Delete: Clear chat\n      if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'Delete') {\n        event.preventDefault();\n        onClearChat?.();\n        return;\n      }\n\n      // Cmd/Ctrl + H: Open history\n      if ((event.metaKey || event.ctrlKey) && event.key === 'h') {\n        event.preventDefault();\n        onOpenHistory?.();\n        return;\n      }\n\n      // Cmd/Ctrl + E: Export chat\n      if ((event.metaKey || event.ctrlKey) && event.key === 'e') {\n        event.preventDefault();\n        onExportChat?.();\n        return;\n      }\n\n      // Cmd/Ctrl + F: Search in chat\n      if ((event.metaKey || event.ctrlKey) && event.key === 'f') {\n        event.preventDefault();\n        onSearch?.();\n        return;\n      }\n\n      // Cmd/Ctrl + Shift + T: Toggle theme (if available)\n      if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'T') {\n        event.preventDefault();\n        onToggleTheme?.();\n        return;\n      }\n\n      // Tab navigation for message list\n      if (event.key === 'Tab' && !event.shiftKey && !isInputActive) {\n        const focusableElements = document.querySelectorAll(\n          'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex=\"-1\"])'\n        );\n\n        if (focusableElements.length > 0) {\n          const currentIndex = Array.from(focusableElements).indexOf(document.activeElement as Element);\n          const nextIndex = (currentIndex + 1) % focusableElements.length;\n          (focusableElements[nextIndex] as HTMLElement).focus();\n          event.preventDefault();\n        }\n      }\n\n      // Arrow key navigation for message list\n      if ((event.key === 'ArrowUp' || event.key === 'ArrowDown') && !isInputActive) {\n        const messages = document.querySelectorAll('[role=\"article\"]');\n        if (messages.length > 0) {\n          const currentFocused = document.activeElement;\n          const currentIndex = Array.from(messages).indexOf(currentFocused as Element);\n\n          let nextIndex: number;\n          if (event.key === 'ArrowUp') {\n            nextIndex = currentIndex > 0 ? currentIndex - 1 : messages.length - 1;\n          } else {\n            nextIndex = currentIndex < messages.length - 1 ? currentIndex + 1 : 0;\n          }\n\n          (messages[nextIndex] as HTMLElement).focus();\n          event.preventDefault();\n        }\n      }\n    },\n    [onNewChat, onClearChat, onOpenHistory, onFocusInput, onToggleTheme, onExportChat, onSearch]\n  );\n\n  useEffect(() => {\n    window.addEventListener('keydown', handleKeyDown);\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleKeyDown]);\n\n  // Return keyboard shortcut info for display\n  return {\n    shortcuts: [\n      { keys: ['', 'K'], description: 'Focus chat input', windows: ['Ctrl', 'K'] },\n      { keys: ['', 'N'], description: 'New chat', windows: ['Ctrl', 'N'] },\n      { keys: ['', 'H'], description: 'Open history', windows: ['Ctrl', 'H'] },\n      { keys: ['', 'E'], description: 'Export chat', windows: ['Ctrl', 'E'] },\n      { keys: ['', 'F'], description: 'Search in chat', windows: ['Ctrl', 'F'] },\n      { keys: ['', '', 'Delete'], description: 'Clear chat', windows: ['Ctrl', 'Shift', 'Delete'] },\n      { keys: ['Esc'], description: 'Close dialog', windows: ['Esc'] },\n      { keys: ['Tab'], description: 'Navigate elements', windows: ['Tab'] },\n      { keys: ['', ''], description: 'Navigate messages', windows: ['', ''] },\n    ],\n  };\n}\n\n/**\n * Hook for managing focus trap within a container\n */\nexport function useFocusTrap(containerRef: React.RefObject<HTMLElement>, isActive = true) {\n  useEffect(() => {\n    if (!isActive || !containerRef.current) {\n      return;\n    }\n\n    const container = containerRef.current;\n    const focusableElements = container.querySelectorAll(\n      'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex=\"-1\"])'\n    );\n\n    if (focusableElements.length === 0) {\n      return;\n    }\n\n    const firstElement = focusableElements[0] as HTMLElement;\n    const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;\n\n    const handleTabKey = (e: KeyboardEvent) => {\n      if (e.key !== 'Tab') {\n        return;\n      }\n\n      if (e.shiftKey) {\n        // Shift + Tab\n        if (document.activeElement === firstElement) {\n          lastElement.focus();\n          e.preventDefault();\n        }\n      } else {\n        // Tab\n        if (document.activeElement === lastElement) {\n          firstElement.focus();\n          e.preventDefault();\n        }\n      }\n    };\n\n    container.addEventListener('keydown', handleTabKey);\n\n    // Focus first element\n    firstElement.focus();\n\n    return () => {\n      container.removeEventListener('keydown', handleTabKey);\n    };\n  }, [containerRef, isActive]);\n}\n\n/**\n * Hook for announcing changes to screen readers\n */\nexport function useAnnounce() {\n  const announce = useCallback((message: string, priority: 'polite' | 'assertive' = 'polite') => {\n    const announcement = document.createElement('div');\n    announcement.setAttribute('role', 'status');\n    announcement.setAttribute('aria-live', priority);\n    announcement.setAttribute('aria-atomic', 'true');\n    announcement.style.position = 'absolute';\n    announcement.style.left = '-10000px';\n    announcement.style.width = '1px';\n    announcement.style.height = '1px';\n    announcement.style.overflow = 'hidden';\n    announcement.textContent = message;\n\n    document.body.appendChild(announcement);\n\n    setTimeout(() => {\n      document.body.removeChild(announcement);\n    }, 1000);\n  }, []);\n\n  return announce;\n}\n","/**\n * Custom error class for storage-related errors\n */\nexport class StorageError extends Error {\n  constructor(message: string, public readonly code: StorageErrorCode, public readonly cause?: Error) {\n    super(message);\n    this.name = 'StorageError';\n    Object.setPrototypeOf(this, StorageError.prototype);\n  }\n\n  static quotaExceeded(cause?: Error): StorageError {\n    return new StorageError(\n      'Storage quota exceeded. Please free up space or delete old sessions.',\n      StorageErrorCode.QUOTA_EXCEEDED,\n      cause\n    );\n  }\n\n  static notFound(itemType: string, itemId: string): StorageError {\n    return new StorageError(`${itemType} with ID \"${itemId}\" not found`, StorageErrorCode.NOT_FOUND);\n  }\n\n  static invalidData(message: string, cause?: Error): StorageError {\n    return new StorageError(`Invalid data: ${message}`, StorageErrorCode.INVALID_DATA, cause);\n  }\n\n  static unavailable(cause?: Error): StorageError {\n    return new StorageError('Storage is not available', StorageErrorCode.UNAVAILABLE, cause);\n  }\n}\n\nexport enum StorageErrorCode {\n  QUOTA_EXCEEDED = 'QUOTA_EXCEEDED',\n  NOT_FOUND = 'NOT_FOUND',\n  INVALID_DATA = 'INVALID_DATA',\n  UNAVAILABLE = 'UNAVAILABLE',\n  UNKNOWN = 'UNKNOWN',\n}\n","import { SessionRepository } from '../repositories/ISessionRepository';\nimport { ChatSession, SessionMetadata } from '../models/ChatSession';\nimport { ChatMessage } from '../../components/Chat/types';\nimport { StorageError } from '../errors/StorageError';\n\n/**\n * Session Service - Business logic layer for session management\n * Coordinates between repository and application layer\n */\nexport class SessionService {\n  constructor(private readonly repository: SessionRepository) {}\n\n  /**\n   * Get all sessions for an organization\n   */\n  async getAllSessions(orgId: string): Promise<SessionMetadata[]> {\n    return this.repository.findAll(orgId);\n  }\n\n  /**\n   * Get a session by ID\n   */\n  async getSession(orgId: string, sessionId: string): Promise<ChatSession | null> {\n    return this.repository.findById(orgId, sessionId);\n  }\n\n  /**\n   * Get current active session\n   */\n  async getCurrentSession(orgId: string): Promise<ChatSession | null> {\n    const currentId = await this.repository.getCurrentSessionId(orgId);\n    if (!currentId) {\n      return null;\n    }\n    return this.repository.findById(orgId, currentId);\n  }\n\n  /**\n   * Create a new session\n   */\n  async createSession(orgId: string, messages: ChatMessage[], title?: string): Promise<ChatSession> {\n    const session = ChatSession.create(messages, title);\n    await this.repository.save(orgId, session);\n    await this.repository.setCurrentSessionId(orgId, session.id);\n    return session;\n  }\n\n  /**\n   * Update an existing session\n   */\n  async updateSession(orgId: string, sessionId: string, messages: ChatMessage[], summary?: string): Promise<void> {\n    const session = await this.repository.findById(orgId, sessionId);\n\n    if (!session) {\n      // Session not found, create new one\n      console.warn(`[SessionService] Session ${sessionId} not found, creating new session`);\n      await this.createSession(orgId, messages);\n      return;\n    }\n\n    session.updateMessages(messages, summary);\n    await this.repository.save(orgId, session);\n  }\n\n  /**\n   * Delete a session\n   */\n  async deleteSession(orgId: string, sessionId: string): Promise<void> {\n    await this.repository.delete(orgId, sessionId);\n  }\n\n  /**\n   * Delete all sessions for an organization\n   */\n  async deleteAllSessions(orgId: string): Promise<void> {\n    await this.repository.deleteAll(orgId);\n  }\n\n  /**\n   * Set active session\n   */\n  async setActiveSession(orgId: string, sessionId: string): Promise<void> {\n    const session = await this.repository.findById(orgId, sessionId);\n    if (!session) {\n      throw StorageError.notFound('Session', sessionId);\n    }\n    await this.repository.setCurrentSessionId(orgId, sessionId);\n  }\n\n  /**\n   * Clear active session\n   */\n  async clearActiveSession(orgId: string): Promise<void> {\n    await this.repository.clearCurrentSessionId(orgId);\n  }\n\n  /**\n   * Export session as JSON\n   */\n  async exportSession(orgId: string, sessionId: string): Promise<string | null> {\n    const session = await this.repository.findById(orgId, sessionId);\n    if (!session) {\n      return null;\n    }\n    return JSON.stringify(session.toStorage(), null, 2);\n  }\n\n  /**\n   * Import session from JSON\n   */\n  async importSession(orgId: string, jsonData: string): Promise<ChatSession> {\n    try {\n      const data = JSON.parse(jsonData);\n\n      // Validate structure\n      if (!data.id || !data.messages || !Array.isArray(data.messages)) {\n        throw new Error('Invalid session format: missing required fields');\n      }\n\n      // Create new session with imported data\n      const messages = data.messages.map((msg: any) => ({\n        ...msg,\n        timestamp: new Date(msg.timestamp),\n      }));\n\n      const session = ChatSession.create(messages, data.title);\n      await this.repository.save(orgId, session);\n\n      return session;\n    } catch (error) {\n      throw StorageError.invalidData('Failed to import session', error as Error);\n    }\n  }\n\n  /**\n   * Get storage statistics\n   */\n  async getStorageStats(orgId: string) {\n    return this.repository.getStorageStats(orgId);\n  }\n\n  /**\n   * Auto-save session (debounced externally)\n   */\n  async autoSave(orgId: string, sessionId: string | null, messages: ChatMessage[]): Promise<void> {\n    if (messages.length === 0) {\n      return;\n    }\n\n    if (sessionId) {\n      await this.updateSession(orgId, sessionId, messages);\n    } else {\n      await this.createSession(orgId, messages);\n    }\n  }\n}\n","import { SessionRepository, StorageStats } from './ISessionRepository';\nimport { ChatSession, SessionMetadata } from '../models/ChatSession';\nimport { StorageError } from '../errors/StorageError';\nimport type { UserStorage } from '@grafana/data';\n\n/**\n * Grafana User Storage implementation of Session Repository\n * Uses Grafana's user storage API which automatically falls back to localStorage\n * if the user is not signed in\n */\nexport class GrafanaUserStorageRepository implements SessionRepository {\n  private readonly storageKeyPrefix = 'grafana-o11y-chat-';\n  private readonly maxSessions = 50;\n\n  constructor(private readonly storage: UserStorage) {\n    if (!storage) {\n      throw new Error('Storage object is required');\n    }\n  }\n\n  async findAll(orgId: string): Promise<SessionMetadata[]> {\n    try {\n      const indexKey = this.getSessionsIndexKey(orgId);\n      console.log('[GrafanaUserStorageRepository] findAll - orgId:', orgId, 'indexKey:', indexKey);\n      const indexData = await this.storage.getItem(indexKey);\n      console.log('[GrafanaUserStorageRepository] findAll - indexData:', indexData ? 'found' : 'not found');\n\n      if (!indexData) {\n        return [];\n      }\n\n      const sessions = JSON.parse(indexData);\n      console.log('[GrafanaUserStorageRepository] findAll - found sessions:', sessions.length);\n      return sessions.map((meta: any) => ({\n        ...meta,\n        createdAt: new Date(meta.createdAt),\n        updatedAt: new Date(meta.updatedAt),\n      }));\n    } catch (error) {\n      console.error('[GrafanaUserStorageRepository] Failed to load sessions index:', error);\n      throw StorageError.invalidData('Failed to parse sessions index', error as Error);\n    }\n  }\n\n  async findById(orgId: string, sessionId: string): Promise<ChatSession | null> {\n    try {\n      const sessionKey = this.getSessionKey(orgId, sessionId);\n      const sessionData = await this.storage.getItem(sessionKey);\n\n      if (!sessionData) {\n        return null;\n      }\n\n      const data = JSON.parse(sessionData);\n      return ChatSession.fromStorage(data);\n    } catch (error) {\n      console.error(`[GrafanaUserStorageRepository] Failed to load session ${sessionId}:`, error);\n      throw StorageError.invalidData(`Failed to parse session ${sessionId}`, error as Error);\n    }\n  }\n\n  async save(orgId: string, session: ChatSession): Promise<void> {\n    try {\n      // Update timestamp\n      session.updatedAt = new Date();\n      session.messageCount = session.messages.length;\n\n      // Save session\n      const sessionKey = this.getSessionKey(orgId, session.id);\n      const sessionData = JSON.stringify(session.toStorage());\n      console.log('[GrafanaUserStorageRepository] save - orgId:', orgId, 'sessionId:', session.id, 'key:', sessionKey, 'size:', sessionData.length, 'bytes');\n      await this.storage.setItem(sessionKey, sessionData);\n      console.log('[GrafanaUserStorageRepository] save - saved to user storage');\n\n      // Update index\n      await this.updateSessionIndex(orgId, session);\n    } catch (error) {\n      console.error('[GrafanaUserStorageRepository] Failed to save session:', error);\n      // Check if it's a quota error (localStorage fallback)\n      if (error instanceof Error && error.name === 'QuotaExceededError') {\n        await this.handleQuotaExceeded(orgId, session);\n      } else {\n        throw StorageError.unavailable(error as Error);\n      }\n    }\n  }\n\n  async delete(orgId: string, sessionId: string): Promise<void> {\n    try {\n      // Remove session data (use empty string since there's no removeItem)\n      const sessionKey = this.getSessionKey(orgId, sessionId);\n      await this.storage.setItem(sessionKey, '');\n\n      // Update index\n      const index = await this.findAll(orgId);\n      const updatedIndex = index.filter((s) => s.id !== sessionId);\n      await this.saveSessionsIndex(orgId, updatedIndex);\n\n      // Clear current session if deleted\n      const currentId = await this.getCurrentSessionId(orgId);\n      if (currentId === sessionId) {\n        await this.clearCurrentSessionId(orgId);\n      }\n    } catch (error) {\n      console.error('[GrafanaUserStorageRepository] Failed to delete session:', error);\n      throw StorageError.unavailable(error as Error);\n    }\n  }\n\n  async deleteAll(orgId: string): Promise<void> {\n    try {\n      const sessions = await this.findAll(orgId);\n\n      // Remove all session data\n      for (const session of sessions) {\n        const sessionKey = this.getSessionKey(orgId, session.id);\n        await this.storage.setItem(sessionKey, '');\n      }\n\n      // Remove index\n      const indexKey = this.getSessionsIndexKey(orgId);\n      await this.storage.setItem(indexKey, '');\n\n      // Clear current session\n      await this.clearCurrentSessionId(orgId);\n    } catch (error) {\n      console.error('[GrafanaUserStorageRepository] Failed to delete all sessions:', error);\n      throw StorageError.unavailable(error as Error);\n    }\n  }\n\n  async getCurrentSessionId(orgId: string): Promise<string | null> {\n    const key = this.getCurrentSessionKey(orgId);\n    const value = await this.storage.getItem(key);\n    return value || null;\n  }\n\n  async setCurrentSessionId(orgId: string, sessionId: string): Promise<void> {\n    const key = this.getCurrentSessionKey(orgId);\n    await this.storage.setItem(key, sessionId);\n  }\n\n  async clearCurrentSessionId(orgId: string): Promise<void> {\n    const key = this.getCurrentSessionKey(orgId);\n    await this.storage.setItem(key, '');\n  }\n\n  async getStorageStats(orgId: string): Promise<StorageStats> {\n    const sessions = await this.findAll(orgId);\n    \n    // Estimate storage usage based on session count\n    // Since we can't directly query storage size, we estimate based on average session size\n    const avgSessionSize = 5000; // Estimate: ~5KB per session\n    const estimatedUsed = sessions.length * avgSessionSize;\n    \n    // Use a reasonable total limit (Grafana manages actual quota)\n    const estimatedTotal = 10 * 1024 * 1024; // 10MB estimate\n\n    return {\n      used: estimatedUsed,\n      total: estimatedTotal,\n      sessionCount: sessions.length,\n    };\n  }\n\n  // Private helper methods\n\n  private async updateSessionIndex(orgId: string, session: ChatSession): Promise<void> {\n    const index = await this.findAll(orgId);\n    const existingIndex = index.findIndex((s) => s.id === session.id);\n\n    if (existingIndex >= 0) {\n      index[existingIndex] = session.getMetadata();\n    } else {\n      index.push(session.getMetadata());\n    }\n\n    await this.saveSessionsIndex(orgId, index);\n  }\n\n  private async saveSessionsIndex(orgId: string, sessions: SessionMetadata[]): Promise<void> {\n    // Sort by most recent first\n    const sorted = [...sessions].sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());\n\n    // Limit to max sessions\n    const limited = sorted.slice(0, this.maxSessions);\n\n    // Save index\n    const indexKey = this.getSessionsIndexKey(orgId);\n    const indexData = JSON.stringify(limited);\n    console.log('[GrafanaUserStorageRepository] saveSessionsIndex - orgId:', orgId, 'key:', indexKey, 'sessions:', limited.length);\n    await this.storage.setItem(indexKey, indexData);\n    console.log('[GrafanaUserStorageRepository] saveSessionsIndex - saved index to user storage');\n\n    // Clean up overflow\n    if (sorted.length > this.maxSessions) {\n      const toDelete = sorted.slice(this.maxSessions);\n      for (const session of toDelete) {\n        const sessionKey = this.getSessionKey(orgId, session.id);\n        await this.storage.setItem(sessionKey, '');\n      }\n    }\n  }\n\n  private async handleQuotaExceeded(orgId: string, session: ChatSession): Promise<void> {\n    console.warn('[GrafanaUserStorageRepository] Storage quota exceeded, cleaning up old sessions');\n\n    // Delete 10 oldest sessions\n    const sessions = await this.findAll(orgId);\n    const sortedByOldest = sessions.sort((a, b) => a.updatedAt.getTime() - b.updatedAt.getTime());\n\n    const toDelete = sortedByOldest.slice(0, 10);\n    for (const s of toDelete) {\n      await this.delete(orgId, s.id);\n    }\n\n    // Retry save\n    try {\n      const sessionKey = this.getSessionKey(orgId, session.id);\n      await this.storage.setItem(sessionKey, JSON.stringify(session.toStorage()));\n      await this.updateSessionIndex(orgId, session);\n    } catch (retryError) {\n      throw StorageError.quotaExceeded(retryError as Error);\n    }\n  }\n\n  // Key generation methods\n\n  private getSessionsIndexKey(orgId: string): string {\n    return `${this.storageKeyPrefix}org-${orgId}-sessions-index`;\n  }\n\n  private getCurrentSessionKey(orgId: string): string {\n    return `${this.storageKeyPrefix}org-${orgId}-current-session`;\n  }\n\n  private getSessionKey(orgId: string, sessionId: string): string {\n    return `${this.storageKeyPrefix}org-${orgId}-${sessionId}`;\n  }\n}\n","import { SessionService } from './SessionService';\nimport { GrafanaUserStorageRepository } from '../repositories/GrafanaUserStorageRepository';\nimport type { UserStorage } from '@grafana/data';\n\n/**\n * Service Factory - Simple dependency injection container\n * Creates and manages service instances with their dependencies\n */\nexport class ServiceFactory {\n  /**\n   * Create a new SessionService instance with the provided storage\n   * Note: We create a new instance each time since storage can change\n   * (e.g., when user signs in/out, the storage object reference changes)\n   * @param storage - UserStorage object from usePluginUserStorage() hook\n   *                  This automatically falls back to localStorage when user is not signed in\n   */\n  static getSessionService(storage: UserStorage): SessionService {\n    const repository = new GrafanaUserStorageRepository(storage);\n    return new SessionService(repository);\n  }\n\n  /**\n   * Reset all services (useful for testing)\n   * Note: This is a no-op now since we don't use singletons\n   */\n  static reset(): void {\n    // No-op: services are created fresh each time\n  }\n}\n"],"names":["LoadingOverlay","isLoading","message","variant","size","showSpinner","showProgress","progress","transparent","children","className","content","div","getSizeClass","Spinner","getSpinnerSize","aria-label","role","aria-live","style","width","Math","min","max","aria-valuenow","aria-valuemin","aria-valuemax","round","Portal","aria-modal","InlineLoading","spinnerSize","span","LoadingButton","loadingText","onClick","disabled","icon","type","button","getVariantClass","aria-busy","aria-disabled","ChatSession","create","messages","title","now","Date","sessionId","generateId","sessionTitle","generateTitle","length","fromStorage","data","id","map","msg","timestamp","createdAt","updatedAt","messageCount","summary","toStorage","this","updateMessages","getMetadata","random","toString","substring","firstUserMessage","find","trim","constructor","sessionShareService","sessionData","expiresInDays","response","firstValueFrom","getBackendSrv","fetch","url","baseUrl","method","showErrorAlert","Error","error","console","shareId","buildShareUrl","window","location","origin","backendMCPClient","cachedTools","tools","params","config","orgName","bootData","user","name","arguments","scopeOrgId","text","isError","isTool","toolName","some","tool","clearCache","status","mcpServers","RequestQueueService","execute","options","priority","defaultPriority","maxRetries","retryDelays","queue","maxQueueSize","Promise","resolve","reject","queueItem","retryCount","insertIndex","findIndex","item","push","splice","processQueue","activeRequests","maxConcurrent","checkRateLimit","delay","getRateLimitDelay","setTimeout","shift","queueTime","metrics","queuedTime","totalRequests","executeRequest","setImmediate","startTime","timeoutId","has","timeout","delete","failedRequests","requestPromise","set","recordRequest","result","clearTimeout","executionTime","successfulRequests","retryDelay","retriedRequests","i","requestCountResetTime","requestCount","requestsPerSecond","timeSinceReset","clear","getStatus","queueLength","getMetrics","avgQueueTime","reduce","a","b","avgExecutionTime","successRate","pendingRequests","completedRequests","updateConfig","promises","Array","from","values","allSettled","Map","llmRequestQueue","toolRequestQueue","tokenizerCache","TokenizerService","initialize","model","tokenizer","get","encodingForModel","warn","getTokenizer","countTokens","encode","ceil","countMessageTokens","tokens","isArray","part","tool_calls","toolCall","function","JSON","stringify","tool_call_id","countMessagesTokens","totalTokens","countToolTokens","toolsJson","calculateContextTokens","messageTokens","toolTokens","breakdown","system","assistant","truncateToTokenLimit","maxTokens","addEllipsis","targetTokens","truncatedTokens","slice","truncatedText","decode","estimatedChars","truncated","estimateCost","isOutput","pricing","input","output","modelPricing","getModelTokenLimit","validateTokenLimit","limit","estimateTokens","getTokenBudget","used","remaining","percentage","splitTextIntoChunks","maxTokensPerChunk","overlapTokens","chunks","words","split","currentChunk","startIndex","testChunk","endIndex","indexOf","overlapWords","getCost","inputTokens","outputTokens","inputCost","outputCost","totalCost","optimizePrompt","parts","userTokens","userInput","instructionTokens","instruction","remainingTokens","context","cleanup","bind","DASHBOARD_PATTERN","EXPLORE_PATTERN","MARKDOWN_LINK_PATTERN","extractDashboardUid","match","undefined","EXPLORE_PATH_CHECK","getPageType","includes","test","normalizeUrl","replace","getDedupeKey","dashboardMatch","exploreMatch","trimMessageContent","aggressive","wasTrimmed","trimToolResponseContent","trimMessagesToTokenLimit","formattedTools","contextInfo","messagesWithTrimmedTools","systemMessage","nonSystemMessages","trimmedMessages","testMessages","filter","Boolean","m","useStreamManager","setChatHistory","handleToolCalls","formatToolsForOpenAI","pluginSettings","abortControllerRef","useRef","isStreamingRef","useEffect","current","abort","getEffectiveMaxTokens","useCallback","maxTotalTokens","handleStreamingChatWithHistory","abortController","AbortController","effectiveMaxTokens","requestStartTime","add","withTimeout","promise","llm","LARGE","timeoutMs","operationName","race","_","firstChoice","choices","signal","aborted","DOMException","updateCallback","partialContent","prev","idx","abortSignal","currentIndex","nextIndex","abortHandler","addEventListener","once","pageRefs","links","seenUrls","Set","markdownMatches","matchAll","rawUrl","dedupeKey","uid","dashboardMatches","exploreMatches","parseGrafanaLinks","functionToolCalls","tc","newTrimmedMessages","elapsed","ConversationMemoryService","summarizeMessages","summaryPrompt","join","stream","lastValueFrom","pipe","fallbackSummarize","topics","createMemoryAwareHistory","allMessages","recentMessageCount","recentMessages","createContextSummaryMessage","shouldSummarize","threshold","extractToolCallContext","toolContext","forEach","toolCalls","buildContextWindow","systemPrompt","estimateContextSize","optimizeMessageHistory","total","needsSummary","recentCount","ReliabilityService","retryWithBackoff","operation","MAX_RETRIES","lastError","attempt","isRetryableError","RETRY_DELAYS","sleep","TypeError","errorMessage","String","toLowerCase","pattern","ms","categorizeError","errorStr","retryable","getUserFriendlyErrorMessage","categorized","saveRecoveryState","sessionStorage","setItem","RECOVERY_KEY","loadRecoveryState","getItem","parse","clearRecoveryState","removeItem","hasRecoveryState","safeOperation","fallback","validateToolCall","valid","key","maxCalls","windowMs","record","rateLimitMap","resetTime","count","checkCircuitBreaker","breaker","circuitBreakers","state","lastFailure","CIRCUIT_BREAKER_TIMEOUT","failures","recordCircuitBreakerFailure","CIRCUIT_BREAKER_THRESHOLD","recordCircuitBreakerSuccess","useChat","initialSession","orgId","systemPromptMode","customSystemPrompt","effectiveSystemPrompt","useMemo","mode","customPrompt","SYSTEM_PROMPT","buildEffectiveSystemPrompt","chatHistory","useState","currentInput","setCurrentInput","isGenerating","setIsGenerating","chatContainerRef","bottomSpacerRef","isAutoScroll","setIsAutoScroll","setRetryCount","toolsLoading","toolsError","toolsData","clearToolCalls","getRunningToolCallsCount","setToolCalls","activeToolCallsRef","isMountedRef","activeToolCalls","getAvailableTools","listTools","handleToolCall","f","running","args","toolCallPromise","callTool","finalContent","CallToolResultSchema","c","catch","finally","functionCalls","all","fc","hasRunningToolCalls","loading","value","useAsync","mcp","useMCPManager","sessionManager","storage","usePluginUserStorage","sessionService","ServiceFactory","getSessionService","currentSessionId","setCurrentSessionId","sessions","setSessions","currentSummary","setCurrentSummary","isSummarizing","setIsSummarizing","storageStats","setStorageStats","sessionCount","autoSaveTimerRef","refreshSessions","loadedSessions","getAllSessions","stats","getStorageStats","cancelled","session","getCurrentSession","createNewSession","clearActiveSession","loadSession","getSession","setActiveSession","deleteSession","deleteAllSessions","exportSession","jsonData","blob","Blob","URL","createObjectURL","document","createElement","href","download","body","appendChild","click","removeChild","revokeObjectURL","importSession","autoSaveMessages","sessionIdAtStart","updateSession","newSession","createSession","prevId","triggerSummarization","messagesToSummarize","useSessionManager","scrollIntoView","block","behavior","handleScroll","atBottom","innerHeight","scrollY","documentElement","scrollHeight","passive","removeEventListener","sendMessage","validatedInput","ValidationService","validateChatInput","userMessage","newChatHistory","assistantMessage","lastMessageIndex","wasGenerating","toolCallsMap","toolCallsArray","updateToolCallsInChatHistory","recovery","detectedPageRefs","ref","messageIndex","handleKeyPress","e","shiftKey","preventDefault","clearChat","cachedResult","fetchPromise","useEmbeddingAllowed","allowed","setAllowed","mounted","then","xFrameOptions","headers","ChatHeader","currentSessionTitle","theme","useTheme2","color","colors","secondary","CheckIcon","svg","height","viewBox","fill","stroke","strokeWidth","strokeLinecap","strokeLinejoin","polyline","points","XIcon","line","x1","y1","x2","y2","SpinnerIcon","path","d","ToolCallDisplay","isExpanded","setIsExpanded","inlineArgs","parsed","keys","Object","formatInlineArguments","hasArgs","canExpand","backgroundColor","isDark","border","primary","pre","formatFullArguments","ToolIcon","ChevronIcon","ToolCallsSection","runningCount","completedCount","errorCount","weak","index","GraphRendererComponent","query","showControls","defaultTimeRange","to","refreshInterval","visualizationType","scene","setScene","setIsLoading","currentVizType","setCurrentVizType","handleVizTypeChange","timeRange","SceneTimeRange","dataSource","getDataSourceSrv","getInstanceSettings","queryRunner","SceneQueryRunner","datasource","queries","refId","expr","format","instant","panel","PanelBuilders","stat","setTitle","setData","setOption","fields","calcs","build","gauge","table","piechart","showLegend","placement","PieChartType","Pie","PieChartLabels","Name","Percent","barchart","VizOrientation","Auto","VisibilityMode","heatmap","HeatmapColorMode","Scheme","scheme","steps","axisPlacement","AxisPlacement","Left","histogram","timeseries","layout","SceneFlexLayout","direction","SceneFlexItem","minHeight","controls","SceneTimePicker","SceneRefreshPicker","intervals","refresh","embeddedScene","EmbeddedScene","$timeRange","isCancelled","activationTimeout","activate","background","borderBottom","h4","RadioButtonGroup","label","onChange","Tooltip","IconButton","Component","borderTop","code","navigator","clipboard","writeText","GraphRenderer","props","ErrorBoundary","fallbackTitle","LogsRenderer","ds","queryType","logs","LogsDedupStrategy","none","LogsSortOrder","Descending","TracesRenderer","traces","getQueryType","language","parseAttributes","attrString","attrs","titleMatch","fromMatch","toMatch","vizMatch","vizValue","viz","ChatMessage","isLastMessage","showThinking","tabIndex","contentSections","sections","codeBlockRegex","lastIndex","exec","textContent","lang","sectionType","visualization","splitContentByPromQL","main","animationDelay","section","Streamdown","ChatHistory","ChatInput","forwardRef","rightSlot","leftSlot","textareaRef","validationError","setValidationError","useImperativeHandle","focus","setSelectionRange","autoResize","Alert","severity","textarea","rawValue","target","onKeyDown","placeholder","rows","lineHeight","aria-invalid","aria-describedby","Icon","displayName","SparkleIcon","xmlns","WelcomeMessage","p","h1","suggestions","QuickSuggestions","onSuggestionClick","suggestion","onMouseEnter","currentTarget","borderColor","onMouseLeave","ShareDialog","onClose","existingShares","setExpiresInDays","customDays","setCustomDays","isCreating","setIsCreating","createdShare","setCreatedShare","shares","setShares","revokingShareId","setRevokingShareId","loadShares","loadedShares","getSessionShares","formatExpiryDate","expiresAt","toLocaleDateString","expiryOptions","Modal","isOpen","onDismiss","Input","readOnly","ClipboardButton","getText","strong","Button","Select","opt","option","share","shareUrl","handleRevokeShare","revokeShare","s","alert","expiresDays","days","parseInt","isNaN","createShare","SessionSidebar","showDeleteConfirm","setShowDeleteConfirm","showImport","setShowImport","loadingAction","setLoadingAction","importLoading","setImportLoading","creatingSession","setCreatingSession","shareDialogSessionId","setShareDialogSessionId","sessionShares","setSessionShares","previousSessionIdsRef","isLoadingRef","sessionIdsString","sort","sharesMap","formatDate","date","diff","getTime","floor","storagePercent","canvas","opacity","h2","SessionItem","isActive","isDeleting","isExporting","hasShares","onLoad","handleLoadSession","onDelete","stopPropagation","handleDeleteClick","onConfirmDelete","confirmDelete","onCancelDelete","onExport","handleExport","onShare","confirm","h3","accept","file","files","reader","FileReader","onload","event","onerror","readAsText","ShareDialogWrapper","next","setSession","React","setLoading","loadedSession","SummarizationIndicator","hasSummary","TabCloseButton","SidePanel","onRemoveTab","activeIndex","setActiveIndex","allowEmbedding","safeActiveIndex","activeRef","showTabs","iframeSrc","startsWith","toRelativeUrl","minWidth","maxWidth","rect","x","y","rx","ry","aria-selected","contrastText","getTabLabel","iframe","src","NewChatButton","onConfirm","setIsOpen","popupRef","handleClickOutside","contains","ChatComponent","root","setProperty","shade","link","medium","success","warning","info","spacing","shape","radius","default","typography","fontFamily","fontFamilyMonospace","useGrafanaTheme","chatInputRef","isHistoryOpen","setIsHistoryOpen","isSidePanelOpen","setIsSidePanelOpen","removedTabUrls","setRemovedTabUrls","prevSourceMessageIndexRef","prevSessionIdRef","announce","announcement","setAttribute","position","left","overflow","visiblePageRefs","handleRemoveTab","tabToRemove","currentSourceIndex","prevSourceIndex","messageIndexChanged","focusChatInput","openHistory","onNewChat","onClearChat","onOpenHistory","onFocusInput","onToggleTheme","onExportChat","onSearch","handleKeyDown","isInputActive","activeElement","tagName","getAttribute","modal","querySelector","closeButton","metaKey","ctrlKey","focusableElements","querySelectorAll","currentFocused","useKeyboardNavigation","currentSession","hasMessages","showSidePanel","aria-relevant","scrollMarginBottom","circle","cx","cy","r","Chat","ChatErrorBoundary","StorageError","quotaExceeded","cause","notFound","itemType","itemId","invalidData","unavailable","super","setPrototypeOf","prototype","SessionService","repository","findAll","findById","currentId","getCurrentSessionId","save","deleteAll","clearCurrentSessionId","GrafanaUserStorageRepository","indexKey","getSessionsIndexKey","indexData","meta","sessionKey","getSessionKey","updateSessionIndex","handleQuotaExceeded","updatedIndex","saveSessionsIndex","getCurrentSessionKey","existingIndex","sorted","limited","maxSessions","toDelete","retryError","storageKeyPrefix","reset"],"ignoreList":[],"sourceRoot":""}