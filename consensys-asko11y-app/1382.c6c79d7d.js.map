{"version":3,"file":"1382.c6c79d7d.js","mappings":"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","sources":["webpack://consensys-asko11y-app/./services/validation.ts","webpack://consensys-asko11y-app/./components/Chat/constants.ts"],"sourcesContent":["/**\n * Input Validation Service\n * Provides comprehensive validation and sanitization for user inputs\n * to prevent XSS, injection attacks, and other security vulnerabilities\n */\n\nexport class ValidationService {\n  // Maximum allowed input length to prevent DoS\n  private static readonly MAX_INPUT_LENGTH = 10000;\n  private static readonly MAX_URL_LENGTH = 2048;\n  private static readonly MAX_QUERY_LENGTH = 5000;\n  static readonly MAX_SYSTEM_PROMPT_LENGTH = 15000;\n\n  /**\n   * Validates and sanitizes user chat input\n   * @param input Raw user input\n   * @returns Sanitized input or throws error if invalid\n   */\n  static validateChatInput(input: string): string {\n    if (!input || typeof input !== 'string') {\n      throw new Error('Input must be a non-empty string');\n    }\n\n    // Trim whitespace\n    const trimmed = input.trim();\n\n    if (trimmed.length === 0) {\n      throw new Error('Input cannot be empty');\n    }\n\n    if (trimmed.length > this.MAX_INPUT_LENGTH) {\n      throw new Error(`Input exceeds maximum length of ${this.MAX_INPUT_LENGTH} characters`);\n    }\n\n    const cleaned = this.removeControlCharacters(trimmed);\n\n    // Check for potential script injection patterns\n    if (this.containsScriptInjection(cleaned)) {\n      throw new Error('Input contains potentially harmful content');\n    }\n\n    return cleaned;\n  }\n\n  /**\n   * Validates PromQL/LogQL queries\n   * @param query Query string\n   * @param language Query language (promql or logql)\n   * @returns Validated query or throws error\n   */\n  static validateQuery(query: string, language: 'promql' | 'logql'): string {\n    if (!query || typeof query !== 'string') {\n      throw new Error('Query must be a non-empty string');\n    }\n\n    const trimmed = query.trim();\n\n    if (trimmed.length === 0) {\n      throw new Error('Query cannot be empty');\n    }\n\n    if (trimmed.length > this.MAX_QUERY_LENGTH) {\n      throw new Error(`Query exceeds maximum length of ${this.MAX_QUERY_LENGTH} characters`);\n    }\n\n    // Basic validation for common injection patterns\n    const dangerousPatterns = [\n      /;[\\s]*drop/i,\n      /;[\\s]*delete/i,\n      /;[\\s]*truncate/i,\n      /;[\\s]*alter/i,\n      /;[\\s]*create/i,\n      /;[\\s]*grant/i,\n      /;[\\s]*revoke/i,\n    ];\n\n    for (const pattern of dangerousPatterns) {\n      if (pattern.test(trimmed)) {\n        throw new Error('Query contains potentially dangerous operations');\n      }\n    }\n\n    // Language-specific validation\n    if (language === 'promql') {\n      this.validatePromQL(trimmed);\n    } else if (language === 'logql') {\n      this.validateLogQL(trimmed);\n    }\n\n    return trimmed;\n  }\n\n  /**\n   * Validates MCP server URLs\n   * @param url Server URL\n   * @returns Validated URL or throws error\n   */\n  static validateMCPServerURL(url: string): string {\n    if (!url || typeof url !== 'string') {\n      throw new Error('URL must be a non-empty string');\n    }\n\n    const trimmed = url.trim();\n\n    if (trimmed.length === 0) {\n      throw new Error('URL cannot be empty');\n    }\n\n    if (trimmed.length > this.MAX_URL_LENGTH) {\n      throw new Error(`URL exceeds maximum length of ${this.MAX_URL_LENGTH} characters`);\n    }\n\n    try {\n      const parsed = new URL(trimmed);\n\n      // Only allow http and https protocols\n      if (!['http:', 'https:'].includes(parsed.protocol)) {\n        throw new Error('Only HTTP and HTTPS protocols are allowed');\n      }\n\n      // Prevent localhost and private network access in production\n      // if (this.isProductionEnvironment()) {\n      //   if (this.isPrivateNetwork(parsed.hostname)) {\n      //     throw new Error('Access to private networks is not allowed');\n      //   }\n      // }\n\n      return trimmed;\n    } catch (error) {\n      if (error instanceof Error && error.message.includes('private')) {\n        throw error;\n      }\n      throw new Error('Invalid URL format');\n    }\n  }\n\n  /**\n   * Validates session data for import\n   * @param sessionData Raw session data\n   * @returns Validated session data or throws error\n   */\n  static validateSessionData(sessionData: any): any {\n    if (!sessionData || typeof sessionData !== 'object') {\n      throw new Error('Session data must be an object');\n    }\n\n    // Check required fields\n    if (!sessionData.id || typeof sessionData.id !== 'string') {\n      throw new Error('Session must have a valid ID');\n    }\n\n    if (!sessionData.title || typeof sessionData.title !== 'string') {\n      throw new Error('Session must have a valid title');\n    }\n\n    if (!Array.isArray(sessionData.messages)) {\n      throw new Error('Session must have a messages array');\n    }\n\n    // Validate each message\n    for (const message of sessionData.messages) {\n      if (!message.role || !['user', 'assistant', 'tool'].includes(message.role)) {\n        throw new Error('Invalid message role');\n      }\n\n      if (typeof message.content !== 'string') {\n        throw new Error('Message content must be a string');\n      }\n\n      // Sanitize message content\n      message.content = this.sanitizeMessageContent(message.content);\n    }\n\n    // Validate title length\n    if (sessionData.title.length > 200) {\n      sessionData.title = sessionData.title.substring(0, 200);\n    }\n\n    return sessionData;\n  }\n\n  /**\n   * Sanitizes message content for safe display\n   * @param content Message content\n   * @returns Sanitized content\n   */\n  static sanitizeMessageContent(content: string): string {\n    if (!content) {\n      return '';\n    }\n\n    // Remove potentially dangerous HTML tags\n    const sanitized = content\n      .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n      .replace(/<iframe\\b[^<]*(?:(?!<\\/iframe>)<[^<]*)*<\\/iframe>/gi, '')\n      .replace(/<object\\b[^<]*(?:(?!<\\/object>)<[^<]*)*<\\/object>/gi, '')\n      .replace(/<embed\\b[^<]*(?:(?!<\\/embed>)<[^<]*)*<\\/embed>/gi, '')\n      .replace(/<link\\b[^>]*>/gi, '')\n      .replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, '');\n\n    // Remove event handlers\n    const eventHandlerPattern = /\\s*on\\w+\\s*=\\s*[\"']?[^\"']*[\"']?/gi;\n    return sanitized.replace(eventHandlerPattern, '');\n  }\n\n  /**\n   * Escapes HTML entities to prevent XSS\n   * @param text Text to escape\n   * @returns Escaped text\n   */\n  static escapeHTML(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Validates configuration values\n   * @param key Configuration key\n   * @param value Configuration value\n   * @returns Validated value or throws error\n   */\n  static validateConfigValue(key: string, value: any): any {\n    const configValidators: Record<string, (val: any) => any> = {\n      maxSessions: (val) => {\n        const num = Number(val);\n        if (isNaN(num) || num < 1 || num > 1000) {\n          throw new Error('Max sessions must be between 1 and 1000');\n        }\n        return num;\n      },\n      tokenLimit: (val) => {\n        const num = Number(val);\n        if (isNaN(num) || num < 100 || num > 100000) {\n          throw new Error('Token limit must be between 100 and 100000');\n        }\n        return num;\n      },\n      logLevel: (val) => {\n        const validLevels = ['debug', 'info', 'warn', 'error'];\n        if (!validLevels.includes(val)) {\n          throw new Error(`Log level must be one of: ${validLevels.join(', ')}`);\n        }\n        return val;\n      },\n      streamingDelay: (val) => {\n        const num = Number(val);\n        if (isNaN(num) || num < 0 || num > 1000) {\n          throw new Error('Streaming delay must be between 0 and 1000ms');\n        }\n        return num;\n      },\n    };\n\n    const validator = configValidators[key];\n    if (validator) {\n      return validator(value);\n    }\n\n    // Default validation for unknown keys\n    if (typeof value === 'string' && value.length > 1000) {\n      throw new Error('Configuration value too long');\n    }\n\n    return value;\n  }\n\n  // Private helper methods\n\n  /**\n   * Removes null bytes and control characters (except newlines and tabs)\n   * @param input String to clean\n   * @returns Cleaned string\n   */\n  private static removeControlCharacters(input: string): string {\n    return input.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');\n  }\n\n  private static containsScriptInjection(input: string): boolean {\n    const dangerousPatterns = [\n      /<script\\b/i,\n      /javascript:/i,\n      /on\\w+\\s*=/i, // Event handlers\n      /<iframe/i,\n      /<object/i,\n      /<embed/i,\n      /eval\\s*\\(/i,\n      /expression\\s*\\(/i,\n      /vbscript:/i,\n      /data:text\\/html/i,\n    ];\n\n    return dangerousPatterns.some((pattern) => pattern.test(input));\n  }\n\n  private static validatePromQL(query: string): void {\n    // Basic PromQL structure validation\n    // This is a simplified validation - full PromQL parsing would be complex\n\n    // Check for balanced parentheses\n    let parenCount = 0;\n    for (const char of query) {\n      if (char === '(') {\n        parenCount++;\n      }\n      if (char === ')') {\n        parenCount--;\n      }\n      if (parenCount < 0) {\n        throw new Error('Unbalanced parentheses in PromQL query');\n      }\n    }\n    if (parenCount !== 0) {\n      throw new Error('Unbalanced parentheses in PromQL query');\n    }\n\n    // Check for balanced brackets\n    let bracketCount = 0;\n    for (const char of query) {\n      if (char === '[') {\n        bracketCount++;\n      }\n      if (char === ']') {\n        bracketCount--;\n      }\n      if (bracketCount < 0) {\n        throw new Error('Unbalanced brackets in PromQL query');\n      }\n    }\n    if (bracketCount !== 0) {\n      throw new Error('Unbalanced brackets in PromQL query');\n    }\n\n    // Check for balanced braces\n    let braceCount = 0;\n    for (const char of query) {\n      if (char === '{') {\n        braceCount++;\n      }\n      if (char === '}') {\n        braceCount--;\n      }\n      if (braceCount < 0) {\n        throw new Error('Unbalanced braces in PromQL query');\n      }\n    }\n    if (braceCount !== 0) {\n      throw new Error('Unbalanced braces in PromQL query');\n    }\n  }\n\n  private static validateLogQL(query: string): void {\n    // Basic LogQL structure validation\n    // Similar to PromQL but with LogQL-specific checks\n\n    // Check for balanced brackets and quotes\n    this.validatePromQL(query); // Reuse basic structure validation\n\n    // LogQL-specific: Check for valid stream selectors\n    if (!query.includes('{') && !query.includes('}')) {\n      // LogQL queries should typically have stream selectors\n      console.warn('LogQL query may be missing stream selectors');\n    }\n  }\n\n  /**\n   * Sanitize HTML content\n   */\n  static sanitizeHTML(html: string): string {\n    const replacements: { [key: string]: string } = {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#x27;',\n      '/': '&#x2F;',\n    };\n\n    return html.replace(/[&<>\"'\\/]/g, (char) => replacements[char]);\n  }\n\n  /**\n   * Validate JSON string\n   */\n  static validateJSON(jsonString: string): any {\n    if (!jsonString || typeof jsonString !== 'string') {\n      throw new Error('Invalid JSON format');\n    }\n\n    // Check size limit (1MB)\n    if (jsonString.length > 1024 * 1024) {\n      throw new Error('JSON string exceeds maximum size of 1MB');\n    }\n\n    try {\n      return JSON.parse(jsonString);\n    } catch (error) {\n      throw new Error('Invalid JSON format');\n    }\n  }\n\n  /**\n   * Validate file name\n   */\n  static validateFileName(fileName: string): string {\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error('File name must be a non-empty string');\n    }\n\n    if (fileName.length > 255) {\n      throw new Error('File name exceeds maximum length of 255 characters');\n    }\n\n    // Check for path traversal attempts\n    if (fileName.includes('../') || fileName.includes('..\\\\') || fileName.startsWith('/')) {\n      throw new Error('File name contains invalid characters');\n    }\n\n    // Check for invalid characters\n    const invalidChars = /[\\x00-\\x1f\\x7f<>:\"|?*\\\\]/;\n    if (invalidChars.test(fileName)) {\n      throw new Error('File name contains invalid characters');\n    }\n\n    return fileName;\n  }\n\n  /**\n   * Validate API key\n   */\n  static validateAPIKey(apiKey: string): string {\n    if (!apiKey || typeof apiKey !== 'string') {\n      throw new Error('API key cannot be empty');\n    }\n\n    if (apiKey.length > 512) {\n      throw new Error('API key exceeds maximum length');\n    }\n\n    // Check for control characters\n    const controlChars = /[\\x00-\\x1f\\x7f]/;\n    if (controlChars.test(apiKey)) {\n      throw new Error('API key contains invalid characters');\n    }\n\n    return apiKey;\n  }\n\n  /**\n   * Validates custom system prompt\n   * @param prompt Custom system prompt string\n   * @param isRequired Whether the prompt is required (when mode is replace or append)\n   * @returns Validated prompt or throws error\n   */\n  static validateCustomSystemPrompt(prompt: string, isRequired: boolean): string {\n    if (isRequired) {\n      if (!prompt || typeof prompt !== 'string') {\n        throw new Error('Custom system prompt is required');\n      }\n\n      const trimmed = prompt.trim();\n\n      if (trimmed.length === 0) {\n        throw new Error('Custom system prompt cannot be empty');\n      }\n\n      if (trimmed.length > this.MAX_SYSTEM_PROMPT_LENGTH) {\n        throw new Error(`Custom system prompt exceeds maximum length of ${this.MAX_SYSTEM_PROMPT_LENGTH} characters`);\n      }\n\n      return this.removeControlCharacters(trimmed);\n    }\n\n    // If not required and empty, return empty string\n    if (!prompt || typeof prompt !== 'string') {\n      return '';\n    }\n\n    const trimmed = prompt.trim();\n\n    if (trimmed.length > this.MAX_SYSTEM_PROMPT_LENGTH) {\n      throw new Error(`Custom system prompt exceeds maximum length of ${this.MAX_SYSTEM_PROMPT_LENGTH} characters`);\n    }\n\n    return this.removeControlCharacters(trimmed);\n  }\n}\n\n// Export validation functions for convenience\nexport const {\n  validateChatInput,\n  validateQuery,\n  validateMCPServerURL,\n  validateSessionData,\n  sanitizeMessageContent,\n  escapeHTML,\n  validateConfigValue,\n  validateCustomSystemPrompt,\n} = ValidationService;\n","export const SYSTEM_PROMPT = `\nYou are an expert Observability Assistant specializing in the Grafana LGTM stack (Loki, Grafana, Tempo, Mimir/Prometheus). Your primary focus is troubleshooting, root cause analysis, and providing direct, actionable answers.\n\n## PRIMARY DIRECTIVE: Use MCP Tools First\n\n**ALWAYS prioritize using your available MCP tools to gather real data from connected systems.** These tools give you direct access to live metrics, logs, dashboards, and configuration data. Use them proactively and extensively.\n\n### Critical Tool Usage Rules\n\n1. **Respect tool schemas**: Provide all required parameters with correct data types (strings as \"value\", numbers as 42, not \"42\", properly structured objects/arrays)\n2. **Validate before calling**: Check that you have all required information before calling a tool. If missing required parameters, ask the user for clarification\n3. **Follow parameter constraints**: Respect any constraints like enum values, patterns, or ranges specified in the schema\n4. **Auto-recover from errors**: If a tool call fails due to missing fields, extract the field name from the error and immediately retry (ask user if value cannot be inferred)\n5. **Never invent parameters**: Only use parameters defined in the tool's schema\n\n### Tool Execution Efficiency\n\n**Use tools efficiently and only when necessary.**\n\nFor maximum efficiency, whenever you perform multiple independent operations, invoke all relevant tools simultaneously rather than sequentially. Prioritize calling tools in parallel whenever possible.\n\n**Parallel vs Sequential Tool Calls:**\n- **Parallel**: Use when operations are independent and results don't depend on each other\n  - Example: Fetching alerts + logs + metrics for different systems simultaneously\n  - Example: Querying multiple datasources at once\n  - Example: Listing dashboards + teams + users concurrently\n- **Sequential**: Use ONLY when results from one tool determine parameters for the next\n  - Example: Search dashboards first, then get specific dashboard by UID from results\n  - Example: List metric names, then query specific metric values based on what was found\n  - Example: Get trace ID from search, then fetch full trace details\nIf a parallel call fails, consider falling back to sequential\n**Default to parallel execution unless there's a clear dependency.**\n\n### When to Use Tools (Always!)\n\n- **Before answering**: Use tools to fetch current data instead of making assumptions\n- **For any data request**: Query tools to get real metrics, logs, traces, alerts, or configuration\n- **For troubleshooting**: Gather actual system state using multiple tools\n- **For verification**: Check current state before and after suggesting changes\n- **When uncertain**: Query additional tools rather than speculating\n\n### Core Capabilities (MCP Tools)\n\n**Grafana Tools** - Use these to explore and manage Grafana:\n- Teams & users management (list_teams, list_users_by_org)\n- Dashboard operations (search_dashboards, get_dashboard_by_uid, update_dashboard)\n- Panel and datasource inspection (get_dashboard_panel_queries, list_datasources)\n- Alert management (list_alert_rules, get_alert_rule_by_uid)\n\n**Prometheus/Mimir Tools** - Use these for metrics:\n- Query execution (query_prometheus)\n- Metric discovery (list_prometheus_metric_names, list_prometheus_metric_metadata)\n- Label exploration (list_prometheus_label_names, list_prometheus_label_values)\n\n**Loki Tools** - Use these for logs:\n- Log queries (query_loki_logs) - Query logs with LogQL\n- Label discovery (list_loki_label_names, list_loki_label_values)\n- Log statistics (query_loki_stats)\n\n**Tempo Tools** - Use these for distributed tracing with TraceQL:\n- TraceQL search (traceql_search_post) - Search for traces using TraceQL queries\n- TraceQL documentation (docs_traceql_post) - Get comprehensive TraceQL documentation including syntax, attributes, aggregates, and examples\n- Attribute discovery (get_attribute_names_post) - List available attribute names for TraceQL queries\n- Attribute values (get_attribute_values_post) - Get values for specific attributes (e.g., resource.service.name to list all services)\n- Trace retrieval (get_trace_post) - Retrieve a specific trace by ID\n- TraceQL metrics (instant) (traceql_metrics_instant_post) - Get instant metric values from TraceQL metrics queries\n- TraceQL metrics (range) (traceql_metrics_range_post) - Get metric time series from TraceQL metrics queries\n\n**Alert Management Tools** - Use these for alert and notification management:\n- List alert rules (list_alert_rules) - Get all configured alert rules (paginated - use page parameter to navigate results)\n  - Optional datasourceUid parameter: omit for Grafana-managed alerts, or specify a datasource UID for Prometheus/Loki datasource alerts\n  - **IMPORTANT**: Always check Prometheus datasource alerts FIRST by calling with the Prometheus datasourceUid, then check Grafana alerts\n- Get alert rule (get_alert_rule_by_uid) - Retrieve a specific alert rule by its UID\n  - Optional datasourceUid parameter: omit for Grafana-managed alerts, or specify a datasource UID for Prometheus/Loki datasource alerts\n- List contact points (list_contact_points) - Get all notification contact points/integrations\n\n**Utilities:**\n- Link generation (generate_deeplink)\n\n---\n\n## ⚠️ ALERT QUERIES - SPECIAL PRIORITY\n\n**For ANY question about alerts, incidents, or \"what's wrong\":**\n1. **FIRST**: Use \\`list_datasources\\` to get the Prometheus datasource UID\n2. **SECOND**: Use \\`list_alert_rules\\` with the Prometheus datasourceUid to check Prometheus datasource alerts (most common)\n3. **THIRD**: Use \\`list_alert_rules\\` without datasourceUid to check Grafana-managed alerts\n4. **THEN**: Use \\`get_alert_rule_by_uid\\` for specific alert rule details if needed\n5. **FINALLY**: Cross-reference with logs (query_loki_logs), traces (traceql_search_post), and metrics (query_prometheus) for root cause context\n\n**CRITICAL**: Always check Prometheus datasource alerts FIRST as they are the primary source of alerting rules. Then check Grafana-managed alerts as a fallback.\n\n**Common alert scenarios:**\n- \"What alert rules are configured?\" → Get Prometheus datasourceUid, then \\`list_alert_rules\\` with that UID, then without UID for Grafana alerts\n- \"Show me alert rule X\" → \\`get_alert_rule_by_uid\\` with specific UID (and datasourceUid if it's a datasource alert)\n- \"What's wrong with service X?\" → Check Prometheus alerts first, then Grafana alerts, then correlate with logs/traces\n- \"What contact points are configured?\" → \\`list_contact_points\\`\n\n---\n\n## Your Approach\n\n**Be Direct and Concise:**\n- Get straight to the answer - no lengthy preambles\n- Provide working queries/solutions first, explain second\n- Use bullet points over paragraphs\n\n**Tool-First Root Cause Analysis:**\nWhen troubleshooting, ALWAYS use tools at each step:\n1. **Identify symptoms** - What's the observed behavior?\n2. **Gather data with tools** - Use list_alert_rules, query_loki_logs, traceql_search_post, query_prometheus\n3. **Analyze patterns** - Look for correlations in the fetched data, use multiple tools to cross-reference\n4. **Determine root cause** - Pinpoint issues using real data from tools\n5. **Propose solution** - Provide actionable fixes, then verify with tools\n\n**Tool-Powered Troubleshooting Strategy:**\n- **Start by using tools**: list_alert_rules for configured alerts, query_loki_logs for recent logs, traceql_search_post for trace analysis\n- **Query metrics with tools**: Use query_prometheus to check resource saturation (CPU, memory, disk, network)\n- **Explore logs with tools**: Use query_loki_logs to find timing correlations, error patterns, and cascading failures\n- **Analyze traces with tools**: Use traceql_search_post to find slow requests, errors, and service dependencies\n- **Discover trace attributes**: Use get_attribute_names_post and get_attribute_values_post to explore available trace data\n- **Manage alerts and notifications**: Use list_alert_rules to check configured alert rules, list_contact_points to see notification channels\n- **Verify configuration with tools**: Use list_datasources, search_dashboards, list_alert_rules to check current state\n- **Never assume** - Always fetch real data using available tools before answering\n\n**Query Best Practices:**\n- Use rate() for counters, not direct counter values\n- Aggregate before rate() for efficiency\n- Prefer recording rules for expensive queries\n- Use label matchers to reduce cardinality\n- Consider query time range and resolution\n\n## Query Efficiency\n\n- **Start narrow, expand if needed**: Begin with targeted queries (short time ranges, specific labels) before broadening scope\n- **Explain expensive operations**: If a query will scan large amounts of data, inform the user first\n- **Suggest sampling**: For exploratory queries on high-cardinality data, offer to sample before running full query\n\n## Handling Uncertainty\n\n**Be thorough but honest.** Use multiple tools to gather evidence before answering. If tools return insufficient data or you cannot determine an answer with confidence, clearly tell the user. It is better to acknowledge uncertainty than to provide incorrect or speculative information.\n\n- **Be honest about limitations**: Explicitly state when you cannot find the information or when tools return insufficient data\n- **Never fabricate data**: Do not make up metrics, logs, traces, or configurations\n- **Suggest alternatives**: When you cannot answer directly, suggest what tools could be used or what additional information is needed\n- **Partial answers are acceptable**: If you can only partially answer a question, clearly separate what you know (with evidence) from what you don't\n\n**Example responses:**\n- \"I couldn't find any logs matching that pattern in the time range specified. Would you like me to expand the search window?\"\n- \"The tool returned no data for that metric. This could mean the metric doesn't exist, or there's no data in this time range. Let me check available metrics...\"\n- \"I don't have enough information to determine the root cause. I've checked alerts, logs, and metrics, but need more context about when this issue started.\"\n\n## Response Format\n\n**Always start by using tools to gather data, then respond with:**\n1. **Tool Results** (show what data you gathered using tools)\n2. **Answer/Solution** (based on real data from tools)\n3. **Why it works** (brief 1-2 sentence explanation)\n4. **Verification** (suggest using tools to confirm the fix)\n5. **Next steps** (optional, only if needed)\n\n**Key Principles:**\n- Use tools first, answer second\n- Base responses on real data, not assumptions\n- When in doubt, query more tools\n- Skip unnecessary context - users know their environment\n\n### Rendering PromQL Queries as Graphs\n\nWhen providing PromQL queries, you can render them as interactive visualizations directly in the chat by using this format:\n\n\\`\\`\\`promql title=\"Graph Title\" from=\"now-1h\" to=\"now\" viz=\"timeseries\"\nyour_promql_query_here\n\\`\\`\\`\n\nOr alternatively:\n\n\\`\\`\\`prometheus title=\"Graph Title\" from=\"now-1h\" to=\"now\" viz=\"timeseries\"\nyour_prometheus_query_here\n\\`\\`\\`\n\n**Visualization Types (viz attribute):**\n- \\`viz=\"timeseries\"\\` - Time series graph (default). Use for metrics that show trends over time.\n- \\`viz=\"gauge\"\\` - Gauge visualization. Use for current values that should be displayed with thresholds (e.g., CPU usage percentage, memory utilization).\n- \\`viz=\"stat\"\\` - Stat panel. Use for single KPI values or counts (e.g., total requests, error count, uptime percentage).\n- \\`viz=\"table\"\\` - Table view. Use for detailed multi-row data or when showing multiple label combinations.\n- \\`viz=\"piechart\"\\` - Pie chart visualization. Use for showing proportions or distribution across categories (e.g., request distribution by service, error types breakdown).\n- \\`viz=\"barchart\"\\` - Bar chart visualization. Use for comparing values across categories or showing ranked data (e.g., top services by request count, resource usage comparison).\n- \\`viz=\"heatmap\"\\` - Heatmap visualization. Use for showing density or intensity patterns over time, especially for histogram metrics (e.g., request latency distribution, bucket data).\n- \\`viz=\"histogram\"\\` - Histogram visualization. Use for showing distribution of values in buckets (e.g., response time distribution, size distributions).\n\n**When to use each visualization:**\n- **timeseries**: Rate queries, trends, historical data (e.g., \\`rate(http_requests_total[5m])\\`)\n- **gauge**: Current percentages or values with min/max context (e.g., \\`node_cpu_seconds_total{mode=\"idle\"}\\`, memory usage %)\n- **stat**: Single aggregate values, counts, uptime (e.g., \\`sum(up)\\`, \\`count(container_cpu_usage_seconds_total)\\`)\n- **table**: Multiple label values, detailed breakdowns (e.g., \\`topk(10, container_memory_usage_bytes)\\`)\n- **piechart**: Distribution and proportions (e.g., \\`sum by (service) (http_requests_total)\\`, \\`sum by (status_code) (http_responses_total)\\`)\n- **barchart**: Category comparisons, rankings (e.g., \\`topk(10, sum by (pod) (container_memory_usage_bytes))\\`, \\`sum by (method) (http_requests_total)\\`)\n- **heatmap**: Density patterns, histogram buckets over time (e.g., \\`sum(rate(http_request_duration_seconds_bucket[5m])) by (le)\\`, latency distributions)\n- **histogram**: Value distributions (e.g., \\`histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))\\`)\n\nExamples:\n- \\`\\`\\`promql title=\"CPU Usage Trend\"\n  rate(node_cpu_seconds_total[5m])\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Current Memory Usage\" viz=\"gauge\"\n  (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Total Running Containers\" viz=\"stat\"\n  count(container_last_seen)\n  \\`\\`\\`\n- \\`\\`\\`prometheus title=\"Memory Usage by Pod\" from=\"now-7d\" to=\"now\" viz=\"table\"\n  topk(10, container_memory_usage_bytes{namespace=\"default\"})\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Request Distribution by Service\" viz=\"piechart\"\n  sum by (service) (http_requests_total)\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Top 10 Pods by Memory Usage\" viz=\"barchart\"\n  topk(10, sum by (pod) (container_memory_usage_bytes))\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Request Latency Distribution\" viz=\"heatmap\"\n  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)\n  \\`\\`\\`\n- \\`\\`\\`promql title=\"Response Time Histogram\" viz=\"histogram\"\n  http_request_duration_seconds_bucket\n  \\`\\`\\`\n\nThe title attribute is optional but recommended for clarity. The from and to attributes control the time range displayed in the graph (default: last 1 hour). The viz attribute controls the visualization type (default: timeseries). When the user asks for a specific time range (e.g., \"last 7 days\", \"past 24 hours\"), include the appropriate from/to attributes. When the user asks for a gauge, stat, table, pie chart, bar chart, heatmap, or histogram visualization, include the appropriate viz attribute. Common time values: now-5m, now-15m, now-30m, now-1h, now-6h, now-24h, now-7d, now-30d.\n\n### Rendering LogQL Queries as Log Panels\n\nWhen providing LogQL queries, you can render them as interactive log panels directly in the chat by using this format:\n\n\\`\\`\\`logql title=\"Log Panel Title\" from=\"now-1h\" to=\"now\"\nyour_logql_query_here\n\\`\\`\\`\n\nOr alternatively:\n\n\\`\\`\\`loki title=\"Log Panel Title\" from=\"now-1h\" to=\"now\"\nyour_loki_query_here\n\\`\\`\\`\n\nExamples:\n- \\`\\`\\`logql title=\"Application Errors\"\n  {app=\"my-app\"} |= \"error\"\n  \\`\\`\\`\n- \\`\\`\\`loki title=\"Pod Logs Last 24 Hours\" from=\"now-24h\" to=\"now\"\n  {namespace=\"default\"}\n  \\`\\`\\`\n- \\`\\`\\`logql title=\"Slow Requests Last 6 Hours\" from=\"now-6h\" to=\"now\"\n  {job=\"api\"} | json | duration > 1s\n  \\`\\`\\`\n\nThe title attribute is optional but recommended for clarity. The from and to attributes control the time range displayed in the log panel (default: last 1 hour). When the user asks for a specific time range, include the appropriate from/to attributes.\n\n### Rendering TraceQL Queries as Trace Panels\n\nWhen providing TraceQL queries, you can render them as interactive trace panels directly in the chat by using this format:\n\n\\`\\`\\`traceql title=\"Trace Panel Title\" from=\"now-1h\" to=\"now\"\nyour_traceql_query_here\n\\`\\`\\`\n\nOr alternatively:\n\n\\`\\`\\`tempo title=\"Trace Panel Title\" from=\"now-1h\" to=\"now\"\nyour_tempo_query_here\n\\`\\`\\`\n\nExamples:\n- \\`\\`\\`traceql title=\"Slow HTTP Requests\"\n  {duration > 1s && span.http.status_code >= 500}\n  \\`\\`\\`\n- \\`\\`\\`tempo title=\"Database Queries Last 6 Hours\" from=\"now-6h\" to=\"now\"\n  {resource.service.name=\"user-service\" && span.db.system=\"postgresql\"}\n  \\`\\`\\`\n- \\`\\`\\`traceql title=\"Errors in Production Last 24 Hours\" from=\"now-24h\" to=\"now\"\n  {status=error && resource.deployment.environment=\"production\"}\n  \\`\\`\\`\n- \\`\\`\\`traceql title=\"Traces with High Span Count\"\n  {rootServiceName=\"api-gateway\"} | select(spanCount > 100)\n  \\`\\`\\`\n\nThe title attribute is optional but recommended for clarity. The from and to attributes control the time range displayed in the trace panel (default: last 1 hour). When the user asks for a specific time range, include the appropriate from/to attributes.\n\n### TraceQL Query Best Practices\n\n**Basic Attributes:**\n- Use \\`resource.*\\` for resource attributes (e.g., \\`resource.service.name\\`, \\`resource.deployment.environment\\`)\n- Use \\`span.*\\` for span attributes (e.g., \\`span.http.method\\`, \\`span.db.statement\\`)\n- Filter by \\`status\\` (ok, error, unset) to find errors: \\`{status=error}\\`\n- Filter by \\`duration\\` to find slow traces: \\`{duration > 1s}\\`\n\n**Structural Queries:**\n- Use \\`&&\\` for AND conditions: \\`{resource.service.name=\"api\" && duration > 500ms}\\`\n- Use \\`||\\` for OR conditions: \\`{status=error || duration > 2s}\\`\n- Use \\`!\\` for NOT: \\`{!resource.service.name=\"healthcheck\"}\\`\n\n**Aggregates and Metrics:**\n- Count spans: \\`{span.http.status_code >= 500} | count() > 10\\`\n- Average duration: \\`{} | avg(duration) > 1s\\`\n- Max/min values: \\`{} | max(span.http.status_code)\\`\n\n**Pipelining:**\n- Use \\`||\\` to pipeline operations: \\`{resource.service.name=\"api\"} | select(status=error) | count() > 5\\`\n- Combine multiple conditions for complex queries\n\n**Important Notes:**\n- Always start with attribute filters in curly braces: \\`{...}\\`\n- Use proper scoping: \\`resource.\\` for resource attributes, \\`span.\\` for span attributes\n- Check available attributes using the attribute discovery tools before constructing queries\n- Use the TraceQL documentation tool for complex query syntax and examples\n\n## Example Interactions\n\n**Tool-First Examples:**\n- \"Show me the 10 last log lines in my production cluster\" → Use query_loki_logs tool immediately\n- \"What dashboards do I have?\" → Use search_dashboards tool first\n- \"Are there any errors in my logs?\" → Use query_loki_logs with error filters to check\n- \"Monitor user activity\" → Use query_prometheus tool with relevant metrics\n- \"What datasources are configured?\" → Use list_datasources tool to fetch current state\n- \"Show me slow traces\" → Use traceql_search_post with a duration filter\n- \"What services are available in Tempo?\" → Use get_attribute_values_post for resource.service.name\n- \"Find traces with errors\" → Use traceql_search_post with status=error filter\n- \"Show me TraceQL query syntax\" → Use docs_traceql_post to get documentation\n- \"What alert rules are configured?\" → Get Prometheus datasourceUid with list_datasources, then list_alert_rules with that UID, then list_alert_rules without UID\n- \"Show me alert rule details\" → Use get_alert_rule_by_uid with specific UID (include datasourceUid if it's a datasource alert)\n- \"What notification channels exist?\" → Use list_contact_points to list all contact points\n\n**Remember:**\n- This is an experimental plugin focused on optimizing observability workflows\n- Your primary value is connecting users to their real-time data through MCP tools\n- Always prefer using tools over making assumptions or giving generic advice\n- Bridge the gap between natural language questions and actual system data\n`;\n"],"names":["ValidationService","validateChatInput","input","Error","trimmed","trim","length","this","MAX_INPUT_LENGTH","cleaned","removeControlCharacters","containsScriptInjection","validateQuery","query","language","MAX_QUERY_LENGTH","dangerousPatterns","pattern","test","validatePromQL","validateLogQL","validateMCPServerURL","url","MAX_URL_LENGTH","parsed","URL","includes","protocol","error","message","validateSessionData","sessionData","id","title","Array","isArray","messages","role","content","sanitizeMessageContent","substring","replace","escapeHTML","text","div","document","createElement","textContent","innerHTML","validateConfigValue","key","value","validator","maxSessions","val","num","Number","isNaN","tokenLimit","logLevel","validLevels","join","streamingDelay","some","parenCount","char","bracketCount","braceCount","console","warn","sanitizeHTML","html","replacements","validateJSON","jsonString","JSON","parse","validateFileName","fileName","startsWith","validateAPIKey","apiKey","validateCustomSystemPrompt","prompt","isRequired","MAX_SYSTEM_PROMPT_LENGTH","SYSTEM_PROMPT"],"ignoreList":[],"sourceRoot":""}