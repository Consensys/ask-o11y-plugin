"use strict";(self.webpackChunkconsensys_asko11y_app=self.webpackChunkconsensys_asko11y_app||[]).push([[202],{35611(e,t,a){a.d(t,{b:()=>r});const r={appConfig:{apiKey:"data-testid ac-api-key",apiUrl:"data-testid ac-api-url",maxTotalTokens:"data-testid ac-max-total-tokens",submit:"data-testid ac-submit-form",addMcpServerButton:"data-testid ac-add-mcp-server",saveMcpServersButton:"data-testid ac-save-mcp-servers",mcpServerCard:e=>`data-testid ac-mcp-server-${e}`,mcpServerNameInput:e=>`data-testid ac-mcp-server-name-${e}`,mcpServerUrlInput:e=>`data-testid ac-mcp-server-url-${e}`,mcpServerRemoveButton:e=>`data-testid ac-mcp-server-remove-${e}`,mcpServerAdvancedToggle:e=>`data-testid ac-mcp-server-advanced-${e}`,mcpServerAddHeaderButton:e=>`data-testid ac-mcp-server-add-header-${e}`,mcpServerHeaderKeyInput:(e,t)=>`data-testid ac-mcp-server-header-key-${e}-${t}`,mcpServerHeaderValueInput:(e,t)=>`data-testid ac-mcp-server-header-value-${e}-${t}`,mcpServerHeaderRemoveButton:(e,t)=>`data-testid ac-mcp-server-header-remove-${e}-${t}`,systemPromptModeSelector:"data-testid ac-system-prompt-mode",customSystemPromptTextarea:"data-testid ac-custom-system-prompt",customSystemPromptCharCount:"data-testid ac-custom-prompt-char-count",viewDefaultPromptButton:"data-testid ac-view-default-prompt",saveSystemPromptButton:"data-testid ac-save-system-prompt",defaultPromptModal:"data-testid ac-default-prompt-modal",defaultPromptContent:"data-testid ac-default-prompt-content",copyDefaultPromptButton:"data-testid ac-copy-default-prompt",closeDefaultPromptButton:"data-testid ac-close-default-prompt"},home:{container:"data-testid home-container"}}},90202(e,t,a){a.r(t),a.d(t,{default:()=>b});var r=a(85959),n=a.n(r),o=a(31269),s=a(18531),l=a(82007),i=a(35611),m=a(47294),d=a(91817);function c(e,t,a,r,n,o,s){try{var l=e[o](s),i=l.value}catch(e){return void a(e)}l.done?t(i):Promise.resolve(i).then(r,n)}function p(e){return function(){var t=this,a=arguments;return new Promise(function(r,n){var o=e.apply(t,a);function s(e){c(o,r,n,s,l,"next",e)}function l(e){c(o,r,n,s,l,"throw",e)}s(void 0)})}}function u(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function v(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},r=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(a).filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),r.forEach(function(t){u(e,t,a[t])})}return e}function y(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,r)}return a}(Object(t)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}),e}const f=[{label:"Use default prompt",value:"default"},{label:"Replace with custom prompt",value:"replace"},{label:"Append to default prompt",value:"append"}],b=({plugin:e})=>{const{enabled:t,pinned:a,jsonData:o}=e.meta,[s,c]=(0,r.useState)({maxTotalTokens:(null==o?void 0:o.maxTotalTokens)||5e4,mcpServers:(null==o?void 0:o.mcpServers)||[],systemPromptMode:(null==o?void 0:o.systemPromptMode)||"default",customSystemPrompt:(null==o?void 0:o.customSystemPrompt)||"",expandedAdvanced:new Set}),[u,b]=(0,r.useState)({mcpServers:{}}),[g,S]=(0,r.useState)(!1),[P,C]=(0,r.useState)(!1),k=Boolean(!s.maxTotalTokens||s.maxTotalTokens<1e3),E=(e,t)=>{c(y(v({},s),{mcpServers:s.mcpServers.map(a=>a.id===e?v({},a,t):a)}));const a=v({},u.mcpServers);if(void 0!==t.url&&t.url.trim())try{m.Bm.validateMCPServerURL(t.url),a[e]&&(delete a[e].url,0===Object.keys(a[e]).length&&delete a[e])}catch(t){a[e]||(a[e]={}),a[e].url=t instanceof Error?t.message:"Invalid URL"}void 0!==t.name&&(t.name.trim()?a[e]&&(delete a[e].name,0===Object.keys(a[e]).length&&delete a[e]):(a[e]||(a[e]={}),a[e].name="Server name is required")),b(e=>y(v({},e),{mcpServers:a}))},x=n().useRef(0),_=(e,t,a,r)=>{const n=s.mcpServers.find(t=>t.id===e);if(!n)return;const o=n.headers||{},l=Object.keys(o),i=e=>{let t=e.trim();return t.includes("__collision_")&&(t=t.split("__collision_")[0].trim()),t},m=e=>e.includes("__collision_")?e.split("__collision_")[1]:null;let d=a;if(t!==a){const e=i(a),r=l.filter(e=>e!==t).find(t=>i(t)===e);if(e&&r){let e;const n=m(t),o=m(r);e=n||(o?`pair_${o}`:t.startsWith("__new_header_")?t.replace("__new_header_",""):`id_${t.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}`),d=`${a}__collision_${e}`}}const c={};for(const e of l)e===t?c[d]=r:c[e]=o[e];E(e,{headers:c})},T=(e,t)=>{if("default"===t)return b(e=>y(v({},e),{customSystemPrompt:void 0})),!0;const a="replace"===t||"append"===t;try{return m.Bm.validateCustomSystemPrompt(e,a),b(e=>y(v({},e),{customSystemPrompt:void 0})),!0}catch(e){return b(t=>y(v({},t),{customSystemPrompt:e instanceof Error?e.message:"Invalid system prompt"})),!1}},w=!("default"===s.systemPromptMode||s.customSystemPrompt.trim()&&!u.customSystemPrompt);return n().createElement("div",null,n().createElement(l.FieldSet,{label:"LLM Settings"},n().createElement(l.Field,{label:"Max Total Tokens",description:"Maximum number of tokens for LLM requests (minimum: 1000, recommended: 50000-200000)",invalid:!!u.maxTotalTokens,error:u.maxTotalTokens},n().createElement(l.Input,{width:60,name:"maxTotalTokens",id:"config-max-tokens","data-testid":i.b.appConfig.maxTotalTokens,type:"number",value:s.maxTotalTokens,placeholder:"50000",min:1e3,max:2e5,onChange:e=>{const{name:t,value:a,type:r}=e.target,n="number"===r?parseInt(a,10)||0:a.trim();if(c(y(v({},s),{[t]:n})),"maxTotalTokens"===t)try{m.Bm.validateConfigValue("tokenLimit",n),b(e=>y(v({},e),{maxTotalTokens:void 0}))}catch(e){b(t=>y(v({},t),{maxTotalTokens:e instanceof Error?e.message:"Invalid value"}))}},invalid:!!u.maxTotalTokens})),n().createElement("div",{className:"mt-3"},n().createElement(l.Button,{onClick:()=>{if(!k&&!u.maxTotalTokens){try{m.Bm.validateConfigValue("tokenLimit",s.maxTotalTokens)}catch(e){return void b(t=>y(v({},t),{maxTotalTokens:e instanceof Error?e.message:"Invalid value"}))}h(e.meta.id,{enabled:t,pinned:a,jsonData:y(v({},o),{maxTotalTokens:s.maxTotalTokens})})}},"data-testid":i.b.appConfig.submit,disabled:k||!!u.maxTotalTokens},"Save LLM settings"))),n().createElement(l.FieldSet,{label:"MCP Server Connections",className:"mt-4"},n().createElement("p",{className:"text-sm text-secondary mb-3"},"Configure additional MCP (Model Context Protocol) servers to extend tool capabilities. Supports OpenAPI-based servers like"," ",n().createElement("a",{href:"https://github.com/open-webui/mcpo",target:"_blank",rel:"noopener noreferrer"},"MCPO"),"."),s.mcpServers.map(e=>{var t,a,r,o,m,d;return n().createElement("div",{key:e.id,"data-testid":i.b.appConfig.mcpServerCard(e.id),className:"p-4 mb-3 rounded border",style:{borderColor:"var(--grafana-border-medium)",backgroundColor:"var(--grafana-background-secondary)"}},n().createElement("div",{className:"flex items-center justify-between mb-3"},n().createElement("div",{className:"flex items-center gap-2"},n().createElement(l.Icon,{name:"plug"}),n().createElement("span",{className:"font-medium"},e.name||"Unnamed Server")),n().createElement("div",{className:"flex items-center gap-2"},n().createElement(l.Switch,{value:e.enabled,onChange:t=>E(e.id,{enabled:t.currentTarget.checked})}),n().createElement(l.Button,{variant:"secondary",size:"sm",icon:"trash-alt",onClick:()=>{return t=e.id,void c(y(v({},s),{mcpServers:s.mcpServers.filter(e=>e.id!==t)}));var t},"data-testid":i.b.appConfig.mcpServerRemoveButton(e.id)},"Remove"))),n().createElement(l.Field,{label:"Server Name",invalid:!!(null===(t=u.mcpServers[e.id])||void 0===t?void 0:t.name),error:null===(a=u.mcpServers[e.id])||void 0===a?void 0:a.name},n().createElement(l.Input,{width:60,value:e.name,placeholder:"My MCP Server",onChange:t=>E(e.id,{name:t.currentTarget.value}),invalid:!!(null===(r=u.mcpServers[e.id])||void 0===r?void 0:r.name),"data-testid":i.b.appConfig.mcpServerNameInput(e.id)})),n().createElement(l.Field,{label:"Server URL",className:"mt-2",invalid:!!(null===(o=u.mcpServers[e.id])||void 0===o?void 0:o.url),error:null===(m=u.mcpServers[e.id])||void 0===m?void 0:m.url},n().createElement(l.Input,{width:60,value:e.url,placeholder:"https://mcp-server.example.com",onChange:t=>E(e.id,{url:t.currentTarget.value}),invalid:!!(null===(d=u.mcpServers[e.id])||void 0===d?void 0:d.url),"data-testid":i.b.appConfig.mcpServerUrlInput(e.id)})),n().createElement(l.Field,{label:"Type",className:"mt-2"},n().createElement("select",{className:"gf-form-input",value:e.type||"openapi",onChange:t=>E(e.id,{type:t.target.value}),style:{width:"240px",height:"32px"}},n().createElement("option",{value:"openapi"},"OpenAPI"),n().createElement("option",{value:"standard"},"Standard MCP"),n().createElement("option",{value:"sse"},"SSE"),n().createElement("option",{value:"streamable-http"},"Streamable HTTP"))),n().createElement("div",{className:"mt-3"},n().createElement("button",{type:"button",onClick:()=>{return t=e.id,void c(e=>{const a=new Set(e.expandedAdvanced);return a.has(t)?a.delete(t):a.add(t),y(v({},e),{expandedAdvanced:a})});var t},className:"flex items-center gap-1 text-sm cursor-pointer bg-transparent border-none p-0",style:{color:"var(--grafana-text-link)"},"data-testid":i.b.appConfig.mcpServerAdvancedToggle(e.id)},n().createElement(l.Icon,{name:s.expandedAdvanced.has(e.id)?"angle-down":"angle-right"}),"Advanced Options",e.headers&&Object.keys(e.headers).length>0&&n().createElement("span",{className:"ml-1 text-xs",style:{color:"var(--grafana-text-secondary)"}},"(",Object.keys(e.headers).length," header",1!==Object.keys(e.headers).length?"s":"",")"))),s.expandedAdvanced.has(e.id)&&n().createElement("div",{className:"mt-2 p-3 rounded",style:{backgroundColor:"var(--grafana-background-canvas)",border:"1px solid var(--grafana-border-weak)"}},n().createElement("div",{className:"flex items-center justify-between mb-2"},n().createElement("span",{className:"text-sm font-medium"},"Custom Headers"),n().createElement("span",{className:"text-xs",style:{color:"var(--grafana-text-secondary)"}},Object.keys(e.headers||{}).length,"/10")),n().createElement("p",{className:"text-xs mb-2",style:{color:"var(--grafana-text-secondary)"}},"Add custom HTTP headers to include with every request to this MCP server."),Object.entries(e.headers||{}).map(([t,a],r)=>{let o=t;t.startsWith("__new_header_")?o="":t.includes("__collision_")&&(o=t.split("__collision_")[0]);const m=t.includes("__collision_");return n().createElement("div",{key:`${e.id}-header-${r}`,className:"mb-2"},n().createElement("div",{className:"flex items-center gap-2"},n().createElement(l.Input,{width:20,value:o,placeholder:"Header key",onChange:r=>_(e.id,t,r.currentTarget.value,a),"data-testid":i.b.appConfig.mcpServerHeaderKeyInput(e.id,r),invalid:m}),n().createElement(l.Input,{width:30,value:a,placeholder:"Header value",onChange:a=>_(e.id,t,t,a.currentTarget.value),"data-testid":i.b.appConfig.mcpServerHeaderValueInput(e.id,r)}),n().createElement(l.Button,{variant:"secondary",size:"sm",icon:"times",onClick:()=>((e,t)=>{const a=s.mcpServers.find(t=>t.id===e);if(!a)return;const r=v({},a.headers||{});delete r[t],E(e,{headers:r})})(e.id,t),"data-testid":i.b.appConfig.mcpServerHeaderRemoveButton(e.id,r),"aria-label":"Remove header"})),m&&n().createElement("span",{className:"text-xs mt-1 block",style:{color:"var(--grafana-text-error)"}},"Duplicate key name"))}),(()=>{const t=e.headers||{},a=Object.keys(t),r=a.length>=10,o=a.some(e=>e.startsWith("__new_header_")||!e.trim()||e.includes("__collision_"));return r?null:n().createElement(l.Button,{variant:"secondary",size:"sm",icon:"plus",onClick:()=>(e=>{const t=s.mcpServers.find(t=>t.id===e);if(!t)return;const a=t.headers||{};if(Object.keys(a).length>=10)return;x.current+=1;const r=`__new_header_${Date.now()}_${x.current}`;E(e,{headers:y(v({},a),{[r]:""})})})(e.id),disabled:o,"data-testid":i.b.appConfig.mcpServerAddHeaderButton(e.id)},"Add Header")})()))}),n().createElement(l.Button,{variant:"secondary",icon:"plus",onClick:()=>{const e={id:`mcp-${Date.now()}`,name:"New MCP Server",url:"",enabled:!0,type:"openapi"};c(y(v({},s),{mcpServers:[...s.mcpServers,e]}))},"data-testid":i.b.appConfig.addMcpServerButton},"Add MCP Server"),n().createElement("div",{className:"mt-3"},Object.keys(u.mcpServers).length>0&&n().createElement(l.Alert,{severity:"error",title:"Validation errors",className:"mb-3"},"Please fix the validation errors above before saving."),n().createElement(l.Button,{onClick:()=>{const r={};let n=!1;if(s.mcpServers.forEach(e=>{const t={};if(e.name.trim()||(t.name="Server name is required",n=!0),e.url.trim())try{m.Bm.validateMCPServerURL(e.url)}catch(e){t.url=e instanceof Error?e.message:"Invalid URL",n=!0}Object.keys(t).length>0&&(r[e.id]=t)}),n)return void b(e=>y(v({},e),{mcpServers:r}));if(s.mcpServers.some(e=>e.headers&&Object.keys(e.headers).some(e=>e.includes("__collision_"))))return;const l=s.mcpServers.map(e=>{if(!e.headers)return e;const t={};for(const[a,r]of Object.entries(e.headers)){let e=a.trim();e&&!e.startsWith("__new_header_")&&(e.includes("__collision_")&&(e=e.split("__collision_")[0].trim()),t[e]=r)}return y(v({},e),{headers:Object.keys(t).length>0?t:void 0})});h(e.meta.id,{enabled:t,pinned:a,jsonData:y(v({},o),{mcpServers:l})})},variant:"primary",disabled:Object.keys(u.mcpServers).length>0,"data-testid":i.b.appConfig.saveMcpServersButton},"Save MCP Server Connections"))),n().createElement(l.FieldSet,{label:"System Prompt",className:"mt-4"},n().createElement("p",{className:"text-sm text-secondary mb-3"},"Customize the system prompt that instructs the AI assistant. You can use the default observability-focused prompt, replace it entirely with your own, or append additional instructions to it."),n().createElement(l.Field,{label:"Prompt Mode",description:"Choose how to configure the system prompt"},n().createElement(l.RadioButtonGroup,{options:f,value:s.systemPromptMode,onChange:e=>{c(y(v({},s),{systemPromptMode:e})),"default"===e?b(e=>y(v({},e),{customSystemPrompt:void 0})):T(s.customSystemPrompt,e)},"data-testid":i.b.appConfig.systemPromptModeSelector})),"default"!==s.systemPromptMode&&n().createElement(l.Field,{label:"Custom System Prompt",description:"replace"===s.systemPromptMode?"Enter your complete custom system prompt":"Enter additional instructions to append to the default prompt",className:"mt-3",invalid:!!u.customSystemPrompt,error:u.customSystemPrompt},n().createElement(l.TextArea,{value:s.customSystemPrompt,onChange:e=>{return t=e.currentTarget.value,c(y(v({},s),{customSystemPrompt:t})),void T(t,s.systemPromptMode);var t},rows:8,placeholder:"replace"===s.systemPromptMode?"You are a helpful assistant that...":"Additional instructions:\n- Always provide code examples\n- Focus on performance optimization",invalid:!!u.customSystemPrompt,"data-testid":i.b.appConfig.customSystemPromptTextarea})),"default"!==s.systemPromptMode&&n().createElement("p",{className:"text-sm text-secondary mt-1","data-testid":i.b.appConfig.customSystemPromptCharCount},"Characters: ",s.customSystemPrompt.length," / ",m.Bm.MAX_SYSTEM_PROMPT_LENGTH,s.customSystemPrompt.length>.8*m.Bm.MAX_SYSTEM_PROMPT_LENGTH&&n().createElement("span",{className:"text-warning ml-2"},"(Approaching limit - long prompts may impact performance)")),n().createElement("div",{className:"mt-3 flex gap-2"},n().createElement(l.Button,{variant:"secondary",onClick:()=>S(!0),icon:"eye","data-testid":i.b.appConfig.viewDefaultPromptButton},"View Default Prompt"),n().createElement(l.Button,{onClick:()=>{T(s.customSystemPrompt,s.systemPromptMode)&&h(e.meta.id,{enabled:t,pinned:a,jsonData:y(v({},o),{systemPromptMode:s.systemPromptMode,customSystemPrompt:s.customSystemPrompt})})},variant:"primary",disabled:w,"data-testid":i.b.appConfig.saveSystemPromptButton},"Save System Prompt"))),n().createElement(l.Modal,{title:"Default System Prompt",isOpen:g,onDismiss:()=>S(!1),"data-testid":i.b.appConfig.defaultPromptModal},n().createElement("div",{className:"p-2"},n().createElement("p",{className:"text-sm text-secondary mb-3"},"This is the default system prompt used by the Observability Assistant. It instructs the AI to specialize in the Grafana LGTM stack and use MCP tools."),n().createElement("pre",{className:"p-3 rounded text-sm overflow-auto",style:{backgroundColor:"var(--grafana-background-secondary)",border:"1px solid var(--grafana-border-weak)",maxHeight:"400px",whiteSpace:"pre-wrap",wordBreak:"break-word"},"data-testid":i.b.appConfig.defaultPromptContent},d.L),n().createElement("div",{className:"mt-3 flex justify-end gap-2"},n().createElement(l.Button,{variant:"secondary",onClick:()=>p(function*(){try{yield navigator.clipboard.writeText(d.L),C(!0),setTimeout(()=>C(!1),2e3)}catch(e){console.error("Failed to copy system prompt:",e)}})(),icon:P?"check":"copy","data-testid":i.b.appConfig.copyDefaultPromptButton},P?"Copied!":"Copy to Clipboard"),n().createElement(l.Button,{variant:"primary",onClick:()=>S(!1),"data-testid":i.b.appConfig.closeDefaultPromptButton},"Close")))))},h=(e,t)=>p(function*(){try{yield g(e,t),window.location.reload()}catch(e){console.error("Error while updating the plugin",e)}})(),g=(e,t)=>p(function*(){const a=yield(0,s.getBackendSrv)().fetch({url:`/api/plugins/${e}/settings`,method:"POST",data:t});return(0,o.lastValueFrom)(a)})()}}]);
//# sourceMappingURL=202.7ae07c24.js.map