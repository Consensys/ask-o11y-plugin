"use strict";(self.webpackChunkconsensys_asko11y_app=self.webpackChunkconsensys_asko11y_app||[]).push([[1039],{9235(e,t,r){r.d(t,{Ou:()=>i,lV:()=>l,p8:()=>a});var n=r(85959),s=r.n(n),o=r(82007);const a=({isLoading:e,message:t="Loading...",variant:r="overlay",size:n="md",showSpinner:a=!0,showProgress:i=!1,progress:l=0,transparent:c=!1,children:u,className:d=""})=>{if(!e)return s().createElement(s().Fragment,null,u);const m=s().createElement("div",{className:`flex flex-col items-center justify-center ${(()=>{switch(n){case"sm":return"text-xs";case"md":default:return"text-sm";case"lg":return"text-base";case"xl":return"text-lg"}})()}`},a&&s().createElement(o.Spinner,{size:(()=>{switch(n){case"sm":return 14;case"md":default:return 20;case"lg":return 28;case"xl":return 36}})(),className:"mb-3","aria-label":"Loading spinner"}),t&&s().createElement("div",{className:"text-secondary font-medium",role:"status","aria-live":"polite"},t),i&&l>0&&s().createElement("div",{className:"mt-3 w-48"},s().createElement("div",{className:"bg-weak rounded-full h-2 overflow-hidden"},s().createElement("div",{className:"bg-primary h-full transition-all duration-300 ease-out",style:{width:`${Math.min(100,Math.max(0,l))}%`},role:"progressbar","aria-valuenow":l,"aria-valuemin":0,"aria-valuemax":100,"aria-label":`Loading progress: ${Math.round(l)}%`})),s().createElement("div",{className:"text-center mt-1 text-xs text-secondary"},Math.round(l),"%")));return"inline"===r?s().createElement("div",{className:`relative ${d}`},u&&s().createElement("div",{className:"opacity-50 pointer-events-none"},u),s().createElement("div",{className:"flex items-center justify-center py-4"},m)):"fullscreen"===r?s().createElement(o.Portal,null,s().createElement("div",{className:`fixed inset-0 z-50 flex items-center justify-center ${c?"bg-black/30":"bg-background"} ${d}`,role:"dialog","aria-modal":"true","aria-label":t},s().createElement("div",{className:"bg-background rounded-lg shadow-lg p-8 max-w-sm w-full mx-4"},m))):s().createElement("div",{className:`relative ${d}`},u,s().createElement("div",{className:"absolute inset-0 z-10 flex items-center justify-center rounded-lg "+(c?"bg-black/20":"bg-background/90"),role:"status","aria-live":"polite","aria-label":t},m))},i=({message:e="Loading...",size:t="sm",className:r=""})=>{const n="sm"===t?12:"md"===t?16:20;return s().createElement("div",{className:`flex items-center gap-2 text-secondary ${r}`,role:"status","aria-live":"polite"},s().createElement(o.Spinner,{size:n}),e&&s().createElement("span",{className:"sm"===t?"text-xs":"text-sm"},e))},l=({isLoading:e=!1,loadingText:t="Processing...",onClick:r,disabled:n=!1,variant:a="primary",size:i="md",icon:l,children:c,className:u="",type:d="button"})=>s().createElement("button",{type:d,onClick:r,disabled:e||n,className:`\n        inline-flex items-center justify-center gap-2\n        rounded-md font-medium transition-colors\n        focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2\n        ${(()=>{if(e||n)return"bg-weak text-disabled cursor-not-allowed";switch(a){case"primary":default:return"bg-primary hover:bg-primary-shade text-primary-text";case"secondary":return"bg-secondary hover:bg-secondary-shade text-secondary-text border border-medium";case"destructive":return"bg-error hover:bg-error-shade text-error-text"}})()}\n        ${(()=>{switch(i){case"sm":return"px-3 py-1.5 text-xs";case"md":default:return"px-4 py-2 text-sm";case"lg":return"px-6 py-3 text-base"}})()}\n        ${u}\n      `,"aria-busy":e,"aria-disabled":e||n},e?s().createElement(s().Fragment,null,s().createElement(o.Spinner,{size:"sm"===i?12:"md"===i?14:16}),s().createElement("span",null,t)):s().createElement(s().Fragment,null,l,c))},15331(e,t,r){function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}r.d(t,{v:()=>o});class o{static create(e,t){const r=new Date,n=o.generateId(),s=t||o.generateTitle(e);return new o(n,s,e,r,r,e.length)}static fromStorage(e){return new o(e.id,e.title,e.messages.map(e=>s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},s=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),s.forEach(function(t){n(e,t,r[t])})}return e}({},e),{timestamp:new Date(e.timestamp)})),new Date(e.createdAt),new Date(e.updatedAt),e.messageCount,e.summary)}toStorage(){return{id:this.id,title:this.title,messages:this.messages,createdAt:this.createdAt,updatedAt:this.updatedAt,messageCount:this.messageCount,summary:this.summary}}updateMessages(e,t){this.messages=e,this.messageCount=e.length,this.updatedAt=new Date,t&&(this.summary=t),"New Conversation"===this.title&&e.length>0&&(this.title=o.generateTitle(e))}getMetadata(){return{id:this.id,title:this.title,createdAt:this.createdAt,updatedAt:this.updatedAt,messageCount:this.messageCount}}static generateId(){return`session-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}static generateTitle(e){const t=e.find(e=>"user"===e.role);if(!t)return"New Conversation";const r=t.content.trim();return r.length>60?`${r.substring(0,60)}...`:r}constructor(e,t,r,s,o,a,i){n(this,"id",void 0),n(this,"title",void 0),n(this,"messages",void 0),n(this,"createdAt",void 0),n(this,"updatedAt",void 0),n(this,"messageCount",void 0),n(this,"summary",void 0),this.id=e,this.title=t,this.messages=r,this.createdAt=s,this.updatedAt=o,this.messageCount=a,this.summary=i}}},35458(e,t,r){r.d(t,{T:()=>i});var n=r(18531),s=r(31269);function o(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function a(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var a=e.apply(t,r);function i(e){o(a,n,s,i,l,"next",e)}function l(e){o(a,n,s,i,l,"throw",e)}i(void 0)})}}const i=new class{createShare(e,t,r){return a(function*(){try{const o=yield(0,s.firstValueFrom)((0,n.getBackendSrv)().fetch({url:`${this.baseUrl}/api/sessions/share`,method:"POST",data:{sessionId:e,sessionData:t.toStorage(),expiresInDays:r},showErrorAlert:!1}));if(!o||!o.data)throw new Error("No response from backend");return o.data}catch(e){throw console.error("[SessionShareService] Failed to create share:",e),e}}).call(this)}getSharedSession(e){return a(function*(){try{const t=yield(0,s.firstValueFrom)((0,n.getBackendSrv)().fetch({url:`${this.baseUrl}/api/sessions/shared/${e}`,method:"GET",showErrorAlert:!1}));if(!t||!t.data)throw new Error("No response from backend");return t.data}catch(e){throw console.error("[SessionShareService] Failed to get shared session:",e),e}}).call(this)}revokeShare(e){return a(function*(){try{yield(0,s.firstValueFrom)((0,n.getBackendSrv)().fetch({url:`${this.baseUrl}/api/sessions/share/${e}`,method:"DELETE",showErrorAlert:!1}))}catch(e){throw console.error("[SessionShareService] Failed to revoke share:",e),e}}).call(this)}getSessionShares(e){return a(function*(){try{const t=yield(0,s.firstValueFrom)((0,n.getBackendSrv)().fetch({url:`${this.baseUrl}/api/sessions/${e}/shares`,method:"GET",showErrorAlert:!1}));return t&&t.data?t.data:[]}catch(e){return console.error("[SessionShareService] Failed to get session shares:",e),[]}}).call(this)}buildShareUrl(e){return`${window.location.origin}/a/consensys-asko11y-app/shared/${e}`}constructor(){var e,t,r;r="/api/plugins/consensys-asko11y-app/resources",(t="baseUrl")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}}},51039(e,t,r){r.d(t,{ry:()=>ot});var n=r(85959),s=r.n(n),o=r(82007),a=r(18531),i=r(37933),l=r(4817),c=r(94431),u=r(31269);function d(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){d(o,n,s,a,i,"next",e)}function i(e){d(o,n,s,a,i,"throw",e)}a(void 0)})}}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const y=new class{listTools(){return m(function*(){if(this.cachedTools)return this.cachedTools;try{const e=yield(0,u.firstValueFrom)((0,a.getBackendSrv)().fetch({url:`${this.baseUrl}/api/mcp/tools`,method:"GET"}));return this.cachedTools=(null==e?void 0:e.data.tools)||[],this.cachedTools}catch(e){return console.error("[BackendMCPClient] Failed to list tools:",e),[]}}).call(this)}callTool(e){return m(function*(){try{var t,r;const n=(null===(r=a.config.bootData)||void 0===r||null===(t=r.user)||void 0===t?void 0:t.orgName)||"",s=yield(0,u.firstValueFrom)((0,a.getBackendSrv)().fetch({url:`${this.baseUrl}/api/mcp/call-tool`,method:"POST",data:{name:e.name,arguments:e.arguments||{},orgName:n,scopeOrgId:e.scopeOrgId||""},showErrorAlert:!1}));if(!s)throw new Error("No response from backend");return s.data}catch(e){return console.error("[BackendMCPClient] Failed to call tool:",e),{content:[{type:"text",text:`Error calling tool via backend: ${e instanceof Error?e.message:"Unknown error"}`}],isError:!0}}}).call(this)}isTool(e){return!!this.cachedTools&&this.cachedTools.some(t=>t.name===e)}clearCache(){this.cachedTools=null}getHealth(){return m(function*(){try{const e=yield(0,u.firstValueFrom)((0,a.getBackendSrv)().fetch({url:`${this.baseUrl}/health`,method:"GET"}));if(!e)throw new Error("No response from backend");return e.data}catch(e){return console.error("[BackendMCPClient] Failed to get health:",e),{status:"error",mcpServers:0,message:"Failed to connect to backend"}}}).call(this)}constructor(){g(this,"baseUrl",void 0),g(this,"cachedTools",null),this.baseUrl="/api/plugins/consensys-asko11y-app/resources"}};function h(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function p(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){h(o,n,s,a,i,"next",e)}function i(e){h(o,n,s,a,i,"throw",e)}a(void 0)})}}function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){f(e,t,r[t])})}return e}class v{add(e){return p(function*(e,t={}){const{priority:r=this.config.defaultPriority,maxRetries:n=this.config.retryDelays.length,id:s=this.generateId()}=t;if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Queue is full (max size: ${this.config.maxQueueSize})`);return new Promise((t,o)=>{const a={id:s,execute:e,resolve:t,reject:o,priority:r,timestamp:Date.now(),retryCount:0,maxRetries:n},i=this.queue.findIndex(e=>e.priority<r);-1===i?this.queue.push(a):this.queue.splice(i,0,a),this.processQueue()})}).apply(this,arguments)}processQueue(){return p(function*(){if(this.activeRequests.size>=this.config.maxConcurrent||0===this.queue.length)return;if(!this.checkRateLimit()){const e=this.getRateLimitDelay();return void setTimeout(()=>this.processQueue(),e)}const e=this.queue.shift();if(!e)return;const t=Date.now()-e.timestamp;this.metrics.queuedTime.push(t),this.metrics.totalRequests++,this.executeRequest(e),this.queue.length>0&&setImmediate(()=>this.processQueue())}).call(this)}executeRequest(e){return p(function*(){const t=Date.now(),r=setTimeout(()=>{this.activeRequests.has(e.id)&&(e.reject(new Error(`Request ${e.id} timed out after ${this.config.timeout}ms`)),this.activeRequests.delete(e.id),this.metrics.failedRequests++)},this.config.timeout);try{const n=e.execute();this.activeRequests.set(e.id,n),this.recordRequest();const s=yield n;clearTimeout(r),this.activeRequests.delete(e.id);const o=Date.now()-t;this.metrics.executionTime.push(o),this.metrics.successfulRequests++,e.resolve(s),this.processQueue()}catch(t){if(clearTimeout(r),this.activeRequests.delete(e.id),e.retryCount<e.maxRetries){const t=this.config.retryDelays[e.retryCount]||5e3;e.retryCount++,this.metrics.retriedRequests++,setTimeout(()=>{const t=this.queue.findIndex(t=>t.priority<e.priority);-1===t?this.queue.push(e):this.queue.splice(t,0,e),this.processQueue()},t)}else console.error(`[RequestQueue] Request ${e.id} failed after ${e.retryCount} retries`,t),this.metrics.failedRequests++,e.reject(t),this.processQueue()}}).call(this)}checkRateLimit(){const e=Date.now();return e-this.requestCountResetTime>1e3&&(this.requestCount=0,this.requestCountResetTime=e),this.requestCount<this.config.requestsPerSecond}getRateLimitDelay(){const e=Date.now()-this.requestCountResetTime;return Math.max(0,1e3-e)}recordRequest(){this.requestCount++}generateId(){return`req-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}clear(){for(const e of this.queue)e.reject(new Error("Queue cleared"));this.queue=[]}getStatus(){return{queueLength:this.queue.length,activeRequests:this.activeRequests.size,maxConcurrent:this.config.maxConcurrent,maxQueueSize:this.config.maxQueueSize,requestsPerSecond:this.config.requestsPerSecond}}getMetrics(){const e=this.metrics.queuedTime.length>0?this.metrics.queuedTime.reduce((e,t)=>e+t,0)/this.metrics.queuedTime.length:0,t=this.metrics.executionTime.length>0?this.metrics.executionTime.reduce((e,t)=>e+t,0)/this.metrics.executionTime.length:0;return{totalRequests:this.metrics.totalRequests,successfulRequests:this.metrics.successfulRequests,failedRequests:this.metrics.failedRequests,retriedRequests:this.metrics.retriedRequests,successRate:this.metrics.totalRequests>0?this.metrics.successfulRequests/this.metrics.totalRequests*100:0,avgQueueTime:Math.round(e),avgExecutionTime:Math.round(t),activeRequests:this.activeRequests.size,pendingRequests:this.queue.length,completedRequests:this.metrics.successfulRequests}}updateConfig(e){this.config=b({},this.config,e)}waitForAll(){return p(function*(){const e=Array.from(this.activeRequests.values());yield Promise.allSettled(e)}).call(this)}constructor(e){f(this,"queue",[]),f(this,"activeRequests",new Map),f(this,"requestCount",0),f(this,"requestCountResetTime",0),f(this,"config",{maxConcurrent:3,maxQueueSize:100,requestsPerSecond:10,retryDelays:[1e3,2e3,5e3],defaultPriority:5,timeout:3e4}),f(this,"metrics",{totalRequests:0,successfulRequests:0,failedRequests:0,retriedRequests:0,queuedTime:[],executionTime:[]}),e&&(this.config=b({},this.config,e))}}const x=new v({maxConcurrent:1,requestsPerSecond:5,timeout:6e4}),E=new v({maxConcurrent:3,requestsPerSecond:20,timeout:3e4});new v({maxConcurrent:5,requestsPerSecond:50,timeout:1e4}),new v;function w(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function k(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){w(o,n,s,a,i,"next",e)}function i(e){w(o,n,s,a,i,"throw",e)}a(void 0)})}}function S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function C(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){S(e,t,r[t])})}return e}function N(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}var T=r(20481);var O=r(78597);const P=new Map;class D{static initialize(e="gpt-4"){this.tokenizer=function(e="gpt-4"){if(P.has(e))return P.get(e);try{const t=(0,O.kN)(e);return P.set(e,t),t}catch(t){console.warn(`[Tokenizer] Model ${e} not recognized, falling back to gpt-4 encoding`);const r=(0,O.kN)("gpt-4");return P.set(e,r),r}}(e)}static countTokens(e){if(this.tokenizer||this.initialize(),!e)return 0;try{return this.tokenizer.encode(e).length}catch(t){return console.error("[TokenizerService] Error counting tokens:",t),Math.ceil(e.length/4)}}static countMessageTokens(e){this.tokenizer||this.initialize();let t=0;if(t+=4,e.role&&(t+=this.countTokens(e.role)),"string"==typeof e.content)t+=this.countTokens(e.content);else if(e.content&&Array.isArray(e.content))for(const r of e.content)"string"==typeof r?t+=this.countTokens(r):r&&"object"==typeof r&&("text"in r&&r.text&&(t+=this.countTokens(r.text)),"image"in r&&(t+=85));if(e.tool_calls)for(const r of e.tool_calls)t+=3,"function"in r&&r.function?(t+=this.countTokens(r.function.name||""),t+=this.countTokens(r.function.arguments||"")):t+=this.countTokens(JSON.stringify(r));return"tool"===e.role&&e.tool_call_id&&(t+=this.countTokens(e.tool_call_id)),t}static countMessagesTokens(e){if(!e||0===e.length)return 0;let t=0;for(const r of e)t+=this.countMessageTokens(r);return t+=3,t}static countToolTokens(e){if(!e||0===e.length)return 0;const t=JSON.stringify(e);return this.countTokens(t)}static calculateContextTokens(e,t=[]){const r=this.countMessagesTokens(e),n=this.countToolTokens(t),s={system:0,user:0,assistant:0,tool:0};for(const t of e){const e=this.countMessageTokens(t);switch(t.role){case"system":s.system+=e;break;case"user":s.user+=e;break;case"assistant":s.assistant+=e;break;case"tool":s.tool+=e}}return{messageTokens:r,toolTokens:n,totalTokens:r+n,breakdown:s}}static truncateToTokenLimit(e,t,r=!0){if(this.tokenizer||this.initialize(),!e)return"";try{const n=this.tokenizer.encode(e);if(n.length<=t)return e;const s=r?t-5:t,o=n.slice(0,s);let a=this.tokenizer.decode(o);return r&&(a+="\n\n[... content truncated ...]"),a}catch(n){console.error("[TokenizerService] Error truncating text:",n);const s=4*t;if(e.length<=s)return e;const o=e.slice(0,s-(r?30:0));return r?o+"\n\n[... content truncated ...]":o}}static estimateCost(e,t="gpt-4",r=!1){const n={"gpt-4":{input:.03,output:.06},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:5e-4,output:.0015},"claude-3-opus":{input:.015,output:.075},"claude-3-sonnet":{input:.003,output:.015},"claude-3-haiku":{input:25e-5,output:.00125}},s=n[t]||n["gpt-4"];return e/1e3*(r?s.output:s.input)}static getModelTokenLimit(e="gpt-4"){return{"gpt-4":8192,"gpt-4-32k":32768,"gpt-4-turbo":128e3,"gpt-3.5-turbo":16385,"gpt-3.5-turbo-16k":16385,"claude-3-opus":2e5,"claude-3-sonnet":2e5,"claude-3-haiku":2e5}[e]||8192}static validateTokenLimit(e,t){const r=this.countTokens(e);if(r>t)throw new Error(`Text exceeds token limit: ${r} tokens (limit: ${t})`)}static estimateTokens(e){return Math.ceil(e.length/4)}static getTokenBudget(e,t="gpt-3.5-turbo"){const r=this.getModelTokenLimit(t),n=this.countMessagesTokens(e);return{used:n,remaining:Math.max(0,r-n),limit:r,percentage:n/r*100}}static splitTextIntoChunks(e,t,r=0){if(!e)return[];const n=[],s=e.split(/\s+/);let o="",a=0;for(let i=0;i<s.length;i++){const l=o?`${o} ${s[i]}`:s[i];if(this.countTokens(l)>t){if(o){if(n.push({text:o,startIndex:a,endIndex:e.indexOf(o,a)+o.length}),r>0&&n.length>0){const e=Math.ceil(.75*r);i=Math.max(0,i-e)}a=e.indexOf(s[i],a+o.length),o=s[i]}}else o=l}return o&&n.push({text:o,startIndex:a,endIndex:e.length}),n}static getCost(e,t,r="gpt-3.5-turbo"){const n=this.estimateCost(e,r,!1),s=this.estimateCost(t,r,!0);return{inputCost:n,outputCost:s,totalCost:n+s}}static optimizePrompt(e,t){const r=this.countTokens(e.userInput),n=this.countTokens(e.instruction);let s=t,o="";if(o=e.userInput,s-=r,s>=n&&(o=`${e.instruction}\n\n${o}`,s-=n),e.context&&s>0){o=`${this.truncateToTokenLimit(e.context,s-10)}\n\n${o}`}return o}static cleanup(){this.tokenizer&&(this.tokenizer=null),P.clear()}}var R,I,j;j=null,(I="tokenizer")in(R=D)?Object.defineProperty(R,I,{value:j,enumerable:!0,configurable:!0,writable:!0}):R[I]=j,D.initialize();D.countTokens.bind(D),D.countMessageTokens.bind(D),D.countMessagesTokens.bind(D),D.countToolTokens.bind(D),D.calculateContextTokens.bind(D);const q=D.truncateToTokenLimit.bind(D),A=(D.estimateCost.bind(D),D.getModelTokenLimit.bind(D),/(?:https?:\/\/[^\s/]+)?\/d\/([a-zA-Z0-9_-]+)(?:\/[^\s?#)"\]`]*)?(?:\?[^\s)"\]`]*)?/g),L=/(?:https?:\/\/[^\s/]+)?\/explore(?=\?|[)\]`"\s.,;:!?]|$)(?:\?[^\s)"\]`]*)?/g,$=/\[([^\]]+)\]\(((?:https?:\/\/[^\s/]+)?\/(?:d\/[^)]+|explore(?:\?[^)]*)?))\)/g;function M(e){const t=e.match(/\/d\/([a-zA-Z0-9_-]+)/);return t?t[1]:void 0}const z=/\/explore(?:\?|\/|$)/;function B(e){return e.includes("/d/")?"dashboard":z.test(e)?"explore":null}function F(e){return e.replace(/[.,;:!?`]+$/,"").trim()}function K(e){const t=e.match(/\/d\/[^\s]*/);if(t)return t[0];const r=e.match(/\/explore(?:\?[^\s]*|\/[^\s]*)?$/);return r?r[0]:e}function U(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function _(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){U(o,n,s,a,i,"next",e)}function i(e){U(o,n,s,a,i,"throw",e)}a(void 0)})}}function G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function H(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){G(e,t,r[t])})}return e}function V(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const W=(e,t=!1)=>{if("tool"===e.role&&"string"==typeof e.content){const r=t?500:8e3,{content:n,wasTrimmed:s}=((e,t=8e3)=>D.countTokens(e)<=t?{content:e,wasTrimmed:!1}:{content:q(e,t,!0),wasTrimmed:!0})(e.content,r);return{message:V(H({},e),{content:n}),wasTrimmed:s}}return{message:e,wasTrimmed:!1}},J=(e,t,r)=>{const n=t;let s=D.calculateContextTokens(e,n);if(s.totalTokens<=r)return e;console.warn(`âš ï¸ Token limit exceeded: ${s.totalTokens} > ${r}. Trimming messages...`);let o=e.map(e=>{const{message:t,wasTrimmed:r}=W(e);return t});if(s=D.calculateContextTokens(o,n),s.totalTokens>r&&(o=e.map(e=>{const{message:t,wasTrimmed:r}=W(e,!0);return t}),s=D.calculateContextTokens(o,n)),s.totalTokens<=r)return o;const a=o.length>0&&"system"===o[0].role?o[0]:null,i=a?o.slice(1):o;let l=a?[a]:[],c=r-1e3;for(let e=i.length-1;e>=0;e--){const t=[a,...i.slice(e)].filter(Boolean);if(D.calculateContextTokens(t,n).totalTokens<=c){l=t;break}}l.length<=(a?1:0)&&i.length>0&&(l=a?[a,i[i.length-1]]:[i[i.length-1]]);D.calculateContextTokens(l,n),e.length,l.length,e.filter(e=>"tool"===e.role).length,l.filter(e=>"tool"===e.role).length,e.filter(e=>"user"===e.role).length,l.filter(e=>"user"===e.role).length,e.filter(e=>"assistant"===e.role).length,l.filter(e=>"assistant"===e.role).length;return l},Y=(e,t,r,s)=>{const o=(0,n.useRef)(null),a=(0,n.useRef)(!1);(0,n.useEffect)(()=>()=>{o.current&&(o.current.abort(),o.current=null),a.current=!1},[]);const i=(0,n.useCallback)(()=>s.maxTotalTokens||1e5,[s.maxTotalTokens]),l=(0,n.useCallback)((n,s)=>_(function*(){const c=new AbortController;o.current=c;const u=r(s),d=i(),m=J(n,u,d),g=(D.calculateContextTokens(m,u),Date.now());try{var y;const r=yield x.add(()=>{return e=T.WX({model:T.Kx.LARGE,messages:m,tools:u}),t=12e4,r="LLM API request",Promise.race([e,new Promise((e,n)=>setTimeout(()=>n(new Error(`${r} timed out after ${t}ms. The LLM API may be slow or unresponsive.`)),t))]);var e,t,r},{priority:10,maxRetries:2}),o=(Date.now(),null===(y=r.choices)||void 0===y?void 0:y[0]);if(!o)throw new Error("No response from LLM");const a=o.message;if(a.content){if(c.signal.aborted)throw new DOMException("Request aborted","AbortError");yield(h=a.content,p=t=>{c.signal.aborted||e(e=>e.map((r,n)=>n===e.length-1&&"assistant"===r.role?V(H({},r),{content:t}):r))},f=c.signal,_(function*(){if(!h)return void p(h);let e=0;for(;e<h.length;){if(null==f?void 0:f.aborted)throw new DOMException("Streaming aborted","AbortError");const t=Math.min(e+50,h.length),r=h.slice(0,t);p(r),e=t,e<h.length&&(yield new Promise((e,t)=>{const r=setTimeout(e,30);if(f){const e=()=>{clearTimeout(r),t(new DOMException("Streaming aborted","AbortError"))};f.aborted?e():f.addEventListener("abort",e,{once:!0})}}))}})());const t=function(e){if(!e)return[];const t=[],r=new Set,n=Array.from(e.matchAll($));for(const e of n){const n=e[1],s=F(e[2]),o=B(s),a=K(s);o&&!r.has(a)&&(r.add(a),t.push({url:s,title:n,type:o,uid:"dashboard"===o?M(s):void 0}))}const s=Array.from(e.matchAll(A));for(const e of s){const n=F(e[0]),s=K(n);r.has(s)||(r.add(s),t.push({url:n,type:"dashboard",uid:M(n)}))}const o=Array.from(e.matchAll(L));for(const e of o){const n=F(e[0]),s=K(n);r.has(s)||(r.add(s),t.push({url:n,type:"explore"}))}return t}(a.content);e(e=>e.map((r,n)=>n===e.length-1&&"assistant"===r.role?V(H({},r),{pageRefs:t}):r))}if(a.tool_calls&&a.tool_calls.length>0){if(c.signal.aborted)throw new DOMException("Request aborted","AbortError");n.push(a);const e=a.tool_calls.filter(e=>"function"===e.type);yield t(e,n);const r=J(n,u,d);D.calculateContextTokens(r,u);yield l(n,s)}}catch(e){const t=Date.now()-g;if(e instanceof DOMException&&"AbortError"===e.name)return;throw console.error(`[API] Error after ${t}ms:`,e),e}finally{o.current===c&&(o.current=null),a.current=!1}var h,p,f})(),[r,i,e,t]);return{handleStreamingChatWithHistory:l}};var Q=r(98852);function X(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}class Z{static summarizeMessages(e){return(t=function*(){if(0===e.length)return"";const t=`Please provide a concise summary of the following conversation between a user and an AI assistant. Focus on:\n1. Key questions asked by the user\n2. Important information discovered or tools used\n3. Main conclusions or action items\n4. Any ongoing context that should be remembered\n\nConversation:\n${e.map(e=>`${"user"===e.role?"User":"Assistant"}: ${e.content}`).join("\n\n")}\n\nSummary:`;try{const e=T.qH({model:T.Kx.LARGE,messages:[{role:"user",content:t}]}),r=yield(0,u.lastValueFrom)(e.pipe(T.qA()));return"string"==typeof r?r:""}catch(t){return console.error("Failed to generate summary:",t),this.fallbackSummarize(e)}},function(){var e=this,r=arguments;return new Promise(function(n,s){var o=t.apply(e,r);function a(e){X(o,n,s,a,i,"next",e)}function i(e){X(o,n,s,a,i,"throw",e)}a(void 0)})}).call(this);var t}static fallbackSummarize(e){const t=e.filter(e=>"user"===e.role).map((e,t)=>`${t+1}. ${e.content.slice(0,100)}...`);return`Conversation covered ${e.length} messages about:\n${t.join("\n")}`}static createMemoryAwareHistory(e,t,r=10){if(e.length<=r)return{summary:null,recentMessages:e};return{summary:t||null,recentMessages:e.slice(-r)}}static createContextSummaryMessage(e){return{role:"system",content:`[Previous conversation summary: ${e}]`}}static shouldSummarize(e,t=20){return e>=t&&e%10==0}static extractToolCallContext(e){const t=[];return e.forEach(e=>{"assistant"===e.role&&e.toolCalls&&e.toolCalls.length>0&&e.toolCalls.forEach(e=>{e.error||t.push(`Used tool: ${e.name}`)})}),t}static buildContextWindow(e,t,r,n=10){const s=[];s.push({role:"system",content:e}),r&&t.length>n&&s.push(this.createContextSummaryMessage(r));return t.slice(-n).forEach(e=>{s.push({role:e.role,content:e.content})}),s}static estimateContextSize(e,t){let r=0;return e.forEach(e=>{const t="string"==typeof e.content?e.content:JSON.stringify(e.content);r+=Math.ceil(t.length/4)}),t.forEach(e=>{r+=Math.ceil(JSON.stringify(e).length/4)}),r}static optimizeMessageHistory(e,t=5e4,r){if(e.reduce((e,t)=>e+Math.ceil(t.content.length/4),0)<.7*t)return{messages:e,needsSummary:!1};const n=r?15:25,s=!r&&e.length>30;return{messages:e.slice(-n),needsSummary:s}}}function ee(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function te(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){ee(o,n,s,a,i,"next",e)}function i(e){ee(o,n,s,a,i,"throw",e)}a(void 0)})}}var re=r(91817);function ne(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function se(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){ne(o,n,s,a,i,"next",e)}function i(e){ne(o,n,s,a,i,"throw",e)}a(void 0)})}}function oe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ae{static retryWithBackoff(e,t){return se(function*(e,t,r=this.MAX_RETRIES){let n;for(let s=0;s<r;s++)try{return yield e()}catch(e){if(n=e,console.error(`[Reliability] ${t} failed (attempt ${s+1}/${r}):`,e),!this.isRetryableError(e))throw e;if(s<r-1){const e=this.RETRY_DELAYS[s]||this.RETRY_DELAYS[this.RETRY_DELAYS.length-1];yield this.sleep(e)}}throw console.error(`[Reliability] ${t} failed after ${r} attempts`),n}).apply(this,arguments)}static isRetryableError(e){if(!e)return!1;if(e instanceof TypeError&&e.message.includes("fetch"))return!0;const t=String(e).toLowerCase();return["network","timeout","econnrefused","enotfound","rate limit","429","500","502","503","504","temporarily unavailable","too many requests"].some(e=>t.includes(e))}static sleep(e){return new Promise(t=>setTimeout(t,e))}static categorizeError(e){const t=String(e).toLowerCase(),r=e instanceof Error?e.message:String(e);return t.includes("network")||t.includes("fetch")||t.includes("econnrefused")||t.includes("timeout")?{type:"network",message:"Network connection error. Please check your connection and try again.",retryable:!0}:t.includes("rate limit")||t.includes("429")||t.includes("500")||t.includes("502")||t.includes("503")?{type:"api",message:"API request failed. The service may be temporarily unavailable.",retryable:!0}:t.includes("tool")||t.includes("function")?{type:"tool",message:`Tool execution failed: ${r}`,retryable:!1}:t.includes("validation")||t.includes("invalid")?{type:"validation",message:`Validation error: ${r}`,retryable:!1}:t.includes("storage")||t.includes("quota")?{type:"storage",message:"Storage error. Your browser storage may be full.",retryable:!1}:{type:"unknown",message:r,retryable:!1}}static getUserFriendlyErrorMessage(e){const t=this.categorizeError(e);switch(t.type){case"network":return"ðŸŒ Network error: Unable to connect. Please check your internet connection and try again.";case"api":return"âš ï¸ Service temporarily unavailable: The API is currently experiencing issues. Please try again in a moment.";case"tool":return`ðŸ”§ Tool error: ${t.message}`;case"validation":return`âŒ Validation error: ${t.message}`;case"storage":return"ðŸ’¾ Storage error: Unable to save data. Your browser storage may be full. Consider clearing old conversations.";default:return`âŒ An error occurred: ${t.message}`}}static saveRecoveryState(e){try{sessionStorage.setItem(this.RECOVERY_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save recovery state:",e)}}static loadRecoveryState(){try{const e=sessionStorage.getItem(this.RECOVERY_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Failed to load recovery state:",e),null}}static clearRecoveryState(){try{sessionStorage.removeItem(this.RECOVERY_KEY)}catch(e){console.error("Failed to clear recovery state:",e)}}static hasRecoveryState(){return null!==sessionStorage.getItem(this.RECOVERY_KEY)}static safeOperation(e,t,r){return se(function*(){try{return yield e()}catch(e){return console.error(`[Reliability] Safe operation "${r}" failed:`,e),t}})()}static validateToolCall(e){var t;if(!(null===(t=e.function)||void 0===t?void 0:t.name))return{valid:!1,error:"Tool name is missing"};try{return JSON.parse(e.function.arguments),{valid:!0}}catch(e){return{valid:!1,error:"Invalid tool arguments JSON"}}}static checkRateLimit(e,t,r){const n=Date.now(),s=this.rateLimitMap.get(e);return!s||n>s.resetTime?(this.rateLimitMap.set(e,{count:1,resetTime:n+r}),!0):!(s.count>=t)&&(s.count++,!0)}static checkCircuitBreaker(e){const t=this.circuitBreakers.get(e),r=Date.now();return t?"open"!==t.state||r-t.lastFailure>this.CIRCUIT_BREAKER_TIMEOUT&&(t.state="half-open",!0):(this.circuitBreakers.set(e,{failures:0,lastFailure:0,state:"closed"}),!0)}static recordCircuitBreakerFailure(e){const t=this.circuitBreakers.get(e),r=Date.now();t?(t.failures++,t.lastFailure=r,t.failures>=this.CIRCUIT_BREAKER_THRESHOLD&&(t.state="open",console.warn(`[Reliability] Circuit breaker opened for ${e} due to repeated failures`))):this.circuitBreakers.set(e,{failures:1,lastFailure:r,state:"closed"})}static recordCircuitBreakerSuccess(e){const t=this.circuitBreakers.get(e);t&&(t.failures=0,t.state="closed")}}oe(ae,"MAX_RETRIES",3),oe(ae,"RETRY_DELAYS",[1e3,2e3,4e3]),oe(ae,"RECOVERY_KEY","grafana-o11y-chat-recovery"),oe(ae,"rateLimitMap",new Map),oe(ae,"circuitBreakers",new Map),oe(ae,"CIRCUIT_BREAKER_THRESHOLD",5),oe(ae,"CIRCUIT_BREAKER_TIMEOUT",6e4);var ie=r(47294);function le(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function ce(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ue(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){ce(e,t,r[t])})}return e}function de(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const me=(e,t)=>{const r=String(a.config.bootData.user.orgId||"1"),{systemPromptMode:s,customSystemPrompt:o}=e,u=(0,n.useMemo)(()=>((e="default",t="")=>{switch(e){case"replace":return t||re.L;case"append":return t.trim()?`${re.L}\n\n## Additional Instructions\n\n${t}`:re.L;default:return re.L}})(s,o),[s,o]),[d,m]=(0,n.useState)(t?t.messages:[]),[g,h]=(0,n.useState)(""),[p,f]=(0,n.useState)(!1),b=(0,n.useRef)(null),v=(0,n.useRef)(null),[x,w]=(0,n.useState)(!0),[S,T]=(0,n.useState)(0),{toolCalls:O,toolsLoading:P,toolsError:D,toolsData:R,clearToolCalls:I,handleToolCalls:j,getRunningToolCallsCount:q,formatToolsForOpenAI:A}=(()=>{const[e,t]=(0,n.useState)(new Map),r=(0,n.useRef)(new Set),s=(0,n.useRef)(!0);(0,n.useEffect)(()=>{const e=r.current;return()=>{s.current=!1,e.size>0&&e.clear()}},[]);const o=(0,n.useCallback)(()=>{t(new Map)},[]),a=(0,n.useCallback)(()=>k(function*(){try{return{tools:yield y.listTools()}}catch(e){return console.error("Error fetching tools:",e),{tools:[]}}})(),[]),u=(0,n.useCallback)((e,n)=>k(function*(){const{function:o,id:a}=e;s.current&&t(e=>new Map(e).set(a,{name:o.name,arguments:o.arguments,running:!0}));const i=JSON.parse(o.arguments),l=E.add(()=>k(function*(){const e=yield y.callTool({name:o.name,arguments:i});if(!e)throw new Error("Backend MCP tool call returned null");const r=c.TF.parse(e).content.filter(e=>"text"===e.type).map(e=>e.text).join("").trim()||"No results returned (empty response)";return n.push({role:"tool",tool_call_id:a,content:r}),s.current&&t(t=>new Map(t).set(a,N(C({},t.get(a)),{running:!1,response:e}))),e})(),{priority:8,maxRetries:1,id:`tool-${a}`}).catch(e=>{var r;const o=null!==(r=e.message)&&void 0!==r?r:e.toString();throw console.error("Tool call error:",o),n.push({role:"tool",tool_call_id:a,content:o}),s.current&&t(e=>new Map(e).set(a,N(C({},e.get(a)),{running:!1,error:o}))),e});r.current.add(l),l.finally(()=>{r.current.delete(l)}),yield l})(),[]),d=(0,n.useCallback)((e,t)=>k(function*(){const r=e.filter(e=>e.function);yield Promise.all(r.map(e=>u(e,t)))})(),[u]),m=(0,n.useCallback)(()=>Array.from(e.values()).filter(e=>e.running).length,[e]),g=(0,n.useCallback)(()=>m()>0,[m]),{loading:h,error:p,value:f}=(0,i.A)(a,[a]);return{toolCalls:e,toolsLoading:h,toolsError:p,toolsData:f,clearToolCalls:o,handleToolCall:u,handleToolCalls:d,getRunningToolCallsCount:m,hasRunningToolCalls:g,formatToolsForOpenAI:e=>l.g9(e),getAvailableTools:a}})(),{handleStreamingChatWithHistory:L}=Y(m,j,A,e),$=((e,t,r)=>{const s=(0,a.usePluginUserStorage)(),o=(0,n.useMemo)(()=>Q.E.getSessionService(s),[s]),[i,l]=(0,n.useState)(null),[c,u]=(0,n.useState)([]),[d,m]=(0,n.useState)(void 0),[g,y]=(0,n.useState)(!1),[h,p]=(0,n.useState)({used:0,total:0,sessionCount:0}),f=(0,n.useRef)(null),b=(0,n.useCallback)(()=>te(function*(){try{const t=yield o.getAllSessions(e);u(t);const r=yield o.getStorageStats(e);p(r)}catch(e){console.error("[SessionManager] Failed to refresh sessions:",e)}})(),[o,e]);(0,n.useEffect)(()=>{let n=!1;return te(function*(){try{const s=yield o.getAllSessions(e);n||u(s);const a=yield o.getStorageStats(e);if(n||p(a),0===t.length){const t=yield o.getCurrentSession(e);!n&&t&&(l(t.id),r(t.messages),m(t.summary))}}catch(e){n||console.error("[SessionManager] Failed to initialize:",e)}})(),()=>{n=!0}},[e]);const v=(0,n.useCallback)(()=>te(function*(){r([]),l(null),m(void 0);try{yield o.clearActiveSession(e)}catch(e){console.error("[SessionManager] Failed to clear active session:",e)}})(),[o,e,r]),x=(0,n.useCallback)(t=>te(function*(){try{const n=yield o.getSession(e,t);n?(l(n.id),r(n.messages),m(n.summary),yield o.setActiveSession(e,n.id)):console.error(`[SessionManager] Session ${t} not found`)}catch(e){console.error("[SessionManager] Error loading session:",e)}})(),[o,e,r]),E=(0,n.useCallback)(t=>te(function*(){try{yield o.deleteSession(e,t),yield b(),t===i&&(yield v())}catch(e){console.error("[SessionManager] Error deleting session:",e)}})(),[o,e,i,v,b]),w=(0,n.useCallback)(()=>te(function*(){try{yield o.deleteAllSessions(e),yield b(),yield v()}catch(e){console.error("[SessionManager] Error deleting all sessions:",e)}})(),[o,e,v,b]),k=(0,n.useCallback)(t=>te(function*(){try{const r=yield o.exportSession(e,t);if(r){const e=new Blob([r],{type:"application/json"}),n=URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=`chat-session-${t}-${Date.now()}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}}catch(e){console.error("[SessionManager] Error exporting session:",e)}})(),[o,e]),S=(0,n.useCallback)(t=>te(function*(){try{const r=yield o.importSession(e,t);return yield b(),yield x(r.id),!0}catch(e){return console.error("[SessionManager] Error importing session:",e),!1}})(),[o,e,x,b]),C=(0,n.useCallback)(t=>{0!==t.length&&(f.current&&clearTimeout(f.current),f.current=setTimeout(()=>te(function*(){try{const r=i;if(r)yield o.updateSession(e,r,t,d);else if(t.length>0){const r=yield o.createSession(e,t);l(e=>null===e?r.id:e)}yield b()}catch(e){console.error("[SessionManager] Auto-save failed:",e)}})(),1e4))},[o,e,i,d,b]),N=(0,n.useCallback)(t=>te(function*(){if(!(g||t.length<20)){y(!0);try{const r=d?t.slice(0,-10):t.slice(0,-5);if(r.length>0){const n=yield Z.summarizeMessages(r);m(n),i&&(yield o.updateSession(e,i,t,n))}}catch(e){console.error("[SessionManager] Summarization failed:",e)}finally{y(!1)}}})(),[o,e,i,d,g]);return(0,n.useEffect)(()=>{t.length>0&&(C(t),Z.shouldSummarize(t.length)&&N(t))},[t,C,N]),(0,n.useEffect)(()=>()=>{f.current&&clearTimeout(f.current)},[]),{currentSessionId:i,sessions:c,currentSummary:d,createNewSession:v,loadSession:x,deleteSession:E,deleteAllSessions:w,exportSession:k,importSession:S,autoSaveMessages:C,triggerSummarization:N,isSummarizing:g,storageStats:h}})(r,d,m);(0,n.useEffect)(()=>{x&&v.current&&v.current.scrollIntoView({block:"end",behavior:"auto"})},[d]),(0,n.useEffect)(()=>{const e=()=>{const e=window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-50;w(e)};return window.addEventListener("scroll",e,{passive:!0}),()=>window.removeEventListener("scroll",e)},[]);const M=()=>{return(e=function*(){if(!g.trim()||p)return;let e;w(!0);try{e=ie.Bm.validateChatInput(g)}catch(e){return console.error("[useChat] Input validation failed:",e),void m(t=>[...t,{role:"assistant",content:`âš ï¸ Input validation error: ${e instanceof Error?e.message:"Invalid input"}`}])}if(!ae.checkCircuitBreaker("llm-stream"))return void m(e=>[...e,{role:"assistant",content:"âš ï¸ The service is temporarily unavailable due to repeated errors. Please try again in a moment."}]);const t={role:"user",content:e},r=[...d,t];m(r),h(""),f(!0),I();const n={role:"assistant",content:"",toolCalls:[]};m(e=>[...e,n]);const s=Z.buildContextWindow(u,r,$.currentSummary,15);ae.saveRecoveryState({sessionId:$.currentSessionId,lastMessageIndex:r.length,wasGenerating:!0});try{const e=(null==R?void 0:R.tools)||[];yield L(s,e),ae.recordCircuitBreakerSuccess("llm-stream"),T(0),ae.clearRecoveryState()}catch(e){console.error("[useChat] Error in chat completion:",e),ae.recordCircuitBreakerFailure("llm-stream");const t=ae.getUserFriendlyErrorMessage(e);m(e=>e.map((r,n)=>n===e.length-1&&"assistant"===r.role?de(ue({},r),{content:t}):r)),T(e=>e+1)}finally{f(!1)}},function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){le(o,n,s,a,i,"next",e)}function i(e){le(o,n,s,a,i,"throw",e)}a(void 0)})})();var e};(0,n.useEffect)(()=>{O.size>0&&(e=>{const t=Array.from(e.values());m(e=>e.map((r,n)=>n===e.length-1&&"assistant"===r.role?de(ue({},r),{toolCalls:t}):r))})(O)},[O]),(0,n.useEffect)(()=>{const e=ae.loadRecoveryState();e&&e.wasGenerating&&ae.clearRecoveryState()},[]);const z=(0,n.useMemo)(()=>{for(let e=d.length-1;e>=0;e--){const t=d[e];if("assistant"===t.role)return t.pageRefs&&t.pageRefs.length>0?t.pageRefs.map(t=>de(ue({},t),{messageIndex:e})):[]}return[]},[d]);return{chatHistory:d,currentInput:g,isGenerating:p,chatContainerRef:b,toolCalls:O,toolsLoading:P,toolsError:D,toolsData:R,setCurrentInput:h,sendMessage:M,handleKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},clearChat:()=>{m([]),I(),$.createNewSession()},getRunningToolCallsCount:q,isAutoScroll:x,setIsAutoScroll:w,handleScroll:()=>{},sessionManager:$,retryCount:S,bottomSpacerRef:v,detectedPageRefs:z}};let ge=null,ye=null;function he(){const[e,t]=(0,n.useState)(ge);return(0,n.useEffect)(()=>{if(null!==ge)return;let e=!0;return ye||(ye=fetch(window.location.origin+"/api/health",{method:"HEAD"}).then(e=>{const t=e.headers.get("X-Frame-Options");return ge=!t||"deny"!==t.toLowerCase(),ge}).catch(()=>(ge=!1,!1))),ye.then(r=>{e&&t(r)}),()=>{e=!1}},[]),e}const pe=({isGenerating:e,currentSessionTitle:t})=>{const r=(0,o.useTheme2)();return s().createElement("div",{className:"flex justify-between items-center py-3 mb-2"},s().createElement("div",{className:"flex items-center gap-3"},t&&s().createElement("span",{className:"text-sm truncate max-w-md font-medium",style:{color:r.colors.text.secondary},title:t},t)))};var fe=r(40343);const be=({size:e=14})=>s().createElement("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("polyline",{points:"20 6 9 17 4 12"})),ve=({size:e=14})=>s().createElement("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),s().createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})),xe=({size:e=14})=>s().createElement("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"animate-spin"},s().createElement("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})),Ee=({toolCall:e})=>{const t=(0,o.useTheme2)(),[r,a]=(0,n.useState)(!1),i=(l=e.running,e.error?{icon:s().createElement(ve,{size:12}),color:"#ef4444"}:l?{icon:s().createElement(xe,{size:12}),color:"#fbbf24"}:{icon:s().createElement(be,{size:12}),color:"#22c55e"});var l;const c=(e=>{try{const t=JSON.parse(e),r=Object.keys(t);if(0===r.length)return"";if(1===r.length){const e=JSON.stringify(t[r[0]]);return e.length>40?`${r[0]}: ${e.substring(0,40)}...`:`${r[0]}: ${e}`}return`${r.length} params`}catch(t){return e.length>40?e.substring(0,40)+"...":e}})(e.arguments),u=e.arguments&&"{}"!==e.arguments,d=u&&e.arguments.length>50;return s().createElement("div",{className:"group rounded-lg transition-all duration-200",style:{backgroundColor:t.isDark?"rgba(255, 255, 255, 0.02)":"rgba(0, 0, 0, 0.01)",border:"1px solid "+(t.isDark?"rgba(255, 255, 255, 0.04)":"rgba(0, 0, 0, 0.04)")}},s().createElement("div",{className:"flex items-center gap-3 px-3 py-2.5 "+(d?"cursor-pointer":""),onClick:d?()=>a(!r):void 0},s().createElement("div",{className:"flex-shrink-0 w-5 h-5 rounded flex items-center justify-center",style:{color:i.color}},i.icon),s().createElement("div",{className:"flex-1 min-w-0 flex items-center gap-2"},s().createElement("span",{className:"font-mono text-xs font-medium truncate",style:{color:t.colors.text.primary},title:e.name},e.name),u&&s().createElement("span",{className:"font-mono text-xs truncate",style:{color:t.colors.text.secondary}},c)),d&&s().createElement("div",{className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",style:{color:t.colors.text.secondary}},s().createElement("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"transition-transform duration-200 "+(r?"rotate-180":"")},s().createElement("polyline",{points:"6 9 12 15 18 9"})))),r&&u&&s().createElement("div",{className:"mx-3 mb-3 p-2.5 rounded-md font-mono text-xs overflow-x-auto",style:{backgroundColor:t.isDark?"rgba(0, 0, 0, 0.3)":"rgba(0, 0, 0, 0.03)",color:t.colors.text.secondary}},s().createElement("pre",{className:"whitespace-pre-wrap break-words m-0 leading-relaxed"},(e=>{try{const t=JSON.parse(e);return JSON.stringify(t,null,2)}catch(t){return e}})(e.arguments))),e.error&&s().createElement("div",{className:"mx-3 mb-3 p-2.5 rounded-md",style:{backgroundColor:t.isDark?"rgba(239, 68, 68, 0.1)":"rgba(239, 68, 68, 0.05)",border:"1px solid "+(t.isDark?"rgba(239, 68, 68, 0.2)":"rgba(239, 68, 68, 0.15)")}},s().createElement("div",{className:"flex items-start gap-2"},s().createElement("span",{style:{color:"#ef4444"}},s().createElement(ve,{size:12})),s().createElement("pre",{className:"text-xs font-mono whitespace-pre-wrap break-words m-0 flex-1",style:{color:t.colors.text.secondary}},e.error))))},we=({size:e=18})=>s().createElement("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"})),ke=({size:e=16,isExpanded:t})=>s().createElement("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"transition-transform duration-200 "+(t?"rotate-180":"")},s().createElement("polyline",{points:"6 9 12 15 18 9"})),Se=({toolCalls:e})=>{const t=(0,o.useTheme2)(),[r,a]=(0,n.useState)(!1),i=e.filter(e=>e.running).length,l=e.filter(e=>!e.running&&!e.error).length,c=e.filter(e=>e.error).length;return e&&0!==e.length?s().createElement("div",{className:"rounded-xl overflow-hidden mb-4 transition-all duration-200",style:{backgroundColor:t.isDark?"rgba(255, 255, 255, 0.02)":"rgba(0, 0, 0, 0.02)",border:`1px solid ${t.isDark?"rgba(255, 255, 255, 0.06)":t.colors.border.weak}`}},s().createElement("button",{className:"w-full flex justify-between items-center px-4 py-3 transition-colors duration-200",style:{backgroundColor:"transparent"},onClick:()=>a(!r)},s().createElement("div",{className:"flex items-center gap-3"},s().createElement("div",{className:"w-7 h-7 rounded-lg flex items-center justify-center",style:{backgroundColor:t.isDark?"rgba(139, 92, 246, 0.15)":"rgba(139, 92, 246, 0.1)",color:"#a78bfa"}},s().createElement(we,{size:14})),s().createElement("div",{className:"flex items-center gap-2"},s().createElement("span",{className:"text-sm font-medium",style:{color:t.colors.text.primary}},"Tool Execution"),s().createElement("span",{className:"px-1.5 py-0.5 rounded text-xs font-medium",style:{backgroundColor:t.isDark?"rgba(255, 255, 255, 0.06)":"rgba(0, 0, 0, 0.04)",color:t.colors.text.secondary}},e.length)),s().createElement("div",{className:"flex items-center gap-1.5"},i>0&&s().createElement("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:t.isDark?"rgba(251, 191, 36, 0.15)":"rgba(251, 191, 36, 0.1)",color:"#fbbf24"}},s().createElement("span",{className:"w-1.5 h-1.5 rounded-full bg-current animate-pulse"}),i),l>0&&s().createElement("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:t.isDark?"rgba(34, 197, 94, 0.15)":"rgba(34, 197, 94, 0.1)",color:"#22c55e"}},s().createElement("span",null,"âœ“"),l),c>0&&s().createElement("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:t.isDark?"rgba(239, 68, 68, 0.15)":"rgba(239, 68, 68, 0.1)",color:"#ef4444"}},s().createElement("span",null,"âœ•"),c))),s().createElement("div",{style:{color:t.colors.text.secondary}},s().createElement(ke,{isExpanded:r}))),r&&s().createElement("div",{className:"px-4 pb-3 pt-1 space-y-2"},e.map((e,t)=>s().createElement(Ee,{key:t,toolCall:e})))):null};var Ce=r(15056),Ne=r(11625),Te=r(94116),Oe=r(65938),Pe=r(29931),De=r(9235);const Re=({query:e,height:t=300,showControls:r=!0,defaultTimeRange:i={from:"now-1h",to:"now"},refreshInterval:l="",visualizationType:c="timeseries"})=>{const u=(0,o.useTheme2)(),[d,m]=(0,n.useState)(null),[g,y]=(0,n.useState)(!0),[h,p]=(0,n.useState)(c),[f,b]=(0,n.useState)(!1),v=(0,n.useCallback)(e=>{p(e)},[]);return(0,n.useEffect)(()=>{y(!0);const n=new Ce.JZ({from:i.from,to:i.to});let s;try{s=(0,a.getDataSourceSrv)().getInstanceSettings("Prometheus"),s||(console.warn("[GraphRenderer] No Prometheus data source found, using default"),s={uid:"prometheus",type:"prometheus"})}catch(e){console.warn("[GraphRenderer] Error getting data source:",e),s={uid:"prometheus",type:"prometheus"}}const o=new Ce.dt({datasource:s,queries:[{refId:"A",expr:e.query,format:"time_series",instant:!1}]});let c;switch(h){case"stat":c=Ce.d0.stat().setTitle(e.title||"Stats").setData(o).setOption("reduceOptions",{values:!1,fields:"",calcs:["lastNotNull"]}).build();break;case"gauge":c=Ce.d0.gauge().setTitle(e.title||"Gauge").setData(o).setOption("showThresholdLabels",!0).setOption("showThresholdMarkers",!0).build();break;case"table":c=Ce.d0.table().setTitle(e.title||"Table").setData(o).setOption("showHeader",!0).build();break;case"piechart":c=Ce.d0.piechart().setTitle(e.title||"Pie Chart").setData(o).setOption("legend",{showLegend:!0,placement:"right"}).setOption("pieType",Te.PieChartType.Pie).setOption("displayLabels",[Te.PieChartLabels.Name,Te.PieChartLabels.Percent]).build();break;case"barchart":c=Ce.d0.barchart().setTitle(e.title||"Bar Chart").setData(o).setOption("legend",{showLegend:!0,placement:"bottom"}).setOption("orientation",Ne.wV.Auto).setOption("showValue",Ne.yL.Auto).build();break;case"heatmap":c=Ce.d0.heatmap().setTitle(e.title||"Heatmap").setData(o).setOption("calculate",!1).setOption("cellGap",1).setOption("color",{mode:Oe.HeatmapColorMode.Scheme,scheme:"Spectral",steps:64}).setOption("yAxis",{axisPlacement:Ne.vM.Left}).build();break;case"histogram":c=Ce.d0.histogram().setTitle(e.title||"Histogram").setData(o).setOption("legend",{showLegend:!0,placement:"bottom"}).setOption("bucketCount",30).build();break;default:c=Ce.d0.timeseries().setTitle(e.title||"Time Series").setData(o).setOption("legend",{showLegend:!0,placement:"bottom"}).build()}const u=new Ce.G1({direction:"column",children:[new Ce.vA({body:c,minHeight:f?2*t:t})]}),d=r?[new Ce.KE({}),new Ce.WM({intervals:["5s","10s","30s","1m","5m","15m","30m","1h"],refresh:l})]:[],g=new Ce.P1({$timeRange:n,body:u,controls:d});let p=!1;const b=setTimeout(()=>{p||(g.activate(),m(g),y(!1))},0);return()=>{p=!0,clearTimeout(b)}},[e.query,e.title,t,h,r,l,f,i.from,i.to]),d?s().createElement("div",{className:"my-4 rounded-lg overflow-hidden",style:{border:`1px solid ${u.colors.border.weak}`}},s().createElement("div",{className:"px-4 py-2 flex items-center justify-between",style:{backgroundColor:u.colors.background.secondary,borderBottom:`1px solid ${u.colors.border.weak}`}},s().createElement("h4",{className:"text-sm font-medium",style:{color:u.colors.text.primary}},e.title||"Query Result"),s().createElement("div",{className:"flex items-center gap-2"},s().createElement(o.RadioButtonGroup,{size:"sm",value:h,options:[{label:"Time Series",value:"timeseries"},{label:"Stats",value:"stat"},{label:"Gauge",value:"gauge"},{label:"Table",value:"table"},{label:"Pie Chart",value:"piechart"},{label:"Bar Chart",value:"barchart"},{label:"Heatmap",value:"heatmap"},{label:"Histogram",value:"histogram"}],onChange:v}),s().createElement(o.Tooltip,{content:f?"Collapse":"Expand"},s().createElement(o.IconButton,{name:f?"angle-up":"angle-down",size:"sm",onClick:()=>b(!f),"aria-label":f?"Collapse graph":"Expand graph"})))),s().createElement("div",{className:"p-4 relative",style:{backgroundColor:u.colors.background.primary,minHeight:f?2*t:t}},s().createElement(De.p8,{isLoading:g,message:"Rendering visualization...",variant:"overlay"},s().createElement(d.Component,{model:d}))),s().createElement("div",{className:"px-4 py-2 flex items-center justify-between",style:{backgroundColor:u.colors.background.secondary,borderTop:`1px solid ${u.colors.border.weak}`}},s().createElement("code",{className:"text-xs flex-1",style:{color:u.colors.text.secondary}},e.query),s().createElement(o.Tooltip,{content:"Copy query"},s().createElement(o.IconButton,{name:"copy",size:"sm",onClick:()=>{navigator.clipboard.writeText(e.query)},"aria-label":"Copy query to clipboard"})))):s().createElement("div",{className:"my-4 rounded-lg overflow-hidden p-4",style:{border:`1px solid ${u.colors.border.weak}`,backgroundColor:u.colors.background.primary}},s().createElement(De.p8,{isLoading:!0,message:"Loading graph..."}))},Ie=e=>s().createElement(Pe.tH,{fallbackTitle:"Graph Rendering Error"},s().createElement(Re,e));var je=r(87781);const qe=({query:e,height:t=400,defaultTimeRange:r={from:"now-1h",to:"now"}})=>{const i=(0,o.useTheme2)(),[l,c]=(0,n.useState)(null);return(0,n.useEffect)(()=>{const n=new Ce.JZ({from:r.from,to:r.to});let s={type:"loki"};try{const e=(0,a.getDataSourceSrv)().getInstanceSettings("loki");e&&(s={uid:e.uid,type:"loki"})}catch(e){console.warn("[LogsRenderer] Could not get default Loki data source, using fallback")}const o=new Ce.dt({datasource:s,queries:[{refId:"A",expr:e.query,queryType:"range"}]}),i=Ce.d0.logs().setTitle(e.title||"Logs").setData(o).setOption("showTime",!0).setOption("showLabels",!0).setOption("showCommonLabels",!1).setOption("wrapLogMessage",!0).setOption("prettifyLogMessage",!1).setOption("enableLogDetails",!0).setOption("dedupStrategy",je.LogsDedupStrategy.none).setOption("sortOrder",je.LogsSortOrder.Descending).build(),l=new Ce.G1({direction:"column",children:[new Ce.vA({minHeight:t,body:i})]}),u=new Ce.P1({$timeRange:n,body:l,controls:[]});let d=!1;const m=setTimeout(()=>{d||(u.activate(),c(u))},0);return()=>{d=!0,clearTimeout(m)}},[e.query,e.title,t,r.from,r.to]),l?s().createElement("div",{className:"my-4 rounded-lg overflow-hidden",style:{border:`1px solid ${i.colors.border.weak}`}},e.title&&s().createElement("div",{className:"px-4 py-2",style:{backgroundColor:i.colors.background.secondary,borderBottom:`1px solid ${i.colors.border.weak}`}},s().createElement("h4",{className:"text-sm font-medium",style:{color:i.colors.text.primary}},e.title)),s().createElement("div",{className:"p-4",style:{backgroundColor:i.colors.background.primary}},s().createElement(l.Component,{model:l})),s().createElement("div",{className:"px-4 py-2",style:{backgroundColor:i.colors.background.secondary,borderTop:`1px solid ${i.colors.border.weak}`}},s().createElement("code",{className:"text-xs",style:{color:i.colors.text.secondary}},e.query))):s().createElement("div",{className:"my-4 rounded-lg overflow-hidden p-4",style:{border:`1px solid ${i.colors.border.weak}`,backgroundColor:i.colors.background.primary}},s().createElement("div",{style:{color:i.colors.text.secondary}},"Loading logs..."))},Ae=({query:e,height:t=400,defaultTimeRange:r={from:"now-1h",to:"now"}})=>{const i=(0,o.useTheme2)(),[l,c]=(0,n.useState)(null);return(0,n.useEffect)(()=>{const n=new Ce.JZ({from:r.from,to:r.to});let s={type:"tempo"};try{const e=(0,a.getDataSourceSrv)().getInstanceSettings("tempo");e&&(s={uid:e.uid,type:"tempo"})}catch(e){console.warn("[TracesRenderer] Could not get default Tempo data source, using fallback")}const o=new Ce.dt({datasource:s,queries:[{refId:"A",query:e.query,queryType:"traceql"}]}),i=Ce.d0.traces().setTitle(e.title||"Traces").setData(o).build(),l=new Ce.G1({direction:"column",children:[new Ce.vA({minHeight:t,body:i})]}),u=new Ce.P1({$timeRange:n,body:l,controls:[]});let d=!1;const m=setTimeout(()=>{d||(u.activate(),c(u))},0);return()=>{d=!0,clearTimeout(m)}},[e.query,e.title,t,r.from,r.to]),l?s().createElement("div",{className:"my-4 rounded-lg overflow-hidden",style:{border:`1px solid ${i.colors.border.weak}`}},e.title&&s().createElement("div",{className:"px-4 py-2",style:{backgroundColor:i.colors.background.secondary,borderBottom:`1px solid ${i.colors.border.weak}`}},s().createElement("h4",{className:"text-sm font-medium",style:{color:i.colors.text.primary}},e.title)),s().createElement("div",{className:"p-4",style:{backgroundColor:i.colors.background.primary}},s().createElement(l.Component,{model:l})),s().createElement("div",{className:"px-4 py-2",style:{backgroundColor:i.colors.background.secondary,borderTop:`1px solid ${i.colors.border.weak}`}},s().createElement("code",{className:"text-xs",style:{color:i.colors.text.secondary}},e.query))):s().createElement("div",{className:"my-4 rounded-lg overflow-hidden p-4",style:{border:`1px solid ${i.colors.border.weak}`,backgroundColor:i.colors.background.primary}},s().createElement("div",{style:{color:i.colors.text.secondary}},"Loading traces..."))};function Le(e){return"logql"===e||"loki"===e?"logs":"traceql"===e||"tempo"===e?"traces":"metrics"}function $e(e){const t={},r=e.match(/title="([^"]*)"/);r&&(t.title=r[1]);const n=e.match(/from="([^"]*)"/);n&&(t.from=n[1]);const s=e.match(/to="([^"]*)"/);s&&(t.to=s[1]);const o=e.match(/viz="([^"]*)"/);if(o){const e=o[1];["timeseries","stat","gauge","table","piechart","barchart","heatmap","histogram"].includes(e)&&(t.viz=e)}return t}const Me=({message:e,isGenerating:t=!1,isLastMessage:r=!1})=>{const n=(0,o.useTheme2)(),a="assistant"===e.role&&t&&r&&!e.content;if("user"===e.role)return s().createElement("div",{className:"flex w-full justify-end mb-5 animate-slideIn",role:"article","aria-label":"User message"},s().createElement("div",{className:"max-w-[75%]"},s().createElement("div",{className:"px-4 py-3 rounded-xl rounded-br-sm",style:{backgroundColor:n.isDark?"#3730a3":"#4f46e5",color:"#ffffff"},tabIndex:0,"aria-live":"polite"},s().createElement("span",{className:"sr-only"},"User message"),s().createElement("div",{className:"text-sm leading-relaxed whitespace-normal break-words"},e.content))));const i=e.content?function(e){const t=[],r=/```(promql|prometheus|logql|loki|traceql|tempo)([^\n]*)\n([\s\S]*?)```/gi;let n,s=0;for(;null!==(n=r.exec(e));){if(n.index>s){const r=e.substring(s,n.index).trim();r&&t.push({type:"text",content:r})}const[,r,o,a]=n,i=r.toLowerCase(),l=Le(i),c=$e(o);let u;u="logs"===l?"logql":"traces"===l?"traceql":"promql",t.push({type:u,content:n[0],query:{query:a.trim(),title:c.title,language:i,type:l,from:c.from,to:c.to,visualization:c.viz}}),s=n.index+n[0].length}if(s<e.length){const r=e.substring(s).trim();r&&t.push({type:"text",content:r})}return 0===t.length&&e.trim()&&t.push({type:"text",content:e}),t}(e.content):[];return s().createElement("div",{className:"flex w-full mb-6 animate-fadeIn",role:"article","aria-label":"Assistant message"},s().createElement("div",{className:"w-full max-w-none",tabIndex:0},s().createElement("span",{className:"sr-only"},"Assistant message"),e.toolCalls&&e.toolCalls.length>0&&s().createElement("div",{className:"mb-4"},s().createElement(Se,{toolCalls:e.toolCalls})),a?s().createElement("div",{className:"flex items-center gap-3 px-4 py-3 rounded-lg animate-pulse",style:{backgroundColor:n.isDark?"rgba(255, 255, 255, 0.03)":"rgba(0, 0, 0, 0.02)",color:n.colors.text.secondary}},s().createElement("div",{className:"flex gap-1.5"},s().createElement("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{backgroundColor:n.colors.primary.main,animationDelay:"0ms"}}),s().createElement("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{backgroundColor:n.colors.primary.main,animationDelay:"150ms"}}),s().createElement("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{backgroundColor:n.colors.primary.main,animationDelay:"300ms"}})),s().createElement("span",{className:"text-sm font-medium"},"Thinking...")):i.length>0?s().createElement("div",{className:"text-sm leading-relaxed whitespace-normal break-words",style:{color:n.colors.text.primary}},i.map((e,t)=>"text"===e.type?s().createElement("div",{key:t,className:"prose prose-sm max-w-none"},s().createElement(fe.jH,null,e.content)):"promql"===e.type&&e.query?s().createElement("div",{key:t,className:"my-3"},s().createElement(Ie,{query:e.query,defaultTimeRange:e.query.from?{from:e.query.from,to:e.query.to||"now"}:void 0,visualizationType:e.query.visualization})):"logql"===e.type&&e.query?s().createElement("div",{key:t,className:"my-3"},s().createElement(qe,{query:e.query,defaultTimeRange:e.query.from?{from:e.query.from,to:e.query.to||"now"}:void 0})):"traceql"===e.type&&e.query?s().createElement("div",{key:t,className:"my-3"},s().createElement(Ae,{query:e.query,defaultTimeRange:e.query.from?{from:e.query.from,to:e.query.to||"now"}:void 0})):null)):s().createElement("div",{className:"text-sm leading-relaxed whitespace-normal break-words prose prose-sm max-w-none",style:{color:n.colors.text.primary}},s().createElement(fe.jH,null,e.content))))},ze=({chatHistory:e,isGenerating:t})=>s().createElement("div",null,e.map((r,n)=>s().createElement(Me,{key:n,message:r,isGenerating:t,isLastMessage:n===e.length-1}))),Be=(0,n.forwardRef)(({currentInput:e,isGenerating:t,toolsLoading:r,setCurrentInput:a,sendMessage:i,handleKeyPress:l,rightSlot:c,leftSlot:u},d)=>{const m=(0,n.useRef)(null),[g,y]=(0,n.useState)(null),h=(0,o.useTheme2)();(0,n.useImperativeHandle)(d,()=>({focus:()=>{m.current&&(m.current.focus(),m.current.setSelectionRange(m.current.value.length,m.current.value.length))}}));const p=()=>{m.current&&(m.current.style.height="auto",m.current.style.height=`${Math.min(m.current.scrollHeight,200)}px`)};(0,n.useEffect)(()=>{p()},[e]);return s().createElement("div",{className:"relative"},g&&s().createElement("div",{className:"mb-2"},s().createElement(o.Alert,{severity:"error",title:"Input validation error"},g)),s().createElement("div",{className:"gradient-border-wrapper "+(g?"opacity-50":"")},s().createElement("div",{className:"gradient-border-inner px-5 py-4",style:{backgroundColor:h.isDark?"#1a1a1a":h.colors.background.primary}},s().createElement("textarea",{ref:m,value:e,onChange:e=>{const t=e.target.value;if(a(t),t.trim())try{ie.Bm.validateChatInput(t),y(null)}catch(e){y(e instanceof Error?e.message:"Invalid input")}else y(null);p()},onKeyDown:e=>{("Enter"!==e.key||e.shiftKey||g)&&"Enter"===e.key&&!e.shiftKey&&g?e.preventDefault():l(e)},placeholder:"Ask me anything about your metrics, logs, or observability...",disabled:t||r,rows:1,className:"w-full resize-none bg-transparent border-0 text-base placeholder-secondary focus:outline-none focus:ring-0 min-h-[28px] max-h-[200px]",style:{lineHeight:"1.6",height:"auto",color:h.colors.text.primary},"aria-label":"Chat input","aria-invalid":!!g,"aria-describedby":g?"input-error":void 0}),s().createElement("div",{className:"flex items-center justify-between mt-4 pt-3"},s().createElement("div",{className:"flex items-center gap-3"},u,(t||r)&&s().createElement("div",{className:"flex items-center text-sm",style:{color:h.colors.text.secondary}},t?s().createElement(s().Fragment,null,s().createElement("div",{className:"flex gap-1 mr-2"},s().createElement("div",{className:"w-1.5 h-1.5 bg-current rounded-full animate-pulse",style:{animationDelay:"0ms"}}),s().createElement("div",{className:"w-1.5 h-1.5 bg-current rounded-full animate-pulse",style:{animationDelay:"150ms"}}),s().createElement("div",{className:"w-1.5 h-1.5 bg-current rounded-full animate-pulse",style:{animationDelay:"300ms"}})),s().createElement("span",null,"Generating...")):s().createElement("span",null,"Loading tools..."))),s().createElement("div",{className:"flex items-center gap-3"},c,s().createElement("button",{onClick:()=>{g||i()},disabled:!e.trim()||t||r||!!g,className:"p-2 rounded-md hover:bg-white/10 transition-colors disabled:opacity-30 disabled:cursor-not-allowed","aria-label":"Send message (Enter)",style:{color:h.colors.text.secondary}},s().createElement(o.Icon,{name:"enter",size:"xl"})))))))});Be.displayName="ChatInput";const Fe=({className:e,style:t})=>s().createElement("svg",{className:e,style:t,width:"44",height:"44",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},s().createElement("path",{d:"M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z",fill:"currentColor"})),Ke=()=>{const e=(0,o.useTheme2)();return s().createElement("div",{className:"text-center animate-fadeIn flex flex-col items-center justify-center py-8"},s().createElement("p",{className:"text-base mb-2",style:{color:e.colors.text.secondary}},"Hi, I'm"),s().createElement("div",{className:"flex items-center justify-center gap-3 mb-5"},s().createElement(Fe,{className:"animate-sparkle",style:{color:e.colors.text.primary}}),s().createElement("h1",{className:"text-5xl font-bold tracking-tight",style:{color:e.colors.text.primary}},"Ask O11y Assistant")),s().createElement("div",{className:"flex items-center gap-3 mb-8"},s().createElement("span",{className:"status-badge"},"BETA"),s().createElement("span",{className:"text-base",style:{color:e.colors.text.secondary}},"v0.2.0")),s().createElement("p",{className:"text-lg max-w-2xl mx-auto leading-relaxed",style:{color:e.colors.text.secondary}},"An"," ",s().createElement("span",{className:"font-medium",style:{color:"#f97316"}},"agentic LLM assistant")," ","for Grafana that helps you query data, investigate issues, manage dashboards, and more through natural language."))},Ue=[{label:"Show me a graph of CPU usage",message:"Show me a graph of CPU usage over time",icon:"ðŸ“Š"},{label:"Graph memory by pod",message:"Graph memory usage by pod in my default namespace",icon:"ðŸ’¾"},{label:"Monitor user activity",message:"Create a query to monitor user activity over the last 24 hours",icon:"ðŸ”"},{label:"Build a dashboard",message:"Help me build a dashboard for system performance metrics",icon:"ðŸŽ¯"}],_e=({onSuggestionClick:e})=>{const t=(0,o.useTheme2)();return s().createElement("div",{className:"mt-8 animate-fadeIn",style:{animationDelay:"200ms"}},s().createElement("p",{className:"text-center text-sm mb-4",style:{color:t.colors.text.secondary}},"Quick start suggestions"),s().createElement("div",{className:"flex flex-wrap justify-center gap-3"},Ue.map((r,n)=>s().createElement("button",{key:n,onClick:()=>null==e?void 0:e(r.message),className:"group inline-flex items-center gap-2.5 px-5 py-3 rounded-xl text-base cursor-pointer transition-all duration-300 hover:-translate-y-1 hover:shadow-lg",style:{backgroundColor:t.isDark?"rgba(255, 255, 255, 0.03)":t.colors.background.secondary,border:`1px solid ${t.isDark?"rgba(255, 255, 255, 0.1)":t.colors.border.weak}`,color:t.colors.text.primary,animationDelay:50*(n+1)+"ms"},onMouseEnter:e=>{e.currentTarget.style.borderColor=t.isDark?"rgba(139, 92, 246, 0.5)":t.colors.primary.main,e.currentTarget.style.backgroundColor=t.isDark?"rgba(139, 92, 246, 0.1)":"rgba(139, 92, 246, 0.05)"},onMouseLeave:e=>{e.currentTarget.style.borderColor=t.isDark?"rgba(255, 255, 255, 0.1)":t.colors.border.weak,e.currentTarget.style.backgroundColor=t.isDark?"rgba(255, 255, 255, 0.03)":t.colors.background.secondary}},s().createElement("span",{className:"text-lg transition-transform duration-300 group-hover:scale-110"},r.icon),s().createElement("span",{className:"font-medium"},r.label)))))};var Ge=r(35458);function He(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function Ve(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){He(o,n,s,a,i,"next",e)}function i(e){He(o,n,s,a,i,"throw",e)}a(void 0)})}}function We({sessionId:e,session:t,onClose:r,existingShares:a=[]}){const[i,l]=(0,n.useState)(void 0),[c,u]=(0,n.useState)(""),[d,m]=(0,n.useState)(!1),[g,y]=(0,n.useState)(null),[h,p]=(0,n.useState)(a),[f,b]=(0,n.useState)(null);(0,n.useEffect)(()=>{0===a.length&&v()},[e,a.length]);const v=()=>Ve(function*(){try{const t=yield Ge.T.getSessionShares(e);p(t)}catch(e){console.error("[ShareDialog] Failed to load shares:",e)}})(),x=e=>{if(!e)return"Never";try{return new Date(e).toLocaleDateString()}catch(e){return"Invalid date"}},E=[{label:"Never",value:void 0},{label:"7 days",value:7},{label:"30 days",value:30},{label:"90 days",value:90},{label:"Custom",value:-1}];return s().createElement(o.Modal,{title:"Share Session",isOpen:!0,onDismiss:r},s().createElement("div",{className:"min-w-[400px]"},g?s().createElement("div",{className:"space-y-3"},s().createElement("p",{className:"text-sm text-primary"},"Share link created successfully!"),s().createElement("div",null,s().createElement("label",{className:"block text-xs font-medium mb-1 text-primary"},"Share URL:"),s().createElement("div",{className:"flex gap-1.5"},s().createElement(o.Input,{value:Ge.T.buildShareUrl(g.shareId),readOnly:!0,className:"flex-1"}),s().createElement(o.ClipboardButton,{icon:"copy",getText:()=>Ge.T.buildShareUrl(g.shareId)},"Copy"))),s().createElement("div",{className:"text-xs text-secondary"},s().createElement("strong",null,"Expires:")," ",x(g.expiresAt)),s().createElement("div",{className:"flex gap-1.5 justify-end pt-2"},s().createElement(o.Button,{variant:"secondary",size:"sm",onClick:()=>y(null)},"Create Another Share"),s().createElement(o.Button,{variant:"primary",size:"sm",onClick:r},"Close"))):s().createElement("div",{className:"space-y-3"},s().createElement("div",null,s().createElement("label",{className:"block text-xs font-medium mb-1 text-primary"},"Expiration:"),s().createElement(o.Select,{options:E.map(e=>{var t;return{label:e.label,value:null!==(t=e.value)&&void 0!==t?t:null}}),value:null!=i?i:null,onChange:e=>{e&&(l(null===e.value?void 0:e.value),-1!==e.value&&u(""))},placeholder:"Select expiration"}),-1===i&&s().createElement("div",{className:"mt-1.5"},s().createElement(o.Input,{type:"number",placeholder:"Enter number of days",value:c,onChange:e=>u(e.currentTarget.value),min:1}))),s().createElement("div",{className:"p-2 bg-secondary rounded text-xs text-secondary"},s().createElement("p",{className:"m-0"},"Shared sessions can be viewed in read-only mode. Recipients can import the session to their account.")),h.length>0&&s().createElement("div",null,s().createElement("label",{className:"block text-xs font-medium mb-1 text-primary"},"Existing Shares:"),s().createElement("div",{className:"flex flex-col gap-1.5"},h.map(e=>s().createElement("div",{key:e.shareId,className:"flex justify-between items-center p-1.5 bg-secondary rounded border border-weak"},s().createElement("div",{className:"flex-1 min-w-0"},s().createElement("div",{className:"text-xs text-secondary overflow-hidden text-ellipsis"},e.shareUrl),s().createElement("div",{className:"text-xs text-disabled mt-0.5"},"Expires: ",x(e.expiresAt))),s().createElement(o.Button,{variant:"destructive",size:"sm",onClick:()=>{return t=e.shareId,Ve(function*(){b(t);try{yield Ge.T.revokeShare(t),p(h.filter(e=>e.shareId!==t)),(null==g?void 0:g.shareId)===t&&y(null)}catch(e){console.error("[ShareDialog] Failed to revoke share:",e),alert("Failed to revoke share. Please try again.")}finally{b(null)}})();var t},disabled:f===e.shareId},f===e.shareId?"Revoking...":"Revoke"))))),s().createElement("div",{className:"flex gap-1.5 justify-end pt-2"},s().createElement(o.Button,{variant:"secondary",size:"sm",onClick:r},"Cancel"),s().createElement(o.Button,{variant:"primary",size:"sm",onClick:()=>Ve(function*(){m(!0);try{let r=i;if(-1===i&&c){const e=parseInt(c,10);if(isNaN(e)||e<=0)return alert("Please enter a valid number of days"),void m(!1);r=e}const n=yield Ge.T.createShare(e,t,r);y(n),yield v()}catch(e){console.error("[ShareDialog] Failed to create share:",e),alert("Failed to create share. Please try again.")}finally{m(!1)}})(),disabled:d},d?"Creating...":"Create Share")))))}function Je(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function Ye(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){Je(o,n,s,a,i,"next",e)}function i(e){Je(o,n,s,a,i,"throw",e)}a(void 0)})}}function Qe({sessionManager:e,currentSessionId:t,isOpen:r,onClose:a}){const i=(0,o.useTheme2)(),[l,c]=(0,n.useState)(null),[u,d]=(0,n.useState)(!1),[m,g]=(0,n.useState)(null),[y,h]=(0,n.useState)(!1),[p,f]=(0,n.useState)(!1),[b,v]=(0,n.useState)(null),[x,E]=(0,n.useState)(new Map),w=(0,n.useRef)(""),k=(0,n.useRef)(!1),S=e.sessions.map(e=>e.id).sort().join(",");(0,n.useEffect)(()=>{if(!r)return;if(S===w.current||k.current)return;w.current=S,k.current=!0;Ye(function*(){try{const t=new Map;for(const r of e.sessions)try{const e=yield Ge.T.getSessionShares(r.id);t.set(r.id,e)}catch(e){console.error(`[SessionSidebar] Failed to load shares for session ${r.id}:`,e)}E(t)}finally{k.current=!1}})()},[r,S]);const C=e=>{const t=(new Date).getTime()-e.getTime(),r=Math.floor(t/864e5);return 0===r?"Today":1===r?"Yesterday":r<7?`${r} days ago`:e.toLocaleDateString()},N=Math.round(e.storageStats.used/e.storageStats.total*100);return r?s().createElement("div",{className:"fixed inset-0 z-50 flex"},s().createElement("div",{className:"absolute inset-0",onClick:a,style:{backgroundColor:i.colors.background.canvas,opacity:i.isDark?.9:.8}}),s().createElement("div",{className:"relative w-80 shadow-xl flex flex-col border-r border-weak",style:{backgroundColor:i.colors.background.primary}},s().createElement("div",{className:"p-2 border-b border-weak"},s().createElement("div",{className:"flex items-center justify-between mb-1"},s().createElement("h2",{className:"text-base font-semibold text-primary"},"Chat History"),s().createElement("button",{onClick:a,className:"p-0.5 hover:bg-secondary rounded text-secondary hover:text-primary transition-colors",title:"Close"},s().createElement(o.Icon,{name:"times",size:"sm"}))),s().createElement("div",{className:"flex gap-1.5 mt-2"},s().createElement(De.lV,{onClick:()=>Ye(function*(){f(!0);try{yield e.createNewSession(),a()}catch(e){console.error("[SessionSidebar] Failed to create new session:",e)}finally{f(!1)}})(),isLoading:p,loadingText:"Creating...",variant:"primary",size:"sm",className:"flex-1"},"+ New Chat"),s().createElement("button",{onClick:()=>d(!0),className:"px-2 py-1 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary transition-colors",title:"Import session",disabled:y},s().createElement(o.Icon,{name:"upload",size:"sm"}))),s().createElement("div",{className:"mt-2 text-xs text-secondary"},s().createElement("div",{className:"flex justify-between mb-1"},s().createElement("span",null,e.sessions.length," sessions"),s().createElement("span",null,N,"% storage used")),s().createElement("div",{className:"w-full bg-surface rounded-full h-1"},s().createElement("div",{className:"h-1 rounded-full "+(N>80?"bg-error":"bg-primary"),style:{width:`${N}%`}})))),s().createElement("div",{className:"flex-1 overflow-y-auto p-1.5"},0===e.sessions.length?s().createElement("div",{className:"text-center text-secondary mt-8"},s().createElement("p",{className:"text-sm"},"No saved conversations yet"),s().createElement("p",{className:"text-xs mt-1"},"Start a new chat to begin")):s().createElement("div",{className:"space-y-0.5"},e.sessions.map(r=>{var n,o;return s().createElement(Ze,{key:r.id,session:r,isActive:r.id===t,showDeleteConfirm:l===r.id,isLoading:m===`loading-${r.id}`,isDeleting:m===`deleting-${r.id}`,isExporting:m===`exporting-${r.id}`,hasShares:(null!==(n=null===(o=x.get(r.id))||void 0===o?void 0:o.length)&&void 0!==n?n:0)>0,onLoad:()=>{return t=r.id,Ye(function*(){g(`loading-${t}`);try{yield new Promise(e=>setTimeout(e,300)),yield e.loadSession(t),a()}finally{g(null)}})();var t},onDelete:e=>((e,t)=>{t.stopPropagation(),c(e)})(r.id,e),onConfirmDelete:()=>{return t=r.id,Ye(function*(){g(`deleting-${t}`);try{yield new Promise(e=>setTimeout(e,300)),yield e.deleteSession(t),c(null)}finally{g(null)}})();var t},onCancelDelete:()=>c(null),onExport:t=>((t,r)=>Ye(function*(){r.stopPropagation(),g(`exporting-${t}`);try{yield new Promise(e=>setTimeout(e,300)),yield e.exportSession(t)}finally{g(null)}})())(r.id,t),onShare:()=>v(r.id),formatDate:C})}))),s().createElement("div",{className:"p-2 border-t border-weak"},e.sessions.length>0&&s().createElement("button",{onClick:()=>Ye(function*(){if(confirm("Are you sure you want to delete all conversations? This cannot be undone."))try{yield e.deleteAllSessions()}catch(e){console.error("[SessionSidebar] Failed to delete all sessions:",e)}})(),className:"w-full px-2 py-1 text-xs text-error hover:bg-error/10 rounded transition-colors"},"Clear All History")),u&&s().createElement("div",{className:"absolute inset-0 bg-background flex items-center justify-center p-3 border border-weak"},s().createElement(De.p8,{isLoading:y,message:"Importing session..."},s().createElement("div",{className:"w-full max-w-sm"},s().createElement("h3",{className:"text-sm font-semibold mb-2 text-primary"},"Import Session"),s().createElement("input",{type:"file",accept:".json",onChange:t=>Ye(function*(){var r;const n=null===(r=t.target.files)||void 0===r?void 0:r[0];if(n){h(!0);const t=new FileReader;t.onload=t=>Ye(function*(){var r;const n=null===(r=t.target)||void 0===r?void 0:r.result;yield new Promise(e=>setTimeout(e,500));(yield e.importSession(n))?d(!1):alert("Failed to import session. Please check the file format."),h(!1)})(),t.onerror=()=>{h(!1),alert("Failed to read file")},t.readAsText(n)}})(),disabled:y,className:"w-full px-2 py-1 text-xs border border-weak rounded bg-background text-primary disabled:opacity-50"}),s().createElement("button",{onClick:()=>d(!1),disabled:y,className:"mt-2 w-full px-2 py-1 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors"},"Cancel")))),b&&s().createElement(Xe,{sessionId:b,onClose:()=>Ye(function*(){v(null);try{const e=yield Ge.T.getSessionShares(b);E(t=>{const r=new Map(t);return r.set(b,e),r})}catch(e){console.error("[SessionSidebar] Failed to refresh shares:",e)}})(),existingShares:x.get(b)||[]}))):null}function Xe({sessionId:e,onClose:t,existingShares:r}){const o=(0,a.usePluginUserStorage)(),i=String(a.config.bootData.user.orgId||"1"),[l,c]=s().useState(null),[u,d]=s().useState(!0);return(0,n.useEffect)(()=>{Ye(function*(){try{const t=Q.E.getSessionService(o),r=yield t.getSession(i,e);r&&c(r)}catch(e){console.error("[ShareDialogWrapper] Failed to load session:",e)}finally{d(!1)}})()},[e,i]),u||!l?null:s().createElement(We,{sessionId:e,session:l,onClose:t,existingShares:r})}function Ze({session:e,isActive:t,showDeleteConfirm:r,isLoading:n=!1,isDeleting:a=!1,isExporting:i=!1,hasShares:l=!1,onLoad:c,onDelete:u,onConfirmDelete:d,onCancelDelete:m,onExport:g,onShare:y,formatDate:h}){return r?s().createElement("div",{className:"p-2 bg-surface rounded border border-error"},s().createElement("p",{className:"text-xs text-error mb-1.5"},"Delete this conversation?"),s().createElement("div",{className:"flex gap-1.5"},s().createElement(De.lV,{onClick:d,isLoading:a,loadingText:"Deleting...",variant:"destructive",size:"sm",className:"flex-1"},"Delete"),s().createElement("button",{onClick:m,disabled:a,className:"flex-1 px-1.5 py-0.5 text-xs bg-secondary hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors"},"Cancel"))):s().createElement("div",{onClick:n?void 0:c,className:`p-1.5 rounded group transition-colors relative ${t?"bg-surface border border-primary":"hover:bg-secondary border border-weak"} ${n?"cursor-wait":"cursor-pointer"}`},n&&s().createElement("div",{className:"absolute inset-0 flex items-center justify-center bg-background rounded border border-weak"},s().createElement(De.Ou,{message:"Loading...",size:"sm"})),s().createElement("div",{className:"flex items-start justify-between gap-1.5"},s().createElement("div",{className:"flex-1 min-w-0"},s().createElement("h3",{className:"font-medium text-xs truncate text-primary"},e.title),s().createElement("div",{className:"flex items-center gap-1.5 mt-0.5 text-xs text-secondary"},s().createElement("span",null,h(e.updatedAt)),s().createElement("span",null,"â€¢"),s().createElement("span",null,e.messageCount," messages"))),s().createElement("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity"},s().createElement("button",{onClick:e=>{e.stopPropagation(),y()},disabled:n||i,className:"p-0.5 hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors",title:l?"View shares":"Share"},s().createElement(o.Icon,{name:"share-alt",size:"sm"})),s().createElement("button",{onClick:g,disabled:i,className:"p-0.5 hover:bg-surface rounded text-secondary hover:text-primary disabled:opacity-50 transition-colors",title:"Export"},i?s().createElement(De.Ou,{size:"sm"}):s().createElement(o.Icon,{name:"arrow-down",size:"sm"})),s().createElement("button",{onClick:u,disabled:n||i,className:"p-0.5 hover:bg-surface rounded text-error hover:text-error disabled:opacity-50 transition-colors",title:"Delete"},s().createElement(o.Icon,{name:"trash-alt",size:"sm"})))))}function et({isSummarizing:e,hasSummary:t,messageCount:r,className:n=""}){return e||t?s().createElement("div",{className:`px-4 py-3 bg-info-background border-l-4 border-info text-sm ${n}`,role:"status","aria-live":"polite","aria-label":e?"Summarizing conversation":"Conversation has been summarized"},e?s().createElement("div",{className:"flex items-center gap-3"},s().createElement(De.Ou,{size:"sm"}),s().createElement("div",{className:"flex-1"},s().createElement("div",{className:"font-medium text-info-text mb-1"},"Optimizing conversation memory..."),s().createElement("div",{className:"text-xs text-secondary"},"Summarizing ",r?`${r} older messages`:"older messages"," to preserve context while reducing token usage"))):s().createElement("div",{className:"flex items-center gap-3"},s().createElement(o.Icon,{name:"check-circle",className:"text-info"}),s().createElement("div",{className:"flex-1"},s().createElement("div",{className:"font-medium text-info-text mb-1"},"Conversation optimized"),s().createElement("div",{className:"text-xs text-secondary"},"Older messages have been summarized to maintain efficient context")))):null}const tt=({onClick:e,color:t})=>s().createElement("button",{onClick:t=>{t.stopPropagation(),e()},className:"p-1 mr-1 rounded hover:bg-black/20 transition-colors flex-shrink-0",style:{color:t},"aria-label":"Close tab",title:"Close tab"},s().createElement("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),s().createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})));const rt=({isOpen:e,onClose:t,pageRefs:r,onRemoveTab:a})=>{const i=(0,o.useTheme2)(),[l,c]=(0,n.useState)(0),u=he(),d=Math.min(l,Math.max(0,r.length-1));if((0,n.useEffect)(()=>{l!==d&&c(d)},[l,d]),!e||0===r.length||null===u||!u)return null;const m=r[d],g=r.length>1,y=function(e){if(e.startsWith("http://")||e.startsWith("https://")){const t=e.match(/https?:\/\/[^/]+(\/.*)/);return t?t[1]:e}return e}(m.url);return s().createElement("div",{className:"flex flex-col h-screen sticky top-0 border-r transition-all duration-300 ease-in-out",style:{width:"800px",minWidth:"400px",maxWidth:"65%",backgroundColor:i.isDark?"#1a1b1f":i.colors.background.primary,borderColor:i.colors.border.weak},role:"complementary","aria-label":"Grafana page preview"},s().createElement("div",{className:"flex items-center justify-between px-4 py-3 border-b flex-shrink-0",style:{borderColor:i.colors.border.weak,backgroundColor:i.isDark?"#111217":i.colors.background.secondary}},s().createElement("div",{className:"flex items-center gap-2"},s().createElement("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{color:i.colors.text.secondary}},s().createElement("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),s().createElement("line",{x1:"9",y1:"3",x2:"9",y2:"21"})),s().createElement("span",{className:"text-sm font-medium",style:{color:i.colors.text.primary}},m.title||("explore"===m.type?"Explore":"Dashboard"))),s().createElement("button",{onClick:t,className:"p-1.5 rounded-md hover:bg-white/10 transition-colors","aria-label":"Close panel",title:"Close panel",style:{color:i.colors.text.secondary}},s().createElement("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),s().createElement("line",{x1:"6",y1:"6",x2:"18",y2:"18"})))),g&&s().createElement("div",{className:"flex gap-1 px-2 py-2 border-b flex-shrink-0",style:{borderColor:i.colors.border.weak,backgroundColor:i.isDark?"#111217":i.colors.background.secondary},role:"tablist"},r.map((e,t)=>s().createElement("div",{key:`${e.url}-${t}`,className:"flex items-center gap-1 flex-1 min-w-0 rounded-md transition-colors",style:{backgroundColor:t===d?i.colors.primary.main:i.isDark?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)"},role:"tab","aria-selected":t===d},s().createElement("button",{onClick:()=>c(t),className:"flex-1 min-w-0 px-3 py-1.5 text-xs truncate text-left",style:{color:t===d?i.colors.primary.contrastText:i.colors.text.secondary},title:e.url},function(e,t){return e.title?e.title.length>20?e.title.substring(0,20)+"...":e.title:"dashboard"===e.type&&e.uid?`Dashboard ${e.uid.substring(0,8)}`:"explore"===e.type?"Explore":`Page ${t+1}`}(e,t)),a&&s().createElement(tt,{onClick:()=>a(t),color:t===d?i.colors.primary.contrastText:i.colors.text.secondary})))),s().createElement("div",{className:"flex-1 min-h-0"},s().createElement("iframe",{src:y,title:m.title||`Grafana ${m.type}`,className:"w-full h-full border-0",style:{backgroundColor:i.colors.background.canvas}})))},nt=({onConfirm:e,disabled:t,theme:r})=>{const[o,a]=(0,n.useState)(!1),i=(0,n.useRef)(null);return s().useEffect(()=>{const e=e=>{i.current&&!i.current.contains(e.target)&&a(!1)};return o&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[o]),s().createElement("div",{className:"relative"},s().createElement("button",{onClick:()=>a(!o),disabled:t,className:"p-2 rounded-md hover:bg-white/10 transition-colors disabled:opacity-30 disabled:cursor-not-allowed","aria-label":"New chat",title:"New chat",style:{color:r.colors.text.secondary}},s().createElement("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),s().createElement("line",{x1:"5",y1:"12",x2:"19",y2:"12"}))),o&&s().createElement("div",{ref:i,className:"absolute bottom-full left-0 mb-2 w-48 p-3 rounded-lg shadow-xl border z-50 flex flex-col gap-2",style:{backgroundColor:r.colors.background.primary,borderColor:r.colors.border.weak}},s().createElement("p",{className:"text-xs font-medium mb-1",style:{color:r.colors.text.primary}},"Start a new chat?"),s().createElement("div",{className:"flex gap-2"},s().createElement("button",{onClick:()=>{e(),a(!1)},className:"flex-1 px-2 py-1 text-xs rounded font-medium transition-colors",style:{backgroundColor:r.colors.primary.main,color:r.colors.text.primary}},"Yes"),s().createElement("button",{onClick:()=>a(!1),className:"flex-1 px-2 py-1 text-xs rounded font-medium transition-colors hover:bg-white/10",style:{color:r.colors.text.secondary,border:`1px solid ${r.colors.border.weak}`}},"No"))))};function st({pluginSettings:e,readOnly:t=!1,initialSession:r}){(()=>{const e=(0,o.useTheme2)();(0,n.useEffect)(()=>{if(!e)return;const t=document.documentElement;t.style.setProperty("--grafana-color-primary",e.colors.primary.main),t.style.setProperty("--grafana-color-primary-light",e.colors.primary.shade),t.style.setProperty("--grafana-color-primary-dark",e.colors.primary.shade),t.style.setProperty("--grafana-color-primary-transparent",e.colors.primary.transparent),t.style.setProperty("--grafana-color-secondary",e.colors.secondary.main),t.style.setProperty("--grafana-color-secondary-light",e.colors.secondary.shade),t.style.setProperty("--grafana-color-secondary-dark",e.colors.secondary.shade),t.style.setProperty("--grafana-color-background-primary",e.colors.background.primary),t.style.setProperty("--grafana-color-background-secondary",e.colors.background.secondary),t.style.setProperty("--grafana-color-background-canvas",e.colors.background.canvas),t.style.setProperty("--grafana-color-background-elevated",e.colors.background.primary),t.style.setProperty("--grafana-color-text-primary",e.colors.text.primary),t.style.setProperty("--grafana-color-text-secondary",e.colors.text.secondary),t.style.setProperty("--grafana-color-text-disabled",e.colors.text.disabled),t.style.setProperty("--grafana-color-text-link",e.colors.text.link),t.style.setProperty("--grafana-color-text-link-hover",e.colors.text.link),t.style.setProperty("--grafana-color-text-primary-inverse",e.colors.text.primary),t.style.setProperty("--grafana-color-border-weak",e.colors.border.weak),t.style.setProperty("--grafana-color-border-medium",e.colors.border.medium),t.style.setProperty("--grafana-color-border-strong",e.colors.border.strong),t.style.setProperty("--grafana-color-success",e.colors.success.main),t.style.setProperty("--grafana-color-success-light",e.colors.success.shade),t.style.setProperty("--grafana-color-success-dark",e.colors.success.shade),t.style.setProperty("--grafana-color-warning",e.colors.warning.main),t.style.setProperty("--grafana-color-warning-light",e.colors.warning.shade),t.style.setProperty("--grafana-color-warning-dark",e.colors.warning.shade),t.style.setProperty("--grafana-color-error",e.colors.error.main),t.style.setProperty("--grafana-color-error-light",e.colors.error.shade),t.style.setProperty("--grafana-color-error-dark",e.colors.error.shade),t.style.setProperty("--grafana-color-info",e.colors.info.main),t.style.setProperty("--grafana-color-info-light",e.colors.info.shade),t.style.setProperty("--grafana-color-info-dark",e.colors.info.shade),t.style.setProperty("--grafana-spacing-xs",`${e.spacing(.5)}px`),t.style.setProperty("--grafana-spacing-sm",`${e.spacing(1)}px`),t.style.setProperty("--grafana-spacing-md",`${e.spacing(2)}px`),t.style.setProperty("--grafana-spacing-lg",`${e.spacing(3)}px`),t.style.setProperty("--grafana-spacing-xl",`${e.spacing(4)}px`),t.style.setProperty("--grafana-spacing-xxl",`${e.spacing(6)}px`),t.style.setProperty("--grafana-border-radius-sm",e.shape.radius.default),t.style.setProperty("--grafana-border-radius",e.shape.radius.default),t.style.setProperty("--grafana-border-radius-lg",e.shape.radius.default),t.style.setProperty("--grafana-border-radius-xl",e.shape.radius.default),t.style.setProperty("--grafana-font-family",e.typography.fontFamily),t.style.setProperty("--grafana-font-family-mono",e.typography.fontFamilyMonospace)},[e])})();const a=(0,o.useTheme2)(),i=he(),{chatHistory:l,currentInput:c,isGenerating:u,chatContainerRef:d,toolsLoading:m,toolsError:g,setCurrentInput:y,sendMessage:h,handleKeyPress:p,clearChat:f,sessionManager:b,bottomSpacerRef:v,detectedPageRefs:x}=me(e,t?r:void 0),E=(0,n.useRef)(null),[w,k]=(0,n.useState)(!1),[S,C]=(0,n.useState)(!1),[N,T]=(0,n.useState)(new Set),O=(0,n.useRef)(null),P=(0,n.useRef)(null),D=(0,n.useCallback)((e,t="polite")=>{const r=document.createElement("div");r.setAttribute("role","status"),r.setAttribute("aria-live",t),r.setAttribute("aria-atomic","true"),r.style.position="absolute",r.style.left="-10000px",r.style.width="1px",r.style.height="1px",r.style.overflow="hidden",r.textContent=e,document.body.appendChild(r),setTimeout(()=>{document.body.removeChild(r)},1e3)},[]),R=x.filter(e=>!N.has(e.url)),I=(0,n.useCallback)(e=>{const t=R[e];t&&T(e=>new Set(e).add(t.url))},[R]);(0,n.useEffect)(()=>{const e=x.length>0?x[0].messageIndex:null,t=O.current,r=b.currentSessionId,n=null!==e&&e!==t;r!==P.current?(T(new Set),null!==e&&C(!0)):n&&(C(!0),T(new Set)),O.current=e,P.current=r},[x,b.currentSessionId]);const j=(0,n.useCallback)(()=>{var e;null===(e=E.current)||void 0===e||e.focus(),D("Chat input focused")},[D]),q=(0,n.useCallback)(()=>{k(!0),D("Chat history opened")},[D]);!function({onNewChat:e,onClearChat:t,onOpenHistory:r,onFocusInput:s,onToggleTheme:o,onExportChat:a,onSearch:i}){const l=(0,n.useCallback)(n=>{var l,c,u;const d="INPUT"===(null===(l=document.activeElement)||void 0===l?void 0:l.tagName)||"TEXTAREA"===(null===(c=document.activeElement)||void 0===c?void 0:c.tagName)||"true"===(null===(u=document.activeElement)||void 0===u?void 0:u.getAttribute("contenteditable"));if("Escape"===n.key){const e=document.querySelector('[role="dialog"]');if(e){const t=e.querySelector('[aria-label*="Close"]');null==t||t.click()}return}if(!d||n.metaKey||n.ctrlKey){if((n.metaKey||n.ctrlKey)&&"k"===n.key)return n.preventDefault(),void(null==s||s());if((n.metaKey||n.ctrlKey)&&"n"===n.key)return n.preventDefault(),void(null==e||e());if((n.metaKey||n.ctrlKey)&&n.shiftKey&&"Delete"===n.key)return n.preventDefault(),void(null==t||t());if((n.metaKey||n.ctrlKey)&&"h"===n.key)return n.preventDefault(),void(null==r||r());if((n.metaKey||n.ctrlKey)&&"e"===n.key)return n.preventDefault(),void(null==a||a());if((n.metaKey||n.ctrlKey)&&"f"===n.key)return n.preventDefault(),void(null==i||i());if((n.metaKey||n.ctrlKey)&&n.shiftKey&&"T"===n.key)return n.preventDefault(),void(null==o||o());if("Tab"===n.key&&!n.shiftKey&&!d){const e=document.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');e.length>0&&(e[(Array.from(e).indexOf(document.activeElement)+1)%e.length].focus(),n.preventDefault())}if(("ArrowUp"===n.key||"ArrowDown"===n.key)&&!d){const e=document.querySelectorAll('[role="article"]');if(e.length>0){const t=document.activeElement,r=Array.from(e).indexOf(t);let s;s="ArrowUp"===n.key?r>0?r-1:e.length-1:r<e.length-1?r+1:0,e[s].focus(),n.preventDefault()}}}},[e,t,r,s,o,a,i]);(0,n.useEffect)(()=>(window.addEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}),[l])}({onNewChat:()=>{b.createNewSession(),D("New chat created")},onClearChat:()=>{window.confirm("Are you sure you want to clear the current chat?")&&(f(),D("Chat cleared"))},onOpenHistory:q,onFocusInput:j,onExportChat:(0,n.useCallback)(()=>{b.currentSessionId&&(b.exportSession(b.currentSessionId),D("Chat exported"))},[b,D])});if(g)return s().createElement("div",null,"Error: ",g.message);const A=b.sessions.find(e=>e.id===b.currentSessionId),L=null==A?void 0:A.title,$=l.length>0,M=S&&R.length>0&&!0===i;return s().createElement("div",{className:"w-full min-h-full flex",role:"main","aria-label":"Chat interface",style:{backgroundColor:a.isDark?"#111217":a.colors.background.canvas}},s().createElement(rt,{isOpen:M,onClose:()=>C(!1),pageRefs:R,onRemoveTab:I}),s().createElement("div",{className:"flex-1 flex flex-col min-h-0 min-w-0"},$?s().createElement("div",{className:"flex-1 flex flex-col min-h-0 w-full px-4 "+(M?"max-w-none":"max-w-4xl mx-auto")},s().createElement(pe,{isGenerating:u,currentSessionTitle:L}),s().createElement(et,{isSummarizing:b.isSummarizing,hasSummary:!!b.currentSummary}),s().createElement("div",{ref:d,className:"flex-1 py-6 rounded-lg",role:"log","aria-label":"Chat messages","aria-live":"polite","aria-relevant":"additions",tabIndex:0,style:{backgroundColor:a.isDark?"#1a1b1f":a.colors.background.primary}},s().createElement("div",{className:"px-4"},s().createElement(ze,{chatHistory:l,isGenerating:u}),s().createElement("div",{ref:v,className:"h-16",style:{scrollMarginBottom:"100px"}}))),!t&&s().createElement("div",{className:"flex-shrink-0 py-4 sticky bottom-0 z-10",role:"region","aria-label":"Message input",style:{backgroundColor:a.isDark?"#111217":a.colors.background.canvas}},s().createElement(Be,{ref:E,currentInput:c,isGenerating:u,toolsLoading:m,setCurrentInput:y,sendMessage:h,handleKeyPress:p,leftSlot:s().createElement(nt,{onConfirm:f,disabled:u,theme:a}),rightSlot:s().createElement("button",{onClick:q,className:"flex items-center gap-2 px-2 py-1 text-xs font-medium rounded-md hover:bg-white/10 transition-colors","aria-label":"Chat history",title:"View chat history",style:{color:a.colors.text.secondary}},s().createElement("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("circle",{cx:"12",cy:"12",r:"10"}),s().createElement("polyline",{points:"12 6 12 12 16 14"})),s().createElement("span",null,"View chat history (",b.sessions.length,")"))}))):s().createElement("div",{className:"flex-1 flex flex-col min-h-0 w-full max-w-3xl mx-auto px-4"},s().createElement("div",{className:"flex-1 flex flex-col items-center justify-center py-8"},s().createElement(Ke,null),s().createElement("div",{className:"w-full mt-10 mb-4",role:"region","aria-label":"Message input"},s().createElement(Be,{ref:E,currentInput:c,isGenerating:u,toolsLoading:m,setCurrentInput:y,sendMessage:h,handleKeyPress:p,leftSlot:void 0,rightSlot:s().createElement("button",{onClick:q,className:"flex items-center gap-2 px-2 py-1 text-xs font-medium rounded-md hover:bg-white/10 transition-colors","aria-label":"Chat history",title:"View chat history",style:{color:a.colors.text.secondary}},s().createElement("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("circle",{cx:"12",cy:"12",r:"10"}),s().createElement("polyline",{points:"12 6 12 12 16 14"})),s().createElement("span",null,"View chat history (",b.sessions.length,")"))})),s().createElement("div",{className:"w-full"},s().createElement(_e,{onSuggestionClick:e=>{y(e),setTimeout(()=>{var e;null===(e=E.current)||void 0===e||e.focus()},100),D(`Suggestion selected: ${e.substring(0,50)}...`)}}))))),s().createElement(Qe,{sessionManager:b,currentSessionId:b.currentSessionId,isOpen:w,onClose:()=>k(!1)}))}function ot(e){return s().createElement(Pe.lw,null,s().createElement(st,e))}},98852(e,t,r){r.d(t,{E:()=>p});var n=r(15331);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class o extends Error{static quotaExceeded(e){return new o("Storage quota exceeded. Please free up space or delete old sessions.","QUOTA_EXCEEDED",e)}static notFound(e,t){return new o(`${e} with ID "${t}" not found`,"NOT_FOUND")}static invalidData(e,t){return new o(`Invalid data: ${e}`,"INVALID_DATA",t)}static unavailable(e){return new o("Storage is not available","UNAVAILABLE",e)}constructor(e,t,r){super(e),s(this,"code",void 0),s(this,"cause",void 0),this.code=t,this.cause=r,this.name="StorageError",Object.setPrototypeOf(this,o.prototype)}}function a(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function i(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function i(e){a(o,n,s,i,l,"next",e)}function l(e){a(o,n,s,i,l,"throw",e)}i(void 0)})}}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class u{getAllSessions(e){return i(function*(){return this.repository.findAll(e)}).call(this)}getSession(e,t){return i(function*(){return this.repository.findById(e,t)}).call(this)}getCurrentSession(e){return i(function*(){const t=yield this.repository.getCurrentSessionId(e);return t?this.repository.findById(e,t):null}).call(this)}createSession(e,t,r){return i(function*(){const s=n.v.create(t,r);return yield this.repository.save(e,s),yield this.repository.setCurrentSessionId(e,s.id),s}).call(this)}updateSession(e,t,r,n){return i(function*(){const s=yield this.repository.findById(e,t);if(!s)return console.warn(`[SessionService] Session ${t} not found, creating new session`),void(yield this.createSession(e,r));s.updateMessages(r,n),yield this.repository.save(e,s)}).call(this)}deleteSession(e,t){return i(function*(){yield this.repository.delete(e,t)}).call(this)}deleteAllSessions(e){return i(function*(){yield this.repository.deleteAll(e)}).call(this)}setActiveSession(e,t){return i(function*(){if(!(yield this.repository.findById(e,t)))throw o.notFound("Session",t);yield this.repository.setCurrentSessionId(e,t)}).call(this)}clearActiveSession(e){return i(function*(){yield this.repository.clearCurrentSessionId(e)}).call(this)}exportSession(e,t){return i(function*(){const r=yield this.repository.findById(e,t);return r?JSON.stringify(r.toStorage(),null,2):null}).call(this)}importSession(e,t){return i(function*(){try{const r=JSON.parse(t);if(!r.id||!r.messages||!Array.isArray(r.messages))throw new Error("Invalid session format: missing required fields");const s=r.messages.map(e=>c(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){l(e,t,r[t])})}return e}({},e),{timestamp:new Date(e.timestamp)})),o=n.v.create(s,r.title);return yield this.repository.save(e,o),o}catch(e){throw o.invalidData("Failed to import session",e)}}).call(this)}getStorageStats(e){return i(function*(){return this.repository.getStorageStats(e)}).call(this)}autoSave(e,t,r){return i(function*(){0!==r.length&&(t?yield this.updateSession(e,t,r):yield this.createSession(e,r))}).call(this)}constructor(e){l(this,"repository",void 0),this.repository=e}}function d(e,t,r,n,s,o,a){try{var i=e[o](a),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,s)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var o=e.apply(t,r);function a(e){d(o,n,s,a,i,"next",e)}function i(e){d(o,n,s,a,i,"throw",e)}a(void 0)})}}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function y(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class h{findAll(e){return m(function*(){try{const t=this.getSessionsIndexKey(e),r=yield this.storage.getItem(t);if(!r)return[];return JSON.parse(r).map(e=>y(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){g(e,t,r[t])})}return e}({},e),{createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}))}catch(e){throw console.error("[GrafanaUserStorageRepository] Failed to load sessions index:",e),o.invalidData("Failed to parse sessions index",e)}}).call(this)}findById(e,t){return m(function*(){try{const r=this.getSessionKey(e,t),s=yield this.storage.getItem(r);if(!s)return null;const o=JSON.parse(s);return n.v.fromStorage(o)}catch(e){throw console.error(`[GrafanaUserStorageRepository] Failed to load session ${t}:`,e),o.invalidData(`Failed to parse session ${t}`,e)}}).call(this)}save(e,t){return m(function*(){try{t.updatedAt=new Date,t.messageCount=t.messages.length;const r=this.getSessionKey(e,t.id),n=JSON.stringify(t.toStorage());yield this.storage.setItem(r,n),yield this.updateSessionIndex(e,t)}catch(r){if(console.error("[GrafanaUserStorageRepository] Failed to save session:",r),!(r instanceof Error&&"QuotaExceededError"===r.name))throw o.unavailable(r);yield this.handleQuotaExceeded(e,t)}}).call(this)}delete(e,t){return m(function*(){try{const r=this.getSessionKey(e,t);yield this.storage.setItem(r,"");const n=(yield this.findAll(e)).filter(e=>e.id!==t);yield this.saveSessionsIndex(e,n);(yield this.getCurrentSessionId(e))===t&&(yield this.clearCurrentSessionId(e))}catch(e){throw console.error("[GrafanaUserStorageRepository] Failed to delete session:",e),o.unavailable(e)}}).call(this)}deleteAll(e){return m(function*(){try{const t=yield this.findAll(e);for(const r of t){const t=this.getSessionKey(e,r.id);yield this.storage.setItem(t,"")}const r=this.getSessionsIndexKey(e);yield this.storage.setItem(r,""),yield this.clearCurrentSessionId(e)}catch(e){throw console.error("[GrafanaUserStorageRepository] Failed to delete all sessions:",e),o.unavailable(e)}}).call(this)}getCurrentSessionId(e){return m(function*(){const t=this.getCurrentSessionKey(e);return(yield this.storage.getItem(t))||null}).call(this)}setCurrentSessionId(e,t){return m(function*(){const r=this.getCurrentSessionKey(e);yield this.storage.setItem(r,t)}).call(this)}clearCurrentSessionId(e){return m(function*(){const t=this.getCurrentSessionKey(e);yield this.storage.setItem(t,"")}).call(this)}getStorageStats(e){return m(function*(){const t=yield this.findAll(e);return{used:5e3*t.length,total:10485760,sessionCount:t.length}}).call(this)}updateSessionIndex(e,t){return m(function*(){const r=yield this.findAll(e),n=r.findIndex(e=>e.id===t.id);n>=0?r[n]=t.getMetadata():r.push(t.getMetadata()),yield this.saveSessionsIndex(e,r)}).call(this)}saveSessionsIndex(e,t){return m(function*(){const r=[...t].sort((e,t)=>t.updatedAt.getTime()-e.updatedAt.getTime()),n=r.slice(0,this.maxSessions),s=this.getSessionsIndexKey(e),o=JSON.stringify(n);if(yield this.storage.setItem(s,o),r.length>this.maxSessions){const t=r.slice(this.maxSessions);for(const r of t){const t=this.getSessionKey(e,r.id);yield this.storage.setItem(t,"")}}}).call(this)}handleQuotaExceeded(e,t){return m(function*(){console.warn("[GrafanaUserStorageRepository] Storage quota exceeded, cleaning up old sessions");const r=(yield this.findAll(e)).sort((e,t)=>e.updatedAt.getTime()-t.updatedAt.getTime()).slice(0,10);for(const t of r)yield this.delete(e,t.id);try{const r=this.getSessionKey(e,t.id);yield this.storage.setItem(r,JSON.stringify(t.toStorage())),yield this.updateSessionIndex(e,t)}catch(e){throw o.quotaExceeded(e)}}).call(this)}getSessionsIndexKey(e){return`${this.storageKeyPrefix}org-${e}-sessions-index`}getCurrentSessionKey(e){return`${this.storageKeyPrefix}org-${e}-current-session`}getSessionKey(e,t){return`${this.storageKeyPrefix}org-${e}-${t}`}constructor(e){if(g(this,"storage",void 0),g(this,"storageKeyPrefix",void 0),g(this,"maxSessions",void 0),this.storage=e,this.storageKeyPrefix="grafana-o11y-chat-",this.maxSessions=50,!e)throw new Error("Storage object is required")}}class p{static getSessionService(e){const t=new h(e);return new u(t)}static reset(){}}}}]);
//# sourceMappingURL=1039.284d8e5e.js.map